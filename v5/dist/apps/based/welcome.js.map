{"version":3,"file":"welcome.js","sources":["../../../apps/based/welcome/welcome.js","../../../apps/based/welcome/lib/bindUIEvents.js","../../../apps/based/welcome/lib/handleAuthentication.js"],"sourcesContent":["import bindUIEvents from \"./lib/bindUIEvents.js\";\nimport handleAuthentication from \"./lib/handleAuthentication.js\";\nexport default class Welcome {\n    constructor(bp, options = {}) {\n        this.bp = bp;\n        this.options = options;\n        return this;\n    }\n\n    async init() {\n        this.html = await this.bp.load('/v5/apps/based/welcome/welcome.html');\n        await this.bp.load('/v5/apps/based/welcome/welcome.css');\n        this.affirmations = await this.bp.importModule('affirmations');\n\n        return 'loaded Welcome';\n    }\n\n    async open() {\n\n        this.win = await this.bp.window(this.window());\n        // this should be handled globally ( if possible )\n        $('.loggedIn', this.win.content).hide();\n        $('.loggedOut', this.win.content).show();\n\n        this.bindUIEvents();\n        // check if the user is already authenticated with qtoken\n        this.handleAuthentication();\n\n        // focus on the username input field\n        $('.welcomeForm input[name=\"username\"]', this.win.content).focus();\n\n    }\n\n     window() {\n        return {\n            id: 'welcome',\n            title: 'Welcome Buddy',\n            icon: 'desktop/assets/images/icons/icon_buddy-frog_64.png',\n            position: 'center',\n            parent: $('#desktop')[0],\n            width: 850,\n            height: 600,\n            content: this.html,\n            resizable: true,\n            closable: true,\n            onClose: () => {\n                this.win = null;\n            },\n            onResize: () => {\n                if (this.board) {\n                    this.board.resize();\n                }\n            }\n        }\n    }\n}\n\nWelcome.prototype.bindUIEvents = bindUIEvents;\nWelcome.prototype.handleAuthentication = handleAuthentication;","export default function welcomeUIEvents() {\n    console.log('aaaaaa', this)\n  let api = this.bp.apps.client.api;\n  let affirmations = this.bp.apps.affirmations.affirmations;\n\n  // bind events\n  $('.welcomeForm').submit((e) => {\n    e.preventDefault();\n\n    // disable the login button\n    $('.loginButton').prop('disabled', true);\n    $('.loginButton').addClass('disabled');\n\n    let username = $('.welcomeForm input[name=\"username\"]').val();\n    let password = $('.welcomeForm input[name=\"password\"]').val();\n    if (!password) {\n      password = username;\n    }\n\n    api.authBuddy(username, password, async (err, result) => {\n      console.log('authBuddy', err, result);\n      if (err) {\n        if (result && result.error) {\n          $('.loginStatus').html(result.error).addClass('error');\n          if (result.error === 'Incorrect password.') {\n            $('.resetPasswordLink').show();\n          }\n        } else {\n          if (err.message === 'Failed to fetch') {\n            $('.loginStatus').text('Failed to connect to Buddy Pond');\n          } else {\n            $('.loginStatus').html(err.message || 'Failed to authenticate buddy');\n          }\n        }\n        $('.loginButton').prop('disabled', false);\n        $('.loginButton').removeClass('disabled');\n\n        $('.password').show().focus();\n        console.error('Failed to authenticate buddy:', err);\n\n        return;\n      }\n      if (result.success) {\n        // attempt to connect for events after getting auth token\n        //console.log('connecting with valid qtokenid', api.qtokenid);\n        result.me = username;\n        await this.bp.open('buddylist');\n        // The user has logged in password or signed up successfully, emit the auth event\n        bp.emit('auth::qtoken', result);\n        this.win.close();\n        // $('.loggedIn').flexShow();\n        $('.welcomeForm .error').text('');\n\n      } else {\n        // re-enable the login button\n        $('.loginButton').prop('disabled', false);\n        $('.loginButton').removeClass('disabled');\n        if (username === password) {\n          $('.password').show();\n          $('.password').focus();\n          return;\n        }\n        $('.welcomeForm .error').text('Failed to authenticate buddy');\n        $('.password').show();\n        console.error('Failed to authenticate buddy:');\n      }\n    });\n    return false;\n  });\n\n  $('.onlineStatusSelect').change((e) => {\n    let status = $(e.target).val();\n    // console.log('status', status);\n    bp.emit('profile::status', status);\n  });\n\n  $('.forgot-password').on('click', (ev) => {\n    ev.preventDefault();\n    $('.welcomeForm').flexHide();\n    $('.forgot-password-modal').flexShow();\n    $('.welcome-tos-checkbox').flexHide();\n    $('.loginStatus').html('');\n    $('.resetPasswordLink').flexHide();\n    return false;\n  });\n\n  $('.closeForgotPassword').on('click', (ev) => {\n    $('.forgot-password-modal').flexHide();\n    $('.welcomeForm').flexShow();\n    $('.welcome-tos-checkbox').flexShow();\n    $('.resetPasswordLink').flexShow();\n  });\n\n  $('.resetPasswordButton').on('click', (ev) => {\n    ev.preventDefault();\n    let email = $('.resetPasswordEmail').val();\n    if (!email) {\n      $('.resetPasswordEmail').addClass('error');\n      return;\n    }\n    $('.resetPasswordEmail').removeClass('error');\n    $('.loginStatus').html('Sending password reset email...');\n    $('.resetPasswordForm').flexHide();\n    $('.resetPasswordMessage').flexHide();\n    api.sendPasswordResetEmail(email, (err, data) => {\n      // console.log('sendPasswordResetEmail', err, data);\n      if (err || !data.success) {\n        $('.loginStatus').html('Failed to send password reset email.');\n        console.error(err || data);\n        return;\n      }\n      $('.loginStatus').removeClass('error').addClass('success').html(data.message);\n    });\n  });\n\n  // Initially disable the login button\n  $('.loginButton').prop('disabled', true);\n  $('.loginButton').addClass('disabled');\n\n  // Toggle the login button based on the checkbox status\n  $('#welcome-tosAgree').change(function () {\n    if ($(this).is(':checked')) {\n      $('.loginButton').prop('disabled', false);\n      $('.loginButton').removeClass('disabled');\n    } else {\n      $('.loginButton').prop('disabled', true);\n      $('.loginButton').addClass('disabled');\n    }\n  });\n\n  function updatePositiveAffirmation() {\n    let key = affirmations[Math.floor(Math.random() * affirmations.length)];\n    $('.welcome-positiveAffirmation').html(key);\n  }\n\n  // update the positive affirmation on an interval\n  if (this.positiveAffirmationInterval) {\n    clearInterval(this.positiveAffirmationInterval);\n  }\n  \n  this.positiveAffirmationInterval = setInterval(function () {\n    $('.welcome-positiveAffirmation').fadeOut({\n      duration: 4444,\n      complete: function () {\n        updatePositiveAffirmation();\n        $('.welcome-positiveAffirmation').fadeIn({\n          duration: 4444,\n          complete: function () { }\n        });\n      }\n    });\n  }, 199800); // 3 minutes, 33 seconds\n\n  updatePositiveAffirmation();\n\n  $('.welcome-positiveAffirmation').on('click', function () {\n    updatePositiveAffirmation();\n  });\n\n\n}","export default function handleAuthentication() {\n        const api = this.bp.apps.client.api;\n        const localToken = localStorage.getItem('qtokenid');\n        const me = localStorage.getItem('me');\n        if (!localToken) {\n            $('#welcome').show();\n            return;\n        };\n        // console.log('localToken', localToken, me);\n        api.verifyToken(me, localToken, async (err, data) => {\n            if (err) {\n                console.error('Failed to verify token:', err);\n                $('.password').show();\n                $('.loginForm .error').text('Failed to authenticate buddy');\n                return;\n            }\n            console.log('verified token', data);\n            if (data.success) {\n                await this.bp.open('buddylist');\n                // A pre-existing token was found and verified, emit the auth event\n                this.bp.emit('auth::qtoken', { qtokenid: localToken, me: me, hasPassword: data.user.hasPassword });\n                $('.loggedIn').flexShow();\n                $('.loggedOut').flexHide();\n                if (!data.user.hasPassword) {\n                    this.bp.open('pincode');\n                }\n                // close the welcome window\n                this.win.close();\n            } else {\n                $('.loginForm .error').text('Failed to authenticate buddy');\n                $('.password').show();\n                console.error('Failed to authenticate buddy:');\n            }\n        });\n\n    }"],"names":["Welcome","constructor","bp","options","this","init","html","load","affirmations","importModule","open","win","window","$","content","hide","show","bindUIEvents","handleAuthentication","focus","id","title","icon","position","parent","width","height","resizable","closable","onClose","onResize","board","resize","prototype","console","log","api","apps","client","updatePositiveAffirmation","key","Math","floor","random","length","submit","e","preventDefault","prop","addClass","username","val","password","authBuddy","async","err","result","error","message","text","removeClass","success","me","emit","close","change","status","target","on","ev","flexHide","flexShow","email","sendPasswordResetEmail","data","is","positiveAffirmationInterval","clearInterval","setInterval","fadeOut","duration","complete","fadeIn","localToken","localStorage","getItem","verifyToken","qtokenid","hasPassword","user"],"mappings":"AAEe,MAAMA,EACjB,WAAAC,CAAYC,EAAIC,EAAU,IAGtB,OAFAC,KAAKF,GAAKA,EACVE,KAAKD,QAAUA,EACRC,IACf,CAEI,UAAMC,GAKF,OAJAD,KAAKE,WAAaF,KAAKF,GAAGK,KAAK,6CACzBH,KAAKF,GAAGK,KAAK,sCACnBH,KAAKI,mBAAqBJ,KAAKF,GAAGO,aAAa,gBAExC,gBACf,CAEI,UAAMC,GAEFN,KAAKO,UAAYP,KAAKF,GAAGU,OAAOR,KAAKQ,UAErCC,EAAE,YAAaT,KAAKO,IAAIG,SAASC,OACjCF,EAAE,aAAcT,KAAKO,IAAIG,SAASE,OAElCZ,KAAKa,eAELb,KAAKc,uBAGLL,EAAE,sCAAuCT,KAAKO,IAAIG,SAASK,OAEnE,CAEK,MAAAP,GACG,MAAO,CACHQ,GAAI,UACJC,MAAO,gBACPC,KAAM,qDACNC,SAAU,SACVC,OAAQX,EAAE,YAAY,GACtBY,MAAO,IACPC,OAAQ,IACRZ,QAASV,KAAKE,KACdqB,WAAW,EACXC,UAAU,EACVC,QAAS,KACLzB,KAAKO,IAAM,MAEfmB,SAAU,KACF1B,KAAK2B,OACL3B,KAAK2B,MAAMC,UAI/B,EAGAhC,EAAQiC,UAAUhB,aCzDH,WACXiB,QAAQC,IAAI,SAAU/B,MACxB,IAAIgC,EAAMhC,KAAKF,GAAGmC,KAAKC,OAAOF,IAC1B5B,EAAeJ,KAAKF,GAAGmC,KAAK7B,aAAaA,aA+H7C,SAAS+B,IACP,IAAIC,EAAMhC,EAAaiC,KAAKC,MAAMD,KAAKE,SAAWnC,EAAaoC,SAC/D/B,EAAE,gCAAgCP,KAAKkC,EAC3C,CA/HE3B,EAAE,gBAAgBgC,QAAQC,IACxBA,EAAEC,iBAGFlC,EAAE,gBAAgBmC,KAAK,YAAY,GACnCnC,EAAE,gBAAgBoC,SAAS,YAE3B,IAAIC,EAAWrC,EAAE,uCAAuCsC,MACpDC,EAAWvC,EAAE,uCAAuCsC,MAqDxD,OApDKC,IACHA,EAAWF,GAGbd,EAAIiB,UAAUH,EAAUE,GAAUE,MAAOC,EAAKC,KAE5C,GADAtB,QAAQC,IAAI,YAAaoB,EAAKC,GAC1BD,EAmBF,OAlBIC,GAAUA,EAAOC,OACnB5C,EAAE,gBAAgBP,KAAKkD,EAAOC,OAAOR,SAAS,SACzB,wBAAjBO,EAAOC,OACT5C,EAAE,sBAAsBG,QAGN,oBAAhBuC,EAAIG,QACN7C,EAAE,gBAAgB8C,KAAK,mCAEvB9C,EAAE,gBAAgBP,KAAKiD,EAAIG,SAAW,gCAG1C7C,EAAE,gBAAgBmC,KAAK,YAAY,GACnCnC,EAAE,gBAAgB+C,YAAY,YAE9B/C,EAAE,aAAaG,OAAOG,aACtBe,QAAQuB,MAAM,gCAAiCF,GAIjD,GAAIC,EAAOK,QAGTL,EAAOM,GAAKZ,QACN9C,KAAKF,GAAGQ,KAAK,aAEnBR,GAAG6D,KAAK,eAAgBP,GACxBpD,KAAKO,IAAIqD,QAETnD,EAAE,uBAAuB8C,KAAK,QAEzB,CAIL,GAFA9C,EAAE,gBAAgBmC,KAAK,YAAY,GACnCnC,EAAE,gBAAgB+C,YAAY,YAC1BV,IAAaE,EAGf,OAFAvC,EAAE,aAAaG,YACfH,EAAE,aAAaM,QAGjBN,EAAE,uBAAuB8C,KAAK,gCAC9B9C,EAAE,aAAaG,OACfkB,QAAQuB,MAAM,gCACtB,MAEW,KAGT5C,EAAE,uBAAuBoD,QAAQnB,IAC/B,IAAIoB,EAASrD,EAAEiC,EAAEqB,QAAQhB,MAEzBjD,GAAG6D,KAAK,kBAAmBG,MAG7BrD,EAAE,oBAAoBuD,GAAG,SAAUC,IACjCA,EAAGtB,iBACHlC,EAAE,gBAAgByD,WAClBzD,EAAE,0BAA0B0D,WAC5B1D,EAAE,yBAAyByD,WAC3BzD,EAAE,gBAAgBP,KAAK,IACvBO,EAAE,sBAAsByD,YACjB,KAGTzD,EAAE,wBAAwBuD,GAAG,SAAUC,IACrCxD,EAAE,0BAA0ByD,WAC5BzD,EAAE,gBAAgB0D,WAClB1D,EAAE,yBAAyB0D,WAC3B1D,EAAE,sBAAsB0D,cAG1B1D,EAAE,wBAAwBuD,GAAG,SAAUC,IACrCA,EAAGtB,iBACH,IAAIyB,EAAQ3D,EAAE,uBAAuBsC,MAChCqB,GAIL3D,EAAE,uBAAuB+C,YAAY,SACrC/C,EAAE,gBAAgBP,KAAK,mCACvBO,EAAE,sBAAsByD,WACxBzD,EAAE,yBAAyByD,WAC3BlC,EAAIqC,uBAAuBD,GAAO,CAACjB,EAAKmB,KAEtC,GAAInB,IAAQmB,EAAKb,QAGf,OAFAhD,EAAE,gBAAgBP,KAAK,6CACvB4B,QAAQuB,MAAMF,GAAOmB,GAGvB7D,EAAE,gBAAgB+C,YAAY,SAASX,SAAS,WAAW3C,KAAKoE,EAAKhB,aAdrE7C,EAAE,uBAAuBoC,SAAS,YAmBtCpC,EAAE,gBAAgBmC,KAAK,YAAY,GACnCnC,EAAE,gBAAgBoC,SAAS,YAG3BpC,EAAE,qBAAqBoD,QAAO,WACxBpD,EAAET,MAAMuE,GAAG,aACb9D,EAAE,gBAAgBmC,KAAK,YAAY,GACnCnC,EAAE,gBAAgB+C,YAAY,cAE9B/C,EAAE,gBAAgBmC,KAAK,YAAY,GACnCnC,EAAE,gBAAgBoC,SAAS,YAEjC,IAQM7C,KAAKwE,6BACPC,cAAczE,KAAKwE,6BAGrBxE,KAAKwE,4BAA8BE,aAAY,WAC7CjE,EAAE,gCAAgCkE,QAAQ,CACxCC,SAAU,KACVC,SAAU,WACR1C,IACA1B,EAAE,gCAAgCqE,OAAO,CACvCF,SAAU,KACVC,SAAU,WAAY,GAEhC,GAEG,GAAE,QAEH1C,IAEA1B,EAAE,gCAAgCuD,GAAG,SAAS,WAC5C7B,GACJ,GAGA,EDtGAvC,EAAQiC,UAAUf,qBE1DH,WACP,MAAMkB,EAAMhC,KAAKF,GAAGmC,KAAKC,OAAOF,IAC1B+C,EAAaC,aAAaC,QAAQ,YAClCvB,EAAKsB,aAAaC,QAAQ,MAC3BF,EAKL/C,EAAIkD,YAAYxB,EAAIqB,GAAY7B,MAAOC,EAAKmB,KACxC,GAAInB,EAIA,OAHArB,QAAQuB,MAAM,0BAA2BF,GACzC1C,EAAE,aAAaG,YACfH,EAAE,qBAAqB8C,KAAK,gCAGhCzB,QAAQC,IAAI,iBAAkBuC,GAC1BA,EAAKb,eACCzD,KAAKF,GAAGQ,KAAK,aAEnBN,KAAKF,GAAG6D,KAAK,eAAgB,CAAEwB,SAAUJ,EAAYrB,GAAIA,EAAI0B,YAAad,EAAKe,KAAKD,cACpF3E,EAAE,aAAa0D,WACf1D,EAAE,cAAcyD,WACXI,EAAKe,KAAKD,aACXpF,KAAKF,GAAGQ,KAAK,WAGjBN,KAAKO,IAAIqD,UAETnD,EAAE,qBAAqB8C,KAAK,gCAC5B9C,EAAE,aAAaG,OACfkB,QAAQuB,MAAM,qCA1BlB5C,EAAE,YAAYG,MA8B1B"}