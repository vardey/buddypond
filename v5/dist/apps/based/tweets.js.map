{"version":3,"file":"tweets.js","sources":["../../../apps/based/tweets/lib/client.js","../../../apps/based/tweets/lib/wsclient.js","../../../apps/based/buddylist/lib/message/parseMarkdownWithoutPTags.js","../../../apps/based/buddylist/lib/message/checkForLinksInMessage.js","../../../apps/based/buddylist/lib/message/isValidUrl.js","../../../apps/based/buddylist/lib/message/isValidYoutubeLink.js","../../../apps/based/buddylist/lib/message/isValidGithubLink.js","../../../apps/based/tweets/lib/renderTweet.js","../../../apps/based/tweets/tweets.js","../../../apps/based/tweets/lib/eventBind.js","../../../apps/based/tweets/lib/render.js"],"sourcesContent":["const client = {};\n\n// client.endpoint = buddypond.adminEndpoint;\nclient.endpoint = 'http://192.168.200.59:9020';\n\nclient.apiRequest = async (uri, method = 'GET', data = null) => {\n\n    const options = {\n        method: method\n    };\n\n    let headers = {\n        \"Accept\": \"application/json\",\n        \"Content-Type\": \"application/json; charset=utf-8\",\n        \"X-Me\": buddypond.me\n      };\n      if (buddypond.qtokenid) {\n        headers[\"Authorization\"] = `Bearer ${buddypond.qtokenid}`; // ‚úÖ Use Authorization header\n      }\n\n\n    if (data) {\n        options.body = JSON.stringify(data);\n    }\n\n    options.headers = headers;\n\n    let url = `${client.endpoint}${uri}`;\n    console.log('tweets client making api request', url, options);\n \n\n    try {\n        const response = await fetch(url, options);\n        if (!response.ok) {\n          console.log('rrrr', response)\n          // get text from response\n          const errorText = await response.text();\n          throw new Error(errorText || response.statusText || 'API request failed');\n            //throw new Error(response.statusText || 'API request failed');\n        }\n        return await response.json();\n    } catch (error) {\n        console.error('Error in API request:', error);\n        throw error;\n    }\n\n};\n\nexport default client;","export default class TweetsWebSocketClient {\n  constructor({ endpoint, bp }) {\n    this.endpoint = buddypond.tweetsWsEndpoint;\n    this.bp = bp;\n\n    this.ws = null;\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 5;\n    this.maxBackoffDelay = 10000; // 10 seconds\n    this.isIntentionallyClosed = false;\n  }\n\n  async connect() {\n    const url = `${this.endpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`;\n    console.log(`üîå Connecting to Tweets...`);\n\n    return new Promise((resolve, reject) => {\n      const ws = new WebSocket(url);\n\n      const onOpen = () => {\n        console.log('‚úÖ WebSocket connected to Tweets');\n        this.reconnectAttempts = 0;\n        this.ws = ws;\n\n        this.bp?.emit('tweets::connected');\n        resolve(this);\n      };\n\n      const onMessage = (event) => {\n        let data;\n        try {\n          data = JSON.parse(event.data);\n        } catch (err) {\n          console.error('‚ùå Failed to parse message:', event.data);\n          this.bp?.emit('tweets::error', { error: 'Invalid JSON', raw: event.data });\n          return;\n        }\n\n        // üîß Add support for custom actions later\n        console.log('üì¨ Message received from Tweets:', data);\n\n        let action = data.action;\n        let error = data.error;\n        if (error) {\n          console.error('‚ùå Error from Tweets:', error);\n          this.bp?.emit('tweets::error', { error });\n          return;\n        }\n\n        switch (action) {\n            case 'tweetsFeed':\n                console.log('Tweets feed received:', data.tweets);\n                this.bp?.emit('tweets::feed', data.tweets);\n                break;\n\n                case 'removedTweet':\n                  console.log('Tweet removed:', data.postId);\n                  this.bp?.emit('tweets::removed', data.postId);\n                  break;\n        }\n\n        // this.bp?.emit('tweets::message', { pondId: this.pondId, message: data });\n      };\n\n      const onClose = (event) => {\n        console.warn(`‚ö†Ô∏è WebSocket closed [${event.code}]: ${event.reason}`);\n\n        this.bp?.emit('tweets::disconnected', {\n          pondId: this.pondId,\n          code: event.code,\n          reason: event.reason,\n        });\n\n        if (!this.isIntentionallyClosed && this.reconnectAttempts < this.maxReconnectAttempts) {\n          const delay = Math.min(\n            200 * Math.pow(2, this.reconnectAttempts) * (1 + 0.1 * Math.random()),\n            this.maxBackoffDelay\n          );\n          console.log(`‚è≥ Reconnecting in ${Math.floor(delay)}ms...`);\n          setTimeout(() => {\n            this.reconnectAttempts++;\n            this.connect().catch(() => {});\n            this.bp?.emit('tweets::reconnecting', { attempt: this.reconnectAttempts });\n          }, delay);\n        } else {\n          if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n            console.error('‚ùå Max reconnect attempts reached. Giving up.');\n            this.bp?.emit('tweets::reconnect_failed', { pondId: this.pondId });\n          }\n        }\n      };\n\n      const onError = (event) => {\n        console.error('‚ùå WebSocket error:', event);\n        this.bp?.emit('tweets::error', { error: 'WebSocket error', event });\n        ws.close(1000, 'Error occurred');\n        reject(new Error('WebSocket connection failed'));\n      };\n\n      // Attach handlers\n      ws.addEventListener('open', onOpen);\n      ws.addEventListener('message', onMessage);\n      ws.addEventListener('close', onClose);\n      ws.addEventListener('error', onError);\n\n      // Store methods for teardown\n      this._teardown = () => {\n        ws.removeEventListener('open', onOpen);\n        ws.removeEventListener('message', onMessage);\n        ws.removeEventListener('close', onClose);\n        ws.removeEventListener('error', onError);\n      };\n    });\n  }\n\n  disconnect() {\n    if (this.ws) {\n      this.isIntentionallyClosed = true;\n      this._teardown?.();\n      this.ws.close(1000, 'Normal closure');\n      this.bp?.emit('tweets::closed', { pondId: this.pondId });\n      this.ws = null;\n      console.log('üõë WebSocket disconnected from Tweets');\n    }\n  }\n\n  send(data) {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      const msg = typeof data === 'string' ? data : JSON.stringify(data);\n      this.ws.send(msg);\n    } else {\n      console.warn('‚ö†Ô∏è Tried to send message but WebSocket is not open');\n    }\n  }\n\n\n  async fetchTweets (context) {\n    console.log('Requesting tweets feed from server...', context);\n     // sends a listActivePonds action message to the server\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.send({ action: 'fetchTweets', authorId: context });\n    } else {\n      console.warn('‚ö†Ô∏è Tried to get tweets feed but WebSocket is not open');\n    }\n\n  }\n\n  async postTweet ({ content }) {\n    console.log('Posting new tweet to server...');\n     // sends a listActivePonds action message to the server\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.send({ action: 'postTweet', content });\n    } else {\n      console.warn('‚ö†Ô∏è Tried to post tweet but WebSocket is not open');\n    }\n  }\n\n  async likeTweet ({ tweetId }) {\n    console.log('Liking tweet on server...');\n     // sends a listActivePonds action message to the server\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.send({ action: 'likeTweet', tweetId });\n    } else {\n      console.warn('‚ö†Ô∏è Tried to like tweet but WebSocket is not open');\n    }\n  }\n\n  async deleteTweet (tweetId) {\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.send({ action: 'deleteTweet', tweetId });\n    } else {\n      console.warn('‚ö†Ô∏è Tried to delete tweet but WebSocket is not open');\n    }\n  }\n\n\n}","// Function to remove outer <p> tags\nexport default function parseMarkdownWithoutPTags(markdown) {\n  if (!markdown) return ''; // empty text\n\n\n  if (isEmojiOnly(markdown)) {\n    return renderBigEmojiHTML(markdown);\n  }\n\n  // Supported colors and styles\n  const supportedColors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'black', 'white', 'gray', 'cyan', 'magenta', 'pink'];\n  const supportedStyles = ['bold', 'italic', 'underline', 'strike', 'blink', 'reverse', 'hidden', 'dim', 'rainbow'];\n\n  // Custom renderer for links to add target=\"_blank\"\n  const linkExtension = {\n    name: 'link',\n    level: 'inline',\n    renderer(token) {\n      // Ensure href is properly encoded\n      const href = token.href.replace(/\"/g, '&quot;');\n      // Add target=\"_blank\" and rel=\"noopener\" for security\n      return `<a href=\"${href}\" target=\"_blank\" rel=\"noopener\">${this.parser.parseInline(token.tokens)}</a>`;\n    }\n  };\n\n  const styleExtension = {\n    name: 'style',\n    level: 'inline',\n\n    tokenizer(src) {\n      const match = /^((?:\\w+\\.)*\\w+)\\(\\s*([\\s\\S]+?)\\s*\\)/.exec(src);\n      if (match) {\n        const raw = match[0];\n        const modifiers = match[1].split('.');\n        const text = match[2];\n\n        const isValid = modifiers.every(mod => supportedColors.includes(mod) || supportedStyles.includes(mod));\n        if (!isValid) return;\n\n        return {\n          type: 'style',\n          raw,\n          modifiers,\n          text,\n          tokens: this.lexer.inlineTokens(text)\n        };\n      }\n    },\n    renderer(token) {\n      let content = this.parser.parseInline(token.tokens);\n\n      // Apply modifiers in reverse order to maintain proper nesting\n      token.modifiers.reverse().forEach(mod => {\n        if (supportedColors.includes(mod)) {\n          content = `<span class=\"message-decoration-color-${mod}\">${content}</span>`;\n        } else if (mod === 'bold') {\n          content = `<strong class=\"message-decoration-bold\">${content}</strong>`;\n        } else if (mod === 'italic') {\n          content = `<em class=\"message-decoration-italic\">${content}</em>`;\n        } else if (mod === 'underline') {\n          content = `<u class=\"message-decoration-underline\">${content}</u>`;\n        } else if (mod === 'strike') {\n          content = `<s class=\"message-decoration-strike\">${content}</s>`;\n        } else if (mod === 'blink') {\n          content = `<span class=\"message-decoration-blink\">${content}</span>`;\n        } else if (mod === 'reverse') {\n          content = content.split('').reverse().join('');\n        } else if (mod === 'hidden') {\n          content = `<span class=\"message-decoration-hidden\">${content}</span>`;\n        } else if (mod === 'dim') {\n          content = `<span class=\"message-decoration-dim\">${content}</span>`;\n        } else if (mod === 'rainbow') {\n          content = `<span class=\"message-decoration-rainbow\">${content}</span>`;\n        }\n      });\n\n      return content;\n    },\n\n\n    walkTokens(token) {\n      if (token.type === 'style') {\n        console.log(`Detected style token: ${token.modifiers.join('.')}`);\n      }\n    }\n  };\n\n  marked.use({ extensions: [styleExtension, linkExtension] });\n\n  let html;\n  try {\n    html = marked.parse(markdown);\n  } catch (error) {\n    html = markdown;\n  }\n\n  // register the hook once at module init\n  if (!DOMPurify.__added_anchor_hook) {\n    DOMPurify.addHook('afterSanitizeAttributes', function (node) {\n      // only run for <a>\n      if (node.tagName && node.tagName.toLowerCase() === 'a') {\n        const href = node.getAttribute('href') || '';\n\n        // Validate URL scheme (same rules as ALLOWED_URI_REGEXP)\n        try {\n          const url = new URL(href, 'https://example.com'); // base for relative URLs\n          if (!/^(https?:|mailto:|tel:)/i.test(url.protocol)) {\n            // Disallow link entirely (or remove href)\n            node.removeAttribute('href');\n            node.removeAttribute('target');\n            node.removeAttribute('rel');\n            return;\n          }\n        } catch (e) {\n          // malformed -> remove\n          node.removeAttribute('href');\n          node.removeAttribute('target');\n          node.removeAttribute('rel');\n          return;\n        }\n\n        // Ensure anchors open safely in a new tab\n        // We force _blank and ensure rel contains noopener noreferrer\n        node.setAttribute('target', '_blank');\n\n        const existing = (node.getAttribute('rel') || '').split(/\\s+/).filter(Boolean);\n        if (!existing.includes('noopener')) existing.push('noopener');\n        if (!existing.includes('noreferrer')) existing.push('noreferrer');\n        node.setAttribute('rel', existing.join(' '));\n      }\n    });\n    DOMPurify.__added_anchor_hook = true;\n  }\n\n  // sanitize: allow the tags/attrs you need, and restrict allowed URI schemes\n  const clean = DOMPurify.sanitize(html, {\n    ALLOWED_TAGS: [\n      'a', 'span', 'strong', 'em', 'u', 's', 'div', 'br', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',\n      'ul', 'ol', 'li', 'code', 'pre', 'blockquote', 'img'\n    ],\n    ALLOWED_ATTR: [\n      'href', 'target', 'rel', 'class', 'data-char-index', 'src'\n    ],\n    FORCE_BODY: true,\n    KEEP_CONTENT: true,\n    SANITIZE_DOM: true,\n    // RETURN_TRUSTED_TYPE: true, // progressive support for supporting Trusted Types, works when available\n    // this will return DOM if supported, otherwise returns string, TODO: would need to handle both cases\n    // allow only http(s), mailto, tel for href/src\n    ALLOWED_URI_REGEXP: /^(?:(https?|mailto|tel):|\\/)/i\n  });\n\n  return clean.replace(/^<p>(.*?)<\\/p>\\s*$/s, '$1');\n  // Explanation:\n  // ^<p>       ‚Üí Matches the opening <p> at the start\n  // (.*?)      ‚Üí Captures the content inside (non-greedy)\n  // <\\/p>\\s*$  ‚Üí Matches the closing </p> with optional trailing whitespace\n  // $1         ‚Üí Returns only the captured content\n}\n\n// Shared helper: Split emoji-aware graphemes\nfunction splitEmojiGraphemes(text) {\n  const splitter = new GraphemeSplitter();\n  return splitter.splitGraphemes(text.trim());\n}\n\n// Strip variation selector (U+FE0F) for matching against EMOJIS\nfunction normalizeEmoji(str) {\n  return str.replace(/\\uFE0F/g, '');\n}\n\nfunction isEmojiOnly(text) {\n  if (!text) return false;\n\n  // if text is longer than 7 length, return false immediately\n  if (text.length > 7) return false;\n\n  const graphemes = splitEmojiGraphemes(text);\n  const emojiList = new Set(Object.keys(EMOJIS));\n\n  const emojis = graphemes.filter(g =>\n    emojiList.has(g) || emojiList.has(normalizeEmoji(g))\n  );\n\n  return emojis.length > 0 &&\n    emojis.length <= 7 &&\n    emojis.join('') === text.trim();\n}\n\n// Render big emoji HTML\nfunction renderBigEmojiHTML(text) {\n  const graphemes = splitEmojiGraphemes(text);\n  return `<div class=\"emoji-only\">` +\n    graphemes.map(g => `<span class=\"big-emoji\">${g}</span>`).join('') +\n    `</div>`;\n}","// TODO: move all this app specific code *outside* of the buddylist / renderMessage\n// use the system.addMessageProcessor() API instead\n\nimport isValidUrl from './isValidUrl.js';\nimport isValidYoutubeLink from './isValidYoutubeLink.js';\nimport isValidGithubLink from './isValidGithubLink.js';\n\nexport default function checkForLinksInMessage(message) {\n  const text = message.text || message.content || '';\n\n  // Basic URL regex ‚Äî matches http(s) links\n  const urlRegex = /https?:\\/\\/(?:[^\\s()<>\\[\\]{}\"']+|\\([^\\s()]*?\\))+/gi;\n  let match = text.match(urlRegex);\n  // match = [message.text];\n\n  if (match && isValidUrl(match[0])) {\n    let contentUrl = match[0];\n    // console.log('Found URL in message:', contentUrl);\n    message.card = {\n      url: contentUrl,\n      type: 'website',\n    };\n\n    // Determine file type from extension (ignoring query strings and hashes)\n    try {\n      const urlObj = new URL(contentUrl);\n      const pathname = urlObj.pathname; // just \"/image.png\" part\n      const ext = pathname.split('.').pop().toLowerCase();\n      if (ext) {\n        if (buddypond.supportedImageTypesExt.includes(ext)) {\n          message.card.type = 'image';\n        } else if (buddypond.supportedAudioTypesExt.includes(ext)) {\n          message.card.type = 'audio';\n        } else if (buddypond.supportedVideoTypesExt.includes(ext)) {\n          message.card.type = 'video';\n        }\n      }\n    } catch (err) {\n      console.warn(\"Invalid URL:\", contentUrl, err);\n    }\n\n    // YouTube link handling\n    if (isValidYoutubeLink(contentUrl)) {\n      const videoId = new URL(contentUrl).searchParams.get('v');\n      if (videoId) {\n        message.card.type = 'youtube';\n        message.card.thumbnail = `https://img.youtube.com/vi/${videoId}/0.jpg`;\n        message.card.context = videoId;\n      }\n    }\n\n    // GitHub link handling\n    if (isValidGithubLink(contentUrl)) {\n      message.card.type = 'github';\n      const githubRegex = /^https?:\\/\\/github\\.com\\/([^\\/]+)\\/([^\\/]+)\\/blob\\/([^\\/]+)\\/(.+)$/;\n      const match = contentUrl.match(githubRegex);\n      if (match) {\n        message.card.owner = match[1];\n        message.card.repo = match[2];\n        message.card.filename = match[4];\n      } else {\n        console.error(\"Invalid GitHub URL format.\");\n      }\n    }\n  }\n}\n","export default function isValidUrl(messageText) {\n    if (!messageText) return false;\n  \n    messageText = messageText.trim(); // Trim whitespace from both ends\n  \n    try {\n      const url = new URL(messageText);\n  \n      // Ensure the URL has http or https protocol\n      if (url.protocol === \"http:\" || url.protocol === \"https:\") {\n        // console.log('This is a valid URL:', url.href);\n        return true;\n      }\n  \n      return false; // Invalid if protocol is not http or https\n    } catch (error) {\n      return false; // If an error is thrown, it's not a valid URL\n    }\n  }","export default function checkIsValidYoutubeLink(url) {\n    const regex = /(?:youtube\\.com\\/(?:[^\\/]+\\/.+\\/|(?:v|e(?:mbed)?)\\/|.*[?&]v=)|youtu\\.be\\/)([^\"&?\\/\\s]{11})/;\n    const match = url.match(regex);\n    return match ? match[1] : null; // Return video ID or null\n}\n","export default function isValidGithubLink(url) {\n    const regex = /^https?:\\/\\/github\\.com\\/([^\\/]+)\\/([^\\/]+)\\/blob\\/([^\\/]+)\\/(.+)$/;\n    const match = url.match(regex);\n    return match ? match.slice(1) : null; \n    // Returns [owner, repo, branch, filePath] or null\n}\n","import parseMarkdownWithoutPTags from '../../buddylist/lib/message/parseMarkdownWithoutPTags.js';\nimport checkForLinksInMessage from '../../buddylist/lib/message/checkForLinksInMessage.js';\n\nexport default async function renderTweet(tweet, tweetsWindow, options = {}) {\n  let showReplyButton = true;\n  let replyButton = ``;\n  let deleteButton = ``;\n  let likeButton = `<a href=\"#\" class=\"tweets-like\" data-id=\"${tweet.id}\">Like (${tweet.like_count || 0})</a>`;\n\n  // Check if tweet already exists in DOM\n  let existingTweet = $(`[data-tweet=\"${tweet.id}\"]`, tweetsWindow.content);\n  if (options.noRender !== true && existingTweet.length > 0) {\n    // --- Differential update ---\n    existingTweet.attr('data-likes', tweet.like_count || 0);\n    existingTweet.attr('data-replies', tweet.reply_count || 0);\n\n    $('.tweets-like', existingTweet).html(`Like (${tweet.like_count || 0})`);\n    $('.tweets-reply', existingTweet).html(`Reply (${tweet.reply_count || 0})`);\n\n    // console.log('Updating existing tweet:', tweet);\n\n    // Normalize text and run link detection (keep same parsing pipeline as new render)\n    tweet.text = tweet.content || '';\n    checkForLinksInMessage(tweet);\n    tweet.text = parseMarkdownWithoutPTags(tweet.text);\n\n    // update content in case it changed (edits)\n    if (!tweet.card) {\n      $('.tweets-content', existingTweet).html(tweet.text);\n    }\n\n    $('.tweets-meta', existingTweet).html(new Date(tweet.ctime).toLocaleString());\n\n    // --- Handle card rendering for updates ---\n    try {\n      // Remove any previous card containers so we replace them\n      existingTweet.find('.cardContainer').remove();\n\n      const cardContainer = await renderCardForTweet(tweet, existingTweet, this.bp);\n      if (cardContainer) {\n        $('.tweets-content', existingTweet).append(cardContainer);\n      }\n    } catch (err) {\n      // Already logged inside helper; keep UI stable\n      console.error('Failed to update card for tweet', tweet && tweet.id, err);\n    }\n\n    // --- Handle replies differential update ---\n    if (options.noRender !== true && tweet.replies && tweet.replies.length > 0) {\n      let repliesContainer = existingTweet.children('.tweets-replies');\n      if (repliesContainer.length === 0) {\n        repliesContainer = $('<div class=\"tweets-replies\"></div>');\n        existingTweet.append(repliesContainer);\n      }\n\n      // Render replies (differentially)\n      const seenReplies = new Set();\n      tweet.replies.forEach(async reply => {\n        seenReplies.add(reply.id);\n        const replyHtml = await this.renderTweet(reply, tweetsWindow, options);\n        if (replyHtml) {\n          repliesContainer.append(replyHtml);\n        }\n      });\n\n      // Remove replies that no longer exist\n      repliesContainer.children('[data-tweet]').each((_, el) => {\n        const replyId = $(el).attr('data-tweet');\n        if (!seenReplies.has(replyId)) {\n          $(el).remove();\n        }\n      });\n    }\n\n    return ''; // stop here, already updated DOM\n  }\n\n  // --- New Tweet ---\n  if (!tweet.parent_id) {\n    replyButton = `<a href=\"#\" class=\"tweets-reply\" data-id=\"${tweet.id}\">Reply (${tweet.reply_count || 0})</a>`;\n  }\n\n  if (tweet.author === this.bp.me || this.bp.me === 'Marak') {\n    deleteButton = `<a href=\"#\" class=\"tweets-delete\" data-id=\"${tweet.id}\">Delete</a>`;\n  }\n\n  if (options.noToolbar) {\n    replyButton = ``;\n    deleteButton = ``;\n    likeButton = ``;\n  }\n\n  let $tweet = $(`\n  <div class=\"tweets-post desktop-section\" data-tweet=\"${tweet.id}\" data-likes=\"${tweet.like_count || 0}\" data-replies=\"${tweet.reply_count || 0}\">\n    <div class=\"tweets-author\">\n      <a href=\"#\" class=\"open-app\" data-app=\"tweets\" data-context=\"${tweet.author}\">\n        @${tweet.author}\n      </a>\n    </div>\n    <div class=\"tweets-content\"></div>\n    <div class=\"tweets-meta\"></div>\n    <div class=\"tweets-toolbar\">\n      ${likeButton}\n      ${replyButton}\n      ${deleteButton}\n    </div>\n  </div>\n`);\n\n  // safely insert user content\n  // this will render through the markdown parser + DOMPurify code path\n  tweet.text = tweet.content || '';\n  checkForLinksInMessage(tweet);\n  tweet.text = parseMarkdownWithoutPTags(tweet.text);\n\n  let container = null;\n  if (tweet.card && this.bp && this.bp.apps && this.bp.apps.card) {\n    // console.log('tweet has card', tweet.card);\n    try {\n      container = await renderCardForTweet(tweet, $tweet, this.bp);\n      // console.log('Rendering card into container', container);\n    } catch (err) {\n      console.error('Error while rendering card for new tweet', tweet && tweet.id, err);\n      container = null;\n    }\n  }\n\n  // console.log('Rendering tweet:', tweet);\n  // console.log('With card container:', container);\n\n  // update content in case it changed (edits)\n  if (!tweet.card) {\n    $('.tweets-content', $tweet).html(tweet.text);\n  }\n\n  if (container) {\n    $('.tweets-content', $tweet).append(container);\n  }\n  $('.tweets-meta', $tweet).text(new Date(tweet.ctime).toLocaleString());\n\n  // append replies if any\n  if (options.noRender !== true && tweet.replies && tweet.replies.length > 0) {\n    let $replies = $('<div class=\"tweets-replies\"></div>');\n    tweet.replies.forEach(async reply => {\n      $replies.append(await this.renderTweet(reply, tweetsWindow, options));\n    });\n    $tweet.append($replies);\n  }\n\n  return $tweet;\n}\n\nasync function renderCardForTweet(tweet, $tweet, bp) {\n  // Returns a DOM element (container) for the card, or null on no-card / error.\n  if (!tweet || !tweet.card || !bp || !bp.apps || !bp.apps.card) {\n    return null;\n  }\n\n  const cardData = tweet.card || {};\n  if (Object.keys(cardData).length === 0) {\n    return null;\n  }\n\n  try {\n    // Give the card context the tweet message\n    cardData.message = tweet;\n    const cardManager = bp.apps.card.cardManager;\n    // provide current $tweet HTML as the context (mirrors original behavior)\n    const _card = await cardManager.loadCard(cardData.type, cardData, $tweet.html());\n\n    const container = document.createElement('div');\n    container.classList.add('cardContainer');\n\n    // Render card into container (await if returns promise)\n    await _card.render(container);\n\n    return container;\n  } catch (err) {\n    console.error('Error rendering card for tweet', tweet && tweet.id, err);\n    return null;\n  }\n}\n","/* Tweets.js - Marak Squires 2025 - BuddyPond */\nimport client from './lib/client.js';\nimport wsClient from './lib/wsclient.js';\nimport eventBind from './lib/eventBind.js';\nimport render from './lib/render.js';\nimport renderTweet from './lib/renderTweet.js';\n\nexport default class Tweets {\n  constructor(bp, options = {}) {\n    this.bp = bp;\n    this.icon = 'desktop/assets/images/icons/icon_tweets_64.webp';\n    return this;\n  }\n\n  async init() {\n    this.html = await this.bp.load('/v5/apps/based/tweets/tweets.html');\n    await this.bp.load('/v5/apps/based/tweets/tweets.css');\n    return 'loaded tweets app';\n  }\n\n  async open(options = {}) {\n\n    if (!this.tweetsWindow) {\n      this.tweetsWindow = this.bp.apps.ui.windowManager.createWindow({\n        id: 'tweets',\n        title: 'Tweets',\n        icon: this.icon,\n        x: 250,\n        y: 75,\n        width: 800,\n        height: 400,\n        minWidth: 200,\n        minHeight: 200,\n        parent: $('#desktop')[0],\n        content: '',\n        resizable: true,\n        minimizable: true,\n        maximizable: true,\n        closable: true,\n        focusable: true,\n        maximized: false,\n        minimized: false,\n        onClose: () => {\n          if (this.wsClient) {\n            this.wsClient.disconnect();\n            this.wsClient = null;\n          }\n          // remove all event listeners\n          this.bp.off('tweets::connected', 'fetch-tweets-feed');\n          this.bp.off('tweets::feed', 'render-tweets-feed');\n          this.bp.off('tweets::removed', 'remove-tweet');\n          this.bp.off('tweets::error', 'tweets-error');\n          this.tweetsWindow = null\n          // remove tweets-reply-modal if exists\n          $('.tweets-reply-modal').remove();\n        }\n      });\n      this.tweetsWindow.loggedIn = true;\n    }\n\n    if (options.context === 'default' || !options.context || options.context === 'undefined') {\n      options.context = 'all';\n    }\n\n    let renderType = 'author';\n    if (options.type === 'post') {\n      renderType = 'post';\n    }\n\n    this.tweetsWindow.context = options.context || 'all';\n\n    if (!this.wsClient) {\n\n      this.wsClient = new wsClient({ bp: this.bp });\n      this.bp.on('tweets::connected', 'fetch-tweets-feed', (data) => {\n        // console.log('Tweets WebSocket connected event received in Tweets app', data);\n        console.log('Tweets WebSocket connected');\n        this.wsClient.fetchTweets(this.tweetsWindow.context);\n      });\n\n      this.bp.on('tweets::feed', 'render-tweets-feed', (tweets) => {\n        // console.log('Tweets feed event received in Tweets app', tweets);\n        if (this.tweetsWindow) {\n          this.render(tweets, this.tweetsWindow.context, 'author', this.tweetsWindow);\n        }\n      });\n\n      this.bp.on('tweets::removed', 'remove-tweet', (tweetId) => {\n        // console.log('Tweet removed event received in Tweets app', tweetId);\n        if (this.tweetsWindow) {\n          // find the tweet by tweetId and remove\n          $(`[data-tweet=\"${tweetId}\"]`, this.tweetsWindow.content).remove();\n          console.log('remove the tweet', tweetId);\n        }\n      });\n\n      this.bp.on('tweets::error', 'tweets-error', (error) => {\n        console.error('Tweets error event received in Tweets app', error);\n        if (this.tweetsWindow) {\n          const errorDiv = $('.tweets-error', this.tweetsWindow.content);\n          if (errorDiv) {\n            errorDiv.html(`<div class=\"error\">Error: ${error.error}</div>`);\n            setTimeout(() => {\n              errorDiv.html('');\n            }, 5000);\n          }\n        }\n      });\n\n      console.log('Connecting to Tweets WebSocket...');\n      await this.wsClient.connect();\n\n    } else {\n      // fetch tweets feed for current context\n      this.wsClient.fetchTweets(this.tweetsWindow.context);\n    }\n\n\n    $(this.tweetsWindow.content).html(this.html);\n\n    this.eventBind(options.context, renderType, this.tweetsWindow);\n\n    return this.tweetsWindow;\n  }\n\n}\n\nTweets.prototype.client = client;\nTweets.prototype.eventBind = eventBind;\nTweets.prototype.render = render;\nTweets.prototype.renderTweet = renderTweet;","// eventBind.js\nexport default function eventBind(context, renderType, tweetsWindow) {\n  const MAX_CHARS = 280;\n  const holder = $('.tweets-holder', tweetsWindow.content);\n\n  // --- Circular character counter setup ---\n  function setupCharCounter(inputEl, container) {\n    if (container.find('.tweets-char-count').length === 0) {\n      container.prepend(`\n        <div class=\"tweets-char-count\" title=\"Character count\">\n          <svg width=\"40\" height=\"40\">\n            <circle class=\"bg\" r=\"18\" cx=\"20\" cy=\"20\" stroke=\"#eee\" stroke-width=\"3\" fill=\"none\"/>\n            <circle class=\"progress\" r=\"18\" cx=\"20\" cy=\"20\" stroke=\"#1DA1F2\" stroke-width=\"3\" fill=\"none\"\n              stroke-dasharray=\"${2 * Math.PI * 18}\" stroke-dashoffset=\"${2 * Math.PI * 18}\"\n              stroke-linecap=\"round\"/>\n          </svg>\n        </div>\n      `);\n    }\n\n    const circle = container.find('.progress');\n    const radius = 18;\n    const circumference = 2 * Math.PI * radius;\n\n    inputEl.on('input', () => {\n      const len = inputEl.val().length;\n      const percent = Math.min(len / MAX_CHARS, 1);\n      const offset = circumference - percent * circumference;\n\n      circle.css('stroke-dashoffset', offset);\n      circle.css('stroke', len > MAX_CHARS ? 'red' : '#1DA1F2');\n    });\n  }\n\n  // --- Helpers ---\n  async function handleCreatePost({ client, tweetsWindow, renderType }) {\n    const input = $('.tweets-input', tweetsWindow.content);\n    const errorEl = $('.tweets-error', tweetsWindow.content);\n    const content = input.val();\n\n    errorEl.text('');\n\n    if (content.length > MAX_CHARS) {\n      errorEl.text(`Post too long! Max ${MAX_CHARS} characters.`);\n      return;\n    }\n    this.wsClient.postTweet({\n      content\n    });\n    input.val('');\n    /*\n    try {\n      await client.apiRequest('/posts', 'POST', {\n        userId: buddypond.me,\n        content\n      });\n      input.val('');\n      await this.render(context, renderType, tweetsWindow);\n    } catch (err) {\n      console.error('Error creating post:', err);\n      errorEl.text(`Error: ${err.message}`);\n    }\n      */\n  }\n\n  async function createReplyPost({ client, tweetsWindow, renderType, tweetId, content }) {\n    if (!content) return;\n    if (content.length > MAX_CHARS) throw new Error(`Reply too long! Max ${MAX_CHARS} characters.`);\n\n    this.wsClient.send({ action: 'postReply', parentId: tweetId, content });\n\n    /*\n    await client.apiRequest(`/posts/${tweetId}/replies`, 'POST', {\n      userId: buddypond.me,\n      content\n    });\n    await this.render(context, renderType, tweetsWindow);\n    */\n  }\n\n  // --- Delegated events from .tweets-holder ---\n  holder.on('click', '.tweets-button', async (e) => {\n    e.preventDefault();\n    await handleCreatePost.call(this, { client: this.client, tweetsWindow, renderType });\n  });\n\n  holder.on('keypress', '.tweets-input', async (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      await handleCreatePost.call(this, { client: this.client, tweetsWindow, renderType });\n    }\n  });\n\n  holder.on('click', '.tweets-delete', async (e) => {\n    e.preventDefault();\n    if (!confirm('Are you sure you want to delete this tweet?')) return;\n\n    const tweetId = $(e.target).data('id');\n    //await this.client.apiRequest(`/posts/${tweetId}`, 'DELETE');\n    this.wsClient.deleteTweet(tweetId);\n    // remove the tweet from the DOM immediately\n    $(`[data-tweet=\"${tweetId}\"]`, tweetsWindow.content).remove();\n    //await this.render(buddypond.me, renderType, tweetsWindow);\n  });\n\n  holder.on('click', '.tweets-like', async (e) => {\n    e.preventDefault();\n    const tweetId = $(e.target).data('id');\n    this.wsClient.send({ action: 'likeTweet', tweetId });\n    //await this.client.apiRequest(`/posts/${tweetId}/likes`, 'POST', { userId: buddypond.me });\n    //await this.render(context, renderType, tweetsWindow);\n  });\n\n  /*\n  holder.on('click', '.tweets-retweet', async (e) => {\n    e.preventDefault();\n    const tweetId = $(e.target).data('id');\n    await this.client.apiRequest(`/posts/${tweetId}/repost`, 'POST', { userId: buddypond.me });\n    await this.render(buddypond.me, renderType, tweetsWindow);\n  });\n  */\n\n  holder.on('click', '.tweets-reply', async (e) => {\n    e.preventDefault();\n    const tweetId = $(e.target).data('id');\n\n    $('.tweets-reply-modal').remove();\n\n    //const tweetData = await this.client.apiRequest(`/posts/${tweetId}?reply_count=1`);\n    //const originalPostHtml = this.renderTweet(tweetData, tweetsWindow, { noToolbar: true, noRender: true });\n    // <div class=\"tweets-reply-modal-original\">${originalPostHtml}</div>\n\n    const modal = $(`\n      <div class=\"tweets-reply-modal\">\n        <div class=\"tweets-reply-modal-content desktop-section\">\n          <div class=\"tweets-reply-modal-header\">\n            <h3>Reply</h3>\n            <span class=\"tweets-reply-modal-close\">&times;</span>\n          </div>\n          <textarea class=\"tweets-reply-modal-input\" placeholder=\"Write your reply...\"></textarea>\n          <div class=\"tweets-error\"></div>\n          <div class=\"tweets-composer-controls\">\n            <div class=\"tweets-char-counter\"></div>\n            <button class=\"tweets-reply-modal-submit\">Reply</button>\n          </div>\n        </div>\n      </div>\n    `);\n\n    $('body').append(modal);\n    const input = modal.find('.tweets-reply-modal-input');\n    input.focus();\n\n    // setup counter for reply\n    setupCharCounter(input, modal.find('.tweets-char-counter'));\n\n    modal.find('.tweets-reply-modal-close').on('click', () => modal.remove());\n\n    async function submitReply() {\n      const replyContent = input.val().trim();\n      if (!replyContent) return;\n\n      const errorEl = modal.find('.tweets-error');\n      errorEl.text('');\n\n      try {\n        await createReplyPost.call(this, {\n          client: this.client,\n          tweetsWindow,\n          renderType,\n          tweetId,\n          content: replyContent\n        });\n        modal.remove();\n      } catch (err) {\n        errorEl.text(`Error: ${err.message}`);\n      }\n    }\n\n    modal.find('.tweets-reply-modal-submit').on('click', submitReply.bind(this));\n    input.on('keypress', (e) => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        submitReply.call(this);\n      }\n    });\n  });\n\n  // --- Setup main composer counter once ---\n  setupCharCounter($('.tweets-input', tweetsWindow.content), $('.tweets-composer-controls', tweetsWindow.content));\n}\n","export default async function render(tweets, context, type = 'author', tweetsWindow) {\n  if (this.bp.me === 'Guest' || !this.bp.me) {\n    $('.loggedIn', this.tweetsWindow.content).hide();\n    $('.loggedOut', this.tweetsWindow.content).show();\n  } else {\n    $('.loggedIn', this.tweetsWindow.content).show();\n    $('.loggedOut', this.tweetsWindow.content).hide();\n  }\n  /*\n  let tweets;\n\n  if (type === 'post' && context) {\n    // fetch single tweet with replies from the backend\n    tweets = await this.client.apiRequest(`/posts/${context}`);\n    tweets = [tweets]; // wrap in array for uniform processing\n  } else {\n    // fetch tweets from the backend\n    if (context !== 'all') {\n      // clear all tweets\n      // $('.tweets-timeline', tweetsWindow.content).empty();\n      tweets = await this.client.apiRequest(`/feed/${context}`);\n    } else {\n      tweets = await this.client.apiRequest('/feed');\n    }\n\n  }\n  */\n\n  // console.log('Fetched tweets:', tweets);\n\n  const tweetList = $('.tweets-timeline', tweetsWindow.content);\n  // tweetList.empty();\n  for (const tweet of tweets) {\n    tweetList.prepend(await this.renderTweet(tweet, tweetsWindow));\n  }\n\n}"],"names":["client","async","uri","method","data","options","headers","Accept","buddypond","me","qtokenid","body","JSON","stringify","url","endpoint","console","log","response","fetch","ok","errorText","text","Error","statusText","json","error","TweetsWebSocketClient","constructor","bp","this","tweetsWsEndpoint","ws","reconnectAttempts","maxReconnectAttempts","maxBackoffDelay","isIntentionallyClosed","connect","Promise","resolve","reject","WebSocket","onOpen","emit","onMessage","event","parse","err","raw","action","tweets","postId","onClose","warn","code","reason","pondId","delay","Math","min","pow","random","floor","setTimeout","catch","attempt","onError","close","addEventListener","_teardown","removeEventListener","disconnect","send","readyState","OPEN","msg","fetchTweets","context","authorId","postTweet","content","likeTweet","tweetId","deleteTweet","parseMarkdownWithoutPTags","markdown","length","graphemes","splitEmojiGraphemes","emojiList","Set","Object","keys","EMOJIS","emojis","filter","g","has","replace","join","trim","isEmojiOnly","map","supportedColors","supportedStyles","linkExtension","name","level","renderer","token","href","parser","parseInline","tokens","styleExtension","tokenizer","src","match","exec","modifiers","split","every","mod","includes","type","lexer","inlineTokens","reverse","forEach","walkTokens","html","marked","use","extensions","DOMPurify","__added_anchor_hook","addHook","node","tagName","toLowerCase","getAttribute","URL","test","protocol","removeAttribute","e","setAttribute","existing","Boolean","push","sanitize","ALLOWED_TAGS","ALLOWED_ATTR","FORCE_BODY","KEEP_CONTENT","SANITIZE_DOM","ALLOWED_URI_REGEXP","GraphemeSplitter","splitGraphemes","checkForLinksInMessage","message","messageText","isValidUrl","contentUrl","card","urlObj","ext","pathname","pop","supportedImageTypesExt","supportedAudioTypesExt","supportedVideoTypesExt","isValidYoutubeLink","videoId","searchParams","get","thumbnail","slice","isValidGithubLink","githubRegex","owner","repo","filename","renderCardForTweet","tweet","$tweet","apps","cardData","cardManager","_card","loadCard","container","document","createElement","classList","add","render","id","Tweets","icon","init","load","open","tweetsWindow","ui","windowManager","createWindow","title","x","y","width","height","minWidth","minHeight","parent","$","resizable","minimizable","maximizable","closable","focusable","maximized","minimized","wsClient","off","remove","loggedIn","renderType","on","errorDiv","eventBind","prototype","MAX_CHARS","holder","setupCharCounter","inputEl","find","prepend","PI","circle","circumference","len","val","percent","offset","css","handleCreatePost","input","errorEl","createReplyPost","parentId","preventDefault","call","key","shiftKey","confirm","target","modal","append","submitReply","replyContent","focus","bind","show","hide","tweetList","renderTweet","replyButton","deleteButton","likeButton","like_count","existingTweet","noRender","attr","reply_count","Date","ctime","toLocaleString","cardContainer","replies","repliesContainer","children","seenReplies","reply","replyHtml","each","_","el","replyId","parent_id","author","noToolbar","$replies"],"mappings":"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"}