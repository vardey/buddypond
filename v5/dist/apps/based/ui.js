const t=(t,e,i)=>Math.min(i,Math.max(e,t));class e{static activeDrag=null;static isListening=!1;static overlay=null;constructor(t,i=t){this.container=t,this.handle=i,this.tx=0,this.ty=0,this.nextX=0,this.nextY=0,this.framePending=!1,this.isDragging=!1,this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this),i.addEventListener("pointerdown",this.onPointerDown),e.isListening||(document.addEventListener("pointermove",e.handleGlobalMove),document.addEventListener("pointerup",e.handleGlobalUp),document.addEventListener("pointercancel",e.handleGlobalUp),e.ensureOverlay(),e.isListening=!0)}static ensureOverlay(){if(!e.overlay){const t=document.createElement("div");Object.assign(t.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:999999,background:"green",opacity:0,cursor:"grabbing",visibility:"hidden"}),document.body.appendChild(t),e.overlay=t}}static showOverlay(){e.overlay&&(e.overlay.style.visibility="visible")}static hideOverlay(){e.overlay&&(e.overlay.style.visibility="hidden")}static handleGlobalMove(t){e.activeDrag&&e.activeDrag.onPointerMove(t)}static handleGlobalUp(t){e.activeDrag&&(e.activeDrag.onPointerUp(t),e.activeDrag=null)}initFromComputedPosition(){const t=this.container.getBoundingClientRect(),e=this.container.offsetParent?.getBoundingClientRect?.()||{left:0,top:0};this.tx=t.left-e.left,this.ty=t.top-e.top,this.container.style.left="0px",this.container.style.top="0px",this.container.style.transform=`translate3d(${this.tx}px, ${this.ty}px, 0)`}onPointerDown(t){if(t.target.closest(".window-controls"))return;this.isDragging=!0,e.activeDrag=this,this.handle.setPointerCapture(t.pointerId),e.showOverlay();const i=this.container.getBoundingClientRect(),n=window.scrollX||window.pageXOffset||document.documentElement.scrollLeft,s=window.scrollY||window.pageYOffset||document.documentElement.scrollTop,o=i.left+n,a=i.top+s,h=getComputedStyle(this.container).transform,d=h&&"none"!==h?new DOMMatrix(h):new DOMMatrix;this.tx=Number.isFinite(d.m41)?d.m41:0,this.ty=Number.isFinite(d.m42)?d.m42:0;const r=o-this.tx,l=a-this.ty,c=Math.max(document.documentElement.scrollWidth,document.documentElement.clientWidth,window.innerWidth),p=Math.max(document.documentElement.scrollHeight,document.documentElement.clientHeight,window.innerHeight),m=document.querySelector(".desktop-menu-bar")?.offsetHeight||20,w=c-i.width-5,u=m,y=p-i.height-5;this.minTranslateX=5-r,this.maxTranslateX=w-r,this.minTranslateY=u-l,this.maxTranslateY=y-l,this.startPageX=t.clientX+n,this.startPageY=t.clientY+s,this.container.classList.add("dragging"),document.body.style.userSelect="none"}onPointerMove(e){if(!this.isDragging)return;const i=window.scrollX||window.pageXOffset||document.documentElement.scrollLeft,n=window.scrollY||window.pageYOffset||document.documentElement.scrollTop,s=e.clientX+i,o=e.clientY+n,a=s-this.startPageX,h=o-this.startPageY,d=this.tx+a,r=this.ty+h;this.nextX=t(d,this.minTranslateX,this.maxTranslateX),this.nextY=t(r,this.minTranslateY,this.maxTranslateY),this.framePending||(this.framePending=!0,requestAnimationFrame((()=>{this.framePending=!1,this.container.style.transform=`translate3d(${this.nextX}px, ${this.nextY}px, 0)`})))}onPointerUp(t){this.isDragging=!1,e.hideOverlay();try{this.handle.releasePointerCapture(t.pointerId)}catch{}this.container.classList.remove("dragging"),document.body.style.userSelect=""}}let i=0;class n{constructor(t={},e){const{title:n="Window",width:s="400px",height:o="300px",app:a="default",type:h="singleton",context:d="default",content:r="",iframeContent:l=!1,position:c=null,icon:p="",x:m=50,y:w=50,z:u=99,parent:y=window.document.body,id:g=`window-${i}`,onFocus:f=()=>{},onClose:b=()=>{},onOpen:v=()=>{},onResize:x=()=>{},onMessage:C=()=>{},onLoad:z=()=>{},className:M="",resizeable:E=!0,preventOverlap:k=!0,canBeBackground:W=!1}=t;this.windowManager=e;let B=document.getElementById(g);return B?(console.log("Window with id already exists",g),B):(this.title=n,p&&p.length&&!p.startsWith("http")&&(this.icon=bp.config.host+"/"+p),this.width=s,this.height=o,this.app="default"!==a?a:g,this.type=h,this.x=m,this.y=w,this.z=99,this.context=d,this.parent=y,this.id=g,this.isMaximized=!1,this.isMinimized=!1,this.container=null,this.content=null,this.iframeContent=l,this.contentValue=r,this.isActive=!1,this.className=M,this.resizeable=E,this.preventOverlap=k,this.canBeBackground=W,"center"===c&&(this.x=(window.innerWidth-parseInt(this.width))/2,this.y=(window.innerHeight-parseInt(this.height))/2),e=e||{windows:[],saveWindowsState:()=>{},removeWindow:()=>{}},this.bp=t.bp,this.onFocus=f,this.onClose=b,this.onOpen=v,this.onLoad=z,this.onMessage=C,this.createWindow(),this.open(),this)}initContentArea(){if("boolean"==typeof this.iframeContent&&this.iframeContent)this.content=document.createElement("iframe"),this.content.classList.add("bp-window-content"),document.body.appendChild(this.content),this.content.src="about:blank",this.content.onload=()=>{let t=this.content.contentDocument||this.content.contentWindow.document;t.open(),t.write(this.contentValue),t.close(),this.setupMessageHandling()};else if("string"==typeof this.iframeContent&&this.iframeContent.length){this.content=document.createElement("div"),this.content.classList.add("bp-window-content"),this.iframe=document.createElement("iframe"),this.content.appendChild(this.iframe),this.iframe.setAttribute("allow","autoplay; encrypted-media; fullscreen; clipboard-write; accelerometer; gyroscope; web-share"),this.iframeContent.startsWith("/")&&(window.discordMode?this.iframeContent=`/.proxy${this.iframeContent}`:this.iframeContent=`${this.bp.config.host}${this.iframeContent}`),this.iframe.src=this.iframeContent;let t=bp.config.host;if(-1!==this.iframe.src.indexOf(t))this.iframe.onload=()=>this.setupMessageHandling();else{this.iframe.style.display="none",this.iframe.onload=()=>{t.remove(),this.iframe.style.display="block"};let t=document.createElement("div");t.id="loaderHolder",t.innerHTML=`\n                <div id="loader"></div>\n                <p class="loaderText">Loading... ${this.id||this.title||this.label||""}</p>\n            `,this.content.appendChild(t)}}else this.content=document.createElement("div"),this.content.classList.add("bp-window-content"),"string"==typeof this.contentValue?this.content.innerHTML=this.contentValue:this.content.appendChild(this.contentValue)}setupMessageHandling(){this.onLoad(this),this.iframe.contentWindow;const t=this.iframe.contentDocument||this.iframe.contentWindow.document,e=t.createElement("script");e.type="text/javascript",e.textContent="\n            document.addEventListener('keydown', (event) => {\n                if (event.key === 'Escape') {\n                    window.parent.postMessage({ event: 'ESC_KEY_PRESSED' }, '*');\n                }\n            });\n        ",t.body.appendChild(e),window.addEventListener("message",this.receiveMessage.bind(this),!1)}sendMessage(t){this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.postMessage(t,"*")}receiveMessage(t){"object"==typeof t.data&&t.data.event&&("ESC_KEY_PRESSED"===t.data.event?(console.log("ESC key pressed inside iframe. Closing window..."),this.close()):this.handleReceivedMessage(t.data))}handleReceivedMessage(t){this.onMessage&&this.onMessage(t)}move(t,e){this.x=t,this.y=e,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.windowManager.saveWindowsState()}serialize(){let t=(t=>{let e=[];for(;t.parentNode;){if(t.id){e.unshift("#"+t.id);break}{let i,n=t,s=1;for(;i=n.previousSibling;)1===i.nodeType&&i.tagName===n.tagName&&s++,n=i;const o=t.tagName.toLowerCase(),a=s>1?`:nth-of-type(${s})`:"";e.unshift(`${o}${a}`),t=t.parentNode}}return e.length?e.join(" > "):null})(this.parent);return{title:this.title,width:this.width,height:this.height,type:this.type,app:this.app,x:this.x,y:this.y,z:this.z,context:this.context,parent:t,id:this.id,onClose:this.onClose,onOpen:this.onOpen,className:this.className,resizeable:this.resizeable,canBeBackground:this.canBeBackground}}hydrate(t){console.log("hydrate",t),this.title=t.title,this.width=t.width,this.height=t.height,this.app=t.app,this.type=t.type,this.x=t.x,this.y=t.y,this.z=Number(t.z),this.context=t.context,this.id=t.id,this.onClose=t.onClose,this.onOpen=t.onOpen,this.onMessage=t.onMessage,this.className=t.className,this.resizeable=t.resizeable,this.canBeBackground=t.canBeBackground,this.updateWindow()}updateWindow(){this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`;let t=this.x+window.scrollX,e=this.y+window.scrollY;this.container.style.top=`${e}px`,this.container.style.left=`${t}px`,this.container.style.zIndex=this.z}setDepth(t){this.z=t,this.container.style.zIndex=t,this.windowManager.saveWindowsState()}setAsBackground(){console.log("setAsBackground",this.windowManager.windows),this.canBeBackground?(this.windowManager.windows.forEach((t=>{t.isBackground&&t.restoreWindowFromBackground()})),this.container.style.zIndex=-1,this.container.style.width="100%",this.container.style.height="100%",this.container.style.top="0",this.container.style.left="0",this.isBackground=!0,this.isActive=!1):console.log("This window cannot be set as background. Try setting canBeBackground:true in the Window declaration")}restoreWindowFromBackground(){this.isBackground=!1,this.container.style.zIndex=11e3,this.container.style.width=`${this.width}`,this.container.style.height=`${this.height}`,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`;let t=document.getElementById("menubar-restore-background-window");t&&t.classList.add("disabled")}restore(){this.bp.isMobile()&&this.windowManager.minimizeAllWindows(!0),this.container.style.display="flex",this.isMinimized=!1}focus(t=!0){if(t&&this.windowManager.focusWindow(this),this.isMinimized&&this.restore(),this.onFocus(this),this.bp.apps.desktop&&this.bp.apps.list){let t=this.bp.apps.list[this.id],e=this.id;if(t&&t.alias){e=t.alias[0]}let i=`/app/${e}`;this.context&&"default"!==this.context&&"all"!==this.context&&(i.endsWith(`/${this.context}`)||(i+=`/${this.context}`)),DelayedPushState.push({appId:e},this.title,i)}}addResizeHandles(){const t=document.createElement("div");t.classList.add("resize-handle"),this.container.appendChild(t),t.addEventListener("mousedown",(t=>this.startResize(t)),{passive:!1}),t.addEventListener("touchstart",(t=>{t.preventDefault(),this.startResize(t.touches[0])}),{passive:!1})}setSize(t,e){this.width=t,this.height=e,this.container.style.width=`${this.width}`,this.container.style.height=`${this.height}`,this.windowManager.saveWindowsState()}startResize(t){const e=this.container,i=t.clientX,n=t.clientY,s=e.offsetWidth,o=e.offsetHeight,a=t=>{const a=t.clientX||t.touches[0].clientX,h=t.clientY||t.touches[0].clientY,d=s+(a-i),r=o+(h-n);e.style.width=`${Math.max(100,d)}px`,e.style.height=`${Math.max(100,r)}px`},h=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",h),document.removeEventListener("touchmove",a),document.removeEventListener("touchend",h)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",h),document.addEventListener("touchmove",a,{passive:!1}),document.addEventListener("touchend",h);const d=this.container.querySelectorAll("iframe");console.log("Disabling pointer events on iframes during resize",d),d.forEach((t=>{t.style.pointerEvents="none"}))}resize(t){if(!this.isResizing)return;const e=this.startWidth+(t.clientX-this.startX),i=this.startHeight+(t.clientY-this.startY);this.container.style.width=`${e}px`,this.container.style.height=`${i}px`,this.onResize&&this.onResize(e,i)}stopResize(){this.isResizing=!1;this.container.querySelectorAll("iframe").forEach((t=>{t.style.pointerEvents="auto"}))}setTitle(t){this.title=t,this.titleBarSpan.textContent=t,this.windowManager.saveWindowsState()}setContent(t){this.contentValue=t,this.content.innerHTML=t,this.windowManager.saveWindowsState()}}n.prototype.maximize=function({fullWindow:t=!1}={}){const e=(t,e,i,n)=>{this.container.style.width=t,this.container.style.height=e,this.container.style.top="0px",this.container.style.left="0px",this.container.style.transform=`translate3d(${i}px, ${n}px, 0)`,this.dragInstance&&(this.dragInstance.tx=i,this.dragInstance.ty=n,this.dragInstance.nextX=i,this.dragInstance.nextY=n,this.dragInstance.isDragging=!1)},i=()=>{const t=window.scrollX,i=window.scrollY;e("100vw","calc(var(--vh) * 90)",t,i),this.isMaximized=!0},n=t=>{t?e("calc(100vw - 75px)","calc(var(--vh) * 95)",75,20):e("90vw","calc(var(--vh) * 90)",75,0),this.isMaximized=!0},s=()=>{const t=50+window.scrollX,i=50+window.scrollY;e(`${this.width}px`,`${this.height}px`,t,i),this.isMaximized=!1},o=t=>{t?e("100vw","calc(var(--vh) * 95)",0,20):e("calc(100vw - 72px)","calc(var(--vh) * 100)",72,20),this.isMaximized=!0},a=()=>{const t=(()=>{const t=document.querySelector(".desktop-menu-bar");return(t?.offsetHeight||21)-21+23})(),i=window.scrollX,n=t+window.scrollY;e("100vw","calc(100vh - 104px)",i,n),this.isMaximized=!0};this.isMaximized?this.bp.isMobile()?i():window.discordView?n(t):s():this.bp.isMobile()?i():window.discordView?o(t):a()},n.prototype.minimize=function(t=!1){this.isMinimized&&!t?this.restore():(this.container.style.display="none",this.isMinimized=!0)},n.prototype.open=function(){console.log("Window open:",this.id,this.title,this.app,this.type,this.context),this.focus();try{this.onOpen(this)}catch(t){console.error(t)}this.bp.isMobile()&&(this.windowManager.minimizeAllWindows(!0),this.maximize()),window.discordView&&this.maximize(),this.bp.emit("window::open",this);let t={id:this.id,app:this.app,label:this.title,icon:this.icon,type:this.type,context:this.context};if(this.bp.apps.taskbar.taskBar.openItem(t),this.bp.apps.ui.recentApps=this.bp.apps.ui.recentApps||this.bp.settings.recentApps||[],this.bp.apps.ui.recentApps=this.bp.apps.ui.recentApps.filter((t=>t.id!==this.id)),this.bp.apps.ui.recentApps.unshift({id:this.id,app:this.app,label:this.label||this.title,icon:this.icon,type:this.type}),this.bp.apps.ui.recentApps=this.bp.apps.ui.recentApps.slice(0,10),this.bp.set("recentApps",this.bp.apps.ui.recentApps),this.bp.apps.list){let t=this.bp.apps.list[this.id],e=this.id;if(t&&t.alias){e=t.alias[0]}let i=`/app/${e}`;"undefined"!=typeof DelayedPushState&&DelayedPushState.push({appId:e},this.title,i)}},n.prototype.close=function(){if(this.parent?this.container.parentElement&&this.container.parentElement===this.parent&&this.parent.removeChild(this.container):this.container.parentElement.removeChild(this.container),this.content&&this.content.contentWindow&&this.content.contentWindow.removeEventListener("message",this.receiveMessage.bind(this),!1),this.content&&(this.content.parentNode&&this.content.parentNode.removeChild(this.content),this.content=null),0===this.windowManager.windows.length){let t=document.getElementById("menubar-set-window-as-background");t&&t.classList.add("disabled")}if(this.windowManager.removeWindow(this.id),this.windowManager.taskBar&&this.windowManager.taskBar.closeItem(this.id),this.onClose(this),this.bp.emit("window::close",this),this.bp.isMobile()&&setTimeout((()=>{}),100),"undefined"!=typeof DelayedPushState&&DelayedPushState.push({},"","/"),this.bp.isMobile()&&this.windowManager.windows.length>0){let t=this.windowManager.windows[0];t&&t.restore()}},n.prototype.createWindow=function(){this.container=document.createElement("div"),this.container.classList.add("window-container"),this.container.dataset.app=this.app,this.container.dataset.type=this.type,this.container.dataset.context=this.context,this.className&&this.container.classList.add(this.className),this.resizeable||this.container.classList.add("window-not-resizeable"),this.container.id=this.id,this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.position="absolute";const t=window.innerWidth,i=window.innerHeight;let n={x:this.x,y:this.y};if(this.preventOverlap&&(n=function(t,e,i,n,s=10){let o=t.x,a=t.y;return e.forEach((e=>{(function(t,e,i,n,s,o,a,h,d=10){return i=parseInt(i),n=parseInt(n),a=parseInt(a),h=parseInt(h),t<s+a+d&&t+i+d>s&&e<o+h+d&&e+n+d>o})(o,a,t.width,t.height,e.x,e.y,e.width,e.height,s)&&(o+=s)})),o+t.width+s>i&&(o=i-t.width-s),a+t.height+s>n&&(a=n-t.height-s),o<s&&(o=s),a<s&&(a=s),{x:o,y:a}}({x:this.x,y:this.y,width:this.width,height:this.height},this.windowManager.windows,t,i,32)),n.x+=window.scrollX,n.y+=window.scrollY,this.x=n.x,this.y=n.y,this.container.style.top=`${this.y}px`,this.container.style.left=`${this.x}px`,this.container.style.zIndex=99,this.container.addEventListener("pointerdown",(()=>{document.querySelectorAll(".window-container").forEach((t=>{t.id!==this.id&&(t.classList.remove("window-active"),t.isActive=!1)})),this.container.classList.add("window-active"),this.isActive=!0})),this.titleBar=document.createElement("div"),this.titleBar.classList.add("window-title-bar"),this.bp.isMobile()&&(this.titleBar.onclick=()=>{console.log("titleBar clicked on mobile"),this.minimize()}),window.discordView?this.titleBar.ondblclick=()=>this.maximize({fullWindow:!0}):this.titleBar.ondblclick=()=>this.maximize(),this.icon){let t=document.createElement("img");t.src=this.icon,t.classList.add("window-icon"),this.titleBar.appendChild(t)}let s=document.createElement("span");s.classList.add("window-title-text"),s.textContent=this.title,this.titleBarSpan=s;const o=document.createElement("div");if(o.classList.add("window-controls"),this.bp.isMobile()||(this.minimizeButton=document.createElement("button"),this.minimizeButton.innerHTML="&#x1F7E1;",this.minimizeButton.classList.add("minimize-button"),this.minimizeButton.title="Minimize",this.minimizeButton.onclick=()=>this.minimize(),o.appendChild(this.minimizeButton)),this.maximizeButton=document.createElement("button"),this.maximizeButton.innerHTML="&#x1F7E2;",this.maximizeButton.classList.add("maximize-button"),this.maximizeButton.title="Maximize",this.maximizeButton.onclick=()=>this.maximize(),o.appendChild(this.maximizeButton),this.closeButton=document.createElement("button"),this.closeButton.innerHTML="&#x1F534;",this.closeButton.classList.add("close-button"),this.closeButton.title="Close",this.closeButton.onclick=()=>this.close(),o.appendChild(this.closeButton),this.titleBar.appendChild(s),this.titleBar.appendChild(o),this.bp.isMobile()||(this.dragInstance=new e(this.container,this.titleBar)),this.initContentArea(),this.container.appendChild(this.titleBar),this.container.appendChild(this.content),this.parent&&("string"==typeof this.parent?$(this.parent).append(this.container):this.parent.appendChild(this.container)),this.resizeable&&this.addResizeHandles(),this.canBeBackground){let t=document.getElementById("menubar-set-window-as-background");t&&t.classList.remove("disabled")}return this.container};class s{constructor(t={},e){const{id:i="panel",title:n="Panel",icon:s=null,position:o="bottom",panel:a="body",width:h=300,height:d=200,iframeContent:r=!1,content:l="",resizable:c=!1,closable:p=!1,minimizable:m=!1,maximizable:w=!1,focusable:u=!1,maximized:y=!1,minimized:g=!1,onClose:f=null,onMinimize:b=null,onMaximize:v=null,onFocus:x=null,onBlur:C=null}=t;this.windowManager=e,this.bp=this.windowManager.bp,this.id=i,this.title=n,this.container=document.createElement("div"),this.content=null,this.iframeContent=r,this.contentValue=l,this.parent=a,this.width="100%",this.height="100%",console.log("Panel options",t),this.initContentArea(),this.container.appendChild(this.content),this.container.classList.add("bp-panel"),this.container.style.overflow="hidden",this.container.style.width=`${this.width}`,this.container.style.height=`${this.height}`,this.content.style.width="100%",this.content.style.height="100%",$(this.parent).append(this.container)}}s.prototype.initContentArea=function(){if("boolean"==typeof this.iframeContent&&this.iframeContent)this.content=document.createElement("iframe"),this.content.classList.add("bp-panel-content"),document.body.appendChild(this.content),this.content.src="about:blank",this.content.onload=()=>{let t=this.content.contentDocument||this.content.contentWindow.document;t.open(),t.write(this.contentValue),t.close()};else if("string"==typeof this.iframeContent&&this.iframeContent.length){this.content=document.createElement("div"),this.content.classList.add("bp-panel-content"),this.iframe=document.createElement("iframe"),this.content.appendChild(this.iframe),this.iframe.setAttribute("allow","autoplay; encrypted-media; fullscreen; clipboard-write; accelerometer; gyroscope; web-share"),this.iframeContent.startsWith("/")&&(window.discordMode?this.iframeContent=`/.proxy${this.iframeContent}`:this.iframeContent=`${this.bp.config.host}${this.iframeContent}`),this.iframe.src=this.iframeContent;let t=bp.config.host;if(-1!==this.iframe.src.indexOf(t));else{this.iframe.style.display="none",this.iframe.onload=()=>{t.remove(),this.iframe.style.display="block"};let t=document.createElement("div");t.id="loaderHolder",t.innerHTML=`\n                <div id="loader"></div>\n                <p class="loaderText">Loading... ${this.id||this.title||this.label||""}</p>\n            `,this.content.appendChild(t)}}else this.content=document.createElement("div"),this.content.classList.add("bp-panel-content"),console.log("content",this.content),console.log("contentValue",this.contentValue),"string"==typeof this.contentValue?this.content.innerHTML=this.contentValue:this.content.appendChild(this.contentValue);this.content.style.padding="0px !important",this.content.style.margin="0px !important"},s.prototype.setContent=function(t){this.contentValue=t,this.content.innerHTML=t,this.windowManager.saveWindowsState()},s.prototype.serialize=function(){return{id:this.id,title:this.title,icon:this.icon,position:this.position,width:this.width,height:this.height,resizable:this.resizable,closable:this.closable,minimizable:this.minimizable,maximizable:this.maximizable,focusable:this.focusable,maximized:this.maximized,minimized:this.minimized}},s.prototype.setDepth=function(t){},s.prototype.minimize=function(t){},s.prototype.restore=function(t){},s.prototype.focus=function(){this.focusable&&(this.container.classList.add("focused"),this.onFocus&&this.onFocus(this),this.bp.emit("window::focus",this)),this.container.scrollIntoView({behavior:"smooth",block:"end"})},s.prototype.close=function(){this.onClose&&this.onClose(this),this.container.remove(),this.bp.emit("window::close",this),this.windowManager.removeWindow(this.id),this.windowManager.saveWindowsState()};class o{constructor(t,e={}){this.storage=e.storage||localStorage,this.storageKey=e.storageKey||"windowsState",this.windows=[],this._windows=[],this.options=e,this.bp=t.bp,this.useKeyboardControls=!0,"boolean"==typeof e.useKeyboardControls&&(this.useKeyboardControls=e.useKeyboardControls),"boolean"==typeof e.hideTaskBar&&(this.hideTaskBar=e.hideTaskBar),"function"==typeof e.openWindow?this._openWindow=e.openWindow:this._openWindow=function(t,i){e.panel&&(i={...i,panel:!0});this.createWindow(i).hydrate(i)},this.options.hideTaskBar&&(this.taskBar.taskBarElement.style.display="none"),this.useKeyboardControls&&window.addEventListener("keydown",(t=>{if("Escape"===t.key&&!this.bp.ignoreUIControlKeys){const t=document.querySelector(".dialog");if(t)return void t.remove();const e=this.windows[0];e&&e.close()}}))}createWindow(t){t={...t,...this.options.window};let e=this._windows.find((e=>e.id===t.id));e&&(t={...e,...t});const i=this.getWindow(t.id);let o;return i?(o=i,this.focusWindow(o),o):(t.bp=this.bp,o=t.panel?new s(t,this):new n(t,this),o.container.addEventListener("mousedown",(()=>{this.focusWindow(o)})),this.addWindow(o),t.panel||this.focusWindow(o),o)}isMobile(){return window.innerWidth<1e3}addWindow(t){this.windows.push(t),this.saveWindowsState(),this.updateFocus()}removeWindow(t){this.windows=this.windows.filter((e=>e.id!==t)),this.saveWindowsState(),this.updateFocus()}focusWindow(t){"string"==typeof t&&(t=this.getWindow(t));const e=this.windows.indexOf(t);-1!==e&&(this.windows.splice(e,1),this.windows.unshift(t),this.updateFocus(),t.focus(!1),this.saveWindowsState()),this.windows.forEach((e=>{e.id!==t?e.isFocused=!1:t.isFocused=!0}))}updateFocus(){this.windows.forEach(((t,e)=>{t.setDepth(1e3-e)}))}closeAllWindows(){this.windows.forEach((t=>t.close())),this.windows=[],this.storage.removeItem(this.storageKey)}minimizeAllWindows(t=!1){this.windowsHiding?this.windowsHiding=!1:this.windowsHiding=!0,this.windows.forEach((e=>{this.windowsHiding&&!t||"function"!=typeof e.minimize?e.restore():e.minimize(t)}))}getWindow(t){return this.windows.find((e=>e.id===t))}findWindows({app:t,type:e}){if(!t)return console.warn("No app provided to findWindows"),[];const i=Array.isArray(t)?t:[t],n=e?Array.isArray(e)?e:[e]:null;return this.windows.filter((t=>{const e=i.includes(t.app),s=!n||n.includes(t.type);return e&&s}))}saveWindowsState(){const t=JSON.stringify(this.windows.map((t=>t.serialize())));this.storage.setItem(this.storageKey,t)}loadWindows(){const t=this.storage.getItem(this.storageKey);t&&this.restoreWindows(t)}arrangeVerticalStacked(){let t=document.body.clientHeight-100,e=document.body.clientWidth-10;const i=.8*t;let n=0;this.windows.reverse().forEach(((t,s)=>{let o=t.isMinimized?120:i;t.setSize(e+"px",o+"px"),t.move(0,n),n+=o+10})),this.bp.apps.desktop&&this.bp.apps.desktop.shortCutsContainer&&(this.bp.apps.desktop.shortCutsContainer.style.position="absolute",this.bp.apps.desktop.shortCutsContainer.style.left="0px",this.bp.apps.desktop.shortCutsContainer.style.top=n+"px")}arrangeHorizontalStacked(){let t=document.body.clientWidth/this.windows.length;t-=10,this.windows.forEach(((e,i)=>{let n=t*i;n+=5,n+=10*i,e.setSize(t+"px","calc(100% - 80px)"),e.move(n,30)}))}arrangeCascadeFromTopLeft(){this.windows.forEach(((t,e)=>{const i=20*e,n=20*e;t.move(i,n)}))}restoreWindows(t,e=!1){const i=JSON.parse(t);this._windows=i,e&&i.forEach((t=>{const e=this.getWindow(t.id);if(e)return console.log("WARNING: Window with id",t.id,"already exists, hydrating instead of creating new window"),void e.hydrate(t);t.parent=document.querySelector(t.parent)}))}}class a{constructor(){this.intervalId=null,this.expiryCallbacks=new WeakMap}updateCountdowns(){const t=$(".countdown-date").filter((function(){return!0!==$(this).data("expired")}));0!==t.length?t.each(((t,e)=>{const i=$(e),n=new Date(i.data("expiry")).getTime(),s=n-Date.now();if(!i.data("duration")){const t=i.data("ctime");t&&i.data("duration",n-t)}if(s<0){i.data("expired",!0);const t=this.expiryCallbacks.get(e);return void("function"==typeof t&&(t(i),this.expiryCallbacks.delete(e)))}const o=Math.floor(s/864e5),a=Math.floor(s%864e5/36e5),h=Math.floor(s%36e5/6e4),d=Math.floor(s%6e4/1e3);let r="",l=[];o>0?(r=`${o} Day${o>1?"s":""} `,l.push(a.toString().padStart(2,"0"))):a>0&&l.push(a.toString()),l.push(h.toString().padStart(2,"0")),l.push(d.toString().padStart(2,"0")),i.text(r+l.join(":"))})):this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null,bp?.apps?.ui&&(bp.apps.ui.countdownTimer=null))}startCountdown(t,e,i){const n=new Date(e).getTime(),s=Date.now(),o=n-s;t.data("expiry",n).data("ctime",s).data("duration",o).data("expired",!1),"function"==typeof i&&this.expiryCallbacks.set(t[0],i),this.intervalId||(this.intervalId=setInterval((()=>this.updateCountdowns()),1e3),bp?.apps?.ui&&(bp.apps.ui.countdownTimer=this.intervalId)),this.updateCountdowns()}}function h(t){$(".buddypond-lightbox-overlay").remove();const e=$('\n    <div class="buddypond-lightbox-overlay" style="\n      position: fixed;\n      top: 0; left: 0; right: 0; bottom: 0;\n      background: rgba(0,0,0,0.85);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: 999999;\n      cursor: zoom-out;\n      display: none;\n    "></div>\n  '),i=$('<img style="max-width: 90%; max-height: 90%; box-shadow: 0 0 10px #000;">');i.attr("src",t),e.append(i),$("body").append(e),bp.ignoreUIControlKeys=!0,e.flexShow().fadeIn(150);const n=t=>{"Escape"===t.key&&s.call(this)};function s(){$(document).off("keyup",n),bp.ignoreUIControlKeys=!1,e.fadeOut(150,(()=>e.remove()))}e.on("click",s),$(document).on("keyup",n)}function d(t,e={}){const i={title:"Alert",buttonText:"OK",onClose:null,...e};if(!window.discordView)return alert(t);const n=document.createElement("div");n.className="custom-alert-modal",n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0, 0, 0, 0.5)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="1000";const s=document.createElement("div");s.style.backgroundColor="#fff",s.style.padding="20px",s.style.borderRadius="8px",s.style.maxWidth="60vw",s.style.width="90%",s.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)",s.style.fontFamily="Arial, sans-serif",s.style.textAlign="center";const o=document.createElement("h2");o.textContent=i.title,o.style.margin="0 0 10px",o.style.fontSize="2.5em",o.style.color="#5865F2",s.appendChild(o);const a=document.createElement("p");a.textContent=t,a.style.margin="0 0 20px",a.style.fontSize="2em",a.style.color="#333",$(a).html(t),s.appendChild(a);const h=document.createElement("button");h.textContent=i.buttonText,h.style.padding="8px 16px",h.style.backgroundColor="#5865F2",h.style.color="#fff",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.style.fontSize="1em",h.addEventListener("click",(()=>{n.remove(),i.onClose&&"function"==typeof i.onClose&&i.onClose()})),s.appendChild(h),n.appendChild(s),document.body.appendChild(n),h.focus();const d=t=>{"Enter"!==t.key&&"Escape"!==t.key||(n.remove(),i.onClose&&i.onClose(),document.removeEventListener("keydown",d))};document.addEventListener("keydown",d)}class r{constructor(t,e={}){this.bp=t,this.bp.alert=d.bind(this);let i={};i.openWindow=this.bp.open.bind(this.bp),i.window=e.window||{},i.hideTaskBar=e.hideTaskBar,this.windowManager=new o(this,i),this.bp.windows=this.windowManager.windows,this.windowManager.loadWindows(),e.parent=e.parent||document.body,this.options=e,"boolean"!=typeof e.fontAwesome&&(e.fontAwesome=!0),this.parent=e.parent,this.countdownManager=new a(this.bp);function n(){const t=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${t}px`);const e=window.innerWidth;document.documentElement.style.setProperty("--vw",`${e}px`)}return this.bp.window=this.windowManager.createWindow.bind(this.windowManager),window.addEventListener("resize",n),n(),this}async init(){if(this.options.noCSS||(this.bp.appendCSS("/v5/apps/based/ui/ui.css"),"prod"!==this.bp.mode&&(this.bp.appendCSS("/v5/apps/based/ui/mobile.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/Window.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/TaskBar.css"),this.bp.appendCSS("/v5/apps/based/ui/Window/StartPanel.css"))),this.options.fontAwesome&&(this.bp.appendCSS("/v5/vendor/font-awesome/css/fontawesome.css",!1,!0),this.bp.appendCSS("/v5/vendor/font-awesome/css/all.min.css",!1,!0)),this.options.noZepto,!this.options.noTabs){let t=await this.bp.importModule("/v5/apps/based/ui/SimpleTabs.js",{},!1);this.Tabs=t.default}await this.bp.appendScript("/v5/vendor/DateFormat.js"),this.showLightBox=h.bind(this);let t=document;return $(t).on("click",".open-app",(function(t){t.preventDefault();let e=$(this).data("app"),i=$(this).data("context"),n=$(this).data("type");bp.open(e,{context:i,type:n})})),$(t).on("click",(function(t){})),$(t).on("click",".open-link",(async function(t){t.preventDefault();let e=$(this).data("link");if(e||(e=$(this).attr("href")),console.log("open-link "+e),!window.discordMode)return window.open(e,"_blank"),!1;await window.discordSdk.commands.openExternalLink({url:e})})),"loaded ui"}async appendToElement(t){console.log("appendToElement",this);let e=await fetchHTMLFragment("ui.html");return console.log(e),t.innerHTML=e,"hello ui"}async loadDocumentBody(){console.log("loadDocumentBody",this);let t=await this.bp.fetchHTMLFragment("/v5/apps/based/ui/ui.html");return console.log(t),$("body").append(t),"hello ui"}toggleFullScreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}}export{r as default};
//# sourceMappingURL=ui.js.map
