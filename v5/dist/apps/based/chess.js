class t{constructor(t,s={}){this.bp=t,this.options=s,this.board=null,this.game=null,this.ws=null,this.playerColor=null,this.stockfish=null,this.difficulty=10,this.mode="multiplayer"}async init(){return this.html=await this.bp.load("/v5/apps/based/chess/chess.html"),await this.bp.appendCSS("/v5/apps/based/chess/chess.css"),await this.bp.appendScript("/v5/apps/based/chess/vendor/chessboardjs-1.0.0/js/chessboard-1.0.0.js"),await this.bp.appendScript("/v5/apps/based/chess/vendor/chess.js"),await this.bp.appendCSS("/v5/apps/based/chess/vendor/chessboardjs-1.0.0/css/chessboard-1.0.0.min.css"),"loaded ChessApp"}async open(t={}){if(this.win)return this.win;if(this.win=await this.bp.window(this.window()),console.log("Opening ChessApp window:",this.win),this.bindUI(),this.setupDifficultySlider(),t.gameId){this.gameId=t.gameId,this.joinGame(t.gameId);let s=this.gameId.split("/");console.log("Parts:",s),this.opponent=s[0],this.opponent===this.bp.me&&(this.opponent=s[1])}return this.win}window(){return{id:"chess",title:"BuddyPond Chess",icon:"desktop/assets/images/icons/icon_chess_64.png",x:120,y:80,parent:$("#desktop")[0],width:600,height:600,content:this.html,resizable:!0,closable:!0,onClose:()=>{this.cleanup(),this.win=null},onResize:()=>{this.board&&this.board.resize()}}}bindUI(){const t=$(".chess-app-mode-selection"),s=$(".chess-app-join-ui"),e=$(".chess-app-game-ui");$("#play-stockfish").on("click",(()=>{this.mode="stockfish",t.hide(),e.show(),$("#opponent-name").text("Opponent: Stockfish"),this.startStockfishGame()})),$("#show-join-game").on("click",(()=>{if(!this.bp.me||"Guest"===this.bp.me)return alert("Please log in to play with a buddy. "+this.bp.me),void this.bp.open("buddylist");t.hide(),s.show()})),$("#join-game").on("click",(async()=>{let t=$("#chess-game-buddyname").val().trim();if(!t)return void alert("Please enter a Buddy Name");let i=this.bp.me;if(t===i)return void alert("You cannot play against yourself. Please enter a different Buddy Name.");let o=[t,i].sort().join("/");console.log("Game ID: "+o),this.opponent=t,$("#game-input").val(o),this.mode="multiplayer",s.hide(),e.show(),this.setStatus(`Waiting for ${t} to connect`),console.log("gameId",o),this.sendGameInvite(t),this.joinGame(document.getElementById("game-input").value.trim())})),$("#leave-button").on("click",(()=>{this.cleanup(),this.resetUI()})),$("#resign-button").on("click",(()=>{"multiplayer"===this.mode&&this.ws?.send(JSON.stringify({type:"resign"})),this.setStatus("You resigned the game."),this.gameHeader("Resigned")})),$("#restart-button").on("click",(()=>{"stockfish"===this.mode&&this.startStockfishGame()})),this.game=new Chess;const i=$("#chessboard",this.win.content);this.board=Chessboard(i,{pieceTheme:"/v5/apps/based/chess/img/chesspieces/wikipedia/{piece}.png",draggable:!0,position:"start",onDragStart:this.onDragStart.bind(this),onDrop:this.onDrop.bind(this),onSnapEnd:this.onSnapEnd.bind(this)}),$(".chess-app-game-row",this.win.content).width(),this.bp.isMobile()&&$(".chess-app-board",this.win.content).css({width:"calc(var(--vw) * 0.95)"}),this.board.resize(),this.updateStatus()}sendGameInvite(t){let s={from:bp.me,to:t,text:"Let's play a chess game",type:"buddy",card:{type:"chess"}};console.log("Buddy Chess message",s),buddypond.sendCardMessage(s,(function(t,s){t?console.error("Error sending message",t):console.log("Message sent",s)}))}setupDifficultySlider(){const t=document.createElement("div");t.className="chess-app-difficulty-slider",t.innerHTML=`\n      <label for="difficulty">Difficulty: <span id="difficultyValue">${this.difficulty}</span></label>\n      <input type="range" id="difficulty" min="0" max="20" value="${this.difficulty}" step="1">\n    `,$(".chess-app-controls",this.win.content).append(t);const s=document.getElementById("difficulty"),e=document.getElementById("difficultyValue");s.addEventListener("input",(t=>{this.difficulty=parseInt(t.target.value,10),e.textContent=this.difficulty,this.stockfish&&this.setStockfishDifficulty()}))}setStockfishDifficulty(){this.stockfish.postMessage(`setoption name Skill Level value ${this.difficulty}`);const t=Math.max(1,Math.floor(this.difficulty/2)+1);this.stockfish.postMessage(`setoption name Skill Level Maximum Depth value ${t}`)}startStockfishGame(){$(".chess-app-difficulty-slider",this.win.content).show(),this.game.reset(),this.board.position("start"),this.playerColor="w",this.setStatus("You are White. Make your move."),this.stockfish=new Worker("v5/apps/based/chess/vendor/stockfish.min.js"),this.stockfish.onmessage=t=>{if("string"==typeof t.data&&t.data.startsWith("bestmove")){const s=t.data.split(" ")[1],e=s.substring(0,2),i=s.substring(2,4);this.game.move({from:e,to:i,promotion:"q"})&&(this.board.position(this.game.fen()),this.updateStatus())}},this.stockfish.postMessage("uci"),this.stockfish.postMessage("isready"),this.setStockfishDifficulty()}async joinGame(t){if(!t)return alert("Please enter a game ID");const s=$(".chess-app-mode-selection"),e=$(".chess-app-join-ui"),i=$(".chess-app-game-ui");this.mode="multiplayer",e.hide(),i.show(),s.hide(),$("#restart-button",this.win.content).hide(),$(".chess-app-difficulty-slider",this.win.content).hide();const o=`${buddypond.chessWsEndpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}gameId=${encodeURIComponent(t)}`;console.log("Connecting to game server at:",o),this.ws=new WebSocket(o),this.ws.onopen=()=>{this.ws.send(JSON.stringify({type:"join",gameId:t})),this.ws.send(JSON.stringify({type:"getState"})),this.setStatus("Connected! Waiting for opponent...")},this.ws.onmessage=t=>this.handleSocketMessage(t),this.ws.onclose=()=>this.setStatus("Disconnected from game"),this.ws.onerror=()=>this.setStatus("WebSocket error occurred")}async resignGame(){this.ws&&this.ws.readyState===WebSocket.OPEN?(this.ws.send(JSON.stringify({type:"resign"})),this.setStatus("You resigned the game.")):this.setStatus("Cannot resign, not connected to a game.")}handleSocketMessage(t){const s=JSON.parse(t.data);switch(console.log("handleSocketMessage",t.data),s.type){case"color":this.playerColor=s.color,this.board.orientation("w"===this.playerColor?"white":"black"),this.setStatus(`You are ${"w"===this.playerColor?"White":"Black"}. `+("w"===this.game.turn()?"White":"Black")+" to move.");break;case"gameStart":this.gameConnected=!0,this.setStatus("Game started! "+(this.playerColor===this.game.turn()?"Your move":this.opponent+"'s move"));break;case"gameState":this.game.load(s.fen),this.board.position(this.game.fen()),this.updateStatus();break;case"move":this.game.move(s.move)&&(this.board.position(this.game.fen()),this.updateStatus());break;case"gameReset":this.game.reset(),this.board.start(),this.gameConnected=!0,this.setStatus("Game started! "+(this.playerColor===this.game.turn()?"Your move":"Opponent's move")),$("#rematch-button",this.win.content).hide();break;case"gameOver":this.setStatus("Game Over: "+s.result),"multiplayer"===this.mode&&($("#rematch-button",this.win.content).show(),$("#rematch-button",this.win.content).on("click",(()=>{this.ws.send(JSON.stringify({type:"rematch"})),this.setStatus(`Rematch requested. Waiting for ${this.opponent}...`)})));break;case"error":this.setStatus("Error: "+s.message);break;case"disconnect":this.gameConnected=!1,this.setStatus(this.opponent+" has disconnected...");break;default:console.warn("Unknown socket message:",s)}}onDragStart(t,s){if(this.game.game_over())return!1;if("multiplayer"===this.mode){if(this.playerColor&&s[0]!==this.playerColor)return!1;if(this.game.turn()!==this.playerColor)return!1}else if("stockfish"===this.mode&&"w"!==this.game.turn())return!1;return!0}onDrop(t,s){let e;try{if(e=this.game.move({from:t,to:s,promotion:"q"}),null===e)return"snapback"}catch(t){return"snapback"}"multiplayer"===this.mode&&this.ws?.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify({type:"move",gameId:document.getElementById("game-input").value,move:{from:t,to:s,promotion:"q"}})):"stockfish"===this.mode&&setTimeout((()=>{this.stockfish.postMessage("position fen "+this.game.fen()),this.stockfish.postMessage("go depth 15")}),200),this.updateStatus()}onSnapEnd(){this.board.position(this.game.fen())}updateStatus(){let t="";t=this.game.in_checkmate()?"Checkmate! "+("w"===this.game.turn()?"Black":"White")+" wins!":this.game.in_draw()?"Game Over: Draw!":this.gameConnected?("w"===this.game.turn()?"White":"Black")+" to move":`Waiting for ${this.opponent} to connect...`,this.setStatus(t)}setStatus(t){$(".chess-app-status",this.win.content).text(t)}resetUI(){$(".chess-app-mode-selection",this.win.content).show(),$(".chess-app-join-ui",this.win.content).hide(),$(".chess-app-game-ui",this.win.content).hide(),$("#opponent-name",this.win.content).text("Opponent: "),$("#rematch-button",this.win.content).hide(),this.setStatus("Welcome to BuddyPond Chess!"),this.board&&(this.board.clear(),this.board.start()),this.game=new Chess,this.playerColor=null,this.stockfish&&(this.stockfish.terminate(),this.stockfish=null),this.ws&&(this.ws.close(),this.ws=null)}cleanup(){this.ws&&this.ws.close(),this.stockfish&&(this.stockfish.terminate(),this.stockfish=null)}}export{t as default};
//# sourceMappingURL=chess.js.map
