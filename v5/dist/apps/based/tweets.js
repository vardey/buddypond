const e={endpoint:"http://192.168.200.59:9020",apiRequest:async(t,s="GET",n=null)=>{const o={method:s};let i={Accept:"application/json","Content-Type":"application/json; charset=utf-8","X-Me":buddypond.me};buddypond.qtokenid&&(i.Authorization=`Bearer ${buddypond.qtokenid}`),n&&(o.body=JSON.stringify(n)),o.headers=i;let r=`${e.endpoint}${t}`;console.log("tweets client making api request",r,o);try{const e=await fetch(r,o);if(!e.ok){console.log("rrrr",e);const t=await e.text();throw new Error(t||e.statusText||"API request failed")}return await e.json()}catch(e){throw console.error("Error in API request:",e),e}}};class t{constructor({endpoint:e,bp:t}){this.endpoint=buddypond.tweetsWsEndpoint,this.bp=t,this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.maxBackoffDelay=1e4,this.isIntentionallyClosed=!1}async connect(){const e=`${this.endpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`;return console.log("üîå Connecting to Tweets..."),new Promise(((t,s)=>{const n=new WebSocket(e),o=()=>{console.log("‚úÖ WebSocket connected to Tweets"),this.reconnectAttempts=0,this.ws=n,this.bp?.emit("tweets::connected"),t(this)},i=e=>{let t;try{t=JSON.parse(e.data)}catch(t){return console.error("‚ùå Failed to parse message:",e.data),void this.bp?.emit("tweets::error",{error:"Invalid JSON",raw:e.data})}console.log("üì¨ Message received from Tweets:",t);let s=t.action,n=t.error;if(n)return console.error("‚ùå Error from Tweets:",n),void this.bp?.emit("tweets::error",{error:n});switch(s){case"tweetsFeed":console.log("Tweets feed received:",t.tweets),this.bp?.emit("tweets::feed",t.tweets);break;case"removedTweet":console.log("Tweet removed:",t.postId),this.bp?.emit("tweets::removed",t.postId)}},r=e=>{if(console.warn(`‚ö†Ô∏è WebSocket closed [${e.code}]: ${e.reason}`),this.bp?.emit("tweets::disconnected",{pondId:this.pondId,code:e.code,reason:e.reason}),!this.isIntentionallyClosed&&this.reconnectAttempts<this.maxReconnectAttempts){const e=Math.min(200*Math.pow(2,this.reconnectAttempts)*(1+.1*Math.random()),this.maxBackoffDelay);console.log(`‚è≥ Reconnecting in ${Math.floor(e)}ms...`),setTimeout((()=>{this.reconnectAttempts++,this.connect().catch((()=>{})),this.bp?.emit("tweets::reconnecting",{attempt:this.reconnectAttempts})}),e)}else this.reconnectAttempts>=this.maxReconnectAttempts&&(console.error("‚ùå Max reconnect attempts reached. Giving up."),this.bp?.emit("tweets::reconnect_failed",{pondId:this.pondId}))},a=e=>{console.error("‚ùå WebSocket error:",e),this.bp?.emit("tweets::error",{error:"WebSocket error",event:e}),n.close(1e3,"Error occurred"),s(new Error("WebSocket connection failed"))};n.addEventListener("open",o),n.addEventListener("message",i),n.addEventListener("close",r),n.addEventListener("error",a),this._teardown=()=>{n.removeEventListener("open",o),n.removeEventListener("message",i),n.removeEventListener("close",r),n.removeEventListener("error",a)}}))}disconnect(){this.ws&&(this.isIntentionallyClosed=!0,this._teardown?.(),this.ws.close(1e3,"Normal closure"),this.bp?.emit("tweets::closed",{pondId:this.pondId}),this.ws=null,console.log("üõë WebSocket disconnected from Tweets"))}send(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const t="string"==typeof e?e:JSON.stringify(e);this.ws.send(t)}else console.warn("‚ö†Ô∏è Tried to send message but WebSocket is not open")}async fetchTweets(e){console.log("Requesting tweets feed from server...",e),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"fetchTweets",authorId:e}):console.warn("‚ö†Ô∏è Tried to get tweets feed but WebSocket is not open")}async postTweet({content:e}){console.log("Posting new tweet to server..."),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"postTweet",content:e}):console.warn("‚ö†Ô∏è Tried to post tweet but WebSocket is not open")}async likeTweet({tweetId:e}){console.log("Liking tweet on server..."),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"likeTweet",tweetId:e}):console.warn("‚ö†Ô∏è Tried to like tweet but WebSocket is not open")}async deleteTweet(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"deleteTweet",tweetId:e}):console.warn("‚ö†Ô∏è Tried to delete tweet but WebSocket is not open")}}function s(e){if(!e)return"";if(function(e){if(!e)return!1;if(e.length>7)return!1;const t=n(e),s=new Set(Object.keys(EMOJIS)),o=t.filter((e=>s.has(e)||s.has(e.replace(/\uFE0F/g,""))));return o.length>0&&o.length<=7&&o.join("")===e.trim()}(e))return'<div class="emoji-only">'+n(e).map((e=>`<span class="big-emoji">${e}</span>`)).join("")+"</div>";const t=["red","blue","green","yellow","purple","orange","black","white","gray","cyan","magenta","pink"],s=["bold","italic","underline","strike","blink","reverse","hidden","dim","rainbow"],o={name:"link",level:"inline",renderer(e){return`<a href="${e.href.replace(/"/g,"&quot;")}" target="_blank" rel="noopener">${this.parser.parseInline(e.tokens)}</a>`}},i={name:"style",level:"inline",tokenizer(e){const n=/^((?:\w+\.)*\w+)\(\s*([\s\S]+?)\s*\)/.exec(e);if(n){const e=n[0],o=n[1].split("."),i=n[2];if(!o.every((e=>t.includes(e)||s.includes(e))))return;return{type:"style",raw:e,modifiers:o,text:i,tokens:this.lexer.inlineTokens(i)}}},renderer(e){let s=this.parser.parseInline(e.tokens);return e.modifiers.reverse().forEach((e=>{t.includes(e)?s=`<span class="message-decoration-color-${e}">${s}</span>`:"bold"===e?s=`<strong class="message-decoration-bold">${s}</strong>`:"italic"===e?s=`<em class="message-decoration-italic">${s}</em>`:"underline"===e?s=`<u class="message-decoration-underline">${s}</u>`:"strike"===e?s=`<s class="message-decoration-strike">${s}</s>`:"blink"===e?s=`<span class="message-decoration-blink">${s}</span>`:"reverse"===e?s=s.split("").reverse().join(""):"hidden"===e?s=`<span class="message-decoration-hidden">${s}</span>`:"dim"===e?s=`<span class="message-decoration-dim">${s}</span>`:"rainbow"===e&&(s=`<span class="message-decoration-rainbow">${s}</span>`)})),s},walkTokens(e){"style"===e.type&&console.log(`Detected style token: ${e.modifiers.join(".")}`)}};let r;marked.use({extensions:[i,o]});try{r=marked.parse(e)}catch(t){r=e}DOMPurify.__added_anchor_hook||(DOMPurify.addHook("afterSanitizeAttributes",(function(e){if(e.tagName&&"a"===e.tagName.toLowerCase()){const t=e.getAttribute("href")||"";try{const s=new URL(t,"https://example.com");if(!/^(https?:|mailto:|tel:)/i.test(s.protocol))return e.removeAttribute("href"),e.removeAttribute("target"),void e.removeAttribute("rel")}catch(t){return e.removeAttribute("href"),e.removeAttribute("target"),void e.removeAttribute("rel")}e.setAttribute("target","_blank");const s=(e.getAttribute("rel")||"").split(/\s+/).filter(Boolean);s.includes("noopener")||s.push("noopener"),s.includes("noreferrer")||s.push("noreferrer"),e.setAttribute("rel",s.join(" "))}})),DOMPurify.__added_anchor_hook=!0);return DOMPurify.sanitize(r,{ALLOWED_TAGS:["a","span","strong","em","u","s","div","br","p","h1","h2","h3","h4","h5","h6","ul","ol","li","code","pre","blockquote","img"],ALLOWED_ATTR:["href","target","rel","class","data-char-index","src"],FORCE_BODY:!0,KEEP_CONTENT:!0,SANITIZE_DOM:!0,ALLOWED_URI_REGEXP:/^(?:(https?|mailto|tel):|\/)/i}).replace(/^<p>(.*?)<\/p>\s*$/s,"$1")}function n(e){return(new GraphemeSplitter).splitGraphemes(e.trim())}class o{constructor(e,t={}){return this.bp=e,this.icon="desktop/assets/images/icons/icon_tweets_64.png",this}async init(){return this.html=await this.bp.load("/v5/apps/based/tweets/tweets.html"),await this.bp.load("/v5/apps/based/tweets/tweets.css"),"loaded tweets app"}async open(e={}){this.tweetsWindow||(this.tweetsWindow=this.bp.apps.ui.windowManager.createWindow({id:"tweets",title:"Tweets",icon:this.icon,x:250,y:75,width:800,height:400,minWidth:200,minHeight:200,parent:$("#desktop")[0],content:"",resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.wsClient&&(this.wsClient.disconnect(),this.wsClient=null),this.bp.off("tweets::connected","fetch-tweets-feed"),this.bp.off("tweets::feed","render-tweets-feed"),this.bp.off("tweets::removed","remove-tweet"),this.bp.off("tweets::error","tweets-error"),this.tweetsWindow=null,$(".tweets-reply-modal").remove()}}),this.tweetsWindow.loggedIn=!0),"default"!==e.context&&e.context&&"undefined"!==e.context||(e.context="all");let s="author";return"post"===e.type&&(s="post"),this.tweetsWindow.context=e.context||"all",this.wsClient?this.wsClient.fetchTweets(this.tweetsWindow.context):(this.wsClient=new t({bp:this.bp}),this.bp.on("tweets::connected","fetch-tweets-feed",(e=>{console.log("Tweets WebSocket connected event received in Tweets app",e),console.log("Tweets WebSocket connected"),this.wsClient.fetchTweets(this.tweetsWindow.context)})),this.bp.on("tweets::feed","render-tweets-feed",(e=>{console.log("Tweets feed event received in Tweets app",e),this.tweetsWindow&&this.render(e,this.tweetsWindow.context,"author",this.tweetsWindow)})),this.bp.on("tweets::removed","remove-tweet",(e=>{console.log("Tweet removed event received in Tweets app",e),this.tweetsWindow&&($(`[data-tweet="${e}"]`,this.tweetsWindow.content).remove(),console.log("remove the tweet",e))})),this.bp.on("tweets::error","tweets-error",(e=>{if(console.error("Tweets error event received in Tweets app",e),this.tweetsWindow){const t=$(".tweets-error",this.tweetsWindow.content);t&&(t.html(`<div class="error">Error: ${e.error}</div>`),setTimeout((()=>{t.html("")}),5e3))}})),console.log("Connecting to Tweets WebSocket..."),await this.wsClient.connect()),$(this.tweetsWindow.content).html(this.html),this.eventBind(e.context,s,this.tweetsWindow),this.tweetsWindow}}o.prototype.client=e,o.prototype.eventBind=function(e,t,s){const n=280,o=$(".tweets-holder",s.content);function i(e,t){0===t.find(".tweets-char-count").length&&t.prepend(`\n        <div class="tweets-char-count" title="Character count">\n          <svg width="40" height="40">\n            <circle class="bg" r="18" cx="20" cy="20" stroke="#eee" stroke-width="3" fill="none"/>\n            <circle class="progress" r="18" cx="20" cy="20" stroke="#1DA1F2" stroke-width="3" fill="none"\n              stroke-dasharray="${2*Math.PI*18}" stroke-dashoffset="${2*Math.PI*18}"\n              stroke-linecap="round"/>\n          </svg>\n        </div>\n      `);const s=t.find(".progress"),o=2*Math.PI*18;e.on("input",(()=>{const t=e.val().length,i=Math.min(t/n,1),r=o-i*o;s.css("stroke-dashoffset",r),s.css("stroke",t>n?"red":"#1DA1F2")}))}async function r({client:e,tweetsWindow:t,renderType:s}){const o=$(".tweets-input",t.content),i=$(".tweets-error",t.content),r=o.val();i.text(""),r.length>n?i.text("Post too long! Max 280 characters."):(this.wsClient.postTweet({content:r}),o.val(""))}async function a({client:e,tweetsWindow:t,renderType:s,tweetId:o,content:i}){if(i){if(i.length>n)throw new Error("Reply too long! Max 280 characters.");this.wsClient.send({action:"postReply",parentId:o,content:i})}}o.on("click",".tweets-button",(async e=>{e.preventDefault(),await r.call(this,{client:this.client,tweetsWindow:s,renderType:t})})),o.on("keypress",".tweets-input",(async e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),await r.call(this,{client:this.client,tweetsWindow:s,renderType:t}))})),o.on("click",".tweets-delete",(async e=>{if(e.preventDefault(),!confirm("Are you sure you want to delete this tweet?"))return;const t=$(e.target).data("id");this.wsClient.deleteTweet(t),$(`[data-tweet="${t}"]`,s.content).remove()})),o.on("click",".tweets-like",(async e=>{e.preventDefault();const t=$(e.target).data("id");this.wsClient.send({action:"likeTweet",tweetId:t})})),o.on("click",".tweets-reply",(async e=>{e.preventDefault();const n=$(e.target).data("id");$(".tweets-reply-modal").remove();const o=$('\n      <div class="tweets-reply-modal">\n        <div class="tweets-reply-modal-content desktop-section">\n          <div class="tweets-reply-modal-header">\n            <h3>Reply</h3>\n            <span class="tweets-reply-modal-close">&times;</span>\n          </div>\n          <textarea class="tweets-reply-modal-input" placeholder="Write your reply..."></textarea>\n          <div class="tweets-error"></div>\n          <div class="tweets-composer-controls">\n            <div class="tweets-char-counter"></div>\n            <button class="tweets-reply-modal-submit">Reply</button>\n          </div>\n        </div>\n      </div>\n    ');$("body").append(o);const r=o.find(".tweets-reply-modal-input");async function c(){const e=r.val().trim();if(!e)return;const i=o.find(".tweets-error");i.text("");try{await a.call(this,{client:this.client,tweetsWindow:s,renderType:t,tweetId:n,content:e}),o.remove()}catch(e){i.text(`Error: ${e.message}`)}}r.focus(),i(r,o.find(".tweets-char-counter")),o.find(".tweets-reply-modal-close").on("click",(()=>o.remove())),o.find(".tweets-reply-modal-submit").on("click",c.bind(this)),r.on("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),c.call(this))}))})),i($(".tweets-input",s.content),$(".tweets-composer-controls",s.content))},o.prototype.render=async function(e,t,s="author",n){"Guest"!==this.bp.me&&this.bp.me?($(".loggedIn",this.tweetsWindow.content).show(),$(".loggedOut",this.tweetsWindow.content).hide()):($(".loggedIn",this.tweetsWindow.content).hide(),$(".loggedOut",this.tweetsWindow.content).show());const o=$(".tweets-timeline",n.content);e.forEach((e=>{o.prepend(this.renderTweet(e,n))}))},o.prototype.renderTweet=function(e,t,n={}){let o="",i="",r=`<a href="#" class="tweets-like" data-id="${e.id}">Like (${e.like_count||0})</a>`,a=$(`[data-tweet="${e.id}"]`,t.content);if(!0!==n.noRender&&a.length>0){if(a.attr("data-likes",e.like_count||0),a.attr("data-replies",e.reply_count||0),$(".tweets-like",a).html(`Like (${e.like_count||0})`),$(".tweets-reply",a).html(`Reply (${e.reply_count||0})`),$(".tweets-content",a).text(e.content),$(".tweets-meta",a).html(new Date(e.ctime).toLocaleString()),!0!==n.noRender&&e.replies&&e.replies.length>0){let s=a.children(".tweets-replies");0===s.length&&(s=$('<div class="tweets-replies"></div>'),a.append(s));const o=new Set;e.replies.forEach((e=>{o.add(e.id);const i=this.renderTweet(e,t,n);i&&s.append(i)})),s.children("[data-tweet]").each(((e,t)=>{const s=$(t).attr("data-tweet");o.has(s)||$(t).remove()}))}return""}e.parent_id||(o=`<a href="#" class="tweets-reply" data-id="${e.id}">Reply (${e.reply_count||0})</a>`),e.author!==this.bp.me&&"Marak"!==this.bp.me||(i=`<a href="#" class="tweets-delete" data-id="${e.id}">Delete</a>`),n.noToolbar&&(o="",i="",r="");let c=$(`\n  <div class="tweets-post desktop-section" data-tweet="${e.id}" data-likes="${e.like_count||0}" data-replies="${e.reply_count||0}">\n    <div class="tweets-author">\n      <a href="#" class="open-app" data-app="tweets" data-context="${e.author}">\n        @${e.author}\n      </a>\n    </div>\n    <div class="tweets-content"></div>\n    <div class="tweets-meta"></div>\n    <div class="tweets-toolbar">\n      ${r}\n      ${o}\n      ${i}\n    </div>\n  </div>\n`);if(e.content=s(e.content),console.log("Rendering tweet:",e),$(".tweets-content",c).html(e.content),$(".tweets-meta",c).text(new Date(e.ctime).toLocaleString()),!0!==n.noRender&&e.replies&&e.replies.length>0){let s=$('<div class="tweets-replies"></div>');e.replies.forEach((e=>{s.append(this.renderTweet(e,t,n))})),c.append(s)}return c};export{o as default};
//# sourceMappingURL=tweets.js.map
