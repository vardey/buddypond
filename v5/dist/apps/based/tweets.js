const e={endpoint:"http://192.168.200.59:9020",apiRequest:async(t,s="GET",n=null)=>{const o={method:s};let i={Accept:"application/json","Content-Type":"application/json; charset=utf-8","X-Me":buddypond.me};buddypond.qtokenid&&(i.Authorization=`Bearer ${buddypond.qtokenid}`),n&&(o.body=JSON.stringify(n)),o.headers=i;let r=`${e.endpoint}${t}`;console.log("tweets client making api request",r,o);try{const e=await fetch(r,o);if(!e.ok){console.log("rrrr",e);const t=await e.text();throw new Error(t||e.statusText||"API request failed")}return await e.json()}catch(e){throw console.error("Error in API request:",e),e}}};class t{constructor({endpoint:e,bp:t}){this.endpoint=buddypond.tweetsWsEndpoint,this.bp=t,this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.maxBackoffDelay=1e4,this.isIntentionallyClosed=!1}async connect(){const e=`${this.endpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`;return console.log("üîå Connecting to Tweets..."),new Promise(((t,s)=>{const n=new WebSocket(e),o=()=>{console.log("‚úÖ WebSocket connected to Tweets"),this.reconnectAttempts=0,this.ws=n,this.bp?.emit("tweets::connected"),t(this)},i=e=>{let t;try{t=JSON.parse(e.data)}catch(t){return console.error("‚ùå Failed to parse message:",e.data),void this.bp?.emit("tweets::error",{error:"Invalid JSON",raw:e.data})}console.log("üì¨ Message received from Tweets:",t);let s=t.action,n=t.error;if(n)return console.error("‚ùå Error from Tweets:",n),void this.bp?.emit("tweets::error",{error:n});switch(s){case"tweetsFeed":console.log("Tweets feed received:",t.tweets),this.bp?.emit("tweets::feed",t.tweets);break;case"removedTweet":console.log("Tweet removed:",t.postId),this.bp?.emit("tweets::removed",t.postId)}},r=e=>{if(console.warn(`‚ö†Ô∏è WebSocket closed [${e.code}]: ${e.reason}`),this.bp?.emit("tweets::disconnected",{pondId:this.pondId,code:e.code,reason:e.reason}),!this.isIntentionallyClosed&&this.reconnectAttempts<this.maxReconnectAttempts){const e=Math.min(200*Math.pow(2,this.reconnectAttempts)*(1+.1*Math.random()),this.maxBackoffDelay);console.log(`‚è≥ Reconnecting in ${Math.floor(e)}ms...`),setTimeout((()=>{this.reconnectAttempts++,this.connect().catch((()=>{})),this.bp?.emit("tweets::reconnecting",{attempt:this.reconnectAttempts})}),e)}else this.reconnectAttempts>=this.maxReconnectAttempts&&(console.error("‚ùå Max reconnect attempts reached. Giving up."),this.bp?.emit("tweets::reconnect_failed",{pondId:this.pondId}))},c=e=>{console.error("‚ùå WebSocket error:",e),this.bp?.emit("tweets::error",{error:"WebSocket error",event:e}),n.close(1e3,"Error occurred"),s(new Error("WebSocket connection failed"))};n.addEventListener("open",o),n.addEventListener("message",i),n.addEventListener("close",r),n.addEventListener("error",c),this._teardown=()=>{n.removeEventListener("open",o),n.removeEventListener("message",i),n.removeEventListener("close",r),n.removeEventListener("error",c)}}))}disconnect(){this.ws&&(this.isIntentionallyClosed=!0,this._teardown?.(),this.ws.close(1e3,"Normal closure"),this.bp?.emit("tweets::closed",{pondId:this.pondId}),this.ws=null,console.log("üõë WebSocket disconnected from Tweets"))}send(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const t="string"==typeof e?e:JSON.stringify(e);this.ws.send(t)}else console.warn("‚ö†Ô∏è Tried to send message but WebSocket is not open")}async fetchTweets(e){console.log("Requesting tweets feed from server...",e),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"fetchTweets",authorId:e}):console.warn("‚ö†Ô∏è Tried to get tweets feed but WebSocket is not open")}async postTweet({content:e}){console.log("Posting new tweet to server..."),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"postTweet",content:e}):console.warn("‚ö†Ô∏è Tried to post tweet but WebSocket is not open")}async likeTweet({tweetId:e}){console.log("Liking tweet on server..."),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"likeTweet",tweetId:e}):console.warn("‚ö†Ô∏è Tried to like tweet but WebSocket is not open")}async deleteTweet(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"deleteTweet",tweetId:e}):console.warn("‚ö†Ô∏è Tried to delete tweet but WebSocket is not open")}}class s{constructor(e,t={}){return this.bp=e,this.icon="desktop/assets/images/icons/icon_tweets_64.png",this}async init(){return this.html=await this.bp.load("/v5/apps/based/tweets/tweets.html"),await this.bp.load("/v5/apps/based/tweets/tweets.css"),"loaded tweets app"}async open(e={}){this.tweetsWindow||(this.tweetsWindow=this.bp.apps.ui.windowManager.createWindow({id:"tweets",title:"Tweets",icon:this.icon,x:250,y:75,width:800,height:400,minWidth:200,minHeight:200,parent:$("#desktop")[0],content:"",resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.wsClient&&(this.wsClient.disconnect(),this.wsClient=null),this.bp.off("tweets::connected","fetch-tweets-feed"),this.bp.off("tweets::feed","render-tweets-feed"),this.bp.off("tweets::removed","remove-tweet"),this.bp.off("tweets::error","tweets-error"),this.tweetsWindow=null,$(".tweets-reply-modal").remove()}}),this.tweetsWindow.loggedIn=!0),"default"!==e.context&&e.context&&"undefined"!==e.context||(e.context="all");let s="author";return"post"===e.type&&(s="post"),this.tweetsWindow.context=e.context||"all",this.wsClient?this.wsClient.fetchTweets(this.tweetsWindow.context):(this.wsClient=new t({bp:this.bp}),this.bp.on("tweets::connected","fetch-tweets-feed",(e=>{console.log("Tweets WebSocket connected event received in Tweets app",e),console.log("Tweets WebSocket connected"),this.wsClient.fetchTweets(this.tweetsWindow.context)})),this.bp.on("tweets::feed","render-tweets-feed",(e=>{console.log("Tweets feed event received in Tweets app",e),this.tweetsWindow&&this.render(e,this.tweetsWindow.context,"author",this.tweetsWindow)})),this.bp.on("tweets::removed","remove-tweet",(e=>{console.log("Tweet removed event received in Tweets app",e),this.tweetsWindow&&($(`[data-tweet="${e}"]`,this.tweetsWindow.content).remove(),console.log("remove the tweet",e))})),this.bp.on("tweets::error","tweets-error",(e=>{if(console.error("Tweets error event received in Tweets app",e),this.tweetsWindow){const t=$(".tweets-error",this.tweetsWindow.content);t&&(t.html(`<div class="error">Error: ${e.error}</div>`),setTimeout((()=>{t.html("")}),5e3))}})),console.log("Connecting to Tweets WebSocket..."),await this.wsClient.connect()),$(this.tweetsWindow.content).html(this.html),this.eventBind(e.context,s,this.tweetsWindow),this.tweetsWindow}}s.prototype.client=e,s.prototype.eventBind=function(e,t,s){const n=280,o=$(".tweets-holder",s.content);function i(e,t){0===t.find(".tweets-char-count").length&&t.prepend(`\n        <div class="tweets-char-count" title="Character count">\n          <svg width="40" height="40">\n            <circle class="bg" r="18" cx="20" cy="20" stroke="#eee" stroke-width="3" fill="none"/>\n            <circle class="progress" r="18" cx="20" cy="20" stroke="#1DA1F2" stroke-width="3" fill="none"\n              stroke-dasharray="${2*Math.PI*18}" stroke-dashoffset="${2*Math.PI*18}"\n              stroke-linecap="round"/>\n          </svg>\n        </div>\n      `);const s=t.find(".progress"),o=2*Math.PI*18;e.on("input",(()=>{const t=e.val().length,i=Math.min(t/n,1),r=o-i*o;s.css("stroke-dashoffset",r),s.css("stroke",t>n?"red":"#1DA1F2")}))}async function r({client:e,tweetsWindow:t,renderType:s}){const o=$(".tweets-input",t.content),i=$(".tweets-error",t.content),r=o.val();i.text(""),r.length>n?i.text("Post too long! Max 280 characters."):(this.wsClient.postTweet({content:r}),o.val(""))}async function c({client:e,tweetsWindow:t,renderType:s,tweetId:o,content:i}){if(i){if(i.length>n)throw new Error("Reply too long! Max 280 characters.");this.wsClient.send({action:"postReply",parentId:o,content:i})}}o.on("click",".tweets-button",(async e=>{e.preventDefault(),await r.call(this,{client:this.client,tweetsWindow:s,renderType:t})})),o.on("keypress",".tweets-input",(async e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),await r.call(this,{client:this.client,tweetsWindow:s,renderType:t}))})),o.on("click",".tweets-delete",(async e=>{if(e.preventDefault(),!confirm("Are you sure you want to delete this tweet?"))return;const t=$(e.target).data("id");this.wsClient.deleteTweet(t),$(`[data-tweet="${t}"]`,s.content).remove()})),o.on("click",".tweets-like",(async e=>{e.preventDefault();const t=$(e.target).data("id");this.wsClient.send({action:"likeTweet",tweetId:t})})),o.on("click",".tweets-reply",(async e=>{e.preventDefault();const n=$(e.target).data("id");$(".tweets-reply-modal").remove();const o=$('\n      <div class="tweets-reply-modal">\n        <div class="tweets-reply-modal-content desktop-section">\n          <div class="tweets-reply-modal-header">\n            <h3>Reply</h3>\n            <span class="tweets-reply-modal-close">&times;</span>\n          </div>\n          <textarea class="tweets-reply-modal-input" placeholder="Write your reply..."></textarea>\n          <div class="tweets-error"></div>\n          <div class="tweets-composer-controls">\n            <div class="tweets-char-counter"></div>\n            <button class="tweets-reply-modal-submit">Reply</button>\n          </div>\n        </div>\n      </div>\n    ');$("body").append(o);const r=o.find(".tweets-reply-modal-input");async function a(){const e=r.val().trim();if(!e)return;const i=o.find(".tweets-error");i.text("");try{await c.call(this,{client:this.client,tweetsWindow:s,renderType:t,tweetId:n,content:e}),o.remove()}catch(e){i.text(`Error: ${e.message}`)}}r.focus(),i(r,o.find(".tweets-char-counter")),o.find(".tweets-reply-modal-close").on("click",(()=>o.remove())),o.find(".tweets-reply-modal-submit").on("click",a.bind(this)),r.on("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),a.call(this))}))})),i($(".tweets-input",s.content),$(".tweets-composer-controls",s.content))},s.prototype.render=async function(e,t,s="author",n){"Guest"!==this.bp.me&&this.bp.me?($(".loggedIn",this.tweetsWindow.content).show(),$(".loggedOut",this.tweetsWindow.content).hide()):($(".loggedIn",this.tweetsWindow.content).hide(),$(".loggedOut",this.tweetsWindow.content).show());const o=$(".tweets-timeline",n.content);e.forEach((e=>{o.prepend(this.renderTweet(e,n))}))},s.prototype.renderTweet=function(e,t,s={}){let n="",o="",i=`<a href="#" class="tweets-like" data-id="${e.id}">Like (${e.like_count||0})</a>`,r=$(`[data-tweet="${e.id}"]`,t.content);if(!0!==s.noRender&&r.length>0){if(r.attr("data-likes",e.like_count||0),r.attr("data-replies",e.reply_count||0),$(".tweets-like",r).html(`Like (${e.like_count||0})`),$(".tweets-reply",r).html(`Reply (${e.reply_count||0})`),$(".tweets-content",r).text(e.content),$(".tweets-meta",r).html(new Date(e.ctime).toLocaleString()),!0!==s.noRender&&e.replies&&e.replies.length>0){let n=r.children(".tweets-replies");0===n.length&&(n=$('<div class="tweets-replies"></div>'),r.append(n));const o=new Set;e.replies.forEach((e=>{o.add(e.id);const i=this.renderTweet(e,t,s);i&&n.append(i)})),n.children("[data-tweet]").each(((e,t)=>{const s=$(t).attr("data-tweet");o.has(s)||$(t).remove()}))}return""}e.parent_id||(n=`<a href="#" class="tweets-reply" data-id="${e.id}">Reply (${e.reply_count||0})</a>`),e.author!==this.bp.me&&"Marak"!==this.bp.me||(o=`<a href="#" class="tweets-delete" data-id="${e.id}">Delete</a>`),s.noToolbar&&(n="",o="",i="");let c=$(`\n  <div class="tweets-post desktop-section" data-tweet="${e.id}" data-likes="${e.like_count||0}" data-replies="${e.reply_count||0}">\n    <div class="tweets-author">\n      <a href="#" class="open-app" data-app="tweets" data-context="${e.author}">\n        @${e.author}\n      </a>\n    </div>\n    <div class="tweets-content"></div>\n    <div class="tweets-meta"></div>\n    <div class="tweets-toolbar">\n      ${i}\n      ${n}\n      ${o}\n    </div>\n  </div>\n`);if($(".tweets-content",c).text(e.content),$(".tweets-meta",c).text(new Date(e.ctime).toLocaleString()),!0!==s.noRender&&e.replies&&e.replies.length>0){let n=$('<div class="tweets-replies"></div>');e.replies.forEach((e=>{n.append(this.renderTweet(e,t,s))})),c.append(n)}return c};export{s as default};
//# sourceMappingURL=tweets.js.map
