const e={endpoint:"http://192.168.200.59:9020",apiRequest:async(t,n="GET",s=null)=>{const o={method:n};let r={Accept:"application/json","Content-Type":"application/json; charset=utf-8","X-Me":buddypond.me};buddypond.qtokenid&&(r.Authorization=`Bearer ${buddypond.qtokenid}`),s&&(o.body=JSON.stringify(s)),o.headers=r;let i=`${e.endpoint}${t}`;console.log("tweets client making api request",i,o);try{const e=await fetch(i,o);if(!e.ok){console.log("rrrr",e);const t=await e.text();throw new Error(t||e.statusText||"API request failed")}return await e.json()}catch(e){throw console.error("Error in API request:",e),e}}};class t{constructor({endpoint:e,bp:t}){this.endpoint=buddypond.tweetsWsEndpoint,this.bp=t,this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.maxBackoffDelay=1e4,this.isIntentionallyClosed=!1}async connect(){const e=`${this.endpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`;return console.log("üîå Connecting to Tweets..."),new Promise(((t,n)=>{const s=new WebSocket(e),o=()=>{console.log("‚úÖ WebSocket connected to Tweets"),this.reconnectAttempts=0,this.ws=s,this.bp?.emit("tweets::connected"),t(this)},r=e=>{let t;try{t=JSON.parse(e.data)}catch(t){return console.error("‚ùå Failed to parse message:",e.data),void this.bp?.emit("tweets::error",{error:"Invalid JSON",raw:e.data})}console.log("üì¨ Message received from Tweets:",t);let n=t.action,s=t.error;if(s)return console.error("‚ùå Error from Tweets:",s),void this.bp?.emit("tweets::error",{error:s});switch(n){case"tweetsFeed":console.log("Tweets feed received:",t.tweets),this.bp?.emit("tweets::feed",t.tweets);break;case"removedTweet":console.log("Tweet removed:",t.postId),this.bp?.emit("tweets::removed",t.postId)}},i=e=>{if(console.warn(`‚ö†Ô∏è WebSocket closed [${e.code}]: ${e.reason}`),this.bp?.emit("tweets::disconnected",{pondId:this.pondId,code:e.code,reason:e.reason}),!this.isIntentionallyClosed&&this.reconnectAttempts<this.maxReconnectAttempts){const e=Math.min(200*Math.pow(2,this.reconnectAttempts)*(1+.1*Math.random()),this.maxBackoffDelay);console.log(`‚è≥ Reconnecting in ${Math.floor(e)}ms...`),setTimeout((()=>{this.reconnectAttempts++,this.connect().catch((()=>{})),this.bp?.emit("tweets::reconnecting",{attempt:this.reconnectAttempts})}),e)}else this.reconnectAttempts>=this.maxReconnectAttempts&&(console.error("‚ùå Max reconnect attempts reached. Giving up."),this.bp?.emit("tweets::reconnect_failed",{pondId:this.pondId}))},a=e=>{console.error("‚ùå WebSocket error:",e),this.bp?.emit("tweets::error",{error:"WebSocket error",event:e}),s.close(1e3,"Error occurred"),n(new Error("WebSocket connection failed"))};s.addEventListener("open",o),s.addEventListener("message",r),s.addEventListener("close",i),s.addEventListener("error",a),this._teardown=()=>{s.removeEventListener("open",o),s.removeEventListener("message",r),s.removeEventListener("close",i),s.removeEventListener("error",a)}}))}disconnect(){this.ws&&(this.isIntentionallyClosed=!0,this._teardown?.(),this.ws.close(1e3,"Normal closure"),this.bp?.emit("tweets::closed",{pondId:this.pondId}),this.ws=null,console.log("üõë WebSocket disconnected from Tweets"))}send(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const t="string"==typeof e?e:JSON.stringify(e);this.ws.send(t)}else console.warn("‚ö†Ô∏è Tried to send message but WebSocket is not open")}async fetchTweets(e){console.log("Requesting tweets feed from server...",e),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"fetchTweets",authorId:e}):console.warn("‚ö†Ô∏è Tried to get tweets feed but WebSocket is not open")}async postTweet({content:e}){console.log("Posting new tweet to server..."),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"postTweet",content:e}):console.warn("‚ö†Ô∏è Tried to post tweet but WebSocket is not open")}async likeTweet({tweetId:e}){console.log("Liking tweet on server..."),this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"likeTweet",tweetId:e}):console.warn("‚ö†Ô∏è Tried to like tweet but WebSocket is not open")}async deleteTweet(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.send({action:"deleteTweet",tweetId:e}):console.warn("‚ö†Ô∏è Tried to delete tweet but WebSocket is not open")}}function n(e){if(!e)return"";if(function(e){if(!e)return!1;if(e.length>7)return!1;const t=s(e),n=new Set(Object.keys(EMOJIS)),o=t.filter((e=>n.has(e)||n.has(e.replace(/\uFE0F/g,""))));return o.length>0&&o.length<=7&&o.join("")===e.trim()}(e))return'<div class="emoji-only">'+s(e).map((e=>`<span class="big-emoji">${e}</span>`)).join("")+"</div>";const t=["red","blue","green","yellow","purple","orange","black","white","gray","cyan","magenta","pink"],n=["bold","italic","underline","strike","blink","reverse","hidden","dim","rainbow"],o={name:"link",level:"inline",renderer(e){return`<a href="${e.href.replace(/"/g,"&quot;")}" target="_blank" rel="noopener">${this.parser.parseInline(e.tokens)}</a>`}},r={name:"style",level:"inline",tokenizer(e){const s=/^((?:\w+\.)*\w+)\(\s*([\s\S]+?)\s*\)/.exec(e);if(s){const e=s[0],o=s[1].split("."),r=s[2];if(!o.every((e=>t.includes(e)||n.includes(e))))return;return{type:"style",raw:e,modifiers:o,text:r,tokens:this.lexer.inlineTokens(r)}}},renderer(e){let n=this.parser.parseInline(e.tokens);return e.modifiers.reverse().forEach((e=>{t.includes(e)?n=`<span class="message-decoration-color-${e}">${n}</span>`:"bold"===e?n=`<strong class="message-decoration-bold">${n}</strong>`:"italic"===e?n=`<em class="message-decoration-italic">${n}</em>`:"underline"===e?n=`<u class="message-decoration-underline">${n}</u>`:"strike"===e?n=`<s class="message-decoration-strike">${n}</s>`:"blink"===e?n=`<span class="message-decoration-blink">${n}</span>`:"reverse"===e?n=n.split("").reverse().join(""):"hidden"===e?n=`<span class="message-decoration-hidden">${n}</span>`:"dim"===e?n=`<span class="message-decoration-dim">${n}</span>`:"rainbow"===e&&(n=`<span class="message-decoration-rainbow">${n}</span>`)})),n},walkTokens(e){"style"===e.type&&console.log(`Detected style token: ${e.modifiers.join(".")}`)}};let i;marked.use({extensions:[r,o]});try{i=marked.parse(e)}catch(t){i=e}DOMPurify.__added_anchor_hook||(DOMPurify.addHook("afterSanitizeAttributes",(function(e){if(e.tagName&&"a"===e.tagName.toLowerCase()){const t=e.getAttribute("href")||"";try{const n=new URL(t,"https://example.com");if(!/^(https?:|mailto:|tel:)/i.test(n.protocol))return e.removeAttribute("href"),e.removeAttribute("target"),void e.removeAttribute("rel")}catch(t){return e.removeAttribute("href"),e.removeAttribute("target"),void e.removeAttribute("rel")}e.setAttribute("target","_blank");const n=(e.getAttribute("rel")||"").split(/\s+/).filter(Boolean);n.includes("noopener")||n.push("noopener"),n.includes("noreferrer")||n.push("noreferrer"),e.setAttribute("rel",n.join(" "))}})),DOMPurify.__added_anchor_hook=!0);return DOMPurify.sanitize(i,{ALLOWED_TAGS:["a","span","strong","em","u","s","div","br","p","h1","h2","h3","h4","h5","h6","ul","ol","li","code","pre","blockquote","img"],ALLOWED_ATTR:["href","target","rel","class","data-char-index","src"],FORCE_BODY:!0,KEEP_CONTENT:!0,SANITIZE_DOM:!0,ALLOWED_URI_REGEXP:/^(?:(https?|mailto|tel):|\/)/i}).replace(/^<p>(.*?)<\/p>\s*$/s,"$1")}function s(e){return(new GraphemeSplitter).splitGraphemes(e.trim())}function o(e){let t=(e.text||e.content||"").match(/https?:\/\/(?:[^\s()<>\[\]{}"']+|\([^\s()]*?\))+/gi);if(t&&function(e){if(!e)return!1;e=e.trim();try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}(t[0])){let n=t[0];e.card={url:n,type:"website"};try{const t=new URL(n),s=t.pathname.split(".").pop().toLowerCase();s&&(buddypond.supportedImageTypesExt.includes(s)?e.card.type="image":buddypond.supportedAudioTypesExt.includes(s)?e.card.type="audio":buddypond.supportedVideoTypesExt.includes(s)&&(e.card.type="video"))}catch(e){console.warn("Invalid URL:",n,e)}if(function(e){const t=e.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);return t?t[1]:null}(n)){const t=new URL(n).searchParams.get("v");t&&(e.card.type="youtube",e.card.thumbnail=`https://img.youtube.com/vi/${t}/0.jpg`,e.card.context=t)}if(function(e){const t=e.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/);return t?t.slice(1):null}(n)){e.card.type="github";const t=/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/,s=n.match(t);s?(e.card.owner=s[1],e.card.repo=s[2],e.card.filename=s[4]):console.error("Invalid GitHub URL format.")}}}async function r(e,t,n){if(!(e&&e.card&&n&&n.apps&&n.apps.card))return null;const s=e.card||{};if(0===Object.keys(s).length)return null;try{s.message=e;const o=n.apps.card.cardManager,r=await o.loadCard(s.type,s,t.html()),i=document.createElement("div");return i.classList.add("cardContainer"),await r.render(i),i}catch(t){return console.error("Error rendering card for tweet",e&&e.id,t),null}}class i{constructor(e,t={}){return this.bp=e,this.icon="desktop/assets/images/icons/icon_tweets_64.webp",this}async init(){return this.html=await this.bp.load("/v5/apps/based/tweets/tweets.html"),await this.bp.load("/v5/apps/based/tweets/tweets.css"),"loaded tweets app"}async open(e={}){this.tweetsWindow||(this.tweetsWindow=this.bp.apps.ui.windowManager.createWindow({id:"tweets",title:"Tweets",icon:this.icon,x:250,y:75,width:800,height:400,minWidth:200,minHeight:200,parent:$("#desktop")[0],content:"",resizable:!0,minimizable:!0,maximizable:!0,closable:!0,focusable:!0,maximized:!1,minimized:!1,onClose:()=>{this.wsClient&&(this.wsClient.disconnect(),this.wsClient=null),this.bp.off("tweets::connected","fetch-tweets-feed"),this.bp.off("tweets::feed","render-tweets-feed"),this.bp.off("tweets::removed","remove-tweet"),this.bp.off("tweets::error","tweets-error"),this.tweetsWindow=null,$(".tweets-reply-modal").remove()}}),this.tweetsWindow.loggedIn=!0),"default"!==e.context&&e.context&&"undefined"!==e.context||(e.context="all");let n="author";return"post"===e.type&&(n="post"),this.tweetsWindow.context=e.context||"all",this.wsClient?this.wsClient.fetchTweets(this.tweetsWindow.context):(this.wsClient=new t({bp:this.bp}),this.bp.on("tweets::connected","fetch-tweets-feed",(e=>{console.log("Tweets WebSocket connected"),this.wsClient.fetchTweets(this.tweetsWindow.context)})),this.bp.on("tweets::feed","render-tweets-feed",(e=>{this.tweetsWindow&&this.render(e,this.tweetsWindow.context,"author",this.tweetsWindow)})),this.bp.on("tweets::removed","remove-tweet",(e=>{this.tweetsWindow&&($(`[data-tweet="${e}"]`,this.tweetsWindow.content).remove(),console.log("remove the tweet",e))})),this.bp.on("tweets::error","tweets-error",(e=>{if(console.error("Tweets error event received in Tweets app",e),this.tweetsWindow){const t=$(".tweets-error",this.tweetsWindow.content);t&&(t.html(`<div class="error">Error: ${e.error}</div>`),setTimeout((()=>{t.html("")}),5e3))}})),console.log("Connecting to Tweets WebSocket..."),await this.wsClient.connect()),$(this.tweetsWindow.content).html(this.html),this.eventBind(e.context,n,this.tweetsWindow),this.tweetsWindow}}i.prototype.client=e,i.prototype.eventBind=function(e,t,n){const s=280,o=$(".tweets-holder",n.content);function r(e,t){0===t.find(".tweets-char-count").length&&t.prepend(`\n        <div class="tweets-char-count" title="Character count">\n          <svg width="40" height="40">\n            <circle class="bg" r="18" cx="20" cy="20" stroke="#eee" stroke-width="3" fill="none"/>\n            <circle class="progress" r="18" cx="20" cy="20" stroke="#1DA1F2" stroke-width="3" fill="none"\n              stroke-dasharray="${2*Math.PI*18}" stroke-dashoffset="${2*Math.PI*18}"\n              stroke-linecap="round"/>\n          </svg>\n        </div>\n      `);const n=t.find(".progress"),o=2*Math.PI*18;e.on("input",(()=>{const t=e.val().length,r=Math.min(t/s,1),i=o-r*o;n.css("stroke-dashoffset",i),n.css("stroke",t>s?"red":"#1DA1F2")}))}async function i({client:e,tweetsWindow:t,renderType:n}){const o=$(".tweets-input",t.content),r=$(".tweets-error",t.content),i=o.val();r.text(""),i.length>s?r.text("Post too long! Max 280 characters."):(this.wsClient.postTweet({content:i}),o.val(""))}async function a({client:e,tweetsWindow:t,renderType:n,tweetId:o,content:r}){if(r){if(r.length>s)throw new Error("Reply too long! Max 280 characters.");this.wsClient.send({action:"postReply",parentId:o,content:r})}}o.on("click",".tweets-button",(async e=>{e.preventDefault(),await i.call(this,{client:this.client,tweetsWindow:n,renderType:t})})),o.on("keypress",".tweets-input",(async e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),await i.call(this,{client:this.client,tweetsWindow:n,renderType:t}))})),o.on("click",".tweets-delete",(async e=>{if(e.preventDefault(),!confirm("Are you sure you want to delete this tweet?"))return;const t=$(e.target).data("id");this.wsClient.deleteTweet(t),$(`[data-tweet="${t}"]`,n.content).remove()})),o.on("click",".tweets-like",(async e=>{e.preventDefault();const t=$(e.target).data("id");this.wsClient.send({action:"likeTweet",tweetId:t})})),o.on("click",".tweets-reply",(async e=>{e.preventDefault();const s=$(e.target).data("id");$(".tweets-reply-modal").remove();const o=$('\n      <div class="tweets-reply-modal">\n        <div class="tweets-reply-modal-content desktop-section">\n          <div class="tweets-reply-modal-header">\n            <h3>Reply</h3>\n            <span class="tweets-reply-modal-close">&times;</span>\n          </div>\n          <textarea class="tweets-reply-modal-input" placeholder="Write your reply..."></textarea>\n          <div class="tweets-error"></div>\n          <div class="tweets-composer-controls">\n            <div class="tweets-char-counter"></div>\n            <button class="tweets-reply-modal-submit">Reply</button>\n          </div>\n        </div>\n      </div>\n    ');$("body").append(o);const i=o.find(".tweets-reply-modal-input");async function c(){const e=i.val().trim();if(!e)return;const r=o.find(".tweets-error");r.text("");try{await a.call(this,{client:this.client,tweetsWindow:n,renderType:t,tweetId:s,content:e}),o.remove()}catch(e){r.text(`Error: ${e.message}`)}}i.focus(),r(i,o.find(".tweets-char-counter")),o.find(".tweets-reply-modal-close").on("click",(()=>o.remove())),o.find(".tweets-reply-modal-submit").on("click",c.bind(this)),i.on("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),c.call(this))}))})),r($(".tweets-input",n.content),$(".tweets-composer-controls",n.content))},i.prototype.render=async function(e,t,n="author",s){"Guest"!==this.bp.me&&this.bp.me?($(".loggedIn",this.tweetsWindow.content).show(),$(".loggedOut",this.tweetsWindow.content).hide()):($(".loggedIn",this.tweetsWindow.content).hide(),$(".loggedOut",this.tweetsWindow.content).show());const o=$(".tweets-timeline",s.content);for(const t of e)o.prepend(await this.renderTweet(t,s))},i.prototype.renderTweet=async function(e,t,s={}){let i="",a="",c=`<a href="#" class="tweets-like" data-id="${e.id}">Like (${e.like_count||0})</a>`,d=$(`[data-tweet="${e.id}"]`,t.content);if(!0!==s.noRender&&d.length>0){d.attr("data-likes",e.like_count||0),d.attr("data-replies",e.reply_count||0),$(".tweets-like",d).html(`Like (${e.like_count||0})`),$(".tweets-reply",d).html(`Reply (${e.reply_count||0})`),e.text=e.content||"",o(e),e.text=n(e.text),e.card||$(".tweets-content",d).html(e.text),$(".tweets-meta",d).html(new Date(e.ctime).toLocaleString());try{d.find(".cardContainer").remove();const t=await r(e,d,this.bp);t&&$(".tweets-content",d).append(t)}catch(t){console.error("Failed to update card for tweet",e&&e.id,t)}if(!0!==s.noRender&&e.replies&&e.replies.length>0){let n=d.children(".tweets-replies");0===n.length&&(n=$('<div class="tweets-replies"></div>'),d.append(n));const o=new Set;e.replies.forEach((async e=>{o.add(e.id);const r=await this.renderTweet(e,t,s);r&&n.append(r)})),n.children("[data-tweet]").each(((e,t)=>{const n=$(t).attr("data-tweet");o.has(n)||$(t).remove()}))}return""}e.parent_id||(i=`<a href="#" class="tweets-reply" data-id="${e.id}">Reply (${e.reply_count||0})</a>`),e.author!==this.bp.me&&"Marak"!==this.bp.me||(a=`<a href="#" class="tweets-delete" data-id="${e.id}">Delete</a>`),s.noToolbar&&(i="",a="",c="");let l=$(`\n  <div class="tweets-post desktop-section" data-tweet="${e.id}" data-likes="${e.like_count||0}" data-replies="${e.reply_count||0}">\n    <div class="tweets-author">\n      <a href="#" class="open-app" data-app="tweets" data-context="${e.author}">\n        @${e.author}\n      </a>\n    </div>\n    <div class="tweets-content"></div>\n    <div class="tweets-meta"></div>\n    <div class="tweets-toolbar">\n      ${c}\n      ${i}\n      ${a}\n    </div>\n  </div>\n`);e.text=e.content||"",o(e),e.text=n(e.text);let p=null;if(e.card&&this.bp&&this.bp.apps&&this.bp.apps.card)try{p=await r(e,l,this.bp)}catch(t){console.error("Error while rendering card for new tweet",e&&e.id,t),p=null}if(e.card||$(".tweets-content",l).html(e.text),p&&$(".tweets-content",l).append(p),$(".tweets-meta",l).text(new Date(e.ctime).toLocaleString()),!0!==s.noRender&&e.replies&&e.replies.length>0){let n=$('<div class="tweets-replies"></div>');e.replies.forEach((async e=>{n.append(await this.renderTweet(e,t,s))})),l.append(n)}return l};export{i as default};
//# sourceMappingURL=tweets.js.map
