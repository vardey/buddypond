function e(e){$(e).on("contextmenu",(e=>{e.preventDefault();let t=e.target.closest("li").dataset.buddy;this.showContextMenu(e.pageX,e.pageY,t)}))}function t(e){if(!e)return"";if(function(e){if(!e)return!1;if(e.length>7)return!1;const t=o(e),s=new Set(Object.keys(EMOJIS)),n=t.filter((e=>s.has(e)||s.has(e.replace(/\uFE0F/g,""))));return n.length>0&&n.length<=7&&n.join("")===e.trim()}(e))return'<div class="emoji-only">'+o(e).map((e=>`<span class="big-emoji">${e}</span>`)).join("")+"</div>";const t=["red","blue","green","yellow","purple","orange","black","white","gray","cyan","magenta","pink"],s=["bold","italic","underline","strike","blink","reverse","hidden","dim","rainbow"],n={name:"link",level:"inline",renderer(e){return`<a href="${e.href.replace(/"/g,"&quot;")}" target="_blank" rel="noopener">${this.parser.parseInline(e.tokens)}</a>`}},i={name:"style",level:"inline",tokenizer(e){const o=/^((?:\w+\.)*\w+)\(\s*([\s\S]+?)\s*\)/.exec(e);if(o){const e=o[0],n=o[1].split("."),i=o[2];if(!n.every((e=>t.includes(e)||s.includes(e))))return;return{type:"style",raw:e,modifiers:n,text:i,tokens:this.lexer.inlineTokens(i)}}},renderer(e){let o=this.parser.parseInline(e.tokens);return e.modifiers.reverse().forEach((e=>{t.includes(e)?o=`<span class="message-decoration-color-${e}">${o}</span>`:"bold"===e?o=`<strong class="message-decoration-bold">${o}</strong>`:"italic"===e?o=`<em class="message-decoration-italic">${o}</em>`:"underline"===e?o=`<u class="message-decoration-underline">${o}</u>`:"strike"===e?o=`<s class="message-decoration-strike">${o}</s>`:"blink"===e?o=`<span class="message-decoration-blink">${o}</span>`:"reverse"===e?o=o.split("").reverse().join(""):"hidden"===e?o=`<span class="message-decoration-hidden">${o}</span>`:"dim"===e?o=`<span class="message-decoration-dim">${o}</span>`:"rainbow"===e&&(o=`<span class="message-decoration-rainbow">${o}</span>`)})),o},walkTokens(e){"style"===e.type&&console.log(`Detected style token: ${e.modifiers.join(".")}`)}};let a;marked.use({extensions:[i,n]});try{a=marked.parse(e)}catch(t){a=e}DOMPurify.__added_anchor_hook||(DOMPurify.addHook("afterSanitizeAttributes",(function(e){if(e.tagName&&"a"===e.tagName.toLowerCase()){const t=e.getAttribute("href")||"";try{const o=new URL(t,"https://example.com");if(!/^(https?:|mailto:|tel:)/i.test(o.protocol))return e.removeAttribute("href"),e.removeAttribute("target"),void e.removeAttribute("rel")}catch(t){return e.removeAttribute("href"),e.removeAttribute("target"),void e.removeAttribute("rel")}e.setAttribute("target","_blank");const o=(e.getAttribute("rel")||"").split(/\s+/).filter(Boolean);o.includes("noopener")||o.push("noopener"),o.includes("noreferrer")||o.push("noreferrer"),e.setAttribute("rel",o.join(" "))}})),DOMPurify.__added_anchor_hook=!0);return DOMPurify.sanitize(a,{ALLOWED_TAGS:["a","span","strong","em","u","s","div","br","p","h1","h2","h3","h4","h5","h6","ul","ol","li","code","pre","blockquote","img"],ALLOWED_ATTR:["href","target","rel","class","data-char-index","src"],FORCE_BODY:!0,KEEP_CONTENT:!0,SANITIZE_DOM:!0,ALLOWED_URI_REGEXP:/^(?:(https?|mailto|tel):|\/)/i}).replace(/^<p>(.*?)<\/p>\s*$/s,"$1")}function o(e){return(new GraphemeSplitter).splitGraphemes(e.trim())}function s(e){const t=document.createElement("div");t.className="aim-hover-menu";const o=[];return o.push({text:"React",action:"react-message",svg:"desktop/assets/images/icons/svg/1f600.svg"}),e.from!==this.bp.me&&"Marak"!==this.bp.me||o.push({text:"Edit Message",action:"edit-message",icon:"fa-duotone fa-regular fa-pencil"}),o.push({text:"Reply Message",action:"reply-message",icon:"fa-duotone fa-regular fa-reply"}),o.push({text:"...",action:"more-options",icon:"fa-solid fa-regular fa-ellipsis"}),o.forEach((e=>{const o=document.createElement("button");if(o.setAttribute("data-action",e.action),o.className="aim-hover-menu-item",e.icon){const t=document.createElement("i");t.className=e.icon,o.appendChild(t),o.appendChild(document.createTextNode(" "))}else if(e.svg){const t=document.createElement("img");t.src=e.svg,t.alt=e.text,t.className="aim-hover-menu-svg-icon",o.appendChild(t)}else o.appendChild(document.createTextNode(e.text));o.setAttribute("title",e.text),t.appendChild(o)})),t}let n={base64:"WyI0cjVlIiwiNWgxdCIsIjVoaXQiLCJhNTUiLCJhbmFsIiwiYW51cyIsImFyNWUiLCJhcnJzZSIsImFyc2UiLCJhc3MiLCJhc3MtZnVja2VyIiwiYXNzZXMiLCJhc3NmdWNrZXIiLCJhc3NmdWtrYSIsImFzc2hvbGUiLCJhc3Nob2xlcyIsImFzc3dob2xlIiwiYV9zX3MiLCJiIXRjaCIsImIwMGJzIiwiYjE3Y2giLCJiMXRjaCIsImJhbGxiYWciLCJiYWxscyIsImJhbGxzYWNrIiwiYmFzdGFyZCIsImJlYXN0aWFsIiwiYmVhc3RpYWxpdHkiLCJiZWxsZW5kIiwiYmVzdGlhbCIsImJlc3RpYWxpdHkiLCJiaStjaCIsImJpYXRjaCIsImJpdGNoIiwiYml0Y2hlciIsImJpdGNoZXJzIiwiYml0Y2hlcyIsImJpdGNoaW4iLCJiaXRjaGluZyIsImJsb29keSIsImJsb3cgam9iIiwiYmxvd2pvYiIsImJsb3dqb2JzIiwiYm9pb2xhcyIsImJvbGxvY2siLCJib2xsb2siLCJib25lciIsImJvb2IiLCJib29icyIsImJvb29icyIsImJvb29vYnMiLCJib29vb29icyIsImJvb29vb29vYnMiLCJicmVhc3RzIiwiYnVjZXRhIiwiYnVnZ2VyIiwiYnVtIiwiYnVubnkgZnVja2VyIiwiYnV0dCIsImJ1dHRob2xlIiwiYnV0dG11bmNoIiwiYnV0dHBsdWciLCJjMGNrIiwiYzBja3N1Y2tlciIsImNhcnBldCBtdW5jaGVyIiwiY2F3ayIsImNoaW5rIiwiY2lwYSIsImNsMXQiLCJjbGl0IiwiY2xpdG9yaXMiLCJjbGl0cyIsImNudXQiLCJjb2NrIiwiY29jay1zdWNrZXIiLCJjb2NrZmFjZSIsImNvY2toZWFkIiwiY29ja211bmNoIiwiY29ja211bmNoZXIiLCJjb2NrcyIsImNvY2tzdWNrICIsImNvY2tzdWNrZWQgIiwiY29ja3N1Y2tlciIsImNvY2tzdWNraW5nIiwiY29ja3N1Y2tzICIsImNvY2tzdWthIiwiY29ja3N1a2thIiwiY29rIiwiY29rbXVuY2hlciIsImNva3N1Y2thIiwiY29vbiIsImNveCIsImNyYXAiLCJjdW0iLCJjdW1tZXIiLCJjdW1taW5nIiwiY3VtcyIsImN1bXNob3QiLCJjdW5pbGluZ3VzIiwiY3VuaWxsaW5ndXMiLCJjdW5uaWxpbmd1cyIsImN1bnQiLCJjdW50bGljayAiLCJjdW50bGlja2VyICIsImN1bnRsaWNraW5nICIsImN1bnRzIiwiY3lhbGlzIiwiY3liZXJmdWMiLCJjeWJlcmZ1Y2sgIiwiY3liZXJmdWNrZWQgIiwiY3liZXJmdWNrZXIiLCJjeWJlcmZ1Y2tlcnMiLCJjeWJlcmZ1Y2tpbmcgIiwiZDFjayIsImRhbW4iLCJkaWNrIiwiZGlja2hlYWQiLCJkaWxkbyIsImRpbGRvcyIsImRpbmsiLCJkaW5rcyIsImRpcnNhIiwiZGxjayIsImRvZy1mdWNrZXIiLCJkb2dnaW4iLCJkb2dnaW5nIiwiZG9ua2V5cmliYmVyIiwiZG9vc2giLCJkdWNoZSIsImR5a2UiLCJlamFjdWxhdGUiLCJlamFjdWxhdGVkIiwiZWphY3VsYXRlcyAiLCJlamFjdWxhdGluZyAiLCJlamFjdWxhdGluZ3MiLCJlamFjdWxhdGlvbiIsImVqYWt1bGF0ZSIsImYgdSBjIGsiLCJmIHUgYyBrIGUgciIsImY0bm55IiwiZmFnIiwiZmFnZ2luZyIsImZhZ2dpdHQiLCJmYWdnb3QiLCJmYWdncyIsImZhZ290IiwiZmFnb3RzIiwiZmFncyIsImZhbm55IiwiZmFubnlmbGFwcyIsImZhbm55ZnVja2VyIiwiZmFueXkiLCJmYXRhc3MiLCJmY3VrIiwiZmN1a2VyIiwiZmN1a2luZyIsImZlY2siLCJmZWNrZXIiLCJmZWxjaGluZyIsImZlbGxhdGUiLCJmZWxsYXRpbyIsImZpbmdlcmZ1Y2sgIiwiZmluZ2VyZnVja2VkICIsImZpbmdlcmZ1Y2tlciAiLCJmaW5nZXJmdWNrZXJzIiwiZmluZ2VyZnVja2luZyAiLCJmaW5nZXJmdWNrcyAiLCJmaXN0ZnVjayIsImZpc3RmdWNrZWQgIiwiZmlzdGZ1Y2tlciAiLCJmaXN0ZnVja2VycyAiLCJmaXN0ZnVja2luZyAiLCJmaXN0ZnVja2luZ3MgIiwiZmlzdGZ1Y2tzICIsImZsYW5nZSIsImZvb2siLCJmb29rZXIiLCJmdWNrIiwiZnVja2EiLCJmdWNrZWQiLCJmdWNrZXIiLCJmdWNrZXJzIiwiZnVja2hlYWQiLCJmdWNraGVhZHMiLCJmdWNraW4iLCJmdWNraW5nIiwiZnVja2luZ3MiLCJmdWNraW5nc2hpdG1vdGhlcmZ1Y2tlciIsImZ1Y2ttZSAiLCJmdWNrcyIsImZ1Y2t3aGl0IiwiZnVja3dpdCIsImZ1ZGdlIHBhY2tlciIsImZ1ZGdlcGFja2VyIiwiZnVrIiwiZnVrZXIiLCJmdWtrZXIiLCJmdWtraW4iLCJmdWtzIiwiZnVrd2hpdCIsImZ1a3dpdCIsImZ1eCIsImZ1eDByIiwiZl91X2NfayIsImdhbmdiYW5nIiwiZ2FuZ2JhbmdlZCAiLCJnYW5nYmFuZ3MgIiwiZ2F5bG9yZCIsImdheXNleCIsImdvYXRzZSIsImdvZC1kYW0iLCJnb2QtZGFtbmVkIiwiZ29kZGFtbiIsImdvZGRhbW5lZCIsImhhcmRjb3Jlc2V4ICIsImhlbGwiLCJoZXNoZSIsImhvYXIiLCJob2FyZSIsImhvZXIiLCJob21vIiwiaG9yZSIsImhvcm5pZXN0IiwiaG9ybnkiLCJob3RzZXgiLCJqYWNrLW9mZiAiLCJqYWNrb2ZmIiwiamFwIiwiamVyay1vZmYgIiwiamlzbSIsImppeiAiLCJqaXptICIsImppenoiLCJrYXdrIiwia25vYiIsImtub2JlYWQiLCJrbm9iZWQiLCJrbm9iZW5kIiwia25vYmhlYWQiLCJrbm9iam9ja3kiLCJrbm9iam9rZXkiLCJrb2NrIiwia29uZHVtIiwia29uZHVtcyIsImt1bSIsImt1bW1lciIsImt1bW1pbmciLCJrdW1zIiwia3VuaWxpbmd1cyIsImtpdW50IiwibDNpK2NoIiwibDNpdGNoIiwibGFiaWEiLCJsbWZhbyIsImx1c3QiLCJsdXN0aW5nIiwibTBmMCIsIm0wZm8iLCJtNDV0ZXJiYXRlIiwibWE1dGVyYjgiLCJtYTV0ZXJiYXRlIiwibWFzb2NoaXN0IiwibWFzdGVyLWJhdGUiLCJtYXN0ZXJiOCIsIm1hc3RlcmJhdCoiLCJtYXN0ZXJiYXQzIiwibWFzdGVyYmF0ZSIsIm1hc3RlcmJhdGlvbiIsIm1hc3RlcmJhdGlvbnMiLCJtYXN0dXJiYXRlIiwibW8tZm8iLCJtb2YwIiwibW9mbyIsIm1vdGhhZnVjayIsIm1vdGhhZnVja2EiLCJtb3RoYWZ1Y2thcyIsIm1vdGhhZnVja2F6IiwibW90aGFmdWNrZWQgIiwibW90aGFmdWNrZXIiLCJtb3RoYWZ1Y2tlcnMiLCJtb3RoYWZ1Y2tpbiIsIm1vdGhhZnVja2luZyAiLCJtb3RoYWZ1Y2tpbmdzIiwibW90aGFmdWNrcyIsIm1vdGhlciBmdWNrZXIiLCJtb3RoZXJmdWNrIiwibW90aGVyZnVja2VkIiwibW90aGVyZnVja2VyIiwibW90aGVyZnVja2VycyIsIm1vdGhlcmZ1Y2tpbiIsIm1vdGhlcmZ1Y2tpbmciLCJtb3RoZXJmdWNraW5ncyIsIm1vdGhlcmZ1Y2trYSIsIm1vdGhlcmZ1Y2tzIiwibXVmZiIsIm11dGhhIiwibXV0aGFmZWNrZXIiLCJtdXRoYWZ1Y2trZXIiLCJtdXRoZXIiLCJtdXRoZXJmdWNrZXIiLCJuMWdnYSIsIm4xZ2dlciIsIm5hemkiLCJuaWdnM3IiLCJuaWdnNGgiLCJuaWdnYSIsIm5pZ2dhaCIsIm5pZ2dhcyIsIm5pZ2dheiIsIm5pZ2dlciIsIm5pZ2dlcnMiLCJub2IiLCJub2Igam9rZXkiLCJub2JoZWFkIiwibm9iam9ja3kiLCJub2Jqb2tleSIsIm51bWJudXRzIiwibnV0c2FjayIsIm9yZ2FzaW0gIiwib3JnYXNpbXMgIiwib3JnYXNtIiwib3JnYXNtcyAiLCJwMHJuIiwicGF3biIsInBlY2tlciIsInBlbmlzIiwicGVuaXNmdWNrZXIiLCJwaG9uZXNleCIsInBodWNrIiwicGh1ayIsInBodWtlZCIsInBodWtpbmciLCJwaHVra2VkIiwicGh1a2tpbmciLCJwaHVrcyIsInBodXEiLCJwaWdmdWNrZXIiLCJwaW1waXMiLCJwaXNzIiwicGlzc2VkIiwicGlzc2VyIiwicGlzc2VycyIsInBpc3NlcyAiLCJwaXNzZmxhcHMiLCJwaXNzaW4gIiwicGlzc2luZyIsInBpc3NvZmYgIiwicG9vcCIsInBvcm4iLCJwb3JubyIsInBvcm5vZ3JhcGh5IiwicG9ybm9zIiwicHJpY2siLCJwcmlja3MgIiwicHJvbiIsInB1YmUiLCJwdXNzZSIsInB1c3NpIiwicHVzc2llcyIsInB1c3N5IiwicHVzc3lzICIsInJlY3R1bSIsInJldGFyZCIsInJpbWphdyIsInJpbW1pbmciLCJzIGhpdCIsInMuby5iLiIsInNhZGlzdCIsInNjaGxvbmciLCJzY3Jld2luZyIsInNjcm9hdCIsInNjcm90ZSIsInNjcm90dW0iLCJzZW1lbiIsInNleCIsInNoISsiLCJzaCF0Iiwic2gxdCIsInNoYWciLCJzaGFnZ2VyIiwic2hhZ2dpbiIsInNoYWdnaW5nIiwic2hlbWFsZSIsInNoaSsiLCJzaGl0Iiwic2hpdGRpY2siLCJzaGl0ZSIsInNoaXRlZCIsInNoaXRleSIsInNoaXRmdWNrIiwic2hpdGZ1bGwiLCJzaGl0aGVhZCIsInNoaXRpbmciLCJzaGl0aW5ncyIsInNoaXRzIiwic2hpdHRlZCIsInNoaXR0ZXIiLCJzaGl0dGVycyAiLCJzaGl0dGluZyIsInNoaXR0aW5ncyIsInNoaXR0eSAiLCJza2FuayIsInNsdXQiLCJzbHV0cyIsInNtZWdtYSIsInNtdXQiLCJzbmF0Y2giLCJzb24tb2YtYS1iaXRjaCIsInNwYWMiLCJzcHVuayIsInNfaF9pX3QiLCJ0MXR0MWU1IiwidDF0dGllcyIsInRlZXRzIiwidGVleiIsInRlc3RpY2FsIiwidGVzdGljbGUiLCJ0aXQiLCJ0aXRmdWNrIiwidGl0cyIsInRpdHQiLCJ0aXR0aWU1IiwidGl0dGllZnVja2VyIiwidGl0dGllcyIsInRpdHR5ZnVjayIsInRpdHR5d2FuayIsInRpdHdhbmsiLCJ0b3NzZXIiLCJ0dXJkIiwidHc0dCIsInR3YXQiLCJ0d2F0aGVhZCIsInR3YXR0eSIsInR3dW50IiwidHd1bnRlciIsInYxNGdyYSIsInYxZ3JhIiwidmFnaW5hIiwidmlhZ3JhIiwidnVsdmEiLCJ3MDBzZSIsIndhbmciLCJ3YW5rIiwid2Fua2VyIiwid2Fua3kiLCJ3aG9hciIsIndob3JlIiwid2lsbGllcyIsIndpbGx5IiwieHJhdGVkIiwieHh4Il0="};function i(e){let t=(e.text||e.content||"").match(/https?:\/\/(?:[^\s()<>\[\]{}"']+|\([^\s()]*?\))+/gi);if(t&&function(e){if(!e)return!1;e=e.trim();try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}(t[0])){let o=t[0];e.card={url:o,type:"website"};try{const t=new URL(o),s=t.pathname.split(".").pop().toLowerCase();s&&(buddypond.supportedImageTypesExt.includes(s)?e.card.type="image":buddypond.supportedAudioTypesExt.includes(s)?e.card.type="audio":buddypond.supportedVideoTypesExt.includes(s)&&(e.card.type="video"))}catch(e){console.warn("Invalid URL:",o,e)}if(function(e){const t=e.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);return t?t[1]:null}(o)){const t=new URL(o).searchParams.get("v");t&&(e.card.type="youtube",e.card.thumbnail=`https://img.youtube.com/vi/${t}/0.jpg`,e.card.context=t)}if(function(e){const t=e.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/);return t?t.slice(1):null}(o)){e.card.type="github";const t=/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/,s=o.match(t);s?(e.card.owner=s[1],e.card.repo=s[2],e.card.filename=s[4]):console.error("Invalid GitHub URL format.")}}}function a(e,t,o){const s=$(".aim-input",o.content),n=$(".message_form",o.content),i=$(".aim-send-btn",o.content);let a=this;s.on("input",(function(e){const t=$(".aim-send-btn",o.content);a.handleEmojiInput(e,t);const n=this.selectionStart,i=s.val(),d=a.getInputContext(i,n);d&&("emoji"===d.type&&d.text.length>=2||"command"===d.type)?$(this).autocomplete("search",d.text):$(this).autocomplete("close")})),s.on("keydown",(d=>{if(13===d.which&&d.shiftKey){const e=s.val(),t=s[0].selectionStart,o=e.slice(0,t)+"\n"+e.slice(t);return s.val(o),s[0].setSelectionRange(t+1,t+1),i.css("opacity",o.length>0?1:.5),!1}if(13===d.which&&s.autocomplete("widget").is(":visible")){const e=s.val();return e.startsWith("/")||e.startsWith("\\")?(n.submit(),d.preventDefault(),!1):(d.preventDefault(),!1)}if(9===d.which)return d.preventDefault(),!1;if(13===d.which){let e=s.val().replace(/\n/g,"<br>");return e=a.replaceShortcodes(e),s.autocomplete("close"),s.val(e),n.submit(),d.preventDefault(),!1}let r=o.currentActiveContext||t;this.bp.emit("buddy::typing",{from:this.bp.me,to:r,type:e,isTyping:!0,ctime:Date.now()})})),s.on("keyup",(e=>{const t=s.val();i.css("opacity",t.length>0?1:.5)}))}function d(e){if(!this.options.autocomplete)return;const t=$(".aim-input",e.content);$(".message_form",e.content);const o=$(".aim-send-btn",e.content);if(this.replaceShortcodes=c.bind(this),!this.emojiMap){const e=new Set;this.emojiMap=Object.keys(EMOJIS).reduce(((t,o)=>(EMOJIS[o].filter(r).forEach((s=>{const n=`:${s}:`;e.has(n)||(t[n]=o,e.add(n))})),t)),{})}function s(e,t){const o=e.slice(0,t);e.slice(t);const s=o.lastIndexOf(":");if(-1!==s){let o=t;const n=e.indexOf(":",t);if(-1!==n){const t=e.slice(s,n+1);/^:[a-z0-9_+]+:$/.test(t)&&(o=n+1)}const i=e.slice(s,o);if(/^:[a-z0-9_+]*(?::|$)/.test(i))return{type:"emoji",text:i,startIndex:s,endIndex:o}}const n=o.charAt(0);return["/","\\"].includes(n)?{type:"command",text:o,startIndex:0,endIndex:t}:null}this.emojiSuggestions||(this.emojiSuggestions=Object.keys(EMOJIS).reduce(((e,t)=>(EMOJIS[t].filter(r).forEach((o=>{e.push({label:`${t} :${o}:`,value:`:${o}:`,emoji:t,type:"emoji"})})),e)),[])),this.commands||(this.commands=Object.keys(this.options.autocomplete).map((e=>({label:`/${e}`,value:`/${e}`,type:"command"})))),this.handleEmojiInput=l.bind(this),this.getInputContext=s.bind(this);let n=this;t.autocomplete({focus:function(e,t){return e.preventDefault(),!1},source:function(e,o){const i=t[0].selectionStart,a=s(t.val(),i);if(a)if("emoji"===a.type&&a.text.length>=2){const e=a.text.replace(/^:|:$/g,"").toLowerCase();o(n.emojiSuggestions.filter((t=>t.value.toLowerCase().includes(e))).slice(0,10))}else if("command"===a.type){const e=a.text.slice(1).toLowerCase();if(n.commands.sort(((e,t)=>e.value.localeCompare(t.value))),0===e.length)return void o(n.commands);o(n.commands.filter((t=>t.value.toLowerCase().startsWith("/"+e))))}else o([]);else o([])},select:function(e,n){const i=t[0],a=i.selectionStart,d=t.val(),r=s(d,a);if(r){const e=d.slice(0,r.startIndex),s=d.slice(r.endIndex),a=e+(n.item.emoji||n.item.value)+s;t.val(a);const c=r.startIndex+n.item.value.length;return i.setSelectionRange(c,c),"emoji"===n.item.type&&t.trigger("input"),o.css("opacity",a.length>0?1:.5),!1}return t.autocomplete("close"),!1},minLength:0,position:{my:"left bottom",at:"left top",collision:"none"},open:function(){$(".ui-autocomplete").css({"max-height":"200px","overflow-y":"auto","z-index":1e3})}}),t.on("input",(function(){$(this).autocomplete("search")}))}function r(e){return/^[a-z0-9_+]+$/.test(e)&&!e.startsWith(":")&&!e.includes(" ")}function c(e){return e.replace(/:[a-z0-9_+]+:/g,(e=>this.emojiMap[e]||e))}function l(e,t){const o=e.target,s=$(o),n=o.selectionStart,i=s.val(),a=c.call(this,i);if(a!==i){s.val(a);const e=n+(a.length-i.length);o.setSelectionRange(e,e),t.css("opacity",a.length>0?1:.5)}}n.randowFunWord=function(){let e=["daffodil","chrysanthemum","waffles","puppies","senpai","kohai","rainbow","fluffy","marklar"];return e[Math.floor(Math.random()*e.length)]},n.containsBadWord=function(e){const t=e.toLowerCase();return n.decoded.some((function(e){return new RegExp(`\\b${e}\\b`,"i").test(t)}))},n.filter=function(e){return n.decoded.forEach((function(t){e=(e=e.replace(new RegExp("\\b"+t+"\\b"),n.randowFunWord())).replace(new RegExp("\\b"+t+"\\b","gi"),n.randowFunWord())})),e},n.decoded=JSON.parse(atob(n.base64));class p{constructor(e,t={}){this.bp=e,this.options=t,console.log("ChatWindowButtonBar options",t);const o=t.buttons||[],s=this.bp.settings?.["buttonBar.buttons"];return Array.isArray(s)?this.buttons=this.sortButtonsByOrder(o,s):this.buttons=o,this.container=this.render(),this.enableDragAndDrop(),this}render(){const e=document.createElement("div");return e.classList.add("button-bar"),this.buttons.forEach((t=>{const o=this.createButtonElement(t,!0);e.appendChild(o)})),e}createButtonElement(e,t=!1){const o=document.createElement("div");let s;o.classList.add("button-bar-item"),t&&(o.classList.add("button-bar-item--root"),o.dataset.text=e.text),e.image?(s=document.createElement("img"),s.src=e.image,s.alt=e.text,s.title=e.text,s.draggable=!1):e.icon?(s=document.createElement("span"),s.innerHTML=e.icon):(s=document.createElement("button"),s.innerText=e.text);const n={context:this.options.context||e.text,type:this.options.type||"buddy",text:e.text};if(Object.entries(n).forEach((([e,t])=>s.dataset[e]=t)),s.classList.add("button-bar-button"),e.className&&s.classList.add(e.className),Array.isArray(e.children)&&e.children.length>0){o.classList.add("has-children");const t=document.createElement("div");t.classList.add("button-dropdown"),t.style.display="none",e.children.forEach((e=>{const o=document.createElement("div");o.classList.add("dropdown-item");const s=this.createButtonElement(e,!1);s.classList.remove("button-bar-item");const i=document.createElement("span");i.innerText=e.text,i.classList.add("dropdown-label"),o.appendChild(s),o.appendChild(i);Object.entries(n).forEach((([e,t])=>o.dataset[e]=t)),Object.entries(n).forEach((([e,t])=>s.dataset[e]=t)),Object.entries(n).forEach((([e,t])=>i.dataset[e]=t)),o.addEventListener("click",(o=>{o.stopPropagation(),"function"==typeof e.onclick&&e.onclick(o),t.style.display="none"})),t.appendChild(o)})),s.addEventListener("click",(e=>{e.stopPropagation(),t.style.display="none"===t.style.display?"block":"none"})),document.addEventListener("click",(()=>{t.style.display="none"})),o.appendChild(s),o.appendChild(t)}else"function"==typeof e.onclick&&s.addEventListener("click",e.onclick),o.appendChild(s);return o}addButton(e){if(this.buttons.some((t=>t.text===e.text)))return void console.warn(`Button with text "${e.text}" already exists.`);this.buttons.push(e);const t=this.createButtonElement(e,!0);this.container.appendChild(t),this.refreshSortable()}removeButton(e){const t=this.buttons.findIndex((t=>t.text===e));if(-1===t)return;this.buttons.splice(t,1);const o=Array.from(this.container.children).filter((e=>e.classList.contains("button-bar-item--root")));for(const t of o)if(t.dataset.text===e){this.container.removeChild(t);break}this.refreshSortable(),this.saveButtonOrder()}enableDragAndDrop(){$(this.container).sortable({items:".button-bar-item--root",tolerance:"pointer",stop:()=>this.syncButtonOrder()})}refreshSortable(){$(this.container).sortable("refresh")}syncButtonOrder(){const e=Array.from(this.container.children).filter((e=>e.classList.contains("button-bar-item--root"))).map((e=>e.dataset.text));console.log("syncButtonOrder orderedTexts",e),this.buttons=e.map((e=>this.buttons.find((t=>t.text===e)))).filter(Boolean),console.log("syncButtonOrder new this.buttons",this.buttons),this.saveButtonOrder()}saveButtonOrder(){console.log("saveButtonOrder this.buttons",this.buttons);const e=this.buttons.map((e=>e.text));this.bp.set("buttonBar.buttons",e);this.bp.apps.ui.windowManager.findWindows({app:"buddylist",type:["buddy","pond"]}).forEach((t=>{t.buttonBar&&(t.buttonBar.buttons=this.sortButtonsByOrder(t.buttonBar.buttons,e),t.buttonBar.reRenderButtons())}))}reRenderButtons(){this.container.innerHTML="",this.buttons.forEach((e=>{const t=this.createButtonElement(e,!0);this.container.appendChild(t)})),this.refreshSortable()}sortButtonsByOrder(e,t){const o=Object.fromEntries(e.map((e=>[e.text,e])));return[...t.map((e=>o[e])).filter(Boolean),...e.filter((e=>!t.includes(e.text)))]}}function m(e,t,o){if(!this.options.chatWindowButtons)return;let s=this.options.chatWindowButtons.slice();"pond"===e&&(s=s.filter((e=>"buddy-only"!==e.type))),this.bp.isMobile()&&"buddy"===e&&(s=s.filter((e=>"BuddyHelp"!==e.text))),/iPad|iPhone|iPod/.test(navigator.userAgent)&&"ontouchend"in document&&(s=s.filter((e=>"desktop-only"!==e.env))),o.buttonBar=new p(this.bp,{context:t,type:e,buttons:s}),$(".aim-message-controls",o.content).prepend(o.buttonBar.container)}function u(e,t,o=null){const s=$(".aim-room-list-items",t.content);if(!s.length)return;if(!e||!Array.isArray(e))return;const n=[...e].sort(((e,t)=>t.connection_count-e.connection_count)),i=this.data.activePonds||[],a=new Map,d=new Set;s.find(".aim-room-item").each(((e,t)=>{const o=$(t).data("pond");o&&(a.set(o,$(t)),d.add(o))})),n.forEach((e=>{const t=e.pond_id;let n=t.replace("pond/","");const r=i.includes(t),c=t===o;n=$("<div>").text(n).html();const l=a.get(t);if(l){const s=l.find(".aim-room-list-item-score");s.text()!==String(e.connection_count)&&(console.log(`Updating connection_count for ${t}: ${e.connection_count}`),s.text(e.connection_count));const n=l.find(".aim-room-close-btn");if(r?n.length||(console.log(`Adding close button for ${t}`),l.append(`<button class="aim-room-close-btn" data-context="${t}">X</button>`)):n.length&&(console.log(`Removing close button for ${t}`),n.remove()),null!==o){const e=c;l.hasClass("aim-room-active")!==e&&(console.log(`Updating active class for ${t}: ${e}`),l.toggleClass("aim-room-active",e))}d.delete(t)}else{const i=r?`<button class="aim-room-close-btn" data-context="${t}">X</button>`:"",d=$(`\n                <li class="aim-room-item aim-room-list-item${c&&null!==o?" aim-room-active":""}" data-pond="${t}" data-context="${t}">\n                    <span class="aim-room-list-item-name">#${n}</span>\n                    <span class="aim-room-list-item-score">${e.connection_count}</span>\n                    ${i}\n                </li>\n            `);s.append(d),a.set(t,d)}})),d.forEach((e=>{console.log(`Removing room item for ${e}`),a.get(e)?.remove(),a.delete(e)}));let r=null;n.forEach((e=>{const t=a.get(e.pond_id);if(t){if(r){const o=r.next();o.length&&o.data("pond")===e.pond_id||(console.log(`Moving ${e.pond_id} after ${r.data("pond")}`),t.insertAfter(r))}else{const o=s.children().first();o.length&&o.data("pond")===e.pond_id||(console.log(`Moving ${e.pond_id} to top`),t.prependTo(s))}r=t}})),null!==o&&(console.log(`Ensuring only ${o} has .aim-room-active`),s.find(".aim-room-item").not(`[data-pond="${o}"]`).removeClass("aim-room-active"),a.get(o)&&a.get(o).addClass("aim-room-active"))}function h(e){const t=e.chatId;if(!t)return void console.log("No chatId provided for updating pond connected users");let o=t.replace("pond/","");const s=$(`.aim-user-list[data-context="${o}"][data-type="pond"] .aim-user-list-items`);if(!s.length)return void console.log(`No .aim-user-list-items found for chatId: ${t}`);const n=new Set;s.find(".aim-user-item").each(((e,t)=>{let o=$(t).data("username");o?(o=o.toString(),n.add(o)):$(t).remove()})),(e.users||[]).forEach((e=>{let{userId:t,profilePicture:o}=e;if(t=t?t.toString():null,!t||"string"!=typeof t)return void console.log("Skipping invalid user with missing or non-string userId:",e);const i=$(`.aim-user-item[data-username="${t}"]`,s);if(i.length){const e=i.find(".aim-user-item-text");e.text()!==t&&e.text(t);const s=i.find(".aim-profile-picture"),a=g.call(this,t,o,s);a&&s.empty().append(a.html()),n.delete(t)}else{const e=$("<li>",{class:"aim-user-item","data-username":t}),n=g.call(this,t,o),i=$("<span>",{class:"aim-user-item-text",text:t});e.append(n,i),s.append(e)}})),n.forEach((e=>{e=e.toString(),$(`.aim-user-item[data-username="${e}"]`,s).remove()}))}function g(e,t,o=null){const s=$("<div>",{class:"aim-profile-picture"});if(window.discordMode&&(t=t.replace("https://files.buddypond.com",bp.config.cdn)),t){const n=$("<img>",{class:"aim-chat-message-profile-picture-img",src:t,alt:`${e}'s avatar`});if(n.attr("draggable","false"),s.append(n),o){const e=o.find(".aim-chat-message-profile-picture-img");if(e.length&&e.attr("src")===t)return null}}else{const t=this.defaultAvatarSvg(e);if(s.html(t),o){if(o.html().trim()===t.trim())return null}}return s}function b(e){const t=e.replace("pond/","");return!this.forbiddenNotes.containsBadWord(t)||(console.error("Forbidden context name:",e),alert("Pond name not allowed, please choose a different name."),!1)}function y(e,t,o,s,n){"pond"===t&&(console.log("Opening pond window",t,o),x.call(this,o,e,s),k.call(this,o,e)),e.focus()}function f({windowType:e,contextName:t,windowTitle:o,windowId:s,client:n,data:i}){const a=w.call(this,e,t,o,s,i),d=this.bp.apps.ui.windowManager.createWindow({...a,onOpen:async o=>{await I.call(this,e,t,o,n)},onClose:o=>{if("pond"===e){if($(".aim-room-list-items",d.content).find(".aim-room-item").each(((e,t)=>{const o=$(t).data("context");n.removeSubscription("pond",o)})),this.data.activePonds=[],"pond-chat"===o.id)for(let[e,t]of bp.apps.client.messagesWsClients)e.startsWith("pond/")&&t.wsClient.closeConnection()}else n.removeSubscription(e,t)}});return"pond"===e&&(M.call(this,d,n),$(".no-open-ponds",d.content).hide(),$(".aim-message-controls",d.content).flexShow()),d.loggedIn=!0,d}function w(e,t,o,s,n){const i="buddy"===e;let a=i?"":"desktop/assets/images/icons/icon_pond_64.png";i&&this.bp.apps.buddylist.data.profileState?.buddylist?.[t]?.profile_picture&&(a=this.bp.apps.buddylist.data.profileState.buddylist[t].profile_picture);let d=i?500:Math.floor(.8*window.innerHeight),r=i?600:Math.floor(.75*window.innerWidth);return this.bp.isMobile()&&(d="calc(var(--vh) * 90)"),{app:"buddylist",id:s,title:i?t:o,icon:a,type:e,context:t,parent:this.bp.apps.ui.parent,className:"chatWindow",x:n.x||10,y:50,width:r,height:d}}async function I(e,t,o,s){if(console.log("initializeChatWindow",e,t,o),S.call(this,e,t,o,s),s.addSubscription(e,t),"buddy"===e&&(console.log(`Opening buddy chat window for: ${t}`),$(".aim-chat-area",o.content).css("margin-top","0"),$(".aim-chat-area",o.content).css("top","10px"),v.call(this,t)),"pond"===e){let e=this.bp.apps?.pond?.data?.hotPonds||[];u.call(this,e,o,t),k.call(this,t,o)}await C.call(this,t,o),this.bp.isMobile()||function(e){function t(){const o=$(".aim-input",e.content);0!==o.length?o.focus():setTimeout(t,100)}t()}(o)}function v(e){this.data.profileState?.buddylist?.[e]?.newMessages&&(this.data.profileState.buddylist[e].newMessages=!1,this.buddyServerClient.receivedInstantMessage(e,((e,t)=>{})))}async function C(e,t){this.data.processedMessages[e]=this.data.processedMessages[e]||[];const o=[...this.data.processedMessages[e]];this.data.processedMessages[e]=[];for(const e of o)try{await this.renderChatMessage(e,t,!0)}catch(o){console.error("Error rendering message",e,o,t)}}function x(e,t,o){const s=$(".aim-chat-area",t.content),n=$(".aim-user-list-area",t.content);if(!s.length||!n.length)return void console.log("Missing chatArea or userListArea for context:",e);let i=e.replace("pond/","");if(i=$("<div>").text(i).html(),!$(`.aim-messages-container[data-context="${e}"]`,s).length){console.log("Creating new messages container for context:",e);const n=document.createElement("div");n.className="aim-messages-container",n.setAttribute("data-context",e),n.setAttribute("data-type","pond"),n.style.display="none",n.innerHTML=`\n            <div class="aim-messages-header">\n                <h2 class="aim-chat-title"><span class="aim-chat-username">#${i}</span></h2>\n                <button class="aim-close-chat-btn" data-context="${e}">Close</button>\n            </div>\n            <div class="aim-no-messages">\n                Your conversation has just started. You can send a message using the form below.\n            </div>\n            <div class="aim-messages"></div>\n        `,s.append(n),o.addSubscription("pond",e),this.data.activePonds=this.data.activePonds||[],this.data.activePonds.includes(e)||this.data.activePonds.push(e),$(".no-open-ponds",t.content).hide(),$(".aim-message-controls",t.content).flexShow()}if(!$(`.aim-user-list[data-context="${i}"][data-type="pond"]`,n).length){console.log("Creating new user list for context:",i);const e=document.createElement("div");e.className="aim-user-list",e.setAttribute("data-context",i),e.setAttribute("data-type","pond"),e.style.display="none",e.innerHTML='\n            <div class="aim-user-list-header">\n                <h3>Buddies</h3>\n            </div>\n            <ul class="aim-user-list-items"></ul>\n        ',n.append(e)}}function k(e,t){const o=$(".aim-chat-area",t.content),s=$(".aim-user-list-area",t.content);if(!o.length||!s.length)return void console.log("Missing chatArea or userListArea for context:",e);$(".aim-messages-container",o).hide(),$(".aim-user-list",s).hide();const n=e.replace("pond/","");t.currentActiveContext=n;const i=$(`.aim-messages-container[data-context="${e}"][data-type="pond"]`,o),a=$(`.aim-user-list[data-context="${n}"][data-type="pond"]`,s);if(i.length||(console.log("Creating messages container for context:",e),x.call(this,e,t,this.bp.apps.client),i=$(`.aim-messages-container[data-context="${e}"][data-type="pond"]`,o)),i.length&&i.show(),a.length&&a.show(),!i.length||!a.length){const e=$(".aim-messages-container",o);if(e.length>0){const n=e.first().data("context"),i=n.replace("pond/","");$(`.aim-messages-container[data-context="${n}"]`,o).show(),$(`.aim-user-list[data-context="${i}"][data-type="pond"]`,s).show(),$(".aim-room-item",t.content).removeClass("aim-room-active"),$(`.aim-room-item[data-context="${n}"]`,t.content).addClass("aim-room-active"),$(".message_form .aim-to",t.content).val(n)}else console.log("No available message containers or user lists")}let d=$(".button-bar",t.content);d.length&&d.children().each(((t,o)=>{$(o).attr("data-context",e)})),this.scrollToBottom(t.content)}function S(e,t,o,s){const n=this.messageTemplateString,i=document.createElement("div");i.innerHTML=n;const r=$(".aim-messages-container",i)[0];if(r.setAttribute("data-context",t),r.setAttribute("data-type",e),"buddy"===e)$(".aim-user-list-area",i).remove(),$(".aim-room-list",i).remove(),$(".aim-messages-header",i).remove(),o.container.classList.add("has-droparea"),o.content.appendChild($(".aim-window",i)[0]);else{const l=$(".aim-user-list",i)[0];l.setAttribute("data-context",t),l.setAttribute("data-type",e),this.bp.isMobile()?($(".aim-close-chat-btn",i).text("Close #"+t.replace("pond/","")),$(".aim-chat-title",i).remove()):$(".aim-chat-title",i).text(`#${t.replace("pond/","")}`),$(".joinPondForm",i).on("submit",(e=>{e.preventDefault();try{let e=$(".customPondName").val();N.call(this,e)}catch(e){console.error("Error joining pond:",e)}return!1})),o.container.classList.add("has-droparea"),o.content.appendChild($(".aim-window",i)[0]);const p=$(".aim-window",o.content)[0];let u=0,h=0;function g(){const e=h-u;e>50?(p.classList.remove("show-room-list"),p.classList.add("show-user-list")):e<-50?(p.classList.remove("show-user-list"),p.classList.add("show-room-list")):p.classList.remove("show-room-list","show-user-list")}p.addEventListener("touchstart",(e=>{u=e.changedTouches[0].screenX})),p.addEventListener("touchend",(e=>{h=e.changedTouches[0].screenX,g()}));const b=document.createElement("div");b.className="pond-button-bar",b.setAttribute("data-context",t),b.setAttribute("data-type",e);const y=document.createElement("button");y.textContent="Ponds",y.className="toggle-room-list";const f=document.createElement("button");f.textContent="Buddies",f.className="toggle-user-list";const w=document.createElement("button");w.textContent="Close #"+t.replace("pond/",""),w.classList.add("aim-close-pond-chat-btn"),w.classList.add("aim-room-close-btn"),w.setAttribute("data-context",t),w.setAttribute("data-type",e),o.content.appendChild(b),o.content.append(y,w,f),M.call(this,o,s),y.addEventListener("click",(()=>{p.classList.toggle("show-room-list"),p.classList.remove("show-user-list")})),f.addEventListener("click",(()=>{p.classList.toggle("show-user-list"),p.classList.remove("show-room-list")}))}d.call(this,o),m.call(this,e,t,o),L.call(this,e,t,o),a.call(this,e,t,o);const c=$(".aim-close-chat-btn",o.content);c.length?c.attr("data-context",t):console.warn("No close button found in chat window for context:",t),"pond"===e&&($(".aim-user-list-items").on("click",(e=>{const t=$(e.target).closest(".aim-user-item").data("username");t?this.openChatWindow({name:t}):console.error("No username found in clicked element")})),W.call(this,o))}function L(e,t,o){$(".message_form .aim-to",o.content).val(t),$(".message_form",o.content).submit((async s=>{s.preventDefault(),await this.sendMessageHandler(s,o,e,t)}))}function W(e){$(".aim-room-list-items",e.content).on("click",".aim-room-item",(t=>{let o=$(t.target).parent().data("context");o?(o=o.replace("pond/",""),$(".aim-room-item",e.content).removeClass("aim-room-active"),$(t.target).addClass("aim-room-active"),x.call(this,o,e,this.bp.apps.client),$(".message_form .aim-to",e.content).val(o),k.call(this,o,e)):console.warn("No context found for clicked room item target",t.target)}))}function M(e,t){$(e.content).on("click",".aim-close-chat-btn, .aim-room-close-btn",(o=>{o.stopPropagation();const s=o.target.getAttribute("data-context");t.removeSubscription("pond",s),$(`.aim-messages-container[data-context="${s}"]`,e.content).remove(),$(`.aim-room-item[data-context="${s}"]`,e.content).remove(),$(`.aim-user-list[data-context="${s.replace("pond/","")}"][data-type="pond"]`,e.content).remove(),this.data.activePonds=this.data.activePonds.filter((e=>e!==s)),this.data.processedMessages[s]&&(this.data.processedMessages[s]=[]);const n=$(".aim-messages-container",e.content);if(n.length>0){const t=n.first().data("context");k.call(this,t,e),$(".aim-room-item",e.content).removeClass("aim-room-active"),$(`.aim-room-item[data-context="${t}"]`,e.content).addClass("aim-room-active"),$(".message_form .aim-to",e.content).val(t)}else $(".aim-messages-container",e.content).hide(),$(".message_form .aim-to",e.content).val("");const i=$(`.aim-room-item[data-context="pond/${s}"]`,e.content);$(".aim-room-list-item-name",i).removeClass("aim-room-active");0===$(".aim-messages-container",e.content).length?($(".no-open-ponds",e.content).flexShow(),$(".aim-message-controls",e.content).hide()):($(".no-open-ponds",e.content).hide(),$(".aim-message-controls",e.content).flexShow())}))}function N(e){if(!e)return void console.error("Pond name is required to join a pond.");if(this.forbiddenNotes.containsBadWord(e))return void alert("Invalid pond name. Please choose a different name.");let t=this.bp.apps.ui.windowManager.getWindow("pond-chat");if(!t)return void console.error("Pond message main window not found, cannot join pond.");let o=`${e}`;x.call(this,o,t,this.bp.apps.client),$(".message_form .aim-to",t.content).val(o),k.call(this,o,t)}const J={"index.html":'\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>My BuddyPond Profile</title>\n    <link rel="stylesheet" href="./style.css">\n</head>\n<body>\n    <h1>My Profile</h1>\n    <div class="profile-section">\n        <p>Welcome to my BuddyPond profile, hosted on the BuddyPond CDN!</p>\n        <p><strong>Customize Your Profile:</strong></p>\n        <ul>\n            <li>This default profile includes <code>index.html</code>, <code>style.css</code>, and <code>profile.js</code>.</li>\n            <li>You may use any files, the only requirement is <code>index.html</code> must be located in root.</li>\n            <li>Edit or upload files in the <strong>Buddy Files</strong> app (root directory).</li>\n            <li>Add any static files (HTML, CSS, JS, images) or projects (e.g., React, Vue).</li>\n            <li>Use relative paths (e.g., <code>./style.css</code>) to link files.</li>\n        </ul>\n        <p><strong>Example:</strong> Click to change text color.</p>\n        <button id="toggleButton">Toggle Text Color</button>\n        <p class="color-text">This text changes color!</p>\n    </div>\n    <script src="./profile.js"><\/script>\n</body>\n</html>',"style.css":"\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    background-color: #f4f4f9;\n    color: #333;\n    margin: 0;\n    padding: 20px;\n    line-height: 1.5;\n}\nh1 {\n    color: #007bff;\n    text-align: center;\n}\n.profile-section {\n    max-width: 600px;\n    margin: 0 auto;\n}\nul {\n    padding-left: 20px;\n    font-size: 0.9em;\n}\ncode {\n    background: #f0f0f0;\n    padding: 2px 4px;\n    border-radius: 3px;\n}\nbutton {\n    background-color: #007bff;\n    color: white;\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    display: block;\n    margin: 10px auto;\n}\nbutton:hover {\n    background-color: #0056b3;\n}\n.color-text {\n    font-size: 1.1em;\n    text-align: center;\n    transition: color 0.3s ease;\n}\n.color-text.toggled {\n    color: #dc3545;\n}","profile.js":"\nconst text = document.querySelectorAll('.color-text');\nconst button = document.getElementById('toggleButton');\nbutton.addEventListener('click', () => {\n    text.forEach(item => item.classList.toggle('toggled'));\n});\n"};function E(e){return e.endsWith(".html")?"text/html":e.endsWith(".css")?"text/css":e.endsWith(".js")?"application/javascript":"text/plain"}function Z(e,t){R.call(this,e,t),"more-options"!==e&&A.call(this)}function B(e,t){const o=t.closest(".aim-editable-container")?.querySelector(".aim-message-content");if(!o)return void console.error("No message content found for edit hint action");const s=o.closest(".aim-chat-message")?.getAttribute("data-uuid"),n=document.querySelector(`.aim-chat-message[data-uuid="${s}"]`);if(!n)return void console.error("No original message found");const i={uuid:s,chatId:n.getAttribute("data-chat-id"),text:n.getAttribute("data-original-text")||o.innerText};"cancel-edit"===e?Y.call(this,o,i.text):"save-edit"===e&&j.call(this,o,i)}function A(){this.activeMessageContextMenu&&(this.activeMessageContextMenu.remove(),this.activeMessageContextMenu=null),this.activeMessageHoverMenu&&(this.activeMessageHoverMenu=null),this.activeReplyBox}function R(e,t){console.log(`Performing action: ${e}`,t);const o=t.closest(".aim-context-menu")||t.closest(".aim-chat-message");if(!o)return void console.error("No closest target found");const s=o.getAttribute("data-uuid"),n={uuid:s,chatId:o.getAttribute("data-chat-id"),from:o.getAttribute("data-from")},i=document.querySelector(`.aim-chat-message[data-uuid="${s}"]`);if(i)if(n.text=i.querySelector(".aim-message-content").innerText,n.uuid&&n.chatId)switch(e){case"react-message":console.log("Add reaction clicked");let o=$(t).closest(".aim-hover-menu-item");console.log("$target",o),console.log(".emoji-picker-popup",$(".emoji-picker-popup").length),o.emojiPicker({onSelect:async e=>{console.log("Selected:",e),console.log("Reacted message",e,n),await buddypond.reactInstantMessage({from:n.from,chatId:n.chatId,uuid:n.uuid,reaction:e})}});break;case"edit-message":T.call(this,n);break;case"reply-message":G.call(this,n,i);break;case"more-options":event.preventDefault();const s=t.closest(".aim-chat-message");console.log("closestMessage",s),s&&this.createMessageContextMenu(t,s);break;case"quote-message":console.log("Quote message clicked");break;case"say-message":console.log("Say message clicked"),console.log("sayMessage",n),this.bp.emit("say::message",n);break;case"report-message":console.log("Report message clicked");break;case"copy-message":console.log("Copy message clicked");break;case"delete-message":P.call(this,n);break;case"cast-spell":this.bp.open("spellbook",{context:n.from,output:"buddy"});break;default:console.error(`Unknown action: ${e}`)}else console.error("No message data found");else console.error("No original message found")}function P(e){console.log("Deleting message",e),buddypond.removeInstantMessage(e)}function T(e){const t=document.querySelector(`.aim-chat-message[data-uuid="${e.uuid}"] .aim-message-content`);if(!t)return void console.error("No message content found");this.bp.ignoreUIControlKeys=!0;const o=e.text,s=document.createElement("div");s.className="aim-editable-container",t.parentNode.insertBefore(s,t),s.appendChild(t),t.closest(".aim-chat-message").setAttribute("data-original-text",o),t.setAttribute("contenteditable","true"),t.setAttribute("data-editing","true"),t.focus();const n=document.createElement("div");n.className="aim-edit-hint",n.innerHTML='\n    <span class="aim-edit-hint-action" data-action="cancel-edit">escape</span> to cancel • \n    <span class="aim-edit-hint-action" data-action="save-edit">enter</span> to save\n  ',s.appendChild(n);const i=t.closest(".chatWindow");this.scrollToBottom(i);const a=s=>{"Escape"===s.key?(Y.call(this,t,o),r(),s.preventDefault(),s.stopPropagation()):"Enter"===s.key&&(j.call(this,t,e),r(),s.preventDefault(),s.stopPropagation())},d=e=>{console.log("handleBlur",e.relatedTarget,e.target.classList),e.relatedTarget&&!e.relatedTarget.classList.contains("aim-edit-hint-action")&&(Y.call(this,t,o),r())},r=()=>{t.removeEventListener("keydown",a),t.removeEventListener("blur",d),this.bp.ignoreUIControlKeys=!1};t.addEventListener("keydown",a),t.addEventListener("blur",d),console.log("Editing message",e)}function Y(e,t,o=!0){const s=e.closest(".aim-editable-container");s&&(s.parentNode.insertBefore(e,s),s.remove()),e.setAttribute("contenteditable","false"),e.removeAttribute("data-editing"),o&&(e.innerText=t),e.blur();const n=e.closest(".aim-chat-message");n&&n.removeAttribute("data-original-text"),console.log("Edit cancelled"),this.bp.ignoreUIControlKeys=!1}async function j(e,t){const o=e.closest(".aim-editable-container");o&&console.log("Editable container found",o);const s=e.innerText;e.setAttribute("contenteditable","false"),e.removeAttribute("data-editing"),e.blur();const n=e.closest(".aim-chat-message");n&&n.removeAttribute("data-original-text"),console.log("Edit saved",s),await buddypond.editInstantMessage({from:t.from,chatId:t.chatId,uuid:t.uuid,text:s}),Y.call(this,e,null,!1)}function G(e,t){this.activeReplyBox&&(this.activeReplyBox.remove(),this.activeReplyBox=null),this.bp.ignoreUIControlKeys=!0,this.bp.replyData=e;const o=document.createElement("div");o.className="aim-reply-box",o.innerHTML=`\n    <span class="aim-reply-header">Replying to ${e.from}</span>\n    <button class="aim-reply-cancel" data-action="cancel-reply">Cancel</button>\n  `;const s=$(t).parent().parent().parent().parent().find(".aim-message-sender")[0];if(!s)return void console.error("No message sender found");s.parentNode.insertBefore(o,s),this.activeReplyBox=o;const n=o.closest(".chatWindow").querySelector('input[name="message_replyto"]'),i=o.closest(".chatWindow").querySelector('textarea[name="message_text"]');n?n.value=e.uuid:console.error("No reply input found"),i?i.focus():console.error("No message text input found");const a=t.closest(".chatWindow");a&&this.scrollToBottom(a);const d=e=>{"Escape"===e.key?(_.call(this,o),r(),e.preventDefault(),e.stopPropagation()):"Enter"===e.key&&(r(),e.preventDefault(),e.stopPropagation())},r=()=>{i.removeEventListener("keydown",d),this.bp.ignoreUIControlKeys=!1};i.addEventListener("keydown",d),console.log("Reply mode activated",e)}function _(e){if(console.log("Cancel reply",e),console.log("aimReplyBox",e),e){const t=e.closest(".chatWindow").querySelector('input[name="message_replyto"]');t?t.value="":console.error("No reply input found"),e.remove(),this.activeReplyBox=null,this.bp.ignoreUIControlKeys=!1,this.bp.replyData=null}console.log("Reply cancelled")}function X(){document.addEventListener("click",(e=>{let t=e.target;if($(t).parents().hasClass("aim-profile-picture")){const e=t.closest(".aim-chat-message");if(!e)return;let o=e.getAttribute("data-from");console.log("Profile picture clicked",o),o===this.bp.me?this.bp.open("profile",{context:"edit"}):this.bp.open("user-profile",{context:o})}}))}function F(e,t){const o=t.toLocaleString("en-US"),s=o.split("");if(bp.isMobile())return void e.text(o);e.find(".odometer-digit").length!==s.filter((e=>","!==e)).length&&(e.empty(),s.forEach((t=>{if(","===t)e.append('<span class="odometer-comma">,</span>');else{const t=$('<div class="odometer-digit"></div>'),o=$('<div class="odometer-digit-inner"></div>');for(let e=0;e<=9;e++)o.append(`<span>${e}</span>`);t.append(o),e.append(t)}})));let n=0;s.forEach(((t,o)=>{if(","===t)return;e.find(".odometer-digit").eq(n).find(".odometer-digit-inner").css({transition:"transform 0.5s ease-in-out",transform:`translateY(-${1*t}em)`}),n++}))}class q{constructor(e,t={}){return this.bp=e,this.config={host:"",api:""},this.api=buddypond,this.reconnectAttempts=0,this.maxReconnectAttempts=999999,this.maxBackoffDelay=1e4,this.isIntentionallyClosed=!1,this}}function V(e=!1){return console.log("createWebSocketClient called, reconnect:",e),!this.wsClient||this.wsClient.readyState!==WebSocket.OPEN&&this.wsClient.readyState!==WebSocket.CONNECTING?(console.log("Creating WebSocket client for buddylist"),new Promise(((e,t)=>{const o=new WebSocket(`${buddypond.buddyServerWsEndpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`),s=()=>{console.log("WebSocket connection opened to buddylist"),this.reconnectAttempts=0,this.wsClient=o,o.send(JSON.stringify({action:"getBuddyList",buddyname:buddypond.me,qtokenid:buddypond.qtokenid})),bp.emit("buddylist-websocket::connected"),this.pingInterval=setInterval((()=>{o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({action:"ping"}))}),25e3),e(o)},n=e=>{if("pong"!==e.data)try{const t=JSON.parse(e.data);switch(t.action){case"buddy_added":console.log("buddy_added WebSocket message received:",t),bp.emit("profile::buddy::in",{name:t.buddyname,profile:t.profile||{ctime:(new Date).getTime(),dtime:0}});break;case"getRemoteProfiles":t.profile&&t.profile.buddylist?bp.emit("profile::fullBuddyList",t.profile):console.error("getProfile message received but no buddylist:",t);break;case"getBuddyList":console.log("getBuddyList message received:",t.buddies),t&&t.buddies?bp.emit("profile::fullBuddyList",{buddylist:t.buddies}):console.error("getProfile message received but no buddylist:",t);break;case"getProfile":t.profile&&t.profile.buddylist?bp.emit("profile::fullBuddyList",t.profile):console.error("getProfile message received but no buddylist:",t),console.log("Requesting remote profile backfill for all buddies"),o.send(JSON.stringify({action:"getRemoteProfiles",buddyname:buddypond.me,qtokenid:buddypond.qtokenid}));break;case"pong":break;case"buddy_removed":console.log("buddy_removed WebSocket message received:",t),this.bp.emit("profile::buddy::out",{name:t.buddyname});break;case"rewards:response":t.success?bp.emit("buddylist-websocket::reward",{success:!0,message:t.message,reward:t.reward}):bp.emit("buddylist-websocket::reward",{success:!1,message:t.message});break;default:console.log("Last message:",e.data),console.warn("Unknown action received:",t)}}catch(t){console.log("Last message:",e.data),console.error("Error parsing WebSocket message:",t),bp.emit("buddylist-websocket::error",{error:"Message parsing failed"})}},i=e=>{if(console.log("WebSocket connection closed to","buddylist","Code:",e.code,"Reason:",e.reason),clearInterval(this.pingInterval),bp.emit("buddylist-websocket::disconnected",{code:e.code,reason:e.reason}),!this.isIntentionallyClosed&&this.reconnectAttempts<this.maxReconnectAttempts){const e=Math.min(200*Math.pow(2,this.reconnectAttempts)*(1+.1*Math.random()),this.maxBackoffDelay);console.log(`Scheduling reconnect attempt ${this.reconnectAttempts+1} for buddylist in ${e}ms`),setTimeout((async()=>{this.reconnectAttempts++,bp.emit("buddylist-websocket::reconnecting",{attempt:this.reconnectAttempts});try{this.wsClient=await this.createWebSocketServerClient(!0)}catch(e){console.error("Reconnect failed:",e)}}),e)}else this.reconnectAttempts>=this.maxReconnectAttempts&&(console.error(`Max reconnect attempts (${this.maxReconnectAttempts}) reached for buddylist. Giving up.`),bp.emit("buddylist-websocket::reconnect_failed"))},a=e=>{console.error("WebSocket error buddylist",e),bp.emit("buddylist-websocket::error",{error:"WebSocket error"}),o.readyState!==WebSocket.OPEN&&t(new Error("WebSocket connection failed")),o.close(1e3,"Error occurred")};o.addEventListener("open",s.bind(this)),o.addEventListener("message",n.bind(this)),o.addEventListener("close",i.bind(this)),o.addEventListener("error",a.bind(this)),o.closeConnection=()=>{this.isIntentionallyClosed=!0,console.log("Intentionally closing WebSocket for buddylist"),o.close(1e3,"Normal closure"),o.removeEventListener("open",s),o.removeEventListener("message",n),o.removeEventListener("close",i),o.removeEventListener("error",a),bp.emit("buddylist-websocket::closed")}}))):(console.log("Reusing existing WebSocket client"),Promise.resolve(this.wsClient))}q.prototype.connect=async function(){console.log("Connecting to BuddyList WebSocket..."),this.wsClient=await this.createWebSocketClient(),console.log("Connected to BuddyList WebSocket!"),this.bp.emit("buddylist::connected",this.wsClient)},q.prototype.disconnect=async function(){console.log("Attempting disconnecting from BuddyList WebSocket..."),this.wsClient?(this.wsClient.closeConnection(),this.wsClient=null,console.log("Disconnected from BuddyList WebSocket")):console.log("No active WebSocket connection to disconnect")},q.prototype.addBuddy=async function(e,t){console.log("NEW Calling addBuddy",this,e),function(e,t,o,s){let n;n=buddypond.endpoint+e;let i={Accept:"application/json","Content-Type":"application/json; charset=utf-8","X-Me":buddypond.me};buddypond.qtokenid&&(i.Authorization=`Bearer ${buddypond.qtokenid}`);let a=JSON.stringify(o);const d={method:t,headers:i,body:a},r=new AbortController,c=setTimeout((()=>r.abort()),3e4);buddypond.incrementPackets("packetsSent");let l={start:new Date};fetch(n,{...d,signal:r.signal}).then((e=>(clearTimeout(c),e.ok?e.json():e.json().then((t=>{const o=new Error(`HTTP ${e.status}: ${e.statusText}`);throw o.status=e.status,o.data=t,o}))))).then((e=>{buddypond.incrementPackets("packetsReceived"),l.end=new Date,buddypond.addPerfTime(l),s(null,e)})).catch((e=>{let t="Fetch connection error. Retrying shortly.";t="AbortError"===e.name?"Fetch request timeout":e.message.includes("Payload Too Large")?"File upload was too large. Try a smaller file.":400===e.status&&e.data?e.data.error||e.data.message||"Invalid input. Please try again.":e.message,console.error("❌ API Request Failed:",e),s(new Error(t),e.data||null)}))}("/buddylist/"+this.bp.me+"/add-buddy","POST",{buddyname:e},(function(e,o){t(e,o)}))},q.prototype.receivedInstantMessage=async function(e,t){this.wsClient.send(JSON.stringify({action:"receivedInstantMessage",buddyname:e})),t(null)},q.prototype.setStatus=async function(e,t,o=function(){}){alert("deprecated: Client.setStatus"),this.wsClient.send(JSON.stringify({action:"setStatus",buddyname:e,status:t.status,profilePicture:t.profilePicture})),o(null)},q.prototype.createWebSocketClient=function(e=!1){return console.log("createWebSocketClient called, reconnect:",e),!this.wsClient||this.wsClient.readyState!==WebSocket.OPEN&&this.wsClient.readyState!==WebSocket.CONNECTING?(console.log("Creating WebSocket client for buddylist"),new Promise(((e,t)=>{const o=new WebSocket(`${buddypond.buddylistWsEndpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`),s=()=>{console.log("WebSocket connection opened to buddylist"),this.reconnectAttempts=0,this.wsClient=o,o.send(JSON.stringify({action:"getProfile",buddyname:buddypond.me,qtokenid:buddypond.qtokenid})),bp.emit("buddylist-websocket::connected"),this.pingInterval=setInterval((()=>{o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({action:"ping"}))}),25e3),e(o)},n=e=>{if("pong"!==e.data)try{const t=JSON.parse(e.data);switch(t.action){case"buddy_added":bp.emit("profile::buddy::in",{name:t.buddyname,profile:t.profile||{ctime:(new Date).getTime(),dtime:0}});break;case"getRemoteProfiles":t.profile&&t.profile.buddylist?bp.emit("profile::fullBuddyList",t.profile):console.error("getProfile message received but no buddylist:",t);break;case"getProfile":t.profile&&t.profile.buddylist?bp.emit("profile::fullBuddyList",t.profile):console.error("getProfile message received but no buddylist:",t),console.log("Requesting remote profile backfill for all buddies");break;case"pong":break;case"buddy_removed":console.log("buddy_removed WebSocket message received:",t),this.bp.emit("profile::buddy::out",{name:t.buddyname});break;case"rewards:response":t.success?bp.emit("buddylist-websocket::reward",{success:!0,message:t.message,reward:t.reward}):bp.emit("buddylist-websocket::reward",{success:!1,message:t.message});break;case"getCoinBalance":t.success,bp.emit("buddylist-websocket::coinBalance",t);break;default:console.log("Last message:",e.data),console.warn("Unknown action received:",t)}}catch(t){console.log("Last message:",e.data),console.error("Error parsing WebSocket message:",t),bp.emit("buddylist-websocket::error",{error:"Message parsing failed"})}},i=e=>{if(console.log("WebSocket connection closed to","buddylist","Code:",e.code,"Reason:",e.reason),clearInterval(this.pingInterval),bp.emit("buddylist-websocket::disconnected",{code:e.code,reason:e.reason}),!this.isIntentionallyClosed&&this.reconnectAttempts<this.maxReconnectAttempts){const e=Math.min(200*Math.pow(2,this.reconnectAttempts)*(1+.1*Math.random()),this.maxBackoffDelay);console.log(`Scheduling reconnect attempt ${this.reconnectAttempts+1} for buddylist in ${e}ms`),setTimeout((async()=>{this.reconnectAttempts++,bp.emit("buddylist-websocket::reconnecting",{attempt:this.reconnectAttempts});try{this.wsClient=await this.createWebSocketClient(!0)}catch(e){console.error("Reconnect failed:",e)}}),e)}else this.reconnectAttempts>=this.maxReconnectAttempts&&(console.error(`Max reconnect attempts (${this.maxReconnectAttempts}) reached for buddylist. Giving up.`),bp.emit("buddylist-websocket::reconnect_failed"))},a=e=>{console.error("WebSocket error buddylist",e),bp.emit("buddylist-websocket::error",{error:"WebSocket error"}),o.readyState!==WebSocket.OPEN&&t(new Error("WebSocket connection failed")),o.close(1e3,"Error occurred")};o.addEventListener("open",s.bind(this)),o.addEventListener("message",n.bind(this)),o.addEventListener("close",i.bind(this)),o.addEventListener("error",a.bind(this)),o.closeConnection=()=>{this.isIntentionallyClosed=!0,console.log("Intentionally closing WebSocket for buddylist"),o.close(1e3,"Normal closure"),o.removeEventListener("open",s),o.removeEventListener("message",n),o.removeEventListener("close",i),o.removeEventListener("error",a),bp.emit("buddylist-websocket::closed")}}))):(console.log("Reusing existing WebSocket client"),Promise.resolve(this.wsClient))};class O{constructor(e,t={}){return this.bp=e,this.config={host:"",api:""},this.api=buddypond,this.reconnectAttempts=0,this.maxReconnectAttempts=999999,this.maxBackoffDelay=1e4,this.isIntentionallyClosed=!1,this}}function D(){return(new Date).getTime()}O.prototype.connect=async function(){console.log("Connecting to BuddyServer WebSocket..."),this.wsServerClient=await this.createWebSocketServerClient(),console.log("Connected to BuddyServer WebSocket!"),this.bp.emit("buddylist::connected",this.wsServerClient)},O.prototype.disconnect=async function(){console.log("Attempting disconnecting from BuddyServer WebSocket..."),this.wsServerClient?(this.wsServerClient.closeConnection(),this.wsServerClient=null,console.log("Disconnected from BuddyServer WebSocket")):console.log("No active WebSocket connection to disconnect")},O.prototype.addBuddy=async function(e,t){console.log("NEW Calling addBuddy",this,e),function(e,t,o,s){let n;n=buddypond.buddyServerApiEndpoint+e,console.log("making apiRequest",n,t,o);let i={Accept:"application/json","Content-Type":"application/json; charset=utf-8","X-Me":buddypond.me};buddypond.qtokenid&&(i.Authorization=`Bearer ${buddypond.qtokenid}`);let a=JSON.stringify(o);const d={method:t,headers:i,body:a},r=new AbortController,c=setTimeout((()=>r.abort()),3e4);buddypond.incrementPackets("packetsSent");let l={start:new Date};fetch(n,{...d,signal:r.signal}).then((e=>(clearTimeout(c),e.ok?e.json():e.json().then((t=>{const o=new Error(`HTTP ${e.status}: ${e.statusText}`);throw o.status=e.status,o.data=t,o}))))).then((e=>{buddypond.incrementPackets("packetsReceived"),l.end=new Date,buddypond.addPerfTime(l),s(null,e)})).catch((e=>{let t="Fetch connection error. Retrying shortly.";t="AbortError"===e.name?"Fetch request timeout":e.message.includes("Payload Too Large")?"File upload was too large. Try a smaller file.":400===e.status&&e.data?e.data.error||e.data.message||"Invalid input. Please try again.":e.message,console.error("❌ API Request Failed:",e),s(new Error(t),e.data||null)}))}("/buddylist/"+this.bp.me+"/add-buddy","POST",{buddyname:e},(function(e,o){t(e,o)}))},O.prototype.receivedInstantMessage=async function(e,t){console.log("ServerClient receivedInstantMessage",e),this.wsServerClient.send(JSON.stringify({action:"receivedInstantMessage",buddyname:e})),t(null)},O.prototype.setStatus=async function(e,t,o=function(){}){this.wsServerClient.send(JSON.stringify({action:"setStatus",buddyname:e,status:t.status,profilePicture:t.profilePicture})),o(null)},O.prototype.createWebSocketServerClient=V,O.prototype.createWebSocketServerClient=V;class z{constructor(e,t={}){this.bp=e,this.data={processedMessages:{},profileState:{me:null,status:null,profilePicture:null,updates:{}},avatarCache:new Map},this.defaultPond="Buddy",this.subscribedBuddies=[],this.subscribedPonds=[],this.options=t,e.apps.buddyscript&&e.apps.buddyscript.commands&&(this.options.autocomplete=e.apps.buddyscript.commands),this.showedHelp=!1,this.bp.logout=this.logout.bind(this),this.options.chatWindowButtons=this.options.chatWindowButtons||function(e){return[{text:"Upload File",image:"desktop/assets/images/icons/icon_upload_64.png",onclick:async t=>{let o=t.target.dataset.context,s=t.target.dataset.type;const n=document.createElement("input");return n.type="file",n.accept="*/*",n.style.display="none",document.body.appendChild(n),n.addEventListener("change",(async()=>{const t=n.files[0];if(console.log("Selected file:",t),t){t.filePath="uploads/"+t.name;try{const n=e=>{console.log(`Upload progress: ${e}%`)};let i=await e.apps.client.api.uploadFile(t,n),a={from:e.me,to:o,text:i,type:s||"buddy"};e.apps.client.api.sendCardMessage(a,(function(e,t){e?console.error("Error sending message",e):console.log("Message sent",t)}))}catch(e){console.error("Upload failed:",e)}}n.remove()})),n.click(),!1}},{text:"Image Search",image:"desktop/assets/images/icons/icon_image-search_64.png",onclick:async t=>{let o=t.target.dataset.context,s=t.target.dataset.type;return e.open("image-search",{output:s||"buddy",context:o,provider:"giphy-stickers"}),!1}},{text:"BuddySound",image:"desktop/assets/images/icons/icon_soundrecorder_64.png",onclick:t=>{console.log("BuddySound button clicked",t);let o=t.target.dataset.context,s=t.target.dataset.type;e.open("soundrecorder",{type:s||"buddy",output:s||"buddy",context:o})}},{text:"BuddyPaint",image:"desktop/assets/images/icons/icon_drawing_64.png",children:[{text:"Chalkboard",image:"desktop/assets/images/icons/icon_chalkboard_64.png",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type;e.open("chalkboard",{type:s||"buddy",output:s||"buddy",context:o})}},{text:"miniPaint",image:"desktop/assets/images/icons/icon_minipaint_64.png",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type;e.open("minipaint",{type:s||"buddy",output:s||"buddy",context:o})}},{text:"Paint",image:"desktop/assets/images/icons/icon_paint_64.png",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type;e.open("paint",{type:s||"buddy",output:s||"buddy",context:o})}},{text:"Painterro",image:"desktop/assets/images/icons/icon_painterro_64.png",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type;e.open("painterro",{type:s||"buddy",output:s||"buddy",context:o})}}]},{text:"BuddySnap",env:"desktop-only",image:"desktop/assets/images/icons/svg/1f4f7.svg",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type;e.open("camera",{type:s||"buddy",output:s||"buddy",context:o})}},{text:"BuddyEmoji",image:"desktop/assets/images/icons/svg/1f600.svg",className:"emojiPicker",onclick:async e=>{let t=$(e.target);console.log("emoji button clicked"),t.emojiPicker({onSelect:e=>{console.log("Selected:",e);let o=t.closest(".aim-message-controls");$(".aim-input",o).val(((t,o)=>o+e)).trigger("input").focus()}}),$(".emoji-picker-popup").length}},{text:"BuddyCall",type:"buddy-only",image:"desktop/assets/images/icons/icon_phone_64.png",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type;e.open("videochat",{type:s||"buddy",output:s||"buddy",context:o,isHost:!0});let n={from:e.me,to:o,text:"Let's have a video call",type:"buddy",card:{type:"videochat"}};console.log("BuddyCall message",n),buddypond.sendCardMessage(n,(function(e,t){e?console.error("Error sending message",e):console.log("Message sent",t)}))}},{text:"Spellbook",image:"desktop/assets/images/icons/icon_spellbook_64.png",onclick:t=>{t.preventDefault(),t.stopPropagation();let o=t.target.dataset.context,s=t.target.dataset.type;e.open("spellbook",{type:s||"buddy",output:s||"buddy",context:o})}},{text:"BuddyCoins",image:"desktop/assets/images/icons/icon_coin_64.png",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type;e.open("portfolio",{type:s||"buddy",output:o,context:"#portfolio-transfer"})}},{text:"Dictate",env:"desktop-only",image:"desktop/assets/images/icons/icon_dictate_64.png",onclick:async t=>{let o=t.target.dataset.context,s=t.target.dataset.type,n=$(".aim-input",$(t.target).parent().parent());await e.open("dictate",{type:s||"buddy",output:s||"buddy",context:o,targetEl:n})}},{text:"BuddyHelp",image:"desktop/assets/images/icons/icon_help_64.png",align:"right",onclick:t=>{let o=t.target.dataset.context,s=t.target.dataset.type,n=("pond"===s?"pond_message_-":"messages/")+o;"pond"===s&&(n="pond-chat");let i=e.apps.ui.windowManager.getWindow(n);console.log("chatWindow",i);let a=i.content.querySelector(".aim-input"),d=i.content.querySelector(".aim-send-btn");a&&(a.value="/help",a.dispatchEvent(new Event("input",{bubbles:!0}))),d&&d.click()}}]}(this.bp);let o=!0;this.bp.apps.desktop&&"boolean"==typeof this.bp.apps.desktop.enabledChatWindowButtons&&(o=this.bp.apps.desktop.enabledChatWindowButtons),o&&Array.isArray(o)&&o.forEach((e=>{let t=this.bp.apps.list[e.name];t&&t.chatButton&&this.options.chatWindowButtons.push(t.chatButton)})),this.opened=!1,this.showingIsTyping=this.showingIsTyping||{},this.activeMessageContextMenu=null,this.faucetAttempts=0}async init(){window.addEventListener("beforeunload",(e=>{this.buddyServerClient&&this.buddyServerClient.setStatus(this.bp.me,{status:"offline"},(function(e,t){console.log("buddypond.setStatus",e,t)}))})),await Promise.all([this.bp.vendor.dicebear=await this.bp.importModule("/v5/apps/based/buddylist/vendor/dicebear.core.js",{},!1),this.bp.vendor.dicebearAvatars=await this.bp.importModule("/v5/apps/based/buddylist/vendor/dicebear.identicon.js",{},!1),await this.bp.appendScript("/v5/apps/based/buddylist/vendor/marked.min.js"),await this.bp.appendScript("/v5/apps/based/buddylist/vendor/purify.min.js"),await bp.load("emoji-picker"),await bp.load("buddyscript"),await bp.load("card"),await bp.load("pond")]),this.bindMessageContextMenu(),this.forbiddenNotes=n}async open(e={type:"buddylist-profile"}){"string"!=typeof e.type&&(e.type="buddylist-profile"),!0===e.openDefaultPond&&(this.openDefaultPond=!0);let t=bp.get("openPondChatRooms");if(!0!==t&&void 0!==t||(this.openDefaultPond=!0),!1===e.showPond&&(this.showPond=!1),"buddylist-profile"===e.type){const t=await this.bp.fetchHTMLFragment("/v5/apps/based/buddylist/buddylist.html");if(this.messageTemplateString=await this.bp.fetchHTMLFragment("/v5/apps/based/buddylist/message.html"),this.bp.appendCSS("/v5/apps/based/buddylist/buddylist.css"),this.bp.appendCSS("/v5/apps/based/buddylist/messages.css"),this.opened){if(!this.buddyListWindow){const e=this.createBuddyListWindow();e.content.appendChild(this.createHTMLContent(t)),this.buddyListWindow=e}return this.buddyListWindow.open(),this.bp.apps.ui.windowManager.focusWindow(this.buddyListWindow),this.buddyListWindow.restore(),$('.loginForm input[name="username"]').focus(),"buddylist already open"}if(this.opened=!0,await this.bp.importModule("affirmations"),!1!==e.showBuddyList){const e=this.createBuddyListWindow();e.content.appendChild(this.createHTMLContent(t)),this.buddyListWindow=e}return!0!==this.eventsBound&&this.registerEventHandlers(),this.buddylistUIEvents(),this.handleAuthentication(),this.eventsBound=!0,"hello buddyList"}"pond"===e.type&&(console.log("BuddyList open config.type is pond",e),this.openChatWindow(e)),"chat"!==e.type&&"buddy"!==e.type||this.openChatWindow(e)}createHTMLContent(e){const t=document.createElement("div");return t.innerHTML=e,$('.loginForm input[name="username"]').focus(),t}getLatestMessages(){const e={buddyname:this.subscribedBuddies.join(","),pondname:this.subscribedPonds.join(","),me:this.bp.me};this.bp.apps.client.sendMessage({id:D(),method:"getMessages",data:e})}buddyReadNewMessages(e){this.bp.log("BuddyReadNewMessages",e),e.name}async handleChatMessages(e){let t=new Set;for(const o of e.result.messages)try{o.from&&this.data.profileState&&this.data.profileState.buddylist&&this.data.profileState.buddylist[o.from]&&this.data.profileState.buddylist[o.from].newMessages&&(console.log("receivedInstantMessage receivedInstantMessage receivedInstantMessage"),this.data.profileState.buddylist[o.from].newMessages=!1,this.buddyServerClient.receivedInstantMessage(o.from,(function(e,t){console.log("receivedInstantMessage",e,t)})));let e=await this.renderChatMessage(o);t.add(e)}catch(e){console.log("error rendering chat message",o,e)}for(const e of t)e&&e.content&&this.scrollToBottom(e.content);if(!this.showedHelp&&!0!==this.bp.settings["viewed-help-card"]&&!this.bp.isMobile()){let e=t.values().next().value;e&&"pond"===e.type&&(this.showCard({chatWindow:e,cardName:"help"}),this.showedHelp=!0)}}sendMessageToServer(e,t=!1){this.bp.log("buddy::sendMessage",e),e.uuid=D(),""!==e.text?("pond"===e.type&&(console.log("sendMessageToServer",e),buddypond.pondSendMessage(e.to,e.text,e,(function(e,t){console.log("pondSendMessage",e,t),console.log(e,t)}))),"buddy"===e.type&&(console.log("sendMessageToServer",e),buddypond.sendMessage(e.to,e.text,e,(function(e,t){console.log("pondSendMessage",e,t),console.log(e,t)})))):console.log("will not sendMessageToServer: no text")}handleAuthentication(){if(this.bp.connected)return;const e=this.bp.apps.client.api,t=localStorage.getItem("qtokenid"),o=localStorage.getItem("me");t&&e.verifyToken(o,t,((e,s)=>{if(e)return console.error("Failed to verify token:",e),$(".password").show(),void $(".loginForm .error").text("Failed to authenticate buddy");console.log("verified token",s),s.success?(this.bp.emit("auth::qtoken",{qtokenid:t,me:o,hasPassword:s.user.hasPassword}),$(".loggedIn").flexShow(),$(".loggedOut").flexHide(),window.discordView?this.buddyListWindow.minimize():s.user.hasPassword||this.bp.open("pincode")):($(".loginForm .error").text("Failed to authenticate buddy"),$(".password").show(),console.error("Failed to authenticate buddy:"))}))}async handleAuthSuccess(e){if(console.log("buddylist.handleAuthSuccess",e),this.bp.connected=!0,this.bp.me=e.me,this.bp.qtokenid=e.qtokenid,this.data.profileState=this.data.profileState||{},this.data.profileState.me=this.bp.me,$("#me_title").html("Welcome "+this.bp.me),!this.client)try{this.client=new this.Client(bp);await this.client.connect()}catch(e){console.error("Error connecting to BuddyList client:",e)}if(!this.buddyServerClient){this.bp.play("desktop/assets/audio/WELCOME.mp3",{tryHard:1/0}),console.log("connecting to buddyserver client");try{this.buddyServerClient=new O(bp);let e=await this.buddyServerClient.connect();console.log("connected to buddyserver client",e)}catch(e){console.error("Error connecting to BuddyServer client:",e)}}window.discordView||e.hasPassword||this.bp.open("pincode"),window.tempDiscordId&&(console.log("linking Discord account",window.tempDiscordId),window.linkDiscordAccount(window.tempDiscordId),window.tempDiscordId=null),this.defaultPond&&!0===this.openDefaultPond&&setTimeout((()=>{let e=this.openChatWindow({pondname:this.defaultPond});window.discordView&&e.minimize(),bp.load("pond")}),100)}}z.prototype.renderOrUpdateBuddyInBuddyList=function(t){let o=this.bp,s=t.name,n=t.profile;this.bp.buddyTimeouts=this.bp.buddyTimeouts||{};let i=document.querySelectorAll(".buddylist li"),a=Array.from(i).find((e=>e.dataset.buddy===s)),d=!!a&&a.querySelector(".buddy-status").textContent.includes("🟢");if(console.log("rendering buddydata",n),n.hasOwnProperty("status")){"online"===n.status?n.isConnected=!0:n.isConnected=!1,this.bp.buddyTimeouts[s]&&(clearTimeout(this.bp.buddyTimeouts[s]),delete this.bp.buddyTimeouts[s]);let e=(new Date).getTime()-n.utime;if(n.isConnected&&e>18e6&&(s===this.bp.me?n.isConnected=!0:n.isConnected=!1),s!==this.bp.me)if(n.isConnected&&!d){(new Date).getTime()-n.utime>300&&o.play("desktop/assets/audio/BUDDY-IN.mp3")}else n.isConnected}let r=n.hasOwnProperty("isConnected")?n.isConnected:d;n.newMessages&&n.newMessages&&(r=!0,this.bp.apps.buddylist.openChatWindow({context:s,type:"buddy"}));let c,l=r?"🟢":"🟠",p=n.isCalling?"<span>📞</span>":"",m=n.newMessages?"<span>💬</span>":"",u=n.utime?n.utime:0,h=new Date(u),g="";try{g="Last seen: "+h.toLocaleString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0})}catch(e){console.log("Error formatting last seen date",e)}if(a)c=a,c.dataset.utime=n.utime,c.title=g,c.querySelector(".buddy-status").innerHTML=`${m}${l}${p}`,c.querySelector(".message-buddy").textContent=s,c.style.display="hidden"===n.status?"none":"";else{let e=`<li data-buddy="${s}" data-utime="${n.utime}" class="buddy-message-sender" title="${g}">\n                          <span class="buddy-status">${m}${l}${p}</span> \n                          <span data-buddy="${s}" class="message-buddy" href="#" draggable="false">${s}</span>\n                        </li>`;c=document.createElement("div"),c.innerHTML=e,c=c.firstChild,"hidden"===n.status&&(c.style.display="none")}if(n.utime){let e=DateFormat.format.date(n.utime,"E MMMM dd, hh:mm:ss a");$(c).find(".buddy-status").attr("title",e)}a||$(".buddylist").append(c),this.sortBuddyList(),e.call(this,c)},z.prototype.createChatMessageElement=function(e,o,n,i){const a=document.createElement("div");a.className="aim-chat-message",a.setAttribute("data-id",e.id),a.setAttribute("data-from",e.from),a.setAttribute("data-to",e.to),a.setAttribute("data-type",e.type),a.setAttribute("data-uuid",e.uuid),a.setAttribute("data-chat-id",e.chatId);const d=document.createElement("div");if(d.className="aim-profile-picture",e.profilePicture||this.bp.apps.buddylist.data.profileState&&this.bp.apps.buddylist.data.profileState.buddylist&&this.bp.apps.buddylist.data.profileState.buddylist[e.from]&&this.bp.apps.buddylist.data.profileState.buddylist[e.from].profile_picture&&(e.profilePicture=this.bp.apps.buddylist.data.profileState.buddylist[e.from].profile_picture),e.profilePicture){const t=document.createElement("img");window.discordMode&&(e.profilePicture=e.profilePicture.replace("https://files.buddypond.com",bp.config.cdn)),t.src=e.profilePicture,t.alt=`${e.from}'s avatar`,t.className="aim-chat-message-profile-picture-img",d.appendChild(t)}else{const t=this.defaultAvatarSvg(e.from);d.innerHTML=t}d.alt=`${e.from}'s avatar`;const r=document.createElement("div");r.className="aim-content-wrapper";const c=document.createElement("div");c.className="aim-message-header";const l=document.createElement("span");l.className="aim-sender",l.textContent="anonymous"===e.from?`Anonymous (${e.tripcode||"tr1pc0d3"})`:e.from;const p=document.createElement("span");p.className="aim-timestamp",p.textContent=o;const m=document.createElement("div");m.className="aim-message-meta";const u=function(e){if("outer space"!==e.location&&e.location||(e.location="AQ"),!e.location||"outer space"===e.location)return document.createElement("span");let t=document.createElement("img");return t.className="geoFlag",t.src=`desktop/assets/geo-flags/flags/4x3/${e.location.toLowerCase()}.svg`,t}(e),h=document.createElement("span");h.className="aim-badges",m.appendChild(u),m.appendChild(h),c.appendChild(l),c.appendChild(m),c.appendChild(p);let g=null;if(e.replyto){const t=n.content.querySelector(`.aim-chat-message[data-uuid="${e.replyto}"]`);if(t){const e=t.querySelector(".aim-sender")?.textContent||"Unknown",o=t.querySelector(".aim-message-content")?.innerText||"";g=document.createElement("div"),g.className="aim-reply-indicator",g.innerHTML=`\n        <span class="aim-reply-sender">${e}</span>\n        <span class="aim-reply-content">${o}</span>\n      `;g.querySelector(".aim-reply-sender").addEventListener("click",(()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("aim-highlight"),setTimeout((()=>t.classList.remove("aim-highlight")),2e3)}))}}const b=document.createElement("div");b.className="aim-message-content";const y=t(e.text);b.innerHTML=y;const f=document.createElement("div");if(f.className="aim-message-reactions",e.reactions){e.reactions=JSON.parse(e.reactions);for(let t in e.reactions){const o=e.reactions[t].count,s=document.createElement("span");s.className="aim-message-reaction",s.setAttribute("data-emoji",t),s.innerHTML=`\n        <span class="aim-reaction-emoji">${t}</span>\n        <span class="aim-reaction-count">${o}</span>\n      `;const n=e.reactions[t].buddies||[];n.length>0&&s.setAttribute("title",`Reacted by: ${n.join(", ")}`),f.appendChild(s)}}const w=s.call(this,e);return r.appendChild(c),g&&r.appendChild(g),r.appendChild(b),r.appendChild(w),i&&r.appendChild(i),r.appendChild(f),a.appendChild(d),a.appendChild(r),a.querySelectorAll("img").forEach((e=>{e.addEventListener("load",(()=>{}))})),function(e,t,o){let s=e.content.querySelector(".aim-messages");"pond"===t.type&&(s=e.content.querySelector(`.aim-messages-container[data-context="${t.to}"] .aim-messages`));if(!s)return void console.log("aim-messages not found. chat window is not yet ready...");const n=s.children,i=n.length;if(0===i||t.id>parseInt(n[i-1].getAttribute("data-id"),10))return s.appendChild(o),o;let a=0,d=i-1,r=null;for(;a<=d;){const e=a+d>>1,o=parseInt(n[e].getAttribute("data-id"),10);isNaN(o)?(console.warn("Invalid data-id on message node:",n[e]),a=e+1):t.id<o?(r=n[e],d=e-1):a=e+1}r?s.insertBefore(o,r):s.appendChild(o)}(n,e,a),a},z.prototype.renderChatMessage=async function(e,t){let o="default";if(i(e),e.text&&e.text.length>0){let t=function(e){const t=function(e){const t={"&amp;":"&","&quot;":'"',"&lt;":"<","&gt;":">","&apos;":"'","&nbsp;":" "};return e.replace(/&[a-zA-Z0-9#]+;/g,(e=>t[e]||e))}(e),o=/(^|\s)#([a-zA-Z0-9\p{L}][a-zA-Z0-9\p{L}_-]*)/gu;return Array.from(t.matchAll(o),(e=>e[2]))}(e.text);t.length>0&&(e.card={type:"pond",pondNames:t})}let s=`messages/${e.to}`;if("buddy"===e.type&&(e.to===this.bp.me?(s=`messages/${e.from}`,o=e.from):(s=`messages/${e.to}`,o=e.to)),("pond"===e.type||e.chatId&&e.chatId.startsWith("pond/"))&&(o=e.to,s="pond-chat"),e.chatId.startsWith("buddy")){let t=e.chatId.split("/"),n=t[1];n===this.bp.me&&(n=t[2]),o=n,s=`messages/${n}`}if(this.data.processedMessages[o]=this.data.processedMessages[o]||[],this.data.activeUsers=this.data.activeUsers||[],this.data.activeUsersInContext=this.data.activeUsersInContext||{},this.data.activeUsersInContext[o]=this.data.activeUsersInContext[o]||[],this.data.activePonds=this.data.activePonds||[],"pond"===e.type&&e.to&&!this.data.activePonds.includes(e.to)&&(this.data.activePonds.push(e.to),this.bp.emit("pond::activePondAdded",e.to)),"buddy"===e.type&&(e.to&&!this.data.activeUsers.includes(e.to)&&(this.data.activeUsers.push(e.to),this.bp.emit("buddy::activeUserAdded",e.to)),e.to&&!this.data.activeUsersInContext[o].includes(e.to)&&this.data.activeUsersInContext[o].push(e.to)),e.from&&!this.data.activeUsers.includes(e.from)&&(this.data.activeUsers.push(e.from),this.bp.emit("buddy::activeUserAdded",e.from)),e.from&&!this.data.activeUsersInContext[o].includes(e.from)&&this.data.activeUsersInContext[o].push(e.from),e.removed){console.log("ATTEMPTING TO REMOVE MESSAGE",e);let t=$(`.aim-chat-message[data-uuid="${e.removed}"]`);return t.length>0&&t.remove(),a}if(e.edited){console.log("ATTEMPTING TO EDIT MESSAGE",e);let t=$(`.aim-chat-message[data-uuid="${e.edited}"]`);if(!t.length>0)return void console.error("No original message found");let o=t.find(".aim-message-content");return o.length>0&&o.html(e.text),a}let n=!1;if(e.reacted){console.log("ATTEMPTING TO REACT TO MESSAGE",e);let t=$(`.aim-chat-message[data-uuid="${e.reacted}"]`);!t.length>0&&console.error("No original message found for reaction",e);let o=t.find(".aim-message-reactions");0===o.length&&(o=$('<div class="aim-message-reactions"></div>'),t.find(".aim-message-content").append(o)),o.html("");for(let s in e.reactions){const i=e.reactions[s].count,a=$(`\n        <span class="aim-message-reaction" data-emoji="${s}">\n          <span class="aim-reaction-emoji">${s}</span>\n          <span class="aim-reaction-count">${i}</span>\n        </span>\n      `),d=e.reactions[s].buddies||[];d.length>0&&$(o).attr("title",`Reacted by: ${d.join(", ")}`),o.append(a),t.is(":last-child")&&(console.log("last message reaction, scrolling to bottom"),n=!0)}}let a=this.bp.apps.ui.windowManager.getWindow(s);if(t&&(a=t),!a||!a.content)return console.log("chat window not ready, trying again soon",s,e),void console.log(e);if(n&&this.scrollToBottom(a.content),document.querySelector(`.chatMessage[data-uuid="${e.uuid}"]`))return a;(new Date).getTime();let d,r=new Date(e.ctime).getTime();$(".aim-no-messages",a.content).remove();for(let t=0;t<this.data.processedMessages[o].length;t++)if(this.data.processedMessages[o][t].uuid===e.uuid)return a;if(this.data.processedMessages[o].length>5e3&&this.data.processedMessages[o].shift(),this.data.processedMessages[o].push(e),"agent"===e.type){if(desktop&&desktop.app&&desktop.app.spellbook&&desktop.app.spellbook[e.text])return void desktop.app.spellbook[e.text]();console.log("unknown agent message",e)}if(this.bp.apps.say&&e.text&&e.text.startsWith("/say")&&this.bp.apps.say.processMessages(e),r=this.bp.isMobile()?DateFormat.format.date(r,"hh:mm:ss a"):DateFormat.format.date(r,"E MMMM dd, hh:mm:ss a"),r=r.toString(),e.card&&this.bp&&this.bp.apps&&this.bp.apps.card){let t=e.card;if(Object.keys(t).length>0){t.message=e;let o=this.bp.apps.card.cardManager;const s=await o.loadCard(t.type,t,a);d=document.createElement("div"),d.classList.add("cardContainer"),await s.render(d)}}return this.bp,this.createChatMessageElement(e,r,a,d),"pond"===e.type?this.bp.emit("pond::message::processed",e):this.bp.emit("buddy::message::processed",e),a},z.prototype.renderBuddyRequests=function(e){$(".you_have_no_buddies").hide();let t=this.bp.apps.client.api;if(e){$(".pendingIncomingBuddyRequests").html(""),$(".pendingOutgoingBuddyRequests").html(""),$(".loading").remove();for(let t in e){let o=e[t];o=JSON.parse(o),o.to===this.bp.me?$(".pendingIncomingBuddyRequests").append("<li>"+o.from+' - <a href="#" class="approveBuddyRequest pointer" data-buddyname="'+o.from+'">Approve</a> / <a href="#" class="denyBuddyRequest pointer" data-buddyname="'+o.from+'">Remove</a> </li>'):$(".pendingOutgoingBuddyRequests").append("<li>"+o.to+' - <a href="#" class="denyBuddyRequest pointer" data-buddyname="'+o.to+'">Remove</a></li>')}$(".apiResult").val(JSON.stringify(e,!0,2)),this.data.pendingIncomingBuddyRequests=this.data.pendingIncomingBuddyRequests||0;let o=$(".pendingIncomingBuddyRequests li").length;o>this.data.pendingIncomingBuddyRequests&&(this.data.pendingIncomingBuddyRequests=o,setTimeout((function(){}),2222)),0===o?$(".pendingIncomingBuddyRequestsHolder").hide():$(".pendingIncomingBuddyRequestsHolder").show(),0==$(".pendingOutgoingBuddyRequests li").length?$(".pendingOutgoingBuddyRequestsHolder").hide():$(".pendingOutgoingBuddyRequestsHolder").show(),$(".denyBuddyRequest").on("click",(function(){return $(this).parent().hide(),t.denyBuddy($(this).attr("data-buddyname"),(function(e,t){$(".apiResult").val(JSON.stringify(t,!0,2))})),!1})),$(".approveBuddyRequest",".pendingIncomingBuddyRequests").on("click",(function(){$(this).parent().hide();let e=$(this).attr("data-buddyname");return t.approveBuddy(e,(function(e,t){$(".apiResult").val(JSON.stringify(t,!0,2))})),!1}))}},z.prototype.buddylistUIEvents=function(){let e=this.bp.apps.client.api,t=this.bp.apps.affirmations.affirmations;$(".loginForm").submit((t=>{t.preventDefault(),$(".loginButton").prop("disabled",!0),$(".loginButton").addClass("disabled");let o=$('.loginForm input[name="username"]').val(),s=$('.loginForm input[name="password"]').val();return s||(s=o),e.authBuddy(o,s,(function(e,t){if(console.log("authBuddy",e,t),e)return t&&t.error?($(".loginStatus").html(t.error),"Incorrect password."===t.error&&$(".resetPasswordLink").show()):"Failed to fetch"===e.message?$(".loginStatus").text("Failed to connect to Buddy Pond"):$(".loginStatus").html(e.message||"Failed to authenticate buddy"),$(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled"),$(".password").show(),void console.error("Failed to authenticate buddy:",e);if(t.success)t.me=o,bp.emit("auth::qtoken",t),$(".loginForm .error").text("");else{if($(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled"),o===s)return $(".password").show(),void $(".password").focus();$(".loginForm .error").text("Failed to authenticate buddy"),$(".password").show(),console.error("Failed to authenticate buddy:")}})),!1})),$(".onlineStatusSelect").change((e=>{let t=$(e.target).val();bp.emit("profile::status",t)})),$(".openPondChatRooms").change((e=>{let t=$(e.target).is(":checked");t&&(this.openChatWindow({pondname:this.defaultPond}),bp.load("pond")),bp.set("openPondChatRooms",t)})),this.openDefaultPond&&$(".openPondChatRooms").prop("checked",!0),$(".forgot-password").on("click",(e=>{$(".loginForm").flexHide(),$(".forgot-password-modal").flexShow(),$(".tos-checkbox").flexHide(),$(".loginStatus").html(""),$(".resetPasswordLink").flexHide()})),$(".closeForgotPassword").on("click",(e=>{$(".forgot-password-modal").flexHide(),$(".loginForm").flexShow(),$(".tos-checkbox").flexShow(),$(".resetPasswordLink").flexShow()})),$(".resetPasswordButton").on("click",(t=>{t.preventDefault();let o=$(".resetPasswordEmail").val();o?($(".resetPasswordEmail").removeClass("error"),$(".loginStatus").html("Sending password reset email..."),$(".resetPasswordForm").flexHide(),$(".resetPasswordMessage").flexHide(),e.sendPasswordResetEmail(o,((e,t)=>{if(e||!t.success)return $(".loginStatus").html("Failed to send password reset email."),void console.error(e||t);$(".loginStatus").removeClass("error").addClass("success").html(t.message)}))):$(".resetPasswordEmail").addClass("error")})),$(".buddylist").click((e=>{if(!$(e.target).closest(".buddy-message-sender").data("buddy"))return;let t=$(e.target).closest(".buddy-message-sender").data("buddy");this.openChatWindow({name:t})})),$(".sendBuddyRequest").on("click",(e=>{e.preventDefault();let t=$(".buddy_request_name").val();t?($(".you_have_no_buddies").html("Buddy Request Sent!"),$(".buddy_request_name").removeClass("error"),$(".buddy_request_name").val(""),this.bp.log("buddypond.addBuddy ->",t),this.buddyServerClient.addBuddy(t,((e,t)=>(console.log("buddypond.addBuddy <-",e,t),t.error?($(".you_have_no_buddies").html(t.error),void console.error(t)):t.success?void this.bp.log("buddypond.addBuddy <-",t):($(".you_have_no_buddies").html(t.message),void console.error(t)))))):$(".buddy_request_name").addClass("error")})),$(".loginButton").prop("disabled",!0),$(".loginButton").addClass("disabled"),$("#tosAgree").change((function(){$(this).is(":checked")?($(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled")):($(".loginButton").prop("disabled",!0),$(".loginButton").addClass("disabled"))}));let o=$(document);const s=[{key:"paint",title:"Paint",icon:"desktop/assets/images/icons/icon_paint_64.png"},{key:"minipaint",title:"miniPaint",icon:"desktop/assets/images/icons/icon_minipaint_64.png"},{key:"painterro",title:"Painterro",icon:"desktop/assets/images/icons/icon_painterro_64.png"},{key:"chalkboard",title:"Chalkboard",icon:"desktop/assets/images/icons/icon_chalkboard_64.png"}];function n(){let e=t[Math.floor(Math.random()*t.length)];$(".positiveAffirmation").html(e)}o.on("click","img.remixPaint",(function(e){e.stopPropagation();const t=$(this);t.closest(".image-card"),t.closest(".image-controls");let o=t.parent(".remix-wrapper");if(0===o.length){t.wrap('<div class="remix-wrapper"></div>'),o=t.parent(),o.css({position:"absolute",left:"0px",top:"6px"});const e=$('<div class="remix-menu" aria-hidden="true"></div>');s.forEach((t=>{const o=$(`\n        <button class="remix-option" type="button" title="${t.title}" data-editor="${t.key}">\n          <img src="${t.icon}" alt="${t.title}" />\n        </button>\n      `);e.append(o)})),t.after(e)}o.find(".remix-menu").first().toggleClass("open")})),o.on("click",".remix-wrapper .remix-option",(function(e){e.stopPropagation();const t=$(this),o=t.data("editor"),s=t.closest(".image-card"),n=s.find(".bp-image").attr("src")||s.find("img.image").attr("src"),i=s.find(".remixPaint").data("output"),a=s.find(".remixPaint").data("context");bp.open(o,{src:n,output:i,context:a}),s.find(".remix-menu.open").removeClass("open")})),$(document).on("click",(function(){$(".remix-menu.open").removeClass("open")})),$(".inviteBuddy").on("click",(()=>{let e=[`Find me as "${this.bp.me}" on https://buddypond.com and let's start a conversation that could last a lifetime.`,`I've taken my conversations to the cloud! Reach me at "${this.bp.me}" on https://buddypond.com where the future of messaging unfolds.`,`Wave goodbye to the old and hello to the old! I'm waiting at "${this.bp.me}" on https://buddypond.com. Let's catch up!`,`Missing chat sessions? They're back and better than ever at "${this.bp.me}" on https://buddypond.com. Join me and let's reconnect!`,`Taking conversations to the next level. Find me at "${this.bp.me}" on https://buddypond.com and let's dive into new topics together!`,`Remember the ease of old-school messaging? Experience it again with a twist! I'm "${this.bp.me}" at https://buddypond.com. Chat soon?`,`I'm charting new territories in the world of digital communication. Join me as "${this.bp.me}" on https://buddypond.com and let's explore together!`,`Just like the good old days but better! Find me on "${this.bp.me}" at https://buddypond.com and let's keep the conversations flowing.`],t=e[Math.floor(Math.random()*e.length)];return window.open(`https://twitter.com/intent/tweet?url=${t}`),!1})),this.positiveAffirmationInterval&&clearInterval(this.positiveAffirmationInterval),this.positiveAffirmationInterval=setInterval((function(){$(".positiveAffirmation").fadeOut({duration:4444,complete:function(){n(),$(".positiveAffirmation").fadeIn({duration:4444,complete:function(){}})}})}),199800),n(),$(".positiveAffirmation").on("click",(function(){n()}))},z.prototype.openChatWindow=function(e){const{windowType:t,contextName:o,windowTitle:s}=function(e){let t=e.pondname?"pond":"buddy",o=e.pondname||e.name||"Buddy",s="pond"===t?"Pond Chat":"";e.context&&(o=e.context);e.type&&(t=e.type);return o=o.toString(),{windowType:t,contextName:o,windowTitle:s}}(e);if(!b.call(this,o))return;this.populateRoomList||(this.populateRoomList=u.bind(this)),this.updatePondConnectedUsers||(this.updatePondConnectedUsers=h.bind(this)),this.joinPond||(this.joinPond=N.bind(this));const n=this.bp.apps.client,i=function(e,t){return"pond"===e?"pond-chat":`messages/${t}`}(t,o),a=this.bp.apps.ui.windowManager.getWindow(i);return a?(y.call(this,a,t,o,n,this),a):f.call(this,{windowType:t,contextName:o,windowTitle:s,windowId:i,client:n,data:e})},z.prototype.generateDefaultProfile=async function(e){const t="https://files.buddypond.com/"+e.me;for(const[e,o]of Object.entries(J))try{const o=await fetch(`${t}/${e}`);if(!o.ok)throw new Error("File not found, needs creation");if(200!==o.status)throw new Error("File not found, needs creation");if("https://buddypond.com/four-ohh-four"===o.url)throw new Error("File not found, needs creation")}catch(t){console.log(`Creating ${e}: ${t.message}`);const s=new Blob([o],{type:E(e)}),n=new File([s],e,{type:s.type,lastModified:new Date});n.filePath=`${e}`;try{await this.bp.apps.client.api.uploadFile(n),console.log(`${e} uploaded successfully.`)}catch(t){console.error(`Error uploading ${e}: ${t.message}`)}}},z.prototype.requestDefaultCoinAllocations=async function(){let e,t=buddypond.qtokenid,o=this.bp.me;console.log(`requestDefaultCoinAllocations ${o} ${t}`);try{let s=`${buddypond.randolphEndpoint}/faucet`;console.log("faucetUrl",s),e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"x-me":o}}),console.log("requestDefaultCoinAllocations",e.status,e.statusText);let n=await e.json();console.log("requestDefaultCoinAllocations",n)}catch(e){throw e}},z.prototype.sortBuddyList=function(){let e=document.querySelector(".buddylist");if(!e)return void console.log("Buddy list not found, unable to sort");let t=Array.from(document.querySelectorAll(".buddylist li"));t.sort(((e,t)=>{let o=e.querySelector(".buddy-status").textContent.includes("🟢")?0:1,s=t.querySelector(".buddy-status").textContent.includes("🟢")?0:1;if(o!==s)return o-s;if(0===o&&0===s)return e.dataset.buddy.localeCompare(t.dataset.buddy);let n=parseInt(e.dataset.utime||0),i=parseInt(t.dataset.utime||0);return n!==i?i-n:e.dataset.buddy.localeCompare(t.dataset.buddy)})),e.innerHTML="",t.forEach((t=>e.appendChild(t)))},z.prototype.showContextMenu=function(e,t,o){const s=$("<div>",{id:"customContextMenu",css:{position:"absolute",top:t,left:e,zIndex:99999,display:"block",background:"var(--desktop_element-background)",border:"1px solid #ccc",padding:"10px",cursor:"pointer"}}).append($("<ul>").append($("<li>").text("View Profile").on("click",(()=>function(e){console.log("Opening profile for "+e),bp.admin?bp.open("admin-profile",{context:e}):bp.open("user-profile",{context:e})}(o)))));$("#customContextMenu").remove(),$("body").append(s),$(document).one("click",(function(){$("#customContextMenu").remove()}))},z.prototype.createMessageContextMenu=function(e,t){this.activeMessageContextMenu&&(this.activeMessageContextMenu.remove(),this.activeMessageContextMenu=null),this.activeMessageHoverMenu&&(this.activeMessageHoverMenu=null);const o=e.closest(".aim-hover-menu"),s=document.createElement("div");s.className="aim-context-menu";const n=t.getAttribute("data-from"),i=[{text:"Reply",action:"reply-message"},{text:"Say Message",action:"say-message"}];n!==this.bp.me&&"Marak"!==this.bp.me||i.push({text:"Edit Message",action:"edit-message"},{text:"Delete Message",action:"delete-message"}),i.push({text:"Cast Spell",action:"cast-spell"}),i.forEach((e=>{const t=document.createElement("div");t.className="aim-context-menu-item",t.textContent=e.text,t.setAttribute("data-action",e.action),s.appendChild(t)})),document.body.appendChild(s);const a=e.getBoundingClientRect();s.style.left=a.left-150+"px",s.style.top=a.bottom+window.scrollY-20+"px";const d=t.getAttribute("data-chat-id"),r=t.getAttribute("data-uuid");return s.setAttribute("data-chat-id",d),s.setAttribute("data-uuid",r),s.setAttribute("data-from",n),this.activeMessageContextMenu=s,this.activeMessageHoverMenu=o,s},z.prototype.bindMessageContextMenu=function(){X.call(this),document.addEventListener("click",(async e=>{const t=e.target;let o=t.getAttribute("data-action");if(console.log("clicked on target",t,o),t.classList.contains("aim-context-menu-item")&&o)return void Z.call(this,o,t);if($(t).hasClass("aim-message-reaction")||$(t).parents().hasClass("aim-message-reaction")){const e=t.closest(".aim-chat-message")?.getAttribute("data-uuid"),o=document.querySelector(`.aim-chat-message[data-uuid="${e}"]`);if(!o)return void console.error("No original message found");const s={uuid:e,chatId:o.getAttribute("data-chat-id"),from:o.getAttribute("data-from")};if(!s.uuid||!s.chatId)return void console.error("No message data found");console.log("React message clicked",s);let n=t.closest(".aim-message-reaction")?.getAttribute("data-emoji");return void await buddypond.reactInstantMessage({from:s.from,chatId:s.chatId,uuid:s.uuid,reaction:n})}let s=$(t).hasClass("aim-hover-menu-item")||$(t).parents().hasClass("aim-hover-menu-item");if(o=t.getAttribute("data-action")||t.parentNode.getAttribute("data-action"),s&&o)Z.call(this,o,t);else if(t.classList.contains("aim-edit-hint-action")&&o)B.call(this,o,t);else if(t.classList.contains("aim-reply-cancel")&&"cancel-reply"===o){const e=t.closest(".aim-reply-box");_.call(this,e)}else A.call(this)}))},z.prototype.loadUserApps=function(){if(console.log("Loading user apps..."),setTimeout((async()=>{await this.bp.load("spellbook"),await this.bp.load("coin"),await this.bp.load("soundrecorder"),await this.bp.load("camera"),await this.bp.load("dictate"),await this.bp.load("chalkboard"),await this.bp.load("paint"),await this.bp.load("painterro"),await this.bp.load("minipaint"),await this.bp.load("say")}),3e3),"Marak"===this.bp.me){let e=this.bp.settings.apps_installed||{};console.log("installedApps",e),e.admin||this.bp.apps.desktop.addApp("admin"),"function"==typeof window.arrangeDesktop&&window.arrangeDesktop()}},z.prototype.sendMessageHandler=async function(e,t,o,s){const n=$(".aim-input",t.content).val(),i={to:$(".aim-to",t.content).val(),replyto:$(".aim-replyto",t.content).val(),type:o,from:this.bp.me,message:n,ctime:Date.now(),text:n,files:[]};console.log("sendMessageHandler _data",i);const a=$(".file-preview",t.content),d=[];if((!n||0===n.length)&&0===a.length)return void console.log("No message to send");a.each(((e,t)=>{$(".file-content",t).each(((e,t)=>{const o=this.bp.apps["file-viewer"].getFile(t);o&&d.push({file:o,element:t})}))})),d.forEach((({file:e,element:t})=>{const o=$("<div>",{class:"upload-status",css:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.7)",color:"white",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3}}).text("Waiting...");$(t).css("position","relative").append(o)}));try{for(const{file:e,element:t}of d){const o=$(t).find(".upload-status");o.text("Uploading...");try{console.log("is there a filepath?",e.filePath),console.log("this is the file",e),e.filePath=e.filePath||e.name;let s=["jpeg","png","gif","webp","svg"],n=["mp3","wav","ogg","flac","aac","m4a"],a=["mp4","webm","ogg","avi","mov","mkv"],d=e.name.split(".").pop().toLowerCase();s.includes(d)&&(e.filePath="images/"+e.filePath),n.includes(d)&&(e.filePath="audio/"+e.filePath),a.includes(d)&&(e.filePath="videos/"+e.filePath),e.filePath=encodeURIComponent(e.filePath),console.log("assigning file path",e.filePath);let r=await this.bp.apps.client.api.uploadFile(e,(e=>{o.text("Uploading: "+e+"%")})),c={to:i.to,from:i.from,type:i.type,replyto:i.replyto,text:r};console.log("sending multimedia message",c),this.bp.emit("buddy::sendMessage",c),await $(t).fadeOut(300),$(t).remove()}catch(e){console.error("Error uploading file:",e),o.text("Failed: "+e.message).css("background","rgba(255, 0, 0, 0.7)"),await new Promise((e=>setTimeout(e,8e3))),await $(t).fadeOut(300),$(t).remove()}}}catch(e){console.error("Error in file upload process:",e)}if(a.each(((e,t)=>{0===$(t).children().length&&$(t).remove()})),$(".file-preview",t.content).remove(),i.type="pond"===o?"pond":"buddy",i.text.startsWith("/gif")){let e=i.text.split(" ").slice(1);if(await bp.load("image-search"),0===e.length)return await bp.open("image-search",{query:e[0],provider:"giphy-stickers",context:i.to,output:o}),void $(".aim-input",t.content).val("");let s=await bp.apps["image-search"].fetchImages(e[0],6,"giphy-stickers");if(s.error)return console.error("Image search error:",s.error),await this.showCard({chatWindow:t,cardName:"error",context:{message:s.error}}),void console.error("Error fetching images:",s.error);if(0===s.length)return void console.error("No images found for query:",e[0]);let n=s[Math.floor(Math.random()*s.length)];console.log("Random image selected:",n),i.card={type:"image",url:n}}if(i.text.startsWith("/image")){let e=i.text.split(" ").slice(1);if(console.log("/image params",e),0===e.length)return await bp.open("image-search",{query:e[0],provider:"pexels"}),void $(".aim-input",t.content).val("");await bp.load("image-search"),console.log("pppp",e);let o=await bp.apps["image-search"].fetchImages(e[0],6,"pexels");if(o.error)return console.error("Image search error:",o.error),await this.showCard({chatWindow:t,cardName:"error",context:{message:o.error}}),void console.error("Error fetching images:",o.error);if(0===o.length)return void console.error("No images found for query:",e[0]);let s=o[Math.floor(Math.random()*o.length)];console.log("Random image selected:",s),i.card={type:"image",url:s}}if(i.text.startsWith("/")&&!i.text.startsWith("/say")&&!i.text.startsWith("/roll")&&!i.text.startsWith("/gif")&&!i.text.startsWith("/image")&&!i.text.startsWith("/deepseek")){let e=this.bp.apps.buddyscript.parseCommand(i.text);return console.log("got back buddyscript command",e),e.pipe?(e.pipe({chatWindow:t,contextName:i.to,windowType:o}),$(".aim-input",t.content).val(""),!1):(console.log(" ",e),"show-card"===e.type&&(e.data,this.showCard({chatWindow:t,cardName:"bs",context:{...e,context:n.to,type:o}})),$(".aim-input",t.content).val(""),!1)}console.log(`Sending message to ${i.to} from ${i.from} of type ${i.type}:`,i.text),console.log(i.text.startsWith("\\")),i.text.startsWith("\\")&&(i.card={type:"bs",command:i.text.replace("\\","/").trim()}),this.bp.emit("buddy::sendMessage",i),$(".aim-input",t.content).val(""),$(".aim-reply-box",t.content).remove(),$(".aim-replyto",t.content).val(""),$(".aim-send-btn",t.content).css("opacity",.5)},z.prototype.showCard=async function({chatWindow:e,cardName:t,context:o={}}){let s=this.bp.apps.card.cardManager;const n=await s.loadCard(t,o,e);let i=document.createElement("div");i.classList.add("cardContainer");let a=await n.render(i,e);if(!e||!e.content)throw console.error("chatWindow not found. user most likely not in the chat window"),new Error("chatWindow.content not found. user most likely not in the chat window");let d=e.content.querySelector(".aim-messages-container");"pond"===o.type&&(d=e.content.querySelector(`.aim-messages-container[data-context="${o.context}"]`));const r=d.querySelector(".aim-messages");if(r)return r.appendChild(i),$(".aim-input",e.content).val(""),a;console.error("aim-messages not found. user most likely not in the chat window")},z.prototype.scrollToBottom=function e(t,o=0,s=0){if(!t)return;if(s>5)return;const n=$(".aim-chat-area",t)[0];n&&(0===s&&n._scrollRetryTimer&&(clearTimeout(n._scrollRetryTimer),n._scrollRetryTimer=null),$(n).scrollTop(n.scrollHeight),requestAnimationFrame((()=>{const i=n.scrollHeight-n.scrollTop-n.clientHeight<10;i?n._scrollRetryTimer=null:(o+=200,s++,n._scrollRetryTimer=setTimeout((()=>{e(t,o,s)}),o)),s>=5&&!i&&n.lastElementChild?.scrollIntoView({block:"end"})})))},z.prototype.defaultAvatarSvg=function(e){if(this.data.avatarCache.has(e))return this.data.avatarCache.get(e);const t=this.bp.vendor.dicebear.createAvatar(this.bp.vendor.dicebearAvatars,{seed:e,size:40,backgroundColor:["#f0f0f0"]}).toString();return this.data.avatarCache.set(e,t),t},z.prototype.registerEventHandlers=function(){this.bp.on("auth::qtoken","handle-auth-success",(e=>this.handleAuthSuccess(e))),this.bp.on("auth::qtoken","load-user-apps",(e=>this.loadUserApps())),this.bp.on("auth::qtoken","generate-default-profile-files",(e=>{setTimeout((()=>{try{this.generateDefaultProfile(e)}catch(e){console.error("generate-default-profile-files",e)}}),6e3)})),this.bp.on("buddylist-websocket::connected","update-buddylist-connected",(e=>{$(".onlineStatusSelect").val("online"),$(".loggedOut").flexHide(),$(".loggedIn").flexShow(),this.bp.apps.buddylist.client.wsClient.send(JSON.stringify({action:"getCoinBalance",buddyname:this.bp.me,qtokenid:this.bp.qtokenid}))})),this.bp.on("profile::buddy::in","render-or-update-buddy-in-buddylist",(e=>this.renderOrUpdateBuddyInBuddyList(e))),this.bp.on("profile::buddy::out","remove-buddy-from-buddylist",(e=>{console.log("profile::buddy::out",e);const t=e.name;let o=$(`li[data-buddy="${t}"]`,".buddylist");console.log("buddyListItem",o),o.remove()})),this.bp.on("profile::fullBuddyList","render-or-update-buddy-in-buddylist",(e=>{let t=e.buddylist||{};Array.isArray(t)&&(t=t.reduce(((e,t)=>(e[t.buddy_id]=t,e)),{})),console.log("profile::buddy::full_profile",t);for(let e in t){let o={name:e,profile:t[e]};this.data.profileState=this.data.profileState||{},this.data.profileState.buddylist=this.data.profileState.buddylist||{},this.data.profileState.buddylist[e]=o.profile,console.log("renderOrUpdateBuddyInBuddyList",o),this.renderOrUpdateBuddyInBuddyList(o)}t[this.bp.me]&&(t[this.bp.me].profile_picture&&(this.data.profileState.profilePicture=t[this.bp.me].profile_picture),t[this.bp.me].status&&(this.data.profileState.status=t[this.bp.me].status)),e.email&&(this.data.profileState.email=e.email,$(".buddy_email").val(e.email)),"boolean"==typeof e.emailVerified&&(this.data.profileState.emailVerified=e.emailVerified,e.emailVerified?$(".buddy_email_verified_text").html("Email Verified"):$(".buddy_email_verified_text").html("Email Not Verified"))})),this.bp.on("buddy::message::processed","play-im-sound",(e=>{if(e.noAlert)return;let t=new Date(e.ctime);(new Date).getTime()-t.getTime()<5e3&&bp.play("desktop/assets/audio/IM.wav")})),this.bp.on("profile::buddy::newmessage","open-chat-window",(e=>{let t="messages/"+e.name;this.bp.apps.ui.windowManager.getWindow(t)||this.openChatWindow(e)})),this.bp.on("profile::buddy::newmessage","mark-messages-as-read",(e=>this.buddyReadNewMessages(e))),this.bp.on("profile::buddy::calling","start-call",(e=>{desktop.app.videochat.startCall(!1,e.name,(function(e,t){console.log("startCall callback",e,t)}))})),this.bp.on("profile::status","update-profile-status",(e=>{this.buddyServerClient.setStatus(this.bp.me,{status:e},((t,o)=>{t&&console.error("error setting status",t),"signout"===e&&this.logout()}))})),this.bp.on("buddy::messages","render-chat-message",(e=>this.handleChatMessages(e))),this.bp.on("buddy::sendMessage","send-buddy-message-to-server",(e=>this.sendMessageToServer(e))),this.bp.on("buddy::isTyping","show-is-typing-message",(e=>{if(!0===e.isTyping){if(e.from===this.bp.me)return;let t,o=new Date(e.ctime);(new Date).getTime();"buddy"===e.type&&(t=e.to===this.bp.me?`messages/${e.from}`:`messages/${e.to}`),"pond"===e.type&&(t="pond-chat");let s=this.bp.apps.ui.windowManager.getWindow(t);o.getTime();let n=`typing-${e.from}`,i=`${e.from} is typing...`;if("pond"===e.type&&s.currentActiveContext!==e.to)return void console.log("pond chat window is not active for this pond",e.to);let a=$(`.aim-typing span[data-user="${e.from}"]`,s.content);return 0===a.length?a=$("<span></span>").attr("data-user",e.from).text(i).appendTo($(".aim-typing",s.content)):a.text(i),this.showingIsTyping[n]&&clearTimeout(this.showingIsTyping[n]),void(this.showingIsTyping[n]=setTimeout((()=>{a.remove()}),500))}})),this.bp.on("buddy::typing","send-typing-message-to-server",(e=>{this.lastTypingMessage=this.lastTypingMessage||0,(new Date).getTime(),this.lastTypingMessage,this.lastTypingMessage=(new Date).getTime();let t="";if("buddy"===e.type){t="buddy/"+[e.from,e.to].sort().join("/")}"pond"===e.type&&(t="pond/"+e.to),bp.apps.client.sendWsMessage(t,{action:"send",chatId:t,buddyname:buddypond.me,qtokenid:buddypond.qtokenid,message:{...e,chatId:t,isTyping:!0}})})),this.bp.on("buddylist-websocket::reward","update-local-coin-balance",(e=>{if(e.success){if(F($("#menu-bar-coin-balance"),e.message.newBalance),this.bp.apps.portfolio&&this.bp.apps.portfolio.portfolioWindow&&this.bp.apps.portfolio.portfolioWindow.content&&this.bp.apps.portfolio.portfolioData){this.bp.apps.portfolio.updateCoinRow(e.message.symbol,{symbol:e.message.symbol,amount:e.message.newBalance,available:e.message.newBalance,price:.001,cost:.001*e.message.newBalance});let t=$("#coin-send-name"),o=$("#current-balance");if("GBP"===t.val()){const t=e.message.newBalance.toLocaleString("en-US");o.text(t)}}}else console.log(e.message)})),this.bp.on("buddylist-websocket::coinBalance","update-local-coin-balance",(async e=>{console.log("buddylist-websocket::coinBalance",e),"number"==typeof e.message.balance?F($("#menu-bar-coin-balance"),e.message.balance):(this.faucetAttempts++,this.faucetAttempts<3?(await this.requestDefaultCoinAllocations(),this.bp.apps.buddylist.client.wsClient.send(JSON.stringify({action:"getCoinBalance",buddyname:this.bp.me,qtokenid:this.bp.qtokenid}))):console.warn("BuddyList: Too many faucet attempts, not requesting balance again this session"))}))},z.prototype.createBuddyListWindow=function(){let e=window.innerWidth-250;return this.bp.apps.ui.windowManager.createWindow({app:"buddylist",type:"buddylist-profile",title:"Buddy List",icon:"/desktop/assets/images/icons/icon_profile_64.png",id:"buddylist",parent:this.bp.apps.ui.parent,width:250,height:500,x:e,y:50,onOpen:()=>{$('.loginForm input[name="username"]').focus()},onClose:()=>{this.opened=!1,this.client&&(this.client.disconnect(),this.client=null),this.bp.connected=!1}})},z.prototype.logout=function(){$(".loginButton").prop("disabled",!1),$(".loginButton").removeClass("disabled"),$("#menu-bar-coin-balance").text("0"),this.buddyServerClient.setStatus(this.bp.me,{status:"offline"},((e,t)=>{console.log("buddypond.setStatus",e,t),this.bp.apps.ui.windowManager.windows.forEach((e=>{console.log("closing window",e),"buddy"!==e.type&&"pond"!==e.type||e.close()})),$(".password").val(""),$(".loggedIn").flexHide(),$(".loggedOut").flexShow(),this.data.profileState=null,this.bp.play("desktop/assets/audio/GOODBYE.wav"),this.bp.apps.client.logout(),this.client.disconnect(),this.buddyServerClient.disconnect(),this.bp.connected=!1,this.client=null,this.buddyServerClient=null,this.data={processedMessages:{},profileState:{},activeUsersInContext:{},activeUsers:[],activePonds:[],avatarCache:new Map},$(".buddylist").empty(),$(".dialog").remove()}))},z.prototype.Client=q;export{z as default};
//# sourceMappingURL=buddylist.js.map
