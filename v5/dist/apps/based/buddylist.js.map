{"version":3,"file":"buddylist.js","sources":["../../../apps/based/buddylist/lib/renderOrUpdateBuddyInBuddyList.js","../../../apps/based/buddylist/lib/message/renderGeoFlag.js","../../../apps/based/buddylist/lib/message/parseMarkdownWithoutPTags.js","../../../apps/based/buddylist/lib/message/createChatMessageElement.js","../../../apps/based/buddylist/lib/forbiddenNotes.js","../../../apps/based/buddylist/lib/message/checkForLinksInMessage.js","../../../apps/based/buddylist/lib/message/isValidUrl.js","../../../apps/based/buddylist/lib/message/isValidYoutubeLink.js","../../../apps/based/buddylist/lib/message/isValidGithubLink.js","../../../apps/based/buddylist/lib/message/setupInputEvents.js","../../../apps/based/buddylist/lib/message/setupAutocomplete.js","../../../apps/based/buddylist/lib/ChatWindowButtonBar.js","../../../apps/based/buddylist/lib/message/setupChatWindowButtons.js","../../../apps/based/buddylist/lib/message/populateRoomList.js","../../../apps/based/buddylist/lib/openChatWindow.js","../../../apps/based/buddylist/lib/defaultProfileFiles.js","../../../apps/based/buddylist/lib/generateDefaultProfile.js","../../../apps/based/buddylist/lib/message/bindMessageContextMenu.js","../../../apps/based/buddylist/lib/registerEventHandlers.js","../../../apps/based/buddylist/lib/ws/Client.js","../../../apps/based/buddylist/lib/ws/server/createWebSocketServerClient.js","../../../apps/based/buddylist/lib/ws/createWebSocketClient.js","../../../apps/based/buddylist/lib/ws/server/ServerClient.js","../../../apps/based/buddylist/buddylist.js","../../../apps/based/buddylist/lib/defaultChatWindowButtons.js","../../../apps/based/buddylist/lib/message/renderChatMessage.js","../../../apps/based/buddylist/lib/renderBuddyRequests.js","../../../apps/based/buddylist/lib/buddylistUIEvents.js","../../../apps/based/buddylist/lib/requestDefaultCoinAllocations.js","../../../apps/based/buddylist/lib/sortBuddyList.js","../../../apps/based/buddylist/lib/showContextMenu.js","../../../apps/based/buddylist/lib/message/createMessageContextMenu.js","../../../apps/based/buddylist/lib/loadUserApps.js","../../../apps/based/buddylist/lib/message/sendMessageHandler.js","../../../apps/based/buddylist/lib/message/showCard.js","../../../apps/based/buddylist/lib/message/scrollToBottom.js","../../../apps/based/buddylist/lib/buddy/defaultAvatarSvg.js","../../../apps/based/buddylist/lib/createBuddyListWindow.js","../../../apps/based/buddylist/lib/logout.js"],"sourcesContent":["// Timeout is for legacy API before websocket connections\n// We should now have a reliable way to track buddy status via websocket disconnect events\n// 15 minute hard-code timeout ( if setStatus() was missed )\nlet buddyTimeoutsInterval = 1000 * 60 * 60 * 5; // 5 hours, shoudn't be needed unless unknown error on server\n\nexport default function renderOrUpdateBuddyInBuddyList(data) {\n  let bp = this.bp;\n  let buddyname = data.name;\n  let buddydata = data.profile;\n\n  this.bp.buddyTimeouts = this.bp.buddyTimeouts || {};\n\n  // console.log('renderOrUpdateBuddyInBuddyList', buddyname, buddydata);\n\n  // Track previous connection status to detect changes\n  let buddyListItems = document.querySelectorAll('.buddylist li');\n  let existingBuddy = Array.from(buddyListItems).find(el => el.dataset.buddy === buddyname);\n  let wasConnected = existingBuddy ? existingBuddy.querySelector('.buddy-status').textContent.includes('ðŸŸ¢') : false;\n\n  // Handle status update only if status field is present\n  if (buddydata.hasOwnProperty('status')) {\n    if (buddydata.status === 'online') {\n      buddydata.isConnected = true;\n    } else {\n      buddydata.isConnected = false;\n    }\n\n    // console.log('isConnected', buddydata.isConnected, buddyname, buddydata.status);\n\n    // Clear the timeout if it exists\n    if (this.bp.buddyTimeouts[buddyname]) {\n      clearTimeout(this.bp.buddyTimeouts[buddyname]);\n      delete this.bp.buddyTimeouts[buddyname];\n    }\n\n    // Remark: Added 5/18/2025: Adds check if user hasn't been online for a while ( this is needed for legacy API )\n    // This may still stay in as CF worker could miss disconnect events\n    // TODO: consider re-implementing a keepAlive ping each 30 minutes\n    let now = new Date().getTime();\n    //console.log('BuddyList: buddydata.utime', buddyname, buddydata.utime, 'now', now);\n    let diff = now - buddydata.utime;\n    //console.log('BuddyList: diff', buddyname, buddydata.utime, diff, buddyTimeoutsInterval);  \n    // console.log('buddydata.utime', buddydata.utime, 'now', now, 'diff', diff);\n    // console.log('BuddyList: diff', buddyname, buddydata.utime, diff, buddyTimeoutsInterval);\n    // If buddy hasn't been online for a while, set them to offline\n    if (buddydata.isConnected && diff > buddyTimeoutsInterval) {\n      // console.log('Setting offline due to timeout', buddyname, buddydata.utime, diff);\n\n      // if buddydata.status is online and this is ourself, always keep as online\n      // Remark: Potential issue with utime not being updated on login for self?\n      if (buddyname === this.bp.me) {\n        buddydata.isConnected = true;\n      } else {\n        buddydata.isConnected = false;\n      }\n\n    }\n\n    /*\n    Remark: Removed 5/17/2025, no longer depending on utime / keepAlives\n    let now = new Date().getTime();\n    let diff = now - buddydata.utime;\n    if (now - buddydata.utime > buddyTimeoutsInterval) {\n      // console.log('Setting offline due to timeout', buddyname, buddydata.utime, diff);\n      buddydata.isConnected = false;\n    }\n    */\n    // Remark: Removed 5/17/2025, no longer depending on utime / keepAlives\n    // We may need to add this back in the future for cases when CF worker abruptly disconnects\n    // This would rely on a ping mechanism to keep the connection alive and update the utime\n    // Set a timeout to mark buddy as offline if they are currently connected\n    /*\n    if (buddydata.isConnected) {\n      this.bp.buddyTimeouts[buddyname] = setTimeout(() => {\n        let _data = {\n          name: buddyname,\n          profile: {\n            buddyname: buddyname,\n            isConnected: false,\n            status: 'offline',\n            utime: new Date().getTime(),\n            dtime: new Date().getTime(),\n            newMessages: false\n          }\n        };\n        renderOrUpdateBuddyInBuddyList.call(this, _data, false);\n      }, buddyTimeoutsInterval * 1.5);\n    }\n    */\n\n    // Play sound based on status change\n    // Don't play sound if buddy is me\n    if (buddyname !== this.bp.me) {\n      if (buddydata.isConnected && !wasConnected) {\n        // compare now time with buddydata.utime\n        // if less than 5 seconds, don't play sound\n        let now = new Date().getTime();\n        let diff = now - buddydata.utime;\n        if (diff > 300) {\n          bp.play('desktop/assets/audio/BUDDY-IN.mp3'); // Buddy comes online\n        }\n      } else if (!buddydata.isConnected && wasConnected) {\n        // Remark: Removed the signout sound as it was too loud / jarring\n        // bp.play('desktop/assets/audio/BUDDY-OUT.wav'); // Buddy goes offline\n      }\n    }\n  }\n\n  // Use existing isConnected if available, otherwise derive from DOM state\n  let isConnected = buddydata.hasOwnProperty('isConnected') ? buddydata.isConnected : wasConnected;\n  // console.log(buddydata);\n  if (buddydata.newMessages && buddydata.newMessages) {\n    isConnected = true;\n    this.bp.apps.buddylist.openChatWindow({ context: buddyname, type: 'buddy' });\n  }\n\n  let connectedStatusIcon = isConnected ? 'ðŸŸ¢' : 'ðŸŸ ';\n  let isCalling = buddydata.isCalling ? '<span>ðŸ“ž</span>' : '';\n  let newMessages = buddydata.newMessages ? '<span>ðŸ’¬</span>' : '';\n\n  let lastSeen = buddydata.utime ? buddydata.utime : 0;\n  let lastSeenDate = new Date(lastSeen);\n  let lastSeenString = '';\n\n  try {\n    lastSeenString = 'Last seen: ' + lastSeenDate.toLocaleString('en-US', {\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit',\n      hour12: true\n    });\n  } catch (err) {\n    console.log('Error formatting last seen date', err);\n  }\n\n  // Update or create buddy list item\n  let buddyListItemEl;\n  if (existingBuddy) {\n    // Update existing element to prevent flicker\n    buddyListItemEl = existingBuddy;\n    buddyListItemEl.dataset.utime = buddydata.utime;\n    buddyListItemEl.title = lastSeenString;\n    buddyListItemEl.querySelector('.buddy-status').innerHTML = `${newMessages}${connectedStatusIcon}${isCalling}`;\n    buddyListItemEl.querySelector('.message-buddy').textContent = buddyname;\n    buddyListItemEl.style.display = buddydata.status === 'hidden' ? 'none' : '';\n  } else {\n    // Create new element if buddy doesn't exist\n    let buddyListItem = `<li data-buddy=\"${buddyname}\" data-utime=\"${buddydata.utime}\" class=\"buddy-message-sender\" title=\"${lastSeenString}\">\n                          <span class=\"buddy-status\">${newMessages}${connectedStatusIcon}${isCalling}</span> \n                          <span data-buddy=\"${buddyname}\" class=\"message-buddy\" href=\"#\" draggable=\"false\">${buddyname}</span>\n                        </li>`;\n    buddyListItemEl = document.createElement('div');\n    buddyListItemEl.innerHTML = buddyListItem;\n    buddyListItemEl = buddyListItemEl.firstChild;\n\n    if (buddydata.status === 'hidden') {\n      buddyListItemEl.style.display = 'none';\n    }\n  }\n\n  if (buddydata.utime) {\n    let formattedDate = DateFormat.format.date(buddydata.utime, 'E MMMM dd, hh:mm:ss a');\n    $(buddyListItemEl).find('.buddy-status').attr('title', formattedDate);\n  }\n\n  // Append new buddy or ensure existing one is in the list\n  if (!existingBuddy) {\n    $('.buddylist').append(buddyListItemEl);\n  }\n\n  // Re-sort the entire buddy list\n  this.sortBuddyList();\n\n  // Add context menu functionality\n  attachContextMenu.call(this, buddyListItemEl);\n}\n\nfunction attachContextMenu(buddyElement) {\n  $(buddyElement).on('contextmenu', (e) => {\n    e.preventDefault();\n    let buddyName = e.target.closest('li').dataset.buddy;\n    this.showContextMenu(e.pageX, e.pageY, buddyName);\n  });\n}","const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });\n\nexport default function renderGeoFlag(message) {\n    if (message.location === 'outer space' || !message.location) {\n      // Set Antarctica to the default flag when the location is 'outer space'\n      message.location = 'AQ';\n    }\n  \n    if (!message.location || message.location === 'outer space') {\n      return document.createElement('span');  // Return an empty span if no flag should be displayed\n    }\n  \n    // Create an image element for the flag\n    let img = document.createElement('img');\n    img.className = 'geoFlag';\n    img.src = `desktop/assets/geo-flags/flags/4x3/${message.location.toLowerCase()}.svg`;\n    img.title = regionNames.of(message.location) || message.location;\n    return img;\n  }\n  ","// Function to remove outer <p> tags\nexport default function parseMarkdownWithoutPTags(markdown) {\n  if (!markdown) return ''; // empty text\n\n\n  if (isEmojiOnly(markdown)) {\n    return renderBigEmojiHTML(markdown);\n  }\n\n  // Supported colors and styles\n  const supportedColors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'black', 'white', 'gray', 'cyan', 'magenta', 'pink'];\n  const supportedStyles = ['bold', 'italic', 'underline', 'strike', 'blink', 'reverse', 'hidden', 'dim', 'rainbow'];\n\n  // Custom renderer for links to add target=\"_blank\"\n  const linkExtension = {\n    name: 'link',\n    level: 'inline',\n    renderer(token) {\n      // Ensure href is properly encoded\n      const href = token.href.replace(/\"/g, '&quot;');\n      // Add target=\"_blank\" and rel=\"noopener\" for security\n      return `<a href=\"${href}\" target=\"_blank\" rel=\"noopener\">${this.parser.parseInline(token.tokens)}</a>`;\n    }\n  };\n\n  const styleExtension = {\n    name: 'style',\n    level: 'inline',\n\n    tokenizer(src) {\n      const match = /^((?:\\w+\\.)*\\w+)\\(\\s*([\\s\\S]+?)\\s*\\)/.exec(src);\n      if (match) {\n        const raw = match[0];\n        const modifiers = match[1].split('.');\n        const text = match[2];\n\n        const isValid = modifiers.every(mod => supportedColors.includes(mod) || supportedStyles.includes(mod));\n        if (!isValid) return;\n\n        return {\n          type: 'style',\n          raw,\n          modifiers,\n          text,\n          tokens: this.lexer.inlineTokens(text)\n        };\n      }\n    },\n    renderer(token) {\n      let content = this.parser.parseInline(token.tokens);\n\n      // Apply modifiers in reverse order to maintain proper nesting\n      token.modifiers.reverse().forEach(mod => {\n        if (supportedColors.includes(mod)) {\n          content = `<span class=\"message-decoration-color-${mod}\">${content}</span>`;\n        } else if (mod === 'bold') {\n          content = `<strong class=\"message-decoration-bold\">${content}</strong>`;\n        } else if (mod === 'italic') {\n          content = `<em class=\"message-decoration-italic\">${content}</em>`;\n        } else if (mod === 'underline') {\n          content = `<u class=\"message-decoration-underline\">${content}</u>`;\n        } else if (mod === 'strike') {\n          content = `<s class=\"message-decoration-strike\">${content}</s>`;\n        } else if (mod === 'blink') {\n          content = `<span class=\"message-decoration-blink\">${content}</span>`;\n        } else if (mod === 'reverse') {\n          content = content.split('').reverse().join('');\n        } else if (mod === 'hidden') {\n          content = `<span class=\"message-decoration-hidden\">${content}</span>`;\n        } else if (mod === 'dim') {\n          content = `<span class=\"message-decoration-dim\">${content}</span>`;\n        } else if (mod === 'rainbow') {\n          content = `<span class=\"message-decoration-rainbow\">${content}</span>`;\n        }\n      });\n\n      return content;\n    },\n\n\n    walkTokens(token) {\n      if (token.type === 'style') {\n        console.log(`Detected style token: ${token.modifiers.join('.')}`);\n      }\n    }\n  };\n\n  marked.use({ extensions: [styleExtension, linkExtension] });\n\n  let html;\n  try {\n    html = marked.parse(markdown);\n  } catch (error) {\n    html = markdown;\n  }\n\n  // register the hook once at module init\n  if (!DOMPurify.__added_anchor_hook) {\n    DOMPurify.addHook('afterSanitizeAttributes', function (node) {\n      // only run for <a>\n      if (node.tagName && node.tagName.toLowerCase() === 'a') {\n        const href = node.getAttribute('href') || '';\n\n        // Validate URL scheme (same rules as ALLOWED_URI_REGEXP)\n        try {\n          const url = new URL(href, 'https://example.com'); // base for relative URLs\n          if (!/^(https?:|mailto:|tel:)/i.test(url.protocol)) {\n            // Disallow link entirely (or remove href)\n            node.removeAttribute('href');\n            node.removeAttribute('target');\n            node.removeAttribute('rel');\n            return;\n          }\n        } catch (e) {\n          // malformed -> remove\n          node.removeAttribute('href');\n          node.removeAttribute('target');\n          node.removeAttribute('rel');\n          return;\n        }\n\n        // Ensure anchors open safely in a new tab\n        // We force _blank and ensure rel contains noopener noreferrer\n        node.setAttribute('target', '_blank');\n\n        const existing = (node.getAttribute('rel') || '').split(/\\s+/).filter(Boolean);\n        if (!existing.includes('noopener')) existing.push('noopener');\n        if (!existing.includes('noreferrer')) existing.push('noreferrer');\n        node.setAttribute('rel', existing.join(' '));\n      }\n    });\n    DOMPurify.__added_anchor_hook = true;\n  }\n\n  // sanitize: allow the tags/attrs you need, and restrict allowed URI schemes\n  const clean = DOMPurify.sanitize(html, {\n    ALLOWED_TAGS: [\n      'a', 'span', 'strong', 'em', 'u', 's', 'div', 'br', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',\n      'ul', 'ol', 'li', 'code', 'pre', 'blockquote', 'img'\n    ],\n    ALLOWED_ATTR: [\n      'href', 'target', 'rel', 'class', 'data-char-index', 'src'\n    ],\n    FORCE_BODY: true,\n    KEEP_CONTENT: true,\n    SANITIZE_DOM: true,\n    // RETURN_TRUSTED_TYPE: true, // progressive support for supporting Trusted Types, works when available\n    // this will return DOM if supported, otherwise returns string, TODO: would need to handle both cases\n    // allow only http(s), mailto, tel for href/src\n    ALLOWED_URI_REGEXP: /^(?:(https?|mailto|tel):|\\/)/i\n  });\n\n  return clean.replace(/^<p>(.*?)<\\/p>\\s*$/s, '$1');\n  // Explanation:\n  // ^<p>       â†’ Matches the opening <p> at the start\n  // (.*?)      â†’ Captures the content inside (non-greedy)\n  // <\\/p>\\s*$  â†’ Matches the closing </p> with optional trailing whitespace\n  // $1         â†’ Returns only the captured content\n}\n\n// Shared helper: Split emoji-aware graphemes\nfunction splitEmojiGraphemes(text) {\n  const splitter = new GraphemeSplitter();\n  return splitter.splitGraphemes(text.trim());\n}\n\n// Strip variation selector (U+FE0F) for matching against EMOJIS\nfunction normalizeEmoji(str) {\n  return str.replace(/\\uFE0F/g, '');\n}\n\nfunction isEmojiOnly(text) {\n  if (!text) return false;\n\n  // if text is longer than 7 length, return false immediately\n  if (text.length > 7) return false;\n\n  const graphemes = splitEmojiGraphemes(text);\n  const emojiList = new Set(Object.keys(EMOJIS));\n\n  const emojis = graphemes.filter(g =>\n    emojiList.has(g) || emojiList.has(normalizeEmoji(g))\n  );\n\n  return emojis.length > 0 &&\n    emojis.length <= 7 &&\n    emojis.join('') === text.trim();\n}\n\n// Render big emoji HTML\nfunction renderBigEmojiHTML(text) {\n  const graphemes = splitEmojiGraphemes(text);\n  return `<div class=\"emoji-only\">` +\n    graphemes.map(g => `<span class=\"big-emoji\">${g}</span>`).join('') +\n    `</div>`;\n}","import renderGeoFlag from './renderGeoFlag.js';\nimport parseMarkdownWithoutPTags from './parseMarkdownWithoutPTags.js';\n\n// Configuration\nconst config = {\n  useMarkdown: true,\n  allowHTML: true,\n};\n\n// New function to create hover menu\n// TODO: remove buttons, just use icons\n// TODO: update bindMessageContextMenu() method to bind to the icons instead of buttons\nfunction createHoverMenu(message) {\n  const hoverMenu = document.createElement('div');\n  hoverMenu.className =\n    'aim-hover-menu';\n\n  const menuItems = [];\n\n  menuItems.push({ text: 'React', action: 'react-message', svg: 'desktop/assets/images/icons/svg/1f600.svg' });\n\n\n  if (message.from === this.bp.me || this.bp.me === 'Marak') { // TODO: admin rbac\n    menuItems.push({ text: 'Edit Message', action: 'edit-message', icon: 'fa-duotone fa-regular fa-pencil' });\n  }\n\n  menuItems.push({ text: 'Reply Message', action: 'reply-message', icon: 'fa-duotone fa-regular fa-reply' });\n  menuItems.push({ text: '...', action: 'more-options', icon: 'fa-solid fa-regular fa-ellipsis' });\n\n\n  menuItems.forEach(item => {\n    const button = document.createElement('button');\n    button.setAttribute('data-action', item.action);\n    button.className = 'aim-hover-menu-item';\n\n    if (item.icon) {\n      const icon = document.createElement('i');\n      icon.className = item.icon;\n      button.appendChild(icon);\n      button.appendChild(document.createTextNode(' ')); // Add space between icon and text\n    } else if (item.svg) {\n      // create svg element\n      const svg = document.createElement('img');\n      svg.src = item.svg;\n      svg.alt = item.text;\n      svg.className = 'aim-hover-menu-svg-icon';\n      button.appendChild(svg);\n      // button.appendChild(document.createTextNode(' ')); // Add space between icon and text\n\n    } else {\n      button.appendChild(document.createTextNode(item.text));\n    }\n    // set title hint with item.text  \n    button.setAttribute('title', item.text);\n    hoverMenu.appendChild(button);\n  });\n\n  return hoverMenu;\n}\n\nexport default function createChatMessageElement(message, messageTime, chatWindow, cardContainer) {\n  // Create main message container\n  const chatMessage = document.createElement('div');\n  chatMessage.className = 'aim-chat-message';\n  chatMessage.setAttribute('data-id', message.id);\n  chatMessage.setAttribute('data-from', message.from);\n  chatMessage.setAttribute('data-to', message.to);\n  chatMessage.setAttribute('data-type', message.type);\n  chatMessage.setAttribute('data-uuid', message.uuid);\n  chatMessage.setAttribute('data-chat-id', message.chatId);\n\n  // Profile picture (SVG)\n  const profilePicture = document.createElement('div');\n  profilePicture.className = 'aim-profile-picture';\n\n  if (!message.profilePicture) {\n    // check if we happen to have a profilePicture in local cache\n    // this may happen if Randolph or other admin is sending messages on behalf of a user\n    // TODO: better way to do this...\n    if (\n      this.bp.apps.buddylist.data.profileState &&\n      this.bp.apps.buddylist.data.profileState.buddylist &&\n      this.bp.apps.buddylist.data.profileState.buddylist[message.from] &&\n      this.bp.apps.buddylist.data.profileState.buddylist[message.from].profile_picture) {\n      message.profilePicture = this.bp.apps.buddylist.data.profileState.buddylist[message.from].profile_picture;\n    }\n\n  }\n\n  if (message.profilePicture) {\n    // use url as profile picture src\n    const img = document.createElement('img');\n    if (window.discordMode) {\n      message.profilePicture = message.profilePicture.replace('https://files.buddypond.com', bp.config.cdn);\n    }\n    img.src = message.profilePicture;\n    img.alt = `${message.from}'s avatar`;\n    img.className = 'aim-chat-message-profile-picture-img';\n    profilePicture.appendChild(img);\n  } else {\n    const defaultAvatar = this.defaultAvatarSvg(message.from);\n    profilePicture.innerHTML = defaultAvatar;\n  }\n\n  // console.log('profilePicture', profilePicture);\n  profilePicture.alt = `${message.from}'s avatar`;\n\n  // Message content wrapper\n  const contentWrapper = document.createElement('div');\n  contentWrapper.className = 'aim-content-wrapper';\n\n  // Message header (sender + timestamp)\n  const messageHeader = document.createElement('div');\n  messageHeader.className = 'aim-message-header';\n\n  const sender = document.createElement('span');\n  sender.className = 'aim-sender';\n  sender.textContent = message.from === 'anonymous'\n    ? `Anonymous (${message.tripcode || 'tr1pc0d3'})`\n    : message.from;\n\n  const timestamp = document.createElement('span');\n  timestamp.className = 'aim-timestamp';\n  timestamp.textContent = messageTime;\n\n  // Message meta (geoflag + badges placeholder)\n  const messageMeta = document.createElement('div');\n  messageMeta.className = 'aim-message-meta';\n\n  const geoFlag = renderGeoFlag(message);\n  const badgesContainer = document.createElement('span');\n  badgesContainer.className = 'aim-badges';\n\n  messageMeta.appendChild(geoFlag);\n  messageMeta.appendChild(badgesContainer);\n\n  messageHeader.appendChild(sender);\n  messageHeader.appendChild(messageMeta);\n  messageHeader.appendChild(timestamp);\n\n  // Reply indicator (if message is a reply)\n  let replyIndicator = null;\n  if (message.replyto) {\n    const repliedMessage = chatWindow.content.querySelector(\n      `.aim-chat-message[data-uuid=\"${message.replyto}\"]`\n    );\n    if (repliedMessage) {\n      const repliedSender = repliedMessage.querySelector('.aim-sender')?.textContent || 'Unknown';\n      const repliedText = repliedMessage.querySelector('.aim-message-content')?.innerText || '';\n\n      replyIndicator = document.createElement('div');\n      replyIndicator.className = 'aim-reply-indicator';\n      replyIndicator.innerHTML = `\n        <span class=\"aim-reply-sender\">${repliedSender}</span>\n        <span class=\"aim-reply-content\">${repliedText}</span>\n      `;\n\n      // Add click handler to scroll to the replied message\n      const replySender = replyIndicator.querySelector('.aim-reply-sender');\n      replySender.addEventListener('click', () => {\n        repliedMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });\n        repliedMessage.classList.add('aim-highlight');\n        setTimeout(() => repliedMessage.classList.remove('aim-highlight'), 2000);\n      });\n    }\n  }\n\n  // Message content\n  const messageContent = document.createElement('div');\n  messageContent.className = 'aim-message-content';\n\n  const processedText = config.useMarkdown\n    ? parseMarkdownWithoutPTags(message.text)\n    : message.text;\n\n  if (config.allowHTML) {\n    messageContent.innerHTML = processedText;\n  } else {\n    messageContent.textContent = processedText;\n  }\n\n  // Message reactions\n  const reactionsContainer = document.createElement('div');\n  reactionsContainer.className = 'aim-message-reactions';\n\n  if (message.reactions) {\n    // console.log('message.reactions', message.reactions);\n    message.reactions = JSON.parse(message.reactions);\n    for (let reaction in message.reactions) {\n      // console.log('reaction', reaction, 'count', message.reactions[reaction]);\n      const count = message.reactions[reaction].count;\n      // console.log('Rendering reaction:', reaction, count);\n      const reactionElement = document.createElement('span');\n      reactionElement.className = 'aim-message-reaction';\n      reactionElement.setAttribute('data-emoji', reaction);\n      reactionElement.innerHTML = `\n        <span class=\"aim-reaction-emoji\">${reaction}</span>\n        <span class=\"aim-reaction-count\">${count}</span>\n      `;\n      // add title property to reactionElement with .buddies who reacted\n      const buddies = message.reactions[reaction].buddies || [];\n      if (buddies.length > 0) {\n        reactionElement.setAttribute('title', `Reacted by: ${buddies.join(', ')}`);\n      }\n      reactionsContainer.appendChild(reactionElement);\n    }\n\n  }\n\n  // Hover menu\n  const hoverMenu = createHoverMenu.call(this, message)\n\n  // Assemble message\n  contentWrapper.appendChild(messageHeader);\n  if (replyIndicator) {\n    contentWrapper.appendChild(replyIndicator);\n  }\n  contentWrapper.appendChild(messageContent);\n  contentWrapper.appendChild(hoverMenu);\n\n  if (cardContainer) {\n    contentWrapper.appendChild(cardContainer);\n  }\n\n  contentWrapper.appendChild(reactionsContainer);\n\n\n  chatMessage.appendChild(profilePicture);\n  chatMessage.appendChild(contentWrapper);\n\n  // Image load handler\n  chatMessage.querySelectorAll('img').forEach(img => {\n    img.addEventListener('load', () => {\n      // Implement scrollToBottom when ready\n    });\n  });\n\n  insertChatMessage(chatWindow, message, chatMessage);\n  return chatMessage;\n}\n\n// Remark: Origina unoptimized version, left here for reference\n// TODO: remove this after new code path has been verified in production for some time\n/*\nfunction insertChatMessageLegacy(chatWindow, message, chatMessage) {\n  // console.log('insertChatMessage', chatWindow, message, chatMessage);\n  let aimMessages = chatWindow.content.querySelector('.aim-messages');\n\n  if (message.type === 'pond') {\n    // console.log('Inserting message into pond chat window', message);\n    aimMessages = chatWindow.content.querySelector(`.aim-messages-container[data-context=\"${message.to}\"] .aim-messages`);\n    // console.log('Pond messages container found:', aimMessages);\n  }\n\n  if (!aimMessages) {\n    // TODO: this case should never be hit? investigate why it is being hit sometimes\n    console.log('aim-messages not found. chat window is not yet ready...');\n    return;\n  }\n\n  const allMessages = Array.from(aimMessages.querySelectorAll('.aim-chat-message'));\n  let inserted = false;\n\n  for (const existingMessage of allMessages) {\n    const existingId = parseInt(existingMessage.getAttribute('data-id'), 10);\n    if (message.id < existingId) {\n      // Remark: insertBefore is taking up a lot of CPU time when loading large chat histories\n      aimMessages.insertBefore(chatMessage, existingMessage);\n      inserted = true;\n      break;\n    }\n  }\n\n  if (!inserted) {\n    aimMessages.appendChild(chatMessage);\n  }\n\n  return chatMessage;\n}\n*/\n\n// Remark: new optimized version using binary search, may be able to optimize further\nfunction insertChatMessage(chatWindow, message, chatMessage) {\n  let aimMessages = chatWindow.content.querySelector('.aim-messages');\n\n  if (message.type === 'pond') {\n    aimMessages = chatWindow.content.querySelector(\n      `.aim-messages-container[data-context=\"${message.to}\"] .aim-messages`\n    );\n  }\n\n  if (!aimMessages) {\n    console.log('aim-messages not found. chat window is not yet ready...');\n    return;\n  }\n\n  const children = aimMessages.children;\n  const count = children.length;\n\n  // âœ… Fast path: append if empty or greater than last message ID\n  if (\n    count === 0 ||\n    message.id > parseInt(children[count - 1].getAttribute('data-id'), 10)\n  ) {\n    aimMessages.appendChild(chatMessage);\n    return chatMessage;\n  }\n\n  // âœ… Binary search for insertion point\n  let low = 0;\n  let high = count - 1;\n  let insertBeforeNode = null;\n\n  while (low <= high) {\n    const mid = (low + high) >> 1;\n    const midId = parseInt(children[mid].getAttribute('data-id'), 10);\n\n    if (isNaN(midId)) {\n      console.warn(`Invalid data-id on message node:`, children[mid]);\n      low = mid + 1;\n      continue;\n    }\n\n    if (message.id < midId) {\n      insertBeforeNode = children[mid];\n      high = mid - 1;\n    } else {\n      low = mid + 1;\n    }\n  }\n\n  if (insertBeforeNode) {\n    aimMessages.insertBefore(chatMessage, insertBeforeNode);\n  } else {\n    // fallback, though fast path usually covers this\n    aimMessages.appendChild(chatMessage);\n  }\n\n  return chatMessage;\n}","// contains list of bad words we dont't want the Desktop to render\n// these are stored as Base64 so we don't have to see them introduced into the codebase\n// if you wish to view the list simply run: \"console.log(atob(forbiddenNotes.base64))\" in console\n\nlet forbiddenNotes = {\n  \"base64\": \"WyI0cjVlIiwiNWgxdCIsIjVoaXQiLCJhNTUiLCJhbmFsIiwiYW51cyIsImFyNWUiLCJhcnJzZSIsImFyc2UiLCJhc3MiLCJhc3MtZnVja2VyIiwiYXNzZXMiLCJhc3NmdWNrZXIiLCJhc3NmdWtrYSIsImFzc2hvbGUiLCJhc3Nob2xlcyIsImFzc3dob2xlIiwiYV9zX3MiLCJiIXRjaCIsImIwMGJzIiwiYjE3Y2giLCJiMXRjaCIsImJhbGxiYWciLCJiYWxscyIsImJhbGxzYWNrIiwiYmFzdGFyZCIsImJlYXN0aWFsIiwiYmVhc3RpYWxpdHkiLCJiZWxsZW5kIiwiYmVzdGlhbCIsImJlc3RpYWxpdHkiLCJiaStjaCIsImJpYXRjaCIsImJpdGNoIiwiYml0Y2hlciIsImJpdGNoZXJzIiwiYml0Y2hlcyIsImJpdGNoaW4iLCJiaXRjaGluZyIsImJsb29keSIsImJsb3cgam9iIiwiYmxvd2pvYiIsImJsb3dqb2JzIiwiYm9pb2xhcyIsImJvbGxvY2siLCJib2xsb2siLCJib25lciIsImJvb2IiLCJib29icyIsImJvb29icyIsImJvb29vYnMiLCJib29vb29icyIsImJvb29vb29vYnMiLCJicmVhc3RzIiwiYnVjZXRhIiwiYnVnZ2VyIiwiYnVtIiwiYnVubnkgZnVja2VyIiwiYnV0dCIsImJ1dHRob2xlIiwiYnV0dG11bmNoIiwiYnV0dHBsdWciLCJjMGNrIiwiYzBja3N1Y2tlciIsImNhcnBldCBtdW5jaGVyIiwiY2F3ayIsImNoaW5rIiwiY2lwYSIsImNsMXQiLCJjbGl0IiwiY2xpdG9yaXMiLCJjbGl0cyIsImNudXQiLCJjb2NrIiwiY29jay1zdWNrZXIiLCJjb2NrZmFjZSIsImNvY2toZWFkIiwiY29ja211bmNoIiwiY29ja211bmNoZXIiLCJjb2NrcyIsImNvY2tzdWNrICIsImNvY2tzdWNrZWQgIiwiY29ja3N1Y2tlciIsImNvY2tzdWNraW5nIiwiY29ja3N1Y2tzICIsImNvY2tzdWthIiwiY29ja3N1a2thIiwiY29rIiwiY29rbXVuY2hlciIsImNva3N1Y2thIiwiY29vbiIsImNveCIsImNyYXAiLCJjdW0iLCJjdW1tZXIiLCJjdW1taW5nIiwiY3VtcyIsImN1bXNob3QiLCJjdW5pbGluZ3VzIiwiY3VuaWxsaW5ndXMiLCJjdW5uaWxpbmd1cyIsImN1bnQiLCJjdW50bGljayAiLCJjdW50bGlja2VyICIsImN1bnRsaWNraW5nICIsImN1bnRzIiwiY3lhbGlzIiwiY3liZXJmdWMiLCJjeWJlcmZ1Y2sgIiwiY3liZXJmdWNrZWQgIiwiY3liZXJmdWNrZXIiLCJjeWJlcmZ1Y2tlcnMiLCJjeWJlcmZ1Y2tpbmcgIiwiZDFjayIsImRhbW4iLCJkaWNrIiwiZGlja2hlYWQiLCJkaWxkbyIsImRpbGRvcyIsImRpbmsiLCJkaW5rcyIsImRpcnNhIiwiZGxjayIsImRvZy1mdWNrZXIiLCJkb2dnaW4iLCJkb2dnaW5nIiwiZG9ua2V5cmliYmVyIiwiZG9vc2giLCJkdWNoZSIsImR5a2UiLCJlamFjdWxhdGUiLCJlamFjdWxhdGVkIiwiZWphY3VsYXRlcyAiLCJlamFjdWxhdGluZyAiLCJlamFjdWxhdGluZ3MiLCJlamFjdWxhdGlvbiIsImVqYWt1bGF0ZSIsImYgdSBjIGsiLCJmIHUgYyBrIGUgciIsImY0bm55IiwiZmFnIiwiZmFnZ2luZyIsImZhZ2dpdHQiLCJmYWdnb3QiLCJmYWdncyIsImZhZ290IiwiZmFnb3RzIiwiZmFncyIsImZhbm55IiwiZmFubnlmbGFwcyIsImZhbm55ZnVja2VyIiwiZmFueXkiLCJmYXRhc3MiLCJmY3VrIiwiZmN1a2VyIiwiZmN1a2luZyIsImZlY2siLCJmZWNrZXIiLCJmZWxjaGluZyIsImZlbGxhdGUiLCJmZWxsYXRpbyIsImZpbmdlcmZ1Y2sgIiwiZmluZ2VyZnVja2VkICIsImZpbmdlcmZ1Y2tlciAiLCJmaW5nZXJmdWNrZXJzIiwiZmluZ2VyZnVja2luZyAiLCJmaW5nZXJmdWNrcyAiLCJmaXN0ZnVjayIsImZpc3RmdWNrZWQgIiwiZmlzdGZ1Y2tlciAiLCJmaXN0ZnVja2VycyAiLCJmaXN0ZnVja2luZyAiLCJmaXN0ZnVja2luZ3MgIiwiZmlzdGZ1Y2tzICIsImZsYW5nZSIsImZvb2siLCJmb29rZXIiLCJmdWNrIiwiZnVja2EiLCJmdWNrZWQiLCJmdWNrZXIiLCJmdWNrZXJzIiwiZnVja2hlYWQiLCJmdWNraGVhZHMiLCJmdWNraW4iLCJmdWNraW5nIiwiZnVja2luZ3MiLCJmdWNraW5nc2hpdG1vdGhlcmZ1Y2tlciIsImZ1Y2ttZSAiLCJmdWNrcyIsImZ1Y2t3aGl0IiwiZnVja3dpdCIsImZ1ZGdlIHBhY2tlciIsImZ1ZGdlcGFja2VyIiwiZnVrIiwiZnVrZXIiLCJmdWtrZXIiLCJmdWtraW4iLCJmdWtzIiwiZnVrd2hpdCIsImZ1a3dpdCIsImZ1eCIsImZ1eDByIiwiZl91X2NfayIsImdhbmdiYW5nIiwiZ2FuZ2JhbmdlZCAiLCJnYW5nYmFuZ3MgIiwiZ2F5bG9yZCIsImdheXNleCIsImdvYXRzZSIsImdvZC1kYW0iLCJnb2QtZGFtbmVkIiwiZ29kZGFtbiIsImdvZGRhbW5lZCIsImhhcmRjb3Jlc2V4ICIsImhlbGwiLCJoZXNoZSIsImhvYXIiLCJob2FyZSIsImhvZXIiLCJob21vIiwiaG9yZSIsImhvcm5pZXN0IiwiaG9ybnkiLCJob3RzZXgiLCJqYWNrLW9mZiAiLCJqYWNrb2ZmIiwiamFwIiwiamVyay1vZmYgIiwiamlzbSIsImppeiAiLCJqaXptICIsImppenoiLCJrYXdrIiwia25vYiIsImtub2JlYWQiLCJrbm9iZWQiLCJrbm9iZW5kIiwia25vYmhlYWQiLCJrbm9iam9ja3kiLCJrbm9iam9rZXkiLCJrb2NrIiwia29uZHVtIiwia29uZHVtcyIsImt1bSIsImt1bW1lciIsImt1bW1pbmciLCJrdW1zIiwia3VuaWxpbmd1cyIsImtpdW50IiwibDNpK2NoIiwibDNpdGNoIiwibGFiaWEiLCJsbWZhbyIsImx1c3QiLCJsdXN0aW5nIiwibTBmMCIsIm0wZm8iLCJtNDV0ZXJiYXRlIiwibWE1dGVyYjgiLCJtYTV0ZXJiYXRlIiwibWFzb2NoaXN0IiwibWFzdGVyLWJhdGUiLCJtYXN0ZXJiOCIsIm1hc3RlcmJhdCoiLCJtYXN0ZXJiYXQzIiwibWFzdGVyYmF0ZSIsIm1hc3RlcmJhdGlvbiIsIm1hc3RlcmJhdGlvbnMiLCJtYXN0dXJiYXRlIiwibW8tZm8iLCJtb2YwIiwibW9mbyIsIm1vdGhhZnVjayIsIm1vdGhhZnVja2EiLCJtb3RoYWZ1Y2thcyIsIm1vdGhhZnVja2F6IiwibW90aGFmdWNrZWQgIiwibW90aGFmdWNrZXIiLCJtb3RoYWZ1Y2tlcnMiLCJtb3RoYWZ1Y2tpbiIsIm1vdGhhZnVja2luZyAiLCJtb3RoYWZ1Y2tpbmdzIiwibW90aGFmdWNrcyIsIm1vdGhlciBmdWNrZXIiLCJtb3RoZXJmdWNrIiwibW90aGVyZnVja2VkIiwibW90aGVyZnVja2VyIiwibW90aGVyZnVja2VycyIsIm1vdGhlcmZ1Y2tpbiIsIm1vdGhlcmZ1Y2tpbmciLCJtb3RoZXJmdWNraW5ncyIsIm1vdGhlcmZ1Y2trYSIsIm1vdGhlcmZ1Y2tzIiwibXVmZiIsIm11dGhhIiwibXV0aGFmZWNrZXIiLCJtdXRoYWZ1Y2trZXIiLCJtdXRoZXIiLCJtdXRoZXJmdWNrZXIiLCJuMWdnYSIsIm4xZ2dlciIsIm5hemkiLCJuaWdnM3IiLCJuaWdnNGgiLCJuaWdnYSIsIm5pZ2dhaCIsIm5pZ2dhcyIsIm5pZ2dheiIsIm5pZ2dlciIsIm5pZ2dlcnMiLCJub2IiLCJub2Igam9rZXkiLCJub2JoZWFkIiwibm9iam9ja3kiLCJub2Jqb2tleSIsIm51bWJudXRzIiwibnV0c2FjayIsIm9yZ2FzaW0gIiwib3JnYXNpbXMgIiwib3JnYXNtIiwib3JnYXNtcyAiLCJwMHJuIiwicGF3biIsInBlY2tlciIsInBlbmlzIiwicGVuaXNmdWNrZXIiLCJwaG9uZXNleCIsInBodWNrIiwicGh1ayIsInBodWtlZCIsInBodWtpbmciLCJwaHVra2VkIiwicGh1a2tpbmciLCJwaHVrcyIsInBodXEiLCJwaWdmdWNrZXIiLCJwaW1waXMiLCJwaXNzIiwicGlzc2VkIiwicGlzc2VyIiwicGlzc2VycyIsInBpc3NlcyAiLCJwaXNzZmxhcHMiLCJwaXNzaW4gIiwicGlzc2luZyIsInBpc3NvZmYgIiwicG9vcCIsInBvcm4iLCJwb3JubyIsInBvcm5vZ3JhcGh5IiwicG9ybm9zIiwicHJpY2siLCJwcmlja3MgIiwicHJvbiIsInB1YmUiLCJwdXNzZSIsInB1c3NpIiwicHVzc2llcyIsInB1c3N5IiwicHVzc3lzICIsInJlY3R1bSIsInJldGFyZCIsInJpbWphdyIsInJpbW1pbmciLCJzIGhpdCIsInMuby5iLiIsInNhZGlzdCIsInNjaGxvbmciLCJzY3Jld2luZyIsInNjcm9hdCIsInNjcm90ZSIsInNjcm90dW0iLCJzZW1lbiIsInNleCIsInNoISsiLCJzaCF0Iiwic2gxdCIsInNoYWciLCJzaGFnZ2VyIiwic2hhZ2dpbiIsInNoYWdnaW5nIiwic2hlbWFsZSIsInNoaSsiLCJzaGl0Iiwic2hpdGRpY2siLCJzaGl0ZSIsInNoaXRlZCIsInNoaXRleSIsInNoaXRmdWNrIiwic2hpdGZ1bGwiLCJzaGl0aGVhZCIsInNoaXRpbmciLCJzaGl0aW5ncyIsInNoaXRzIiwic2hpdHRlZCIsInNoaXR0ZXIiLCJzaGl0dGVycyAiLCJzaGl0dGluZyIsInNoaXR0aW5ncyIsInNoaXR0eSAiLCJza2FuayIsInNsdXQiLCJzbHV0cyIsInNtZWdtYSIsInNtdXQiLCJzbmF0Y2giLCJzb24tb2YtYS1iaXRjaCIsInNwYWMiLCJzcHVuayIsInNfaF9pX3QiLCJ0MXR0MWU1IiwidDF0dGllcyIsInRlZXRzIiwidGVleiIsInRlc3RpY2FsIiwidGVzdGljbGUiLCJ0aXQiLCJ0aXRmdWNrIiwidGl0cyIsInRpdHQiLCJ0aXR0aWU1IiwidGl0dGllZnVja2VyIiwidGl0dGllcyIsInRpdHR5ZnVjayIsInRpdHR5d2FuayIsInRpdHdhbmsiLCJ0b3NzZXIiLCJ0dXJkIiwidHc0dCIsInR3YXQiLCJ0d2F0aGVhZCIsInR3YXR0eSIsInR3dW50IiwidHd1bnRlciIsInYxNGdyYSIsInYxZ3JhIiwidmFnaW5hIiwidmlhZ3JhIiwidnVsdmEiLCJ3MDBzZSIsIndhbmciLCJ3YW5rIiwid2Fua2VyIiwid2Fua3kiLCJ3aG9hciIsIndob3JlIiwid2lsbGllcyIsIndpbGx5IiwieHJhdGVkIiwieHh4Il0=\"\n};\n\nforbiddenNotes.randowFunWord = function randowFunWord() {\n  let words = [\"daffodil\", \"chrysanthemum\", \"waffles\", \"puppies\", \"senpai\", \"kohai\", \"rainbow\", \"fluffy\", \"marklar\"];\n  // Remark: we could use bp.random() in order to get seedable randomness\n  // this will provide consistent results across all client instances\n  var item = words[Math.floor(Math.random() * words.length)];\n  return item;\n}\n\nforbiddenNotes.containsBadWord = function (str) {\n  // Convert input to lowercase for case-insensitive matching\n  const lowerStr = str.toLowerCase();\n  // Check each forbidden word using word boundaries\n  return forbiddenNotes.decoded.some(function (fnote) {\n    // Create a regex with word boundaries for whole-word matching\n    const regex = new RegExp(`\\\\b${fnote}\\\\b`, 'i');\n    const found = regex.test(lowerStr);\n    return found;\n  });\n};\n\n// TODO: is there a way to perform improved performance here?\n// this method is called on each chat message on initial render\nforbiddenNotes.filter = function (str) {\n  forbiddenNotes.decoded.forEach(function (fnote) {\n    str = str.replace(new RegExp(\"\\\\b\" + fnote + \"\\\\b\"), forbiddenNotes.randowFunWord())\n    str = str.replace(new RegExp(\"\\\\b\" + fnote + \"\\\\b\", \"gi\"), forbiddenNotes.randowFunWord())\n  });\n  return str;\n}\n\nforbiddenNotes.decoded = JSON.parse(atob(forbiddenNotes.base64))\n\nexport default forbiddenNotes;\n","// TODO: move all this app specific code *outside* of the buddylist / renderMessage\n// use the system.addMessageProcessor() API instead\n\nimport isValidUrl from './isValidUrl.js';\nimport isValidYoutubeLink from './isValidYoutubeLink.js';\nimport isValidGithubLink from './isValidGithubLink.js';\n\nexport default function checkForLinksInMessage(message) {\n  const text = message.text || message.content || '';\n\n  // Basic URL regex â€” matches http(s) links\n  const urlRegex = /https?:\\/\\/(?:[^\\s()<>\\[\\]{}\"']+|\\([^\\s()]*?\\))+/gi;\n  let match = text.match(urlRegex);\n  // match = [message.text];\n\n  if (match && isValidUrl(match[0])) {\n    let contentUrl = match[0];\n    // console.log('Found URL in message:', contentUrl);\n    message.card = {\n      url: contentUrl,\n      type: 'website',\n    };\n\n    // Determine file type from extension (ignoring query strings and hashes)\n    try {\n      const urlObj = new URL(contentUrl);\n      const pathname = urlObj.pathname; // just \"/image.png\" part\n      const ext = pathname.split('.').pop().toLowerCase();\n      // console.log(\"URL extension:\", pathname, ext);\n      if (ext) {\n        if (buddypond.supportedImageTypesExt.includes(ext)) {\n          message.card.type = 'image';\n        } else if (buddypond.supportedAudioTypesExt.includes(ext)) {\n          // devmode feature flag, upgraded audio to waveform if not prod\n          if(window.location.hostname !== 'buddypond.com') {\n            message.card.type = 'waveform';\n          } else {\n            message.card.type = 'audio';\n          }\n        } else if (buddypond.supportedVideoTypesExt.includes(ext)) {\n          message.card.type = 'video';\n        }\n      }\n    } catch (err) {\n      console.warn(\"Invalid URL:\", contentUrl, err);\n    }\n\n    // YouTube link handling\n    if (isValidYoutubeLink(contentUrl)) {\n      const videoId = new URL(contentUrl).searchParams.get('v');\n      if (videoId) {\n        message.card.type = 'youtube';\n        message.card.thumbnail = `https://img.youtube.com/vi/${videoId}/0.jpg`;\n        message.card.context = videoId;\n      }\n    }\n\n    // GitHub link handling\n    if (isValidGithubLink(contentUrl)) {\n      message.card.type = 'github';\n      const githubRegex = /^https?:\\/\\/github\\.com\\/([^\\/]+)\\/([^\\/]+)\\/blob\\/([^\\/]+)\\/(.+)$/;\n      const match = contentUrl.match(githubRegex);\n      if (match) {\n        message.card.owner = match[1];\n        message.card.repo = match[2];\n        message.card.filename = match[4];\n      } else {\n        console.error(\"Invalid GitHub URL format.\");\n      }\n    }\n  }\n}\n","export default function isValidUrl(messageText) {\n    if (!messageText) return false;\n  \n    messageText = messageText.trim(); // Trim whitespace from both ends\n  \n    try {\n      const url = new URL(messageText);\n  \n      // Ensure the URL has http or https protocol\n      if (url.protocol === \"http:\" || url.protocol === \"https:\") {\n        // console.log('This is a valid URL:', url.href);\n        return true;\n      }\n  \n      return false; // Invalid if protocol is not http or https\n    } catch (error) {\n      return false; // If an error is thrown, it's not a valid URL\n    }\n  }","export default function checkIsValidYoutubeLink(url) {\n    const regex = /(?:youtube\\.com\\/(?:[^\\/]+\\/.+\\/|(?:v|e(?:mbed)?)\\/|.*[?&]v=)|youtu\\.be\\/)([^\"&?\\/\\s]{11})/;\n    const match = url.match(regex);\n    return match ? match[1] : null; // Return video ID or null\n}\n","export default function isValidGithubLink(url) {\n    const regex = /^https?:\\/\\/github\\.com\\/([^\\/]+)\\/([^\\/]+)\\/blob\\/([^\\/]+)\\/(.+)$/;\n    const match = url.match(regex);\n    return match ? match.slice(1) : null; \n    // Returns [owner, repo, branch, filePath] or null\n}\n","export default function setupInputEvents(windowType, contextName, chatWindow) {\n    const $input = $(\".aim-input\", chatWindow.content);\n    const $form = $(\".message_form\", chatWindow.content);\n    const $sendButton = $(\".aim-send-btn\", chatWindow.content);\n\n    \n    // Trigger autocomplete manually on input\n    let that = this;\n    $input.on(\"input\", function (event) {\n        const $sendButton = $(\".aim-send-btn\", chatWindow.content);\n\n        that.handleEmojiInput(event, $sendButton);\n        const cursorPos = this.selectionStart;\n        const inputValue = $input.val();\n        const context = that.getInputContext(inputValue, cursorPos);\n\n        if (context && ((context.type === 'emoji' && context.text.length >= 2) || context.type === 'command')) {\n            $(this).autocomplete(\"search\", context.text);\n        } else {\n            $(this).autocomplete(\"close\");\n        }\n    });\n\n    $input.on(\"keydown\", (e) => {\n        if (e.which === 13 && e.shiftKey) {\n            const inputValue = $input.val();\n            const cursorPosition = $input[0].selectionStart;\n            const newValue = inputValue.slice(0, cursorPosition) + \"\\n\" + inputValue.slice(cursorPosition);\n            $input.val(newValue);\n            $input[0].setSelectionRange(cursorPosition + 1, cursorPosition + 1);\n            $sendButton.css(\"opacity\", newValue.length > 0 ? 1 : 0.5);\n            return false;\n        }\n\n        // Prevent form submission on Enter when autocomplete is visible\n        if (e.which === 13 && $input.autocomplete(\"widget\").is(\":visible\")) {\n            // check if this is a BS command, if so we do need to submit the form\n            const inputValue = $input.val();\n            // check if inputValue starts with / or \\, if so, run it\n            if (inputValue.startsWith(\"/\") || inputValue.startsWith(\"\\\\\")) {\n                $form.submit();\n                e.preventDefault();\n                return false;\n            }\n            e.preventDefault();\n            return false; // Let jQuery UI handle selection\n        }\n\n        // Prevent focus change on Tab ( with or without autocomplete visible )\n        if (e.which === 9) {\n            e.preventDefault();\n            return false; // Let jQuery UI handle selection\n        }\n\n        if (e.which === 13) {\n            let message = $input.val().replace(/\\n/g, \"<br>\");\n            message = that.replaceShortcodes(message);\n            // close the autocomplete if open\n            $input.autocomplete(\"close\");\n            $input.val(message);\n            $form.submit();\n            e.preventDefault();\n            return false;\n        }\n\n        let activeContext = chatWindow.currentActiveContext || contextName;\n\n        this.bp.emit(\"buddy::typing\", {\n            from: this.bp.me,\n            to: activeContext,\n            type: windowType,\n            isTyping: true,\n            ctime: Date.now(),\n        });\n    });\n\n    $input.on(\"keyup\", (e) => {\n        const inputValue = $input.val();\n        $sendButton.css(\"opacity\", inputValue.length > 0 ? 1 : 0.5);\n    });\n}","export default function setupAutocomplete(chatWindow) {\n\n    if (!this.options.autocomplete) return;\n\n    const $input = $(\".aim-input\", chatWindow.content);\n    const $form = $(\".message_form\", chatWindow.content);\n    const $sendButton = $(\".aim-send-btn\", chatWindow.content);\n\n    this.replaceShortcodes = replaceShortcodes.bind(this);\n\n    // Create a lookup map for faster emoji shortcode to Unicode conversion\n    if (!this.emojiMap) {\n         const usedShortcodes = new Set(); // Track used shortcodes to avoid duplicates\n        this.emojiMap = Object.keys(EMOJIS).reduce((map, emoji) => {\n            const aliases = EMOJIS[emoji].filter(isValidShortcode);\n            aliases.forEach(alias => {\n                const shortcode = `:${alias}:`;\n                // Only add if shortcode hasn't been used (prioritize first emoji)\n                if (!usedShortcodes.has(shortcode)) {\n                    map[shortcode] = emoji;\n                    usedShortcodes.add(shortcode);\n                }\n            });\n            return map;\n        }, {});\n    }\n\n    // Prepare autocomplete data for emojis: array of { label, value, emoji, type }\n    if (!this.emojiSuggestions) {\n        this.emojiSuggestions = Object.keys(EMOJIS).reduce((suggestions, emoji) => {\n            const aliases = EMOJIS[emoji].filter(isValidShortcode);\n            aliases.forEach(alias => {\n                suggestions.push({\n                    label: `${emoji} :${alias}:`, // Display: \"ðŸ´â€â˜ ï¸ :skull_and_crossbones:\"\n                    value: `:${alias}:`, // Insert: \":skull_and_crossbones:\"\n                    emoji: emoji,\n                    type: 'emoji'\n                });\n            });\n            return suggestions;\n        }, []);\n    }\n\n    if (!this.commands) {\n        // Prepare autocomplete data for commands\n        this.commands = Object.keys(this.options.autocomplete).map(command => ({\n            label: `/${command}`,\n            value: `/${command}`,\n            type: 'command'\n        }));\n    }\n\n    this.handleEmojiInput = handleEmojiInput.bind(this);\n\n    // Function to get the partial shortcode or command at the cursor position\n    function getInputContext(text, cursorPos) {\n        const textBeforeCursor = text.slice(0, cursorPos);\n        const textAfterCursor = text.slice(cursorPos);\n\n        // Check for partial or complete emoji shortcode (e.g., \":sku\" or \":skull_and_crossbones:\")\n        const lastColonIndex = textBeforeCursor.lastIndexOf(':');\n        if (lastColonIndex !== -1) {\n            // Extract potential shortcode from last \":\" to next \":\" or cursor\n            let endIndex = cursorPos;\n            const nextColonIndex = text.indexOf(':', cursorPos);\n            if (nextColonIndex !== -1) {\n                // Include trailing \":\" if it forms a valid shortcode\n                const potentialShortcode = text.slice(lastColonIndex, nextColonIndex + 1);\n                if (/^:[a-z0-9_+]+:$/.test(potentialShortcode)) {\n                    endIndex = nextColonIndex + 1;\n                }\n            }\n            const potentialShortcode = text.slice(lastColonIndex, endIndex);\n            // Match partial (\":sku\") or complete (\":skull_and_crossbones:\") shortcode\n            if (/^:[a-z0-9_+]*(?::|$)/.test(potentialShortcode)) {\n                return {\n                    type: 'emoji',\n                    text: potentialShortcode,\n                    startIndex: lastColonIndex,\n                    endIndex: endIndex\n                };\n            }\n        }\n\n        // Check for command (starts with \"/\" or \"\\\")\n        const firstChar = textBeforeCursor.charAt(0);\n        if ([\"/\", \"\\\\\"].includes(firstChar)) {\n            return {\n                type: 'command',\n                text: textBeforeCursor,\n                startIndex: 0,\n                endIndex: cursorPos\n            };\n        }\n        return null;\n    }\n\n    this.getInputContext = getInputContext.bind(this);\n\n    let that = this;\n\n    // Initialize autocomplete for both commands and emojis\n    $input.autocomplete({\n\n        focus: function (event, ui) {\n            // Prevent jQuery UI from inserting `.label` automatically\n            event.preventDefault();\n            return false;\n        },\n\n        source: function (request, response) {\n            const cursorPos = $input[0].selectionStart;\n            const inputValue = $input.val();\n            const context = getInputContext(inputValue, cursorPos);\n\n            if (!context) {\n                response([]);\n                return;\n            }\n\n            if (context.type === 'emoji' && context.text.length >= 2) {\n                const query = context.text.replace(/^:|:$/g, '').toLowerCase();\n                const matches = that.emojiSuggestions.filter(suggestion =>\n                    suggestion.value.toLowerCase().includes(query)\n                ).slice(0, 10);\n                response(matches);\n            } else if (context.type === 'command') {\n                const query = context.text.slice(1).toLowerCase();\n\n                // sort that.commands by value alphabetically\n                that.commands.sort((a, b) => a.value.localeCompare(b.value));\n\n                // console.log('Command query:', query, query.length);\n                // console.log('Available commands:', that.commands);\n                if (query.length === 0) {\n                    // Remark: confirmed it makes it here\n                    response(that.commands);\n                    return;\n                }\n                // matching should be left to right, so startsWith\n                const matches = that.commands.filter(suggestion =>\n                    suggestion.value.toLowerCase().startsWith('/' + query)\n                );\n                response(matches);\n            } else {\n                response([]);\n            }\n        },\n        select: function (event, ui) {\n            const textarea = $input[0];\n            const cursorPos = textarea.selectionStart;\n            const inputValue = $input.val();\n            const context = getInputContext(inputValue, cursorPos);\n\n            if (context) {\n                // Replace from startIndex to endIndex\n                const before = inputValue.slice(0, context.startIndex);\n                const after = inputValue.slice(context.endIndex);\n                const newValue = before + (ui.item.emoji || ui.item.value) + after;\n                $input.val(newValue);\n\n                // Set cursor after the inserted value\n                const newCursorPos = context.startIndex + ui.item.value.length;\n                textarea.setSelectionRange(newCursorPos, newCursorPos);\n\n                // Trigger input event for emoji replacement (if emoji)\n                if (ui.item.type === 'emoji') {\n                    $input.trigger('input');\n                }\n\n                // Update send button\n                $sendButton.css(\"opacity\", newValue.length > 0 ? 1 : 0.5);\n\n                return false;\n            }\n\n            // Close autocomplete\n            $input.autocomplete(\"close\");\n            return false;\n\n        },\n        minLength: 0,\n        position: { my: \"left bottom\", at: \"left top\", collision: \"none\" },\n        open: function () {\n            $('.ui-autocomplete').css({\n                'max-height': '200px',\n                'overflow-y': 'auto',\n                'z-index': 1000\n            });\n        }\n    });\n\n    // Remark: ensures autocomplete works on first keypress\n    $input.on(\"input\", function() {\n        $(this).autocomplete(\"search\");\n    });\n\n}\n\n// Function to validate and normalize a shortcode name\nfunction isValidShortcode(name) {\n    return /^[a-z0-9_+]+$/.test(name) && !name.startsWith(':') && !name.includes(' ');\n}\n\n// Function to replace shortcodes in a string with emojis\nfunction replaceShortcodes(text) {\n    const shortcodeRegex = /:[a-z0-9_+]+:/g;\n    return text.replace(shortcodeRegex, match => this.emojiMap[match] || match);\n}\n\n// Function to handle text area input and replace shortcodes\nfunction handleEmojiInput(event, $sendButton) {\n    const textarea = event.target;\n    const $textarea = $(textarea);\n    const cursorPos = textarea.selectionStart;\n    const originalText = $textarea.val();\n    const newText = replaceShortcodes.call(this, originalText);\n\n    if (newText !== originalText) {\n        $textarea.val(newText);\n        const offset = newText.length - originalText.length;\n        const newCursorPos = cursorPos + offset;\n        textarea.setSelectionRange(newCursorPos, newCursorPos);\n        $sendButton.css(\"opacity\", newText.length > 0 ? 1 : 0.5);\n    }\n}","export default class ChatWindowButtonBar {\n  constructor(bp, options = {}) {\n    this.bp = bp;\n    this.options = options;\n    console.log('ChatWindowButtonBar options', options);\n    // Button objects provided via options\n    const inputButtons = options.buttons || [];\n\n    // Read stored order of button labels\n    const storedOrder = this.bp.settings?.['buttonBar.buttons'];\n\n    if (Array.isArray(storedOrder)) {\n      // Sort input buttons by stored order\n      this.buttons = this.sortButtonsByOrder(inputButtons, storedOrder);\n    } else {\n      this.buttons = inputButtons;\n    }\n\n    this.container = this.render();       // DOM\n    this.enableDragAndDrop();             // jQuery UI sorting\n    return this;\n  }\n\n  render() {\n    const buttonBar = document.createElement('div');\n    buttonBar.classList.add('button-bar');\n\n    // create top-level (root) items\n    this.buttons.forEach(button => {\n      const element = this.createButtonElement(button, true); // <-- pass isRoot = true\n      buttonBar.appendChild(element);\n    });\n\n    return buttonBar;\n  }\n\n  /**\n   * createButtonElement(button, isRoot)\n   * - isRoot: true for top-level buttons (draggable, dataset.text set)\n   *           false for child/dropdown items (not draggable)\n   */\n  createButtonElement(button, isRoot = false) {\n    // Create wrapper for either a single button or a dropdown\n    const wrapper = document.createElement('div');\n    wrapper.classList.add('button-bar-item');\n\n    // Mark top-level wrappers so sortable only acts on them\n    if (isRoot) {\n      wrapper.classList.add('button-bar-item--root');\n      // IMPORTANT: attach the text identifier to the wrapper so ordering works\n      wrapper.dataset.text = button.text;\n    }\n\n    // Base button (icon / image / text)\n    let element;\n    if (button.image) {\n      element = document.createElement('img');\n      element.src = button.image;\n      element.alt = button.text;\n      element.title = button.text;\n      element.draggable = false;\n    } else if (button.icon) {\n      element = document.createElement('span');\n      element.innerHTML = button.icon;\n    } else {\n      element = document.createElement('button');\n      element.innerText = button.text;\n    }\n\n    // Base dataset on the actual clickable element (keeps existing logic)\n    const baseDataset = {\n      context: this.options.context || button.text,\n      type: this.options.type || 'buddy',\n      text: button.text\n    };\n    Object.entries(baseDataset).forEach(([k, v]) => element.dataset[k] = v);\n\n    element.classList.add('button-bar-button');\n    if (button.className) element.classList.add(button.className);\n\n    // If button has children â†’ create dropdown\n    if (Array.isArray(button.children) && button.children.length > 0) {\n      wrapper.classList.add('has-children');\n\n      // Dropdown container\n      const dropdown = document.createElement('div');\n      dropdown.classList.add('button-dropdown');\n      dropdown.style.display = 'none';\n\n      // Inside createButtonElement, in the children loop:\n      button.children.forEach(child => {\n        // Create wrapper for the child item\n        const childWrapper = document.createElement('div');\n        childWrapper.classList.add('dropdown-item');\n\n        // Create the base element (icon/image/button)\n        const childBaseEl = this.createButtonElement(child, false);\n        childBaseEl.classList.remove('button-bar-item'); // avoid nested wrappers confusion\n\n        // Create the text label\n        const label = document.createElement('span');\n        label.innerText = child.text;\n        label.classList.add('dropdown-label');\n\n        // Put both inside wrapper\n        childWrapper.appendChild(childBaseEl);\n        childWrapper.appendChild(label);\n\n        // Unified click handler\n        const clickHandler = (ev) => {\n          ev.stopPropagation();\n          if (typeof child.onclick === 'function') {\n            child.onclick(ev);\n          }\n          // optionally: close dropdown after click\n          dropdown.style.display = 'none';\n        };\n\n        // add baseDataset to childWrapper for consistency\n        Object.entries(baseDataset).forEach(([k, v]) => childWrapper.dataset[k] = v);\n        // add baseDataset to childBaseEl too for consistency\n        Object.entries(baseDataset).forEach(([k, v]) => childBaseEl.dataset[k] = v);\n        // add baseDataset to label too for consistency\n        Object.entries(baseDataset).forEach(([k, v]) => label.dataset[k] = v);\n\n        childWrapper.addEventListener('click', clickHandler);\n\n        dropdown.appendChild(childWrapper);\n      });\n\n\n      // Toggle dropdown on click\n      element.addEventListener('click', (ev) => {\n        ev.stopPropagation();\n        dropdown.style.display = (dropdown.style.display === 'none') ? 'block' : 'none';\n      });\n\n      // Close dropdown if clicking outside\n      document.addEventListener('click', () => {\n        dropdown.style.display = 'none';\n      });\n\n      wrapper.appendChild(element);\n      wrapper.appendChild(dropdown);\n    } else {\n      // Plain button case: attach onclick handler\n      if (typeof button.onclick === 'function') {\n        element.addEventListener('click', button.onclick);\n      }\n      wrapper.appendChild(element);\n    }\n\n    return wrapper;\n  }\n\n  addButton(button) {\n    if (this.buttons.some(b => b.text === button.text)) {\n      console.warn(`Button with text \"${button.text}\" already exists.`);\n      return;\n    }\n\n    this.buttons.push(button);\n    const newButtonElement = this.createButtonElement(button, true); // root\n    this.container.appendChild(newButtonElement);\n    this.refreshSortable();\n  }\n\n  removeButton(buttonText) {\n    const index = this.buttons.findIndex(button => button.text === buttonText);\n    if (index === -1) return;\n\n    this.buttons.splice(index, 1);\n\n    // Only remove top-level (root) wrappers\n    const roots = Array.from(this.container.children).filter(el => el.classList.contains('button-bar-item--root'));\n    for (const el of roots) {\n      if (el.dataset.text === buttonText) {\n        this.container.removeChild(el);\n        break;\n      }\n    }\n\n    this.refreshSortable();\n    this.saveButtonOrder();\n  }\n\n  enableDragAndDrop() {\n    $(this.container).sortable({\n      // Only root-level items are sortable\n      items: '.button-bar-item--root',\n      tolerance: 'pointer',\n      stop: () => this.syncButtonOrder()\n    });\n  }\n\n  refreshSortable() {\n    $(this.container).sortable('refresh');\n  }\n\n  syncButtonOrder() {\n    // Read order only from top-level wrapper elements\n    const roots = Array.from(this.container.children).filter(el => el.classList.contains('button-bar-item--root'));\n    const orderedTexts = roots.map(el => el.dataset.text);\n    console.log('syncButtonOrder orderedTexts', orderedTexts);\n\n    // Rebuild this.buttons in the new order using the original objects (match by text)\n    this.buttons = orderedTexts\n      .map(text => this.buttons.find(b => b.text === text))\n      .filter(Boolean);\n\n    console.log('syncButtonOrder new this.buttons', this.buttons);\n    this.saveButtonOrder();\n  }\n\n  saveButtonOrder() {\n    // this.buttons should now reflect the new order\n    console.log('saveButtonOrder this.buttons', this.buttons);\n    const orderedTexts = this.buttons.map(b => b.text);\n    this.bp.set('buttonBar.buttons', orderedTexts);\n\n    const openWindows = this.bp.apps.ui.windowManager.findWindows({\n      app: 'buddylist',\n      type: ['buddy', 'pond']\n    });\n\n    openWindows.forEach(window => {\n      if (window.buttonBar) {\n        // Reorder buttons on other windows (they store button objects too)\n        window.buttonBar.buttons = this.sortButtonsByOrder(window.buttonBar.buttons, orderedTexts);\n\n        // Re-render DOM in other windows\n        window.buttonBar.reRenderButtons();\n      }\n    });\n  }\n\n  // used when making a remote change to the button order from an outside source\n  // drag and drop does not use this method and instead uses syncButtonOrder\n  // reRenderButtons should recreate top-level wrappers as root items\n  reRenderButtons() {\n    // Clear the container\n    this.container.innerHTML = '';\n\n    // Recreate and append all buttons in current order (root)\n    this.buttons.forEach(button => {\n      const el = this.createButtonElement(button, true);\n      this.container.appendChild(el);\n    });\n\n    // Re-enable drag and drop after replacing children\n    this.refreshSortable();\n  }\n\n  sortButtonsByOrder(buttons, order) {\n    const buttonMap = Object.fromEntries(buttons.map(b => [b.text, b]));\n    const ordered = order.map(text => buttonMap[text]).filter(Boolean);\n\n    // Append any new buttons not in stored order\n    const remaining = buttons.filter(b => !order.includes(b.text));\n    return [...ordered, ...remaining];\n  }\n}\n","import ChatWindowButtonBar from \"../ChatWindowButtonBar.js\";\n\n\nexport default function setupChatWindowButtons(windowType, contextName, chatWindow) {\n    if (!this.options.chatWindowButtons) return;\n\n    let buttons = this.options.chatWindowButtons.slice();\n    if (windowType === \"pond\") {\n        buttons = buttons.filter((button) => button.type !== \"buddy-only\");\n    }\n\n    if (this.bp.isMobile() && windowType === \"buddy\") {\n        // don't show help button on mobile buddy chat windows\n        buttons = buttons.filter((button) => button.text !== \"BuddyHelp\");\n    }\n\n    if (isIOS()) {\n        buttons = buttons.filter((button) => button.env !== \"desktop-only\");\n    }\n\n    chatWindow.buttonBar = new ChatWindowButtonBar(this.bp, {\n        context: contextName,\n        type: windowType,\n        buttons,\n    });\n    $(\".aim-message-controls\", chatWindow.content).prepend(chatWindow.buttonBar.container);\n}\n\nfunction isIOS() {\n    return /iPad|iPhone|iPod/.test(navigator.userAgent) && \"ontouchend\" in document;\n}","// Populates or updates the pond room list in the chat window\n// Maintains sort order by connection_count (descending) without full re-render\n// Manages .aim-room-active class only when an activeContext is specified\nexport default function populateRoomList(hotPonds, chatWindow, activeContext = null) {\n    // console.log('populateRoomList called with hotPonds:', hotPonds, 'chatWindow:', chatWindow, 'activeContext:', activeContext);\n    const roomList = $(\".aim-room-list-items\", chatWindow.content);\n    if (!roomList.length) return;\n\n    if (!hotPonds || !Array.isArray(hotPonds)) return;\n\n    // Sort ponds by connection count (descending)\n    const sortedPonds = [...hotPonds].sort((a, b) => b.connection_count - a.connection_count);\n    // console.log('Sorted ponds:', sortedPonds);\n\n    // Track user-opened ponds\n    const userOpenedPonds = this.data.activePonds || [];\n\n    // Track existing room items by pond_id\n    const existingItems = new Map();\n    const existingPondIds = new Set();\n    roomList.find(\".aim-room-item\").each((_, item) => {\n        const pondId = $(item).data(\"pond\");\n        if (pondId) {\n            existingItems.set(pondId, $(item));\n            existingPondIds.add(pondId);\n        }\n    });\n\n    // Update or add room items\n    sortedPonds.forEach((pond) => {\n        const pondId = pond.pond_id;\n        let pondName = pondId.replace(\"pond/\", \"\");\n        const isUserOpened = userOpenedPonds.includes(pondId);\n        const isActive = pondId === activeContext;\n        // Sanitize pond name using jQuery to prevent XSS\n        pondName = $(\"<div>\").text(pondName).html();\n        const existingItem = existingItems.get(pondId);\n        if (existingItem) {\n            // Update existing item only if data has changed\n            const $scoreElement = existingItem.find(\".aim-room-list-item-score\");\n            if ($scoreElement.text() !== String(pond.connection_count)) {\n                console.log(`Updating connection_count for ${pondId}: ${pond.connection_count}`);\n                $scoreElement.text(pond.connection_count);\n            }\n\n            const $closeButton = existingItem.find(\".aim-room-close-btn\");\n            if (isUserOpened) {\n                if (!$closeButton.length) {\n                    console.log(`Adding close button for ${pondId}`);\n                    existingItem.append(`<button class=\"aim-room-close-btn\" data-context=\"${pondId}\">X</button>`);\n                }\n            } else if ($closeButton.length) {\n                console.log(`Removing close button for ${pondId}`);\n                $closeButton.remove();\n            }\n\n            // Update active class only if activeContext is specified\n            if (activeContext !== null) {\n                const shouldBeActive = isActive;\n                if (existingItem.hasClass(\"aim-room-active\") !== shouldBeActive) {\n                    console.log(`Updating active class for ${pondId}: ${shouldBeActive}`);\n                    existingItem.toggleClass(\"aim-room-active\", shouldBeActive);\n                }\n            }\n\n            existingPondIds.delete(pondId); // Mark as processed\n        } else {\n            // Create new room item\n            // console.log(`Adding new room item for ${pondId}`);\n            const closeButton = isUserOpened\n                ? `<button class=\"aim-room-close-btn\" data-context=\"${pondId}\">X</button>`\n                : \"\";\n            const $newItem = $(`\n                <li class=\"aim-room-item aim-room-list-item${isActive && activeContext !== null ? \" aim-room-active\" : \"\"}\" data-pond=\"${pondId}\" data-context=\"${pondId}\">\n                    <span class=\"aim-room-list-item-name\">#${pondName}</span>\n                    <span class=\"aim-room-list-item-score\">${pond.connection_count}</span>\n                    ${closeButton}\n                </li>\n            `);\n            roomList.append($newItem); // Append temporarily; will reorder later\n            existingItems.set(pondId, $newItem); // Track for reordering\n        }\n\n        // Ensure messages container exists for active or opened ponds\n        // TODO: we don't have a scope to ensureMessagesContainer here,\n        // do we need to ensureMessagesContainer here? if so, it needs to be scoped to buddylist or chatWindow\n        /*\n        if (isActive || isUserOpened) {\n            ensureMessagesContainer.call(this, pondId, chatWindow, this.bp.apps.client);\n        }\n        */\n    });\n\n    // Remove room items for ponds no longer in hotPonds\n    existingPondIds.forEach((pondId) => {\n        console.log(`Removing room item for ${pondId}`);\n        existingItems.get(pondId)?.remove();\n        existingItems.delete(pondId);\n    });\n\n    // Reorder room items to match sortedPonds\n    // console.log('Reordering room items to match sortedPonds');\n    let previousItem = null;\n    sortedPonds.forEach((pond) => {\n        const $item = existingItems.get(pond.pond_id);\n        if ($item) {\n            if (previousItem) {\n                // Insert after the previous item\n                const $nextSibling = previousItem.next();\n                if (!$nextSibling.length || $nextSibling.data(\"pond\") !== pond.pond_id) {\n                    console.log(`Moving ${pond.pond_id} after ${previousItem.data(\"pond\")}`);\n                    $item.insertAfter(previousItem);\n                }\n            } else {\n                // Move to the top if it's the first item\n                const $firstItem = roomList.children().first();\n                if (!$firstItem.length || $firstItem.data(\"pond\") !== pond.pond_id) {\n                    console.log(`Moving ${pond.pond_id} to top`);\n                    $item.prependTo(roomList);\n                }\n            }\n            previousItem = $item;\n        }\n    });\n\n    // Ensure only the active room has .aim-room-active if activeContext is specified\n    if (activeContext !== null) {\n        console.log(`Ensuring only ${activeContext} has .aim-room-active`);\n        roomList.find(\".aim-room-item\").not(`[data-pond=\"${activeContext}\"]`).removeClass(\"aim-room-active\");\n        if (existingItems.get(activeContext)) {\n            existingItems.get(activeContext).addClass(\"aim-room-active\");\n        }\n    }\n}","import setupInputEvents from \"./message/setupInputEvents.js\";\nimport setupAutocomplete from \"./message/setupAutocomplete.js\";\nimport setupChatWindowButtons from \"./message/setupChatWindowButtons.js\";\n\n// this is now handled in the pond.js file\nimport populateRoomList from \"./message/populateRoomList.js\";\nimport updateRoomList from \"./message/updateRoomList.js\";\n// Updates the list of connected users for a specific pond chat\n// data.chatId specifies the pond context (e.g., \"pond/general\")\n\n// Updates the list of connected users for a specific pond chat\n// data.chatId specifies the pond context (e.g., \"pond/general\")\nfunction updatePondConnectedUsers(data) {\n    const chatId = data.chatId;\n    if (!chatId) {\n        console.log(\"No chatId provided for updating pond connected users\");\n        return;\n    }\n    // console.log('updatePondConnectedUsers called with data:', data);\n    let context = chatId.replace(\"pond/\", \"\");\n\n    // Select the user list for the specific pond\n    const userList = $(`.aim-user-list[data-context=\"${context}\"][data-type=\"pond\"] .aim-user-list-items`);\n\n    // console.log('found userList:', userList.length, 'for chatId:', chatId, userList);\n    if (!userList.length) {\n        console.log(`No .aim-user-list-items found for chatId: ${chatId}`);\n        return;\n    }\n\n    // console.log(\"Updating pond connected users for chatId:\", chatId, data);\n\n    // Track existing users to identify disconnected ones\n    const existingUserIds = new Set();\n    userList.find(\".aim-user-item\").each((_, item) => {\n        let userId = $(item).data(\"username\");\n        if (userId) {\n            userId = userId.toString();\n            existingUserIds.add(userId);\n        } else {\n            // console.log(\"Found invalid .aim-user-item without data-username, removing:\", item);\n            $(item).remove(); // Remove empty/invalid items\n        }\n    });\n\n    // Update or add user items\n    (data.users || []).forEach((user) => {\n        let { userId, profilePicture } = user;\n        userId = userId ? userId.toString() : null;\n        if (!userId || typeof userId !== \"string\") {\n            console.log(\"Skipping invalid user with missing or non-string userId:\", user);\n            return; // Skip invalid users\n        }\n\n        // Remark: we could also populate the this.data.activeUsers\n        // Might be better to just allow user to click name and then open spellbook, less clutter in dropdown\n        /*\n        if (message.to && !this.data.activeUsers.includes(message.to)) {\n            this.data.activeUsers.push(message.to);\n            this.bp.emit('buddy::activeUserAdded', message.to);\n        }\n        */\n\n        const userItem = $(`.aim-user-item[data-username=\"${userId}\"]`, userList);\n\n        if (userItem.length) {\n            // Update existing user only if data has changed\n            const $textElement = userItem.find(\".aim-user-item-text\");\n            if ($textElement.text() !== userId) {\n                // console.log(`Updating userId text for ${userId}`);\n                $textElement.text(userId);\n            }\n\n            const $profileContainer = userItem.find(\".aim-profile-picture\");\n            const $newProfileElement = createProfilePictureElement.call(this, userId, profilePicture, $profileContainer);\n            if ($newProfileElement) {\n                // console.log(`Updating profile picture for ${userId}`);\n                $profileContainer.empty().append($newProfileElement.html());\n            } else {\n                // console.log(`No profile picture update needed for ${userId}`);\n            }\n\n            existingUserIds.delete(userId); // Mark as processed\n        } else {\n            // Create new user item\n            // console.log(\"Adding user to aim-user-list-items:\", user);\n            const $userItem = $(\"<li>\", {\n                class: \"aim-user-item\",\n                \"data-username\": userId,\n            });\n            const $profilePicture = createProfilePictureElement.call(this, userId, profilePicture);\n            const $userText = $(\"<span>\", {\n                class: \"aim-user-item-text\",\n                text: userId,\n            });\n            //console.log('$profilePicture', $profilePicture.html())\n            //console.log('$userItem', $userItem.html())\n            $userItem.append($profilePicture, $userText);\n            userList.append($userItem);\n        }\n    });\n\n    // Remove disconnected users\n    // console.log('checking existingUserIds for removal:', existingUserIds);\n    existingUserIds.forEach((userId) => {\n        userId = userId.toString();\n        $(`.aim-user-item[data-username=\"${userId}\"]`, userList).remove();\n    });\n}\n\n// Creates a profile picture element for a user\n// Returns null if no update is needed for existing users\nfunction createProfilePictureElement(userId, profilePicture, $existingContainer = null) {\n    const $profilePicture = $(\"<div>\", { class: \"aim-profile-picture\" });\n\n    if (window.discordMode) {\n       profilePicture =  profilePicture.replace('https://files.buddypond.com', bp.config.cdn);\n    }\n\n    if (profilePicture) {\n        const $img = $(\"<img>\", {\n            class: \"aim-chat-message-profile-picture-img\",\n            src: profilePicture,\n            alt: `${userId}'s avatar`,\n        });\n        $img.attr('draggable', 'false');\n        $profilePicture.append($img);\n\n        // For existing users, check if update is needed\n        if ($existingContainer) {\n            const $currentImg = $existingContainer.find(\".aim-chat-message-profile-picture-img\");\n            if ($currentImg.length && $currentImg.attr(\"src\") === profilePicture) {\n                return null; // No update needed\n            }\n        }\n    } else {\n        const defaultAvatarSvg = this.defaultAvatarSvg(userId);\n        $profilePicture.html(defaultAvatarSvg);\n\n        // For existing users, check if SVG content is unchanged\n        if ($existingContainer) {\n            const currentHtml = $existingContainer.html().trim();\n            if (currentHtml === defaultAvatarSvg.trim()) {\n                return null; // No update needed\n            }\n        }\n    }\n\n    return $profilePicture;\n}\n\nexport default function openChatWindow(data) {\n    const { windowType, contextName, windowTitle } = determineWindowParameters(data);\n    if (!isValidContextName.call(this, contextName)) {\n        return;\n    }\n\n    // TODO: move these to prototype of buddylist...\n    if (!this.populateRoomList) {\n        this.populateRoomList = populateRoomList.bind(this);\n    }\n\n    if (!this.updatePondConnectedUsers) {\n        this.updatePondConnectedUsers = updatePondConnectedUsers.bind(this);\n    }\n\n    if (!this.joinPond) {\n        this.joinPond = joinPond.bind(this);\n    }\n\n    const client = this.bp.apps.client;\n    const windowId = generateWindowId(windowType, contextName);\n    const existingWindow = this.bp.apps.ui.windowManager.getWindow(windowId);\n    if (existingWindow) {\n        handleExistingWindow.call(this, existingWindow, windowType, contextName, client, this);\n        return existingWindow;\n    }\n\n    return createNewChatWindow.call(this, {\n        windowType,\n        contextName,\n        windowTitle,\n        windowId,\n        client,\n        data,\n    });\n}\n\nfunction determineWindowParameters(data) {\n    let windowType = data.pondname ? \"pond\" : \"buddy\";\n    let contextName = data.pondname || data.name || 'Buddy';\n    let windowTitle = windowType === \"pond\" ? \"Pond Chat\" : \"\";\n\n    if (data.context) {\n        contextName = data.context;\n    }\n\n    if (data.type) {\n        windowType = data.type;\n    }\n\n    contextName = contextName.toString();\n\n    return { windowType, contextName, windowTitle };\n}\n\nfunction isValidContextName(contextName) {\n    const pondName = contextName.replace(\"pond/\", \"\");\n    if (this.forbiddenNotes.containsBadWord(pondName)) {\n        console.error(\"Forbidden context name:\", contextName);\n        alert(\"Pond name not allowed, please choose a different name.\");\n        return false;\n    }\n    return true;\n}\n\nfunction generateWindowId(windowType, contextName) {\n    return windowType === \"pond\"\n        ? 'pond-chat'\n        : `messages/${contextName}`;\n}\n\nfunction handleExistingWindow(chatWindow, windowType, contextName, client, context) {\n    if (windowType === \"pond\") {\n        // Remark: It seems this case never happens?\n        console.log(\"Opening pond window\", windowType, contextName);\n        // Use context.data.hotPonds if available, otherwise skip population\n        //const hotPonds = context.data.hotPonds || [];\n        //populateRoomList.call(context, hotPonds, chatWindow, contextName);\n        // Ensure the messages container exists and is subscribed\n        ensureMessagesContainer.call(this, contextName, chatWindow, client);\n        toggleMessagesContainer.call(this, contextName, chatWindow);\n    }\n    chatWindow.focus();\n}\n\nfunction createNewChatWindow({ windowType, contextName, windowTitle, windowId, client, data }) {\n    const windowConfig = buildWindowConfig.call(this, windowType, contextName, windowTitle, windowId, data);\n    const chatWindow = this.bp.apps.ui.windowManager.createWindow({\n        ...windowConfig,\n        onOpen: async (_window) => {\n            await initializeChatWindow.call(this, windowType, contextName, _window, client);\n        },\n        onClose: (_window) => {\n            if (windowType === \"pond\") {\n                const roomList = $(\".aim-room-list-items\", chatWindow.content);\n                roomList.find(\".aim-room-item\").each((_, item) => {\n                    const context = $(item).data(\"context\");\n                    client.removeSubscription(\"pond\", context);\n                });\n                this.data.activePonds = [];\n                // Remark: This is a special case if the entire pond window is closed at once\n                // It's important we close all active pond subscriptions\n                if (_window.id === 'pond-chat') {\n                    // alert('main pond window closed')\n                    // iterate through all current subscriptions and close them all\n                    for (let [key, value] of bp.apps.client.messagesWsClients) {\n                        if (key.startsWith(\"pond/\")) {\n                            value.wsClient.closeConnection();\n                        }\n                    }\n                }\n            } else {\n                client.removeSubscription(windowType, contextName);\n            }\n        },\n    });\n\n    if (windowType === \"pond\") {\n        setupCloseButtonHandler.call(this, chatWindow, client);\n        $(\".no-open-ponds\", chatWindow.content).hide();\n        $('.aim-message-controls', chatWindow.content).flexShow();\n\n    }\n\n    chatWindow.loggedIn = true;\n    return chatWindow;\n}\n\nfunction buildWindowConfig(windowType, contextName, windowTitle, windowId, data) {\n    const isBuddy = windowType === \"buddy\";\n    let iconImagePath = isBuddy ? \"\" : \"desktop/assets/images/icons/icon_pond_64.webp\";\n\n    if (isBuddy && this.bp.apps.buddylist.data.profileState?.buddylist?.[contextName]?.profile_picture) {\n        iconImagePath = this.bp.apps.buddylist.data.profileState.buddylist[contextName].profile_picture;\n    }\n\n    // calculate height and width as percent of screen size\n    let height = isBuddy ? 500 : Math.floor(window.innerHeight * 0.8);\n    let width = isBuddy ? 600 : Math.floor(window.innerWidth * 0.75);\n\n    if (this.bp.isMobile()) {\n        height = 'calc(var(--vh) * 90)';\n    }\n\n    return {\n        app: \"buddylist\",\n        id: windowId,\n        title: isBuddy ? contextName : windowTitle,\n        icon: iconImagePath,\n        type: windowType,\n        context: contextName,\n        parent: this.bp.apps.ui.parent,\n        className: \"chatWindow\",\n        //x: 0,\n        //y: 0,\n        x: data.x || 10,\n        y: 50,\n        width: width,\n        height: height,\n    };\n}\n\nasync function initializeChatWindow(windowType, contextName, chatWindow, client) {\n    console.log('initializeChatWindow', windowType, contextName, chatWindow);\n    setupChatWindow.call(this, windowType, contextName, chatWindow, client);\n    client.addSubscription(windowType, contextName);\n\n    if (windowType === \"buddy\") {\n        console.log(`Opening buddy chat window for: ${contextName}`);\n        // remove the .aim-chat-area margin-top ( its the close button for tabbed ponds )\n        $(\".aim-chat-area\", chatWindow.content).css(\"margin-top\", \"0\");\n        // the top to 10\n        $(\".aim-chat-area\", chatWindow.content).css(\"top\", \"10px\");\n        clearBuddyNewMessages.call(this, contextName);\n    }\n\n    if (windowType === \"pond\") {\n        // Populate room list with hot ponds if available\n        // const hotPonds = this.data.hotPonds || [];\n        let hotPonds = this.bp.apps?.pond?.data?.hotPonds || [];\n        populateRoomList.call(this, hotPonds, chatWindow, contextName);\n        // send getConnectedUsers message to the pond\n        toggleMessagesContainer.call(this, contextName, chatWindow);\n    }\n    await renderMessages.call(this, contextName, chatWindow);\n    if (!this.bp.isMobile()) {\n        focusInputField(chatWindow);\n    }\n}\n\nfunction clearBuddyNewMessages(contextName) {\n    if (\n        this.data.profileState?.buddylist?.[contextName]?.newMessages\n    ) {\n        this.data.profileState.buddylist[contextName].newMessages = false;\n        // console.log(\"SETTING newMessages to false for\", contextName);\n        this.buddyServerClient.receivedInstantMessage(contextName, (err, re) => {\n            // console.log(\"receivedInstantMessage\", err, re);\n        });\n    }\n}\n\nasync function renderMessages(contextName, chatWindow) {\n    this.data.processedMessages[contextName] = this.data.processedMessages[contextName] || [];\n    const messagesToRender = [...this.data.processedMessages[contextName]];\n    this.data.processedMessages[contextName] = [];\n\n    for (const message of messagesToRender) {\n        try {\n            await this.renderChatMessage(message, chatWindow, true);\n        } catch (err) {\n            console.error(\"Error rendering message\", message, err, chatWindow);\n        }\n    }\n}\n\nfunction focusInputField(chatWindow) {\n    function attemptFocus() {\n        const aimInput = $(\".aim-input\", chatWindow.content);\n        if (aimInput.length === 0) {\n            setTimeout(attemptFocus, 100);\n            return;\n        }\n        aimInput.focus();\n    }\n    attemptFocus();\n}\n\n\nfunction ensureMessagesContainer(contextName, chatWindow, client) {\n    const chatArea = $(\".aim-chat-area\", chatWindow.content);\n    const userListArea = $(\".aim-user-list-area\", chatWindow.content);\n    if (!chatArea.length || !userListArea.length) {\n        console.log(\"Missing chatArea or userListArea for context:\", contextName);\n        return;\n    }\n\n    // Normalize context for user list (e.g., \"pond/general\" -> \"general\")\n    let userListContext = contextName.replace(\"pond/\", \"\");\n\n    // santitize userListContext using jQuery to prevent XSS\n    userListContext = $(\"<div>\").text(userListContext).html();\n\n    // Create message container if missing\n    let existingContainer = $(`.aim-messages-container[data-context=\"${contextName}\"]`, chatArea);\n    if (!existingContainer.length) {\n        console.log(\"Creating new messages container for context:\", contextName);\n        const newContainer = document.createElement(\"div\");\n        newContainer.className = \"aim-messages-container\";\n        newContainer.setAttribute(\"data-context\", contextName);\n        newContainer.setAttribute(\"data-type\", \"pond\");\n        newContainer.style.display = \"none\";\n        newContainer.innerHTML = `\n            <div class=\"aim-messages-header\">\n                <h2 class=\"aim-chat-title\"><span class=\"aim-chat-username\">#${userListContext}</span></h2>\n                <button class=\"aim-close-chat-btn\" data-context=\"${contextName}\">Close</button>\n            </div>\n            <div class=\"aim-no-messages\">\n                Your conversation has just started. You can send a message using the form below.\n            </div>\n            <div class=\"aim-messages\"></div>\n        `;\n        chatArea.append(newContainer);\n\n        client.addSubscription(\"pond\", contextName);\n        this.data.activePonds = this.data.activePonds || [];\n        if (!this.data.activePonds.includes(contextName)) {\n            this.data.activePonds.push(contextName);\n        }\n        $(\".no-open-ponds\", chatWindow.content).hide();\n        $(\".aim-message-controls\", chatWindow.content).flexShow();\n    } \n\n    // Create user list if missing\n    let existingUserList = $(`.aim-user-list[data-context=\"${userListContext}\"][data-type=\"pond\"]`, userListArea);\n    if (!existingUserList.length) {\n        console.log(\"Creating new user list for context:\", userListContext);\n        const newUserList = document.createElement(\"div\");\n        newUserList.className = \"aim-user-list\";\n        newUserList.setAttribute(\"data-context\", userListContext);\n        newUserList.setAttribute(\"data-type\", \"pond\");\n        newUserList.style.display = \"none\";\n        newUserList.innerHTML = `\n            <div class=\"aim-user-list-header\">\n                <h3>Buddies</h3>\n            </div>\n            <ul class=\"aim-user-list-items\"></ul>\n        `;\n        userListArea.append(newUserList);\n    }\n}\n\nfunction toggleMessagesContainer(contextName, chatWindow) {\n    const chatArea = $(\".aim-chat-area\", chatWindow.content);\n    const userListArea = $(\".aim-user-list-area\", chatWindow.content);\n    if (!chatArea.length || !userListArea.length) {\n        console.log(\"Missing chatArea or userListArea for context:\", contextName);\n        return;\n    }\n\n    // Hide all message containers and user lists\n    $(\".aim-messages-container\", chatArea).hide();\n    $(\".aim-user-list\", userListArea).hide();\n\n    // Normalize context for user list (e.g., \"pond/general\" -> \"general\")\n    const userListContext = contextName.replace(\"pond/\", \"\");\n\n    chatWindow.currentActiveContext = userListContext;\n\n    // Select target elements\n    const targetContainer = $(`.aim-messages-container[data-context=\"${contextName}\"][data-type=\"pond\"]`, chatArea);\n    const targetUserList = $(`.aim-user-list[data-context=\"${userListContext}\"][data-type=\"pond\"]`, userListArea);\n\n    if (!targetContainer.length) {\n        console.log(\"Creating messages container for context:\", contextName);\n        ensureMessagesContainer.call(this, contextName, chatWindow, this.bp.apps.client);\n        // Re-select after creation\n        targetContainer = $(`.aim-messages-container[data-context=\"${contextName}\"][data-type=\"pond\"]`, chatArea);\n    }\n\n    // Show target elements\n    if (targetContainer.length) {\n        // console.log(\"Showing messages container for context:\", contextName);\n        targetContainer.show();\n    }\n    if (targetUserList.length) {\n        // console.log(\"Showing user list for context:\", userListContext);\n        targetUserList.show();\n    }\n\n    // Fallback: Show first available context if target is missing\n    if (!targetContainer.length || !targetUserList.length) {\n        const availableContainers = $(\".aim-messages-container\", chatArea);\n        if (availableContainers.length > 0) {\n            const firstContext = availableContainers.first().data(\"context\");\n            const firstUserListContext = firstContext.replace(\"pond/\", \"\");\n            // console.log(\"Falling back to first context:\", firstContext);\n\n            $(`.aim-messages-container[data-context=\"${firstContext}\"]`, chatArea).show();\n            $(`.aim-user-list[data-context=\"${firstUserListContext}\"][data-type=\"pond\"]`, userListArea).show();\n\n            $(\".aim-room-item\", chatWindow.content).removeClass(\"aim-room-active\");\n            $(`.aim-room-item[data-context=\"${firstContext}\"]`, chatWindow.content).addClass(\"aim-room-active\");\n            $(\".message_form .aim-to\", chatWindow.content).val(firstContext);\n        } else {\n            console.log(\"No available message containers or user lists\");\n        }\n    }\n\n    // find the current .button-bar\n    let buttonBar = $(\".button-bar\", chatWindow.content);\n    // we need to iterate through all the first level children of the buttonBar\n    // and update the data-context attribute to match the current contextName\n    if (buttonBar.length) {\n        buttonBar.children().each((_, child) => {\n            // console.log(`Updating button bar child context for:`, child, contextName);\n            $(child).attr(\"data-context\", contextName);\n        });\n    }\n\n    this.scrollToBottom(chatWindow.content);\n}\n\nfunction setupChatWindow(windowType, contextName, chatWindow, client) {\n    const chatWindowTemplate = this.messageTemplateString;\n    const cloned = document.createElement(\"div\");\n    cloned.innerHTML = chatWindowTemplate;\n\n    const aimMessagesContainer = $(\".aim-messages-container\", cloned)[0];\n    aimMessagesContainer.setAttribute(\"data-context\", contextName);\n    aimMessagesContainer.setAttribute(\"data-type\", windowType);\n\n    if (windowType === \"buddy\") {\n        $(\".aim-user-list-area\", cloned).remove();\n        $(\".aim-room-list\", cloned).remove();\n        $('.aim-messages-header', cloned).remove();\n        chatWindow.container.classList.add(\"has-droparea\");\n        chatWindow.content.appendChild($(\".aim-window\", cloned)[0]);\n\n    } else {\n\n        const aimUserListContainer = $(\".aim-user-list\", cloned)[0];\n        aimUserListContainer.setAttribute(\"data-context\", contextName);\n        aimUserListContainer.setAttribute(\"data-type\", windowType);\n\n        if (this.bp.isMobile()) {\n            $('.aim-close-chat-btn', cloned).text('Close #' + contextName.replace(\"pond/\", \"\"));\n            $('.aim-chat-title', cloned).remove();\n        } else {\n            $('.aim-chat-title', cloned).text(`#${contextName.replace(\"pond/\", \"\")}`);\n\n        }\n\n        $('.joinPondForm', cloned).on('submit', (e) => {\n            e.preventDefault();\n            // get value from #customPondName\n            try {\n                let pondName = $('.customPondName').val();\n                joinPond.call(this, pondName);\n\n            } catch (err) {\n                console.error(\"Error joining pond:\", err);\n            }\n            return false;\n        });\n\n        chatWindow.container.classList.add(\"has-droparea\");\n        chatWindow.content.appendChild($(\".aim-window\", cloned)[0]);\n\n        const aimWindow = $('.aim-window', chatWindow.content)[0];\n        let touchStartX = 0;\n        let touchEndX = 0;\n\n        aimWindow.addEventListener('touchstart', (e) => {\n            touchStartX = e.changedTouches[0].screenX;\n        });\n\n        aimWindow.addEventListener('touchend', (e) => {\n            touchEndX = e.changedTouches[0].screenX;\n            handleSwipe();\n        });\n\n        function handleSwipe() {\n            const swipeThreshold = 50; // Minimum swipe distance in pixels\n            const deltaX = touchEndX - touchStartX;\n\n            if (deltaX > swipeThreshold) {\n                // Swipe right: show user list\n                aimWindow.classList.remove('show-room-list');\n                aimWindow.classList.add('show-user-list');\n            } else if (deltaX < -swipeThreshold) {\n                // Swipe left: show room list\n                aimWindow.classList.remove('show-user-list');\n                aimWindow.classList.add('show-room-list');\n            } else {\n                // No swipe or too small: return to chat\n                aimWindow.classList.remove('show-room-list', 'show-user-list');\n            }\n        }\n\n        // create button bar at top\n        const buttonBar = document.createElement('div');\n        buttonBar.className = 'pond-button-bar';\n        buttonBar.setAttribute('data-context', contextName);\n        buttonBar.setAttribute('data-type', windowType);\n\n        // Optional: Add buttons to toggle panels for accessibility\n        const toggleRoomListBtn = document.createElement('button');\n        toggleRoomListBtn.textContent = 'Ponds';\n        toggleRoomListBtn.className = 'toggle-room-list';\n\n        const toggleUserListBtn = document.createElement('button');\n        toggleUserListBtn.textContent = 'Buddies';\n        toggleUserListBtn.className = 'toggle-user-list';\n\n        const closePondChatBtn = document.createElement('button');\n        closePondChatBtn.textContent = 'Close #' + contextName.replace(\"pond/\", \"\");\n        //closePondChatBtn.className = 'aim-room-close-btn';\n        // add another className, aim-close-pond-chat-btn\n        closePondChatBtn.classList.add('aim-close-pond-chat-btn');\n        closePondChatBtn.classList.add('aim-room-close-btn');\n        closePondChatBtn.setAttribute('data-context', contextName);\n        closePondChatBtn.setAttribute('data-type', windowType);\n\n        chatWindow.content.appendChild(buttonBar);\n\n        chatWindow.content.append(toggleRoomListBtn, closePondChatBtn, toggleUserListBtn);\n        // Append the button bar to the chat window content\n\n        setupCloseButtonHandler.call(this, chatWindow, client);\n\n        toggleRoomListBtn.addEventListener('click', () => {\n            aimWindow.classList.toggle('show-room-list');\n            aimWindow.classList.remove('show-user-list');\n        });\n\n        toggleUserListBtn.addEventListener('click', () => {\n            aimWindow.classList.toggle('show-user-list');\n            aimWindow.classList.remove('show-room-list');\n        });\n\n    }\n\n    setupAutocomplete.call(this, chatWindow);\n    setupChatWindowButtons.call(this, windowType, contextName, chatWindow);\n    setupMessageForm.call(this, windowType, contextName, chatWindow);\n    setupInputEvents.call(this, windowType, contextName, chatWindow);\n    \n    // update the aim-close-chat-btn with contextName\n    const closeButton = $(\".aim-close-chat-btn\", chatWindow.content);\n    if (closeButton.length) {\n        closeButton.attr(\"data-context\", contextName);\n    } else {\n        console.warn(\"No close button found in chat window for context:\", contextName);\n    }\n\n    if (windowType === \"pond\") {\n        $(\".aim-user-list-items\").on(\"click\", (e) => {\n            const username = $(e.target).closest('.aim-user-item').data(\"username\");\n            if (!username) {\n                console.error(\"No username found in clicked element\");\n                return;\n            }\n            this.openChatWindow({ name: username });\n        });\n\n        setupRoomListClickHandler.call(this, chatWindow);\n\n    }\n}\n\nfunction setupMessageForm(windowType, contextName, chatWindow) {\n    $(\".message_form .aim-to\", chatWindow.content).val(contextName);\n\n    $(\".message_form\", chatWindow.content).submit(async (e) => {\n        e.preventDefault();\n        await this.sendMessageHandler(e, chatWindow, windowType, contextName);\n    });\n}\n\nfunction setupRoomListClickHandler(chatWindow) {\n    $(\".aim-room-list-items\", chatWindow.content).on(\"click\", \".aim-room-item\", (e) => {\n        let selectedContext = $(e.target).parent().data(\"context\");\n        if (!selectedContext) {\n            console.warn(\"No context found for clicked room item target\", e.target);\n            return;\n        }\n        selectedContext = selectedContext.replace(\"pond/\", \"\");\n        //console.log(\"Selected context:\", selectedContext);\n        $(\".aim-room-item\", chatWindow.content).removeClass(\"aim-room-active\");\n        $(e.target).addClass(\"aim-room-active\");\n        ensureMessagesContainer.call(this, selectedContext, chatWindow, this.bp.apps.client);\n        $(\".message_form .aim-to\", chatWindow.content).val(selectedContext);\n        toggleMessagesContainer.call(this, selectedContext, chatWindow);\n        // TODO: Implement logic to load messages for selectedContext\n    });\n}\n\nfunction setupCloseButtonHandler(chatWindow, client) {\n    $(chatWindow.content).on(\"click\", \".aim-close-chat-btn, .aim-room-close-btn\", (ev) => {\n        ev.stopPropagation();\n        const context = ev.target.getAttribute(\"data-context\");\n\n        // Remove subscription and container\n        client.removeSubscription(\"pond\", context);\n        $(`.aim-messages-container[data-context=\"${context}\"]`, chatWindow.content).remove();\n        $(`.aim-room-item[data-context=\"${context}\"]`, chatWindow.content).remove();\n        // remove the associated .aim-user-list\n        $(`.aim-user-list[data-context=\"${context.replace(\"pond/\", \"\")}\"][data-type=\"pond\"]`, chatWindow.content).remove();\n        // Update active ponds\n        this.data.activePonds = this.data.activePonds.filter((pond) => pond !== context);\n\n        // clear out this.data.processedMessages[contextName] = [];\n        if (this.data.processedMessages[context]) {\n            this.data.processedMessages[context] = [];\n        }\n\n        // Switch to another pond or hide all containers\n        const remainingContainers = $(\".aim-messages-container\", chatWindow.content);\n        if (remainingContainers.length > 0) {\n            const nextContext = remainingContainers.first().data(\"context\");\n            toggleMessagesContainer.call(this, nextContext, chatWindow);\n            $(\".aim-room-item\", chatWindow.content).removeClass(\"aim-room-active\");\n            $(`.aim-room-item[data-context=\"${nextContext}\"]`, chatWindow.content).addClass(\"aim-room-active\");\n            $(\".message_form .aim-to\", chatWindow.content).val(nextContext);\n        } else {\n            $(\".aim-messages-container\", chatWindow.content).hide();\n            $(\".message_form .aim-to\", chatWindow.content).val(\"\");\n        }\n\n        // find the .aim-room-list-item with data-pond matching context\n        const roomItem = $(`.aim-room-item[data-context=\"pond/${context}\"]`, chatWindow.content);\n        // find the .aim-room-list-item and remove active class\n        $(\".aim-room-list-item-name\", roomItem).removeClass(\"aim-room-active\");\n\n        // get current count of .aim-chat-area, if 2 show .no-open-ponds\n        const chatAreas = $(\".aim-messages-container\", chatWindow.content);\n        if (chatAreas.length === 0) {\n            $(\".no-open-ponds\", chatWindow.content).flexShow();\n            $('.aim-message-controls', chatWindow.content).hide();\n        }\n        else {\n            $(\".no-open-ponds\", chatWindow.content).hide();\n            $('.aim-message-controls', chatWindow.content).flexShow();\n        }\n\n    });\n}\n\n\nfunction joinPond(pondName) {\n\n    if (!pondName) {\n        console.error(\"Pond name is required to join a pond.\");\n        return;\n    }\n\n    let invalidName = this.forbiddenNotes.containsBadWord(pondName);\n    if (invalidName) {\n        alert('Invalid pond name. Please choose a different name.');\n        return;\n    }\n\n    // currently all ponds exists in the main \"server\" context, pond_messages_main\n    let chatWindow = this.bp.apps.ui.windowManager.getWindow('pond-chat');\n\n    if (!chatWindow) {\n        // we may want to open  bp.open('buddylist', { context: pondName, type: 'pond' }); in this case\n        console.error(\"Pond message main window not found, cannot join pond.\");\n        // TODO: might be easier to just open the window here instread of parent API doing it\n        // see: apps/pond/pond.js for example\n        /*\n        const pondMainWindow = this.bp.apps.ui.windowManager.getWindow('pond_message_main');\n        if (pondMainWindow) {\n            this.bp.apps.buddylist.joinPond(pondName);\n            pondMainWindow.focus();\n        } else {\n            this.bp.apps.buddylist.openChatWindow({ pondname: pondName });\n        }\n        */\n        return;\n    }\n    // this.openChatWindow({ pondname: pondName });\n    let selectedContext = `${pondName}`;\n    ensureMessagesContainer.call(this, selectedContext, chatWindow, this.bp.apps.client);\n    $(\".message_form .aim-to\", chatWindow.content).val(selectedContext);\n    toggleMessagesContainer.call(this, selectedContext, chatWindow);\n\n}","const defaultProfileFiles = {\n    'index.html': `\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>My BuddyPond Profile</title>\n    <link rel=\"stylesheet\" href=\"./style.css\">\n</head>\n<body>\n    <h1>My Profile</h1>\n    <div class=\"profile-section\">\n        <p>Welcome to my BuddyPond profile, hosted on the BuddyPond CDN!</p>\n        <p><strong>Customize Your Profile:</strong></p>\n        <ul>\n            <li>This default profile includes <code>index.html</code>, <code>style.css</code>, and <code>profile.js</code>.</li>\n            <li>You may use any files, the only requirement is <code>index.html</code> must be located in root.</li>\n            <li>Edit or upload files in the <strong>Buddy Files</strong> app (root directory).</li>\n            <li>Add any static files (HTML, CSS, JS, images) or projects (e.g., React, Vue).</li>\n            <li>Use relative paths (e.g., <code>./style.css</code>) to link files.</li>\n        </ul>\n        <p><strong>Example:</strong> Click to change text color.</p>\n        <button id=\"toggleButton\">Toggle Text Color</button>\n        <p class=\"color-text\">This text changes color!</p>\n    </div>\n    <script src=\"./profile.js\"></script>\n</body>\n</html>`,\n    'style.css': `\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    background-color: #f4f4f9;\n    color: #333;\n    margin: 0;\n    padding: 20px;\n    line-height: 1.5;\n}\nh1 {\n    color: #007bff;\n    text-align: center;\n}\n.profile-section {\n    max-width: 600px;\n    margin: 0 auto;\n}\nul {\n    padding-left: 20px;\n    font-size: 0.9em;\n}\ncode {\n    background: #f0f0f0;\n    padding: 2px 4px;\n    border-radius: 3px;\n}\nbutton {\n    background-color: #007bff;\n    color: white;\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    display: block;\n    margin: 10px auto;\n}\nbutton:hover {\n    background-color: #0056b3;\n}\n.color-text {\n    font-size: 1.1em;\n    text-align: center;\n    transition: color 0.3s ease;\n}\n.color-text.toggled {\n    color: #dc3545;\n}`,\n    'profile.js': `\nconst text = document.querySelectorAll('.color-text');\nconst button = document.getElementById('toggleButton');\nbutton.addEventListener('click', () => {\n    text.forEach(item => item.classList.toggle('toggled'));\n});\n`\n};\n\nexport default defaultProfileFiles;","\n// the best way to determine if user has a profile seems to be to just\n// check the CDN for index.html, style.css, and profile.js files\n// if any of them 404, we will programmatically create them here\n// generateDefaultProfile() is called on auth::qtoken ( login success )\n// so on each logic we will check if the profile exists\n// if we didn't do this, we'd have to check profile on File Explorer open or Profile open or Pad open,\n// which would result in a fragmented code and a delay in UI while we check for profile existence\n\nimport defaultProfileFiles from './defaultProfileFiles.js';\n\nexport default async function generateDefaultProfile(qtoken) {\n    const basePath = \"https://files.buddypond.com/\" + qtoken.me;\n\n    // TODO: move to portfolio / faucet\n    // await requestDefaultCoinAllocations.call(this, qtoken);\n\n\n    for (const [fileName, fileContent] of Object.entries(defaultProfileFiles)) {\n        try {\n            const response = await fetch(`${basePath}/${fileName}`);\n            if (!response.ok) throw new Error('File not found, needs creation');\n\n            // check if not 200 response\n            // if not, throw error\n            if (response.status !== 200) throw new Error('File not found, needs creation');\n\n            // check if new location is four-ohh-four, if so, throw error\n            if (response.url === 'https://buddypond.com/four-ohh-four') {\n                throw new Error('File not found, needs creation');\n            }\n\n        } catch (error) {\n            console.log(`Creating ${fileName}: ${error.message}`);\n            const blob = new Blob([fileContent], { type: getFileType(fileName) });\n            const file = new File([blob], fileName, {\n                type: blob.type,\n                lastModified: new Date()\n            });\n            file.filePath = `${fileName}`; // maybe\n\n            try {\n                await this.bp.apps.client.api.uploadFile(file);\n                console.log(`${fileName} uploaded successfully.`);\n            } catch (uploadError) {\n                console.error(`Error uploading ${fileName}: ${uploadError.message}`);\n            }\n        }\n    }\n}\n\nfunction getFileType(fileName) {\n    if (fileName.endsWith('.html')) return 'text/html';\n    if (fileName.endsWith('.css')) return 'text/css';\n    if (fileName.endsWith('.js')) return 'application/javascript';\n    return 'text/plain';\n}\n\n\nasync function requestDefaultCoinAllocations(qtoken) {\n    // before generating the default profile files ( for home page)\n    // we need to establish the users initial MEGA ( Megabytes ) asset allocation in their portfolio\n    // since the user's initial state will have no record, we can simply attempt to add\n    // backend will allow initial allocation of 10 MEGA to all users\n\n    //\n    // Request default MEGA allocation\n    //\n    try {\n        await this.bp.load('portfolio');\n\n\n        await this.bp.apps.portfolio.resource.apiRequest('POST', 'portfolio/' + qtoken.me + '/MEGA', {\n            symbol: 'MEGA',\n            owner: qtoken.me,\n            amount: 10,\n            available: 10,\n            price: 0.1,\n            cost: 0\n        });\n\n    } catch (error) {\n        console.log('Error creating MEGA asset for user', error);\n    }\n\n    //\n    // Request default GBP allocation\n    //\n    try {\n        await this.bp.load('portfolio'); // should be cached at this stage\n        await this.bp.apps.portfolio.resource.apiRequest('POST',  'portfolio/' + qtoken.me + '/GBP', {\n            symbol: 'GBP',\n            owner: qtoken.me,\n            amount: 10000,\n            available: 10000,\n            price: 0.001,\n            cost: 0\n        });\n    } catch (error) {\n        console.log('Error creating GBP asset for user', error);\n    }\n}","// import scrollToBottom from \"./scrollToBottom.js\";\n\n// TODO: add logic for \"reply-message\" action\n//       reply-message action should open a small \"replying to\" box above the closest .aim-message-sender element\n//       The \"Replying to {BuddyName}\" box should contain the message text and a small \"cancel\" button at the right / end of the box\n//       We can assume that data-from will be the same as the sender of the message we are replying to\n\nexport default function bindMessageContextMenu() {\n\n  bindProfilePictureClick.call(this);\n\n  // Single event delegation for context menu, hover menu, and edit hint actions\n  document.addEventListener('click', async (event) => {\n    const target = event.target;\n    let action = target.getAttribute('data-action');\n    \n    console.log('clicked on target', target, action);\n    // Handle context menu item click\n    if (target.classList.contains('aim-context-menu-item') && action) {\n      handleContextMenuItemClick.call(this, action, target);\n      return;\n    }\n\n    // Handle hover menu item click\n\n    // check if the target or any of its parents has class 'aim-message-reaction'\n    if ($(target).hasClass('aim-message-reaction') || $(target).parents().hasClass('aim-message-reaction')) {\n      // action = target.getAttribute('data-action') || target.parentNode.getAttribute('data-action');\n\n\n      const messageUUID = target.closest('.aim-chat-message')?.getAttribute('data-uuid');\n      const originalMessage = document.querySelector(`.aim-chat-message[data-uuid=\"${messageUUID}\"]`);\n      if (!originalMessage) {\n        console.error('No original message found');\n        return;\n      }\n      const messageData = {\n        uuid: messageUUID,\n        chatId: originalMessage.getAttribute('data-chat-id'),\n        from: originalMessage.getAttribute('data-from'),\n      };\n      if (!messageData.uuid || !messageData.chatId) {\n        console.error('No message data found');\n        return;\n      }\n      console.log('React message clicked', messageData);\n\n      let emoji = target.closest('.aim-message-reaction')?.getAttribute('data-emoji');\n\n      await buddypond.reactInstantMessage({\n        from: messageData.from,\n        chatId: messageData.chatId,\n        uuid: messageData.uuid,\n        reaction: emoji,\n      });\n\n\n\n      return;\n    }\n\n    // TODO: there must be a better way to do this\n    // Remark: The issue is that we wish to cover the click action for the parent item and all its potential children\n    let isHoverMenuAction = $(target).hasClass('aim-hover-menu-item') || $(target).parents().hasClass('aim-hover-menu-item');\n    action = target.getAttribute('data-action') || target.parentNode.getAttribute('data-action');\n\n    // alert(`isHoverMenuAction: ${isHoverMenuAction}, action: ${action}`)\n\n    if (isHoverMenuAction && action) {\n      handleContextMenuItemClick.call(this, action, target);\n      return;\n    }\n\n    // Handle edit hint action click (escape/enter)\n    if (target.classList.contains('aim-edit-hint-action') && action) {\n      handleEditHintAction.call(this, action, target);\n      return;\n    }\n\n    // Handle reply cancel button click\n    if (target.classList.contains('aim-reply-cancel') && action === 'cancel-reply') {\n      // get the closest reply box\n      const replyBox = target.closest('.aim-reply-box');\n      cancelReply.call(this, replyBox);\n      return;\n    }\n\n    // Close existing context menu and reset hover menu\n    closeMenus.call(this);\n  });\n}\n\n// Handle context menu or hover menu item click\nfunction handleContextMenuItemClick(action, target) {\n  performAction.call(this, action, target);\n  if (action !== 'more-options') {\n    closeMenus.call(this);\n  }\n}\n\n// Handle edit hint action (escape/enter)\nfunction handleEditHintAction(action, target) {\n  const messageContent = target.closest('.aim-editable-container')?.querySelector('.aim-message-content');\n  if (!messageContent) {\n    console.error('No message content found for edit hint action');\n    return;\n  }\n\n  const messageUUID = messageContent.closest('.aim-chat-message')?.getAttribute('data-uuid');\n  const originalMessage = document.querySelector(`.aim-chat-message[data-uuid=\"${messageUUID}\"]`);\n  if (!originalMessage) {\n    console.error('No original message found');\n    return;\n  }\n\n  const messageData = {\n    uuid: messageUUID,\n    chatId: originalMessage.getAttribute('data-chat-id'),\n    text: originalMessage.getAttribute('data-original-text') || messageContent.innerText\n  };\n\n  if (action === 'cancel-edit') {\n    cancelEdit.call(this, messageContent, messageData.text);\n  } else if (action === 'save-edit') {\n    saveEdit.call(this, messageContent, messageData);\n  }\n\n}\n\n// Close active context and hover menus\nfunction closeMenus() {\n  if (this.activeMessageContextMenu) {\n    this.activeMessageContextMenu.remove();\n    this.activeMessageContextMenu = null;\n  }\n  if (this.activeMessageHoverMenu) {\n    this.activeMessageHoverMenu = null; // Rely on CSS for hiding hover menu\n  }\n  if (this.activeReplyBox) {\n    return;\n    this.activeReplyBox.remove();\n    this.activeReplyBox = null;\n    this.bp.replyMode = false;\n  }\n}\n\n// Perform the specified action\nfunction performAction(action, target) {\n  console.log(`Performing action: ${action}`, target);\n  const closestTarget = target.closest('.aim-context-menu') || target.closest('.aim-chat-message');\n  if (!closestTarget) {\n    console.error('No closest target found');\n    return;\n  }\n  // console.log('closestTarget', closestTarget);\n  const messageUUID = closestTarget.getAttribute('data-uuid');\n  const messageChatId = closestTarget.getAttribute('data-chat-id');\n  const messageFrom = closestTarget.getAttribute('data-from');\n  const messageData = {\n    uuid: messageUUID,\n    chatId: messageChatId,\n    from: messageFrom,\n  };\n\n  const originalMessage = document.querySelector(`.aim-chat-message[data-uuid=\"${messageUUID}\"]`);\n  if (!originalMessage) {\n    console.error('No original message found');\n    return;\n  }\n\n  messageData.text = originalMessage.querySelector('.aim-message-content').innerText;\n\n  if (!messageData.uuid || !messageData.chatId) {\n    console.error('No message data found');\n    return;\n  }\n\n  switch (action) {\n    case 'react-message':\n      console.log('Add reaction clicked');\n      // alert('react-message clicked');\n      let $target = $(target).closest('.aim-hover-menu-item');\n      console.log('$target', $target);\n      console.log('.emoji-picker-popup', $('.emoji-picker-popup').length);\n      $target.emojiPicker({\n        onSelect: async (emoji) => {\n          console.log(\"Selected:\", emoji);\n          // send reaction event to server\n\n\n          console.log('Reacted message', emoji, messageData);\n\n          await buddypond.reactInstantMessage({\n            from: messageData.from,\n            chatId: messageData.chatId,\n            uuid: messageData.uuid,\n            reaction: emoji,\n          });\n\n\n          // let messageControls = $target.closest('.aim-message-controls');\n          // $('.aim-input', messageControls).val((i, val) => val + emoji).trigger('input').focus();\n        }\n      });\n\n\n\n      break;\n    case 'edit-message':\n      editMessage.call(this, messageData);\n      break;\n    case 'reply-message':\n      replyMessage.call(this, messageData, originalMessage);\n      break;\n    case 'more-options':\n      event.preventDefault();\n      const closestMessage = target.closest('.aim-chat-message');\n      console.log('closestMessage', closestMessage);\n      if (closestMessage) {\n        this.createMessageContextMenu(target, closestMessage);\n      }\n\n      break;\n    case 'quote-message':\n      console.log('Quote message clicked');\n      break;\n    case 'say-message':\n      console.log('Say message clicked');\n      console.log('sayMessage', messageData);\n      this.bp.emit('say::message', messageData);\n      break;\n    case 'report-message':\n      console.log('Report message clicked');\n      break;\n    case 'copy-message':\n      console.log('Copy message clicked');\n      break;\n    case 'delete-message':\n      deleteMessage.call(this, messageData);\n      break;\n    case 'cast-spell':\n      this.bp.open('spellbook', { context: messageData.from, output: 'buddy' });\n      break;\n    default:\n      console.error(`Unknown action: ${action}`);\n  }\n}\n\n// Delete a message\nfunction deleteMessage(messageData) {\n  console.log('Deleting message', messageData);\n  buddypond.removeInstantMessage(messageData);\n}\n\n// Edit a message\nfunction editMessage(messageData) {\n  const messageContent = document.querySelector(\n    `.aim-chat-message[data-uuid=\"${messageData.uuid}\"] .aim-message-content`\n  );\n  if (!messageContent) {\n    console.error('No message content found');\n    return;\n  }\n\n  this.bp.ignoreUIControlKeys = true;\n  const originalText = messageData.text;\n\n  // Wrap message content in an editable container\n  const editableContainer = document.createElement('div');\n  editableContainer.className = 'aim-editable-container';\n  messageContent.parentNode.insertBefore(editableContainer, messageContent);\n  editableContainer.appendChild(messageContent);\n\n  // Store original text for restoration\n  messageContent.closest('.aim-chat-message').setAttribute('data-original-text', originalText);\n\n  // Make content editable\n  messageContent.setAttribute('contenteditable', 'true');\n  messageContent.setAttribute('data-editing', 'true');\n  messageContent.focus();\n\n  // Add UX hint message\n  const editHint = document.createElement('div');\n  editHint.className = 'aim-edit-hint';\n  editHint.innerHTML = `\n    <span class=\"aim-edit-hint-action\" data-action=\"cancel-edit\">escape</span> to cancel â€¢ \n    <span class=\"aim-edit-hint-action\" data-action=\"save-edit\">enter</span> to save\n  `;\n  editableContainer.appendChild(editHint);\n\n  // find the closest chatWindow\n  const chatWindow = messageContent.closest('.chatWindow');\n\n  this.scrollToBottom(chatWindow);\n\n  // Named event handler for keydown\n  const handleKeydown = (event) => {\n    if (event.key === 'Escape') {\n      cancelEdit.call(this, messageContent, originalText);\n      cleanupListeners();\n      event.preventDefault();\n      event.stopPropagation();\n    } else if (event.key === 'Enter') {\n      saveEdit.call(this, messageContent, messageData);\n      cleanupListeners();\n      event.preventDefault();\n      event.stopPropagation();\n    }\n  };\n\n  // Named event handler for blur\n  const handleBlur = (ev) => {\n    // ensure the target was not \".aim-edit-hint-action\"\n    console.log('handleBlur', ev.relatedTarget, ev.target.classList);\n    if (ev.relatedTarget && !ev.relatedTarget.classList.contains('aim-edit-hint-action')) {\n      cancelEdit.call(this, messageContent, originalText);\n      cleanupListeners();\n    }\n  };\n\n  // Cleanup function for event listeners\n  const cleanupListeners = () => {\n    messageContent.removeEventListener('keydown', handleKeydown);\n    messageContent.removeEventListener('blur', handleBlur);\n    this.bp.ignoreUIControlKeys = false;\n  };\n\n  // Attach event listeners\n  messageContent.addEventListener('keydown', handleKeydown);\n  messageContent.addEventListener('blur', handleBlur);\n\n  console.log('Editing message', messageData);\n}\n\n// Cancel editing and restore original text\nfunction cancelEdit(messageContent, originalText, restoreText = true) {\n  const editableContainer = messageContent.closest('.aim-editable-container');\n  if (editableContainer) {\n    // Move messageContent back to its original parent\n    editableContainer.parentNode.insertBefore(messageContent, editableContainer);\n    editableContainer.remove();\n  }\n\n  messageContent.setAttribute('contenteditable', 'false');\n  messageContent.removeAttribute('data-editing');\n  if (restoreText) {\n    messageContent.innerText = originalText;\n  }\n  messageContent.blur();\n\n  const messageElement = messageContent.closest('.aim-chat-message');\n  if (messageElement) {\n    messageElement.removeAttribute('data-original-text');\n  }\n\n  console.log('Edit cancelled');\n  this.bp.ignoreUIControlKeys = false;\n}\n\n// Save edited message\nasync function saveEdit(messageContent, messageData) {\n  const editableContainer = messageContent.closest('.aim-editable-container');\n  if (editableContainer) {\n    console.log('Editable container found', editableContainer);\n    // Move messageContent back to its original parent\n    // throws error:  Failed to execute 'insertBefore' on 'Node': The node to be removed is no longer a child of this node. Perhaps it was moved in a 'blur' event handler?\n    // is the blur event already removing this?\n    //editableContainer.parentNode.insertBefore(messageContent, editableContainer);\n    //editableContainer.remove();\n  }\n\n  const newMessageText = messageContent.innerText;\n  messageContent.setAttribute('contenteditable', 'false');\n  messageContent.removeAttribute('data-editing');\n  messageContent.blur();\n\n  const messageElement = messageContent.closest('.aim-chat-message');\n  if (messageElement) {\n    messageElement.removeAttribute('data-original-text');\n  }\n\n  console.log('Edit saved', newMessageText);\n\n  await buddypond.editInstantMessage({\n    from: messageData.from,\n    chatId: messageData.chatId,\n    uuid: messageData.uuid,\n    text: newMessageText,\n  });\n\n  // close the edit hint\n  cancelEdit.call(this, messageContent, null, false);\n}\n\n// Reply to a message\nfunction replyMessage(messageData, originalMessage) {\n  // Close any existing reply box\n  if (this.activeReplyBox) {\n    this.activeReplyBox.remove();\n    this.activeReplyBox = null;\n  }\n\n\n  this.bp.ignoreUIControlKeys = true;\n  this.bp.replyData = messageData; // Store reply data for message submission\n\n  // Create reply box\n  const replyBox = document.createElement('div');\n  replyBox.className = 'aim-reply-box';\n  replyBox.innerHTML = `\n    <span class=\"aim-reply-header\">Replying to ${messageData.from}</span>\n    <button class=\"aim-reply-cancel\" data-action=\"cancel-reply\">Cancel</button>\n  `;\n  //   <span class=\"aim-reply-text\">${messageData.text}</span>\n\n  // Insert reply box above .aim-message-sender\n  const messageSender = $(originalMessage).parent().parent().parent().parent().find('.aim-message-sender')[0];\n  if (!messageSender) {\n    console.error('No message sender found');\n    return;\n  }\n  messageSender.parentNode.insertBefore(replyBox, messageSender);\n\n  // Store active reply box\n  this.activeReplyBox = replyBox;\n  // this.activeReplyUUID = messageData.uuid;\n  // find the closet input named \"message_replyto\"\n  const replyInput = replyBox.closest('.chatWindow').querySelector('input[name=\"message_replyto\"]');\n  const messageTextInput = replyBox.closest('.chatWindow').querySelector('textarea[name=\"message_text\"]');\n  // set the value of the input to the messageData.uuid\n  // set the focus to the replyInput\n  if (replyInput) {\n    replyInput.value = messageData.uuid;\n  } else {\n    console.error('No reply input found');\n  }\n  if (messageTextInput) {\n    messageTextInput.focus();\n  } else {\n    console.error('No message text input found');\n  }\n\n  // Find the closest chatWindow and scroll to bottom\n  const chatWindow = originalMessage.closest('.chatWindow');\n  if (chatWindow) {\n    this.scrollToBottom(chatWindow);\n  }\n\n  const handleKeydown = (event) => {\n    if (event.key === 'Escape') {\n      //cancelEdit(messageContent, originalText);\n      cancelReply.call(this, replyBox);\n      cleanupListeners();\n      event.preventDefault();\n      event.stopPropagation();\n    } else if (event.key === 'Enter') {\n      // saveEdit.call(this, messageContent, messageData);\n      cleanupListeners();\n      event.preventDefault();\n      event.stopPropagation();\n    }\n  };\n\n  // Cleanup function for event listeners\n  const cleanupListeners = () => {\n    messageTextInput.removeEventListener('keydown', handleKeydown);\n    // messageTextInput.removeEventListener('blur', handleBlur);\n    this.bp.ignoreUIControlKeys = false;\n  };\n\n  messageTextInput.addEventListener('keydown', handleKeydown);\n\n  console.log('Reply mode activated', messageData);\n\n}\n\n// Cancel reply mode\nfunction cancelReply(replyBox) {\n  console.log('Cancel reply', replyBox);\n  console.log('aimReplyBox', replyBox);\n  if (replyBox) {\n\n    // clear out the .aim-replyto input value\n    const replyInput = replyBox.closest('.chatWindow').querySelector('input[name=\"message_replyto\"]');\n    if (replyInput) {\n      replyInput.value = '';\n    } else {\n      console.error('No reply input found');\n    }\n\n    replyBox.remove();\n    this.activeReplyBox = null;\n    this.bp.ignoreUIControlKeys = false;\n    this.bp.replyData = null;\n  }\n\n  console.log('Reply cancelled');\n}\n\nfunction bindProfilePictureClick() {\n\n  document.addEventListener('click', (event) => {\n    let target = event.target;\n    // if target is svg and parent has class aim-profile-picture\n    // console.log(' bindProfilePictureClick target', target, target.tagName);\n    if ($(target).parents().hasClass('aim-profile-picture')) {\n      //if (target.classList.contains('.aim-avatar')) {\n      const chatMessageElement = target.closest('.aim-chat-message')\n      if (!chatMessageElement) {\n        // console.error('No chat message element found');\n        return;\n      }\n      let buddyname = chatMessageElement.getAttribute('data-from');\n      console.log('Profile picture clicked', buddyname);\n\n      if (buddyname === this.bp.me) {\n        // opens profile edit page\n        this.bp.open('profile', { context: 'edit' });\n      } else {\n        // opens profile page\n        // this.bp.emit('profile::view', buddyname);\n        this.bp.open('user-profile', { context: buddyname });\n\n      }\n\n    }\n  });\n\n}","export default function registerEventHandlers() {\n    // console.log('BuddyList registerEventHandlers');\n    this.bp.on('auth::qtoken', 'handle-auth-success', qtoken => this.handleAuthSuccess(qtoken));\n\n    // On auth success, load user specific apps ( TODO: should pull from DB )\n    this.bp.on('auth::qtoken', 'load-user-apps', qtoken => this.loadUserApps());\n\n    // Generate default profile files ( TODO: don't run this each time, keep track on profile state if users generated default profile )\n    this.bp.on('auth::qtoken', 'generate-default-profile-files', qtoken => {\n        // give the app a moment to load messages and open windows before generating default profile\n        // TODO: we could do this server-side instead\n        setTimeout(() => {\n            try {\n                // alert('Generating default profile files');\n                this.generateDefaultProfile(qtoken)\n\n            } catch (err) {\n                console.error('generate-default-profile-files', err);\n            }\n        }, 6000);\n\n    });\n\n    this.bp.on('buddylist-websocket::connected', 'update-buddylist-connected', ws => {\n        // sets buddylist status to online\n        $('.onlineStatusSelect').val('online');\n        $('.loggedOut').flexHide();\n        $('.loggedIn').flexShow();\n\n        this.bp.apps.buddylist.client.wsClient.send(JSON.stringify({\n            action: 'getCoinBalance',\n            buddyname: this.bp.me,\n            qtokenid: this.bp.qtokenid,\n        }));\n\n        //$('.loggedIn').addClass('show');\n    });\n\n    // Remark: This has been removed in favor of letting windows manage their own state\n    // If the buddylist emits newMessages: true for a buddy, the window will open automatically calling getMessages\n    //this.bp.on('client::websocketConnected', 'get-latest-messages', ws => this.getLatestMessages());\n\n    // Removed: 9/17/2025, this appears to be legacy for V3 API ( before CF edge workers )\n    // this.bp.on('profile::buddylist', 'process-buddylist', ev => this.processBuddylist(ev.data));\n\n    this.bp.on('profile::buddy::in', 'render-or-update-buddy-in-buddylist', data => this.renderOrUpdateBuddyInBuddyList(data));\n    this.bp.on('profile::buddy::out', 'remove-buddy-from-buddylist', data => {\n        console.log('profile::buddy::out', data);\n        const buddyName = data.name;\n        let buddyListItem = $(`li[data-buddy=\"${buddyName}\"]`, '.buddylist');\n        console.log('buddyListItem', buddyListItem);\n        buddyListItem.remove();\n    });\n\n    this.bp.on('profile::fullBuddyList', 'render-or-update-buddy-in-buddylist', data => {\n        let buddylist = data.buddylist || {};\n\n        // Legacy API support\n        // check if buddylist is an array, if so convert to object\n        if (Array.isArray(buddylist)) {\n            buddylist = buddylist.reduce((acc, buddy) => {\n                acc[buddy.buddy_id] = buddy;\n                return acc;\n            }, {});\n        }\n\n        // console.log('profile::buddy::full_profile', buddylist);\n        for (let b in buddylist) {\n            let buddy = {\n                name: b,\n                profile: buddylist[b]\n            }\n            this.data.profileState = this.data.profileState || {};\n            this.data.profileState.buddylist = this.data.profileState.buddylist || {};\n\n            this.data.profileState.buddylist[b] = buddy.profile;\n            // console.log('renderOrUpdateBuddyInBuddyList', buddy);\n            // this.renderOrUpdateBuddyInBuddyList(buddy);\n        }\n\n        if (buddylist[this.bp.me]) {\n            // for now...needs to change shape of server response to include root fields?\n            if (buddylist[this.bp.me].profile_picture) {\n                // console.log('setting profilePicture', buddylist[this.bp.me].profile_picture);\n                this.data.profileState.profilePicture = buddylist[this.bp.me].profile_picture;\n            }\n            if (buddylist[this.bp.me].status) {\n                // console.log('setting status', buddylist[this.bp.me].status);\n                this.data.profileState.status = buddylist[this.bp.me].status;\n            }\n        }\n\n        if (data.email) {\n            this.data.profileState.email = data.email;\n            // update the email input field\n            $('.buddy_email').val(data.email);\n        }\n\n        if (typeof data.emailVerified === 'boolean') {\n            this.data.profileState.emailVerified = data.emailVerified;\n            // update the email verified checkbox\n            // $('.buddy_email_verified').prop('checked', data.emailVerified);\n            if (data.emailVerified) {\n                $('.buddy_email_verified_text').html('Email Verified');\n            } else {\n                $('.buddy_email_verified_text').html('Email Not Verified');\n            }\n        }\n\n        // iterate through all buddies and call renderOrUpdateBuddyInBuddylist\n\n    });\n\n\n\n\n    // Remark: removing buddy-in sound because Marak account is friends without everyone is is constantly triggering the sound\n    // We'll have to be smarter about when to play sounds and limit the amount of BUDDY-IN a single buddy can trigger\n    // total amount of buddy-in sounds per time window ( in case of 100s of buddies, etc )\n    // this.bp.on('profile::buddy::in', 'play-buddy-in-sound', data => bp.play('desktop/assets/audio/BUDDY-IN.wav'));\n\n    // Remark: buddy-out sound disabled until new client connection logic with backend is fully tested \n    //         ( was triggering too many sounds too often )\n    //this.bp.on('profile::buddy::out', 'play-buddy-out-sound', data => bp.play('desktop/assets/audio/BUDDY-OUT.wav'));\n    this.bp.on('buddy::message::processed', 'play-im-sound', data => {\n        if (data.noAlert) {\n            // don't play sound if noAlert is set by server\n            return;\n        }\n        // only play sounds for recent messages\n        let messageTime = new Date(data.ctime);\n        let now = new Date().getTime();\n        //console.log(\"messageTime\", messageTime);\n        //console.log(\"now\", new Date());\n        if (now - messageTime.getTime() < 5000) {\n            bp.play('desktop/assets/audio/IM.wav');\n        }\n    });\n\n    this.bp.on('profile::buddy::newmessage', 'open-chat-window', data => {\n        // open the new chat window only if not already open\n        let windowId = `messages/` + data.name;\n        let win = this.bp.apps.ui.windowManager.getWindow(windowId);\n        if (!win) {\n            this.openChatWindow(data)\n        }\n    });\n\n    // Remark: Not used? Should be added?\n    this.bp.on('profile::buddy::newmessage', 'mark-messages-as-read', data => this.buddyReadNewMessages(data));\n\n    this.bp.on('profile::buddy::calling', 'start-call', data => {\n        // legacy BP API\n        // console.log(\"profile::buddy::calling\", data);\n        desktop.app.videochat.startCall(false, data.name, function (err, re) {\n            console.log('startCall callback', err, re);\n        });\n    });\n\n    // buddylist should not respond to auth::logout \n    // this.bp.on('auth::logout', 'logout', () => this.logout());\n\n    this.bp.on('profile::status', 'update-profile-status', status => {\n        this.buddyServerClient.setStatus(this.bp.me, { status }, (err, re) => {\n            if (err) {\n                console.error('error setting status', err);\n            }\n            // console.log('setStatus', err, re);\n\n            if (status === 'signout') {\n              this.logout()\n            }\n        });\n        /*\n        buddypond.setStatus(this.bp.me, { status }, function(err, re){\n            // console.log('errrrr', err, re);\n        });\n        */\n\n    });\n\n    this.bp.on('buddy::messages', 'render-chat-message', data => this.handleChatMessages(data));\n    this.bp.on('buddy::sendMessage', 'send-buddy-message-to-server', data => this.sendMessageToServer(data));\n    // this.bp.on('pond::sendMessage', 'send-pond-message-to-server', data => this.sendPondMessageToServer(data));\n\n    //this.bp.on('buddy::sendMessage', 'process-buddymessage-bs', data => this.bp.apps.buddyscript.parseCommand(data.text));\n    //this.bp.on('pond::sendMessage', 'process-pondmessage-bs', data => this.bp.apps.buddyscript.parseCommand(data.text));\n\n    // remote isTyping event from server\n    // TODO: move to separate file\n    this.bp.on(\"buddy::isTyping\", \"show-is-typing-message\", message => {\n        // console.log('show-is-typing-message', message);\n        // TODO: move to separate file\n        // TODO: move this to a separate file / function\n        // Handling typing message display\n        if (message.isTyping === true) {\n            // check to see if message.from is the same as the current user\n            // if so, ignore the message\n            if (message.from === this.bp.me) {\n                return;\n            }\n\n            // check the ctime of the message\n            // console.log(\"isTyping message\", message);\n            let messageTime = new Date(message.ctime);\n            // console.log(\"messageTime\", messageTime.getTime());\n            let now = new Date().getTime();\n            let windowId;\n            if (message.type === 'buddy') {\n                if (message.to === this.bp.me) {\n                    windowId = `messages/${message.from}`;\n                } else {\n                    windowId = `messages/${message.to}`;\n                }\n            }\n\n            if (message.type === 'pond') {\n                // windowId = `pond_message_-${message.to}`;\n                windowId = 'pond-chat';\n            }\n\n            let chatWindow = this.bp.apps.ui.windowManager.getWindow(windowId);\n            // don't process isTyping messages over 3 seconds old\n            if (now - messageTime.getTime() > 3000) {\n                // console.log(\"isTyping message too old\", message);\n                // return;\n            }\n\n            // console.log('typing message', message);\n\n            let typingIndicatorId = `typing-${message.from}`;\n            let typingMessage = `${message.from} is typing...`;\n\n            if (message.type === 'pond') {\n                // we need to determine if the current open pond aim-messages-container matches the message.to\n                if (chatWindow.currentActiveContext !== message.to) {\n                    console.log('pond chat window is not active for this pond', message.to);\n                    return;\n                }\n            }\n\n\n            // Check if the typing indicator for this user already exists\n            let typingIndicator = $(`.aim-typing span[data-user=\"${message.from}\"]`, chatWindow.content);\n            // console.log('typingIndicator', typingIndicator);\n            // console.log('typingMessage', typingMessage);\n            if (typingIndicator.length === 0) {\n                // If it does not exist, create a new span and append it to the .aim-typing area\n                typingIndicator = $('<span></span>')\n                    .attr('data-user', message.from)\n                    .text(typingMessage)\n                    .appendTo($('.aim-typing', chatWindow.content));\n            } else {\n                // If it exists, just update the text\n                typingIndicator.text(typingMessage);\n            }\n\n            // Clear any existing timeout for this user\n            // console.log(\"CLEARING OLD TIMER\")\n            if (this.showingIsTyping[typingIndicatorId]) {\n                clearTimeout(this.showingIsTyping[typingIndicatorId]);\n            }\n\n            // console.log(\"CREATING NEW TIMER\")\n            // Set a new timeout to remove the typing message after very short pause\n            // since there already is a delay from the server\n            let typingDuration = message.typingDuration || 500;\n            this.showingIsTyping[typingIndicatorId] = setTimeout(() => {\n                typingIndicator.remove();\n            }, typingDuration);\n            return;\n        }\n    })\n\n    // local typing event TOOD: better name\n    // when buddy is typing send a message to the ws server\n    this.bp.on('buddy::typing', 'send-typing-message-to-server', data => {\n        // we don't want to spam typing messages, so we will only send a message every 2 seconds\n        this.lastTypingMessage = this.lastTypingMessage || 0;\n        if (new Date().getTime() - this.lastTypingMessage < 2000) {\n            // return;\n        }\n        this.lastTypingMessage = new Date().getTime();\n        // console.log('buddy::typing', data);\n\n        let chatId = '';\n\n        if (data.type === 'buddy') {\n            let buddyNames = [data.from, data.to].sort();\n            chatId = 'buddy/' + buddyNames.join('/');\n        }\n\n        if (data.type === 'pond') {\n            chatId = 'pond/' + data.to;\n        }\n\n        bp.apps.client.sendWsMessage(chatId, {\n            action: 'send',\n            chatId: chatId,\n            buddyname: buddypond.me,\n            qtokenid: buddypond.qtokenid,\n            message: {\n                ...data,\n                chatId,\n                isTyping: true\n            }\n        });\n        /*\n        if (data.type === 'pond') {\n            this.sendPondMessageToServer(data, false);\n        } else {\n            this.sendMessageToServer(data, false);\n        }\n        */\n        // this.bp.apps.client.sendMessage({ id: uuid(), method: 'sendMessage', data: data });\n\n\n    });\n\n    // TODO: this handler could instead bind to bp.apps.system.messages\n    // a System allows for sending and receiving messages to a sequence of handlers\n    /*\n    */\n    // the buddylist registers with the \"messages\" system\n    // in order to receive messages from other systems\n    /*\n    // this will get or create a system called \"messages\"\n    // the send and recieve handlers should get ordered in the order they are registered\n    // unless the order is specified, which should put the system in the correct order by number values and then undefined last\n    bp.apps.system.registerSystem('messages', {\n        registrant: 'buddylist',\n        send: {\n            // since send is missing name and handler, it will be ignored\n        },\n        receive: {\n            name: 'buddylist-processes-messages',\n            order: 2, // we can stack multiple systems in order\n            handler: (message) => {\n                console.log('buddylist-processes-messages', message);\n            }\n        }\n    });\n    // this event can be anywhere, doesn't have to be in the buddylist\n    // prob should be though :-D\n    // by sending the events to the messages system, they will \n    // go through the processing chain ( if any exists for that system )\n    // and then we recieved via the receive handler\n    this.bp.on(\n        'buddy::messages',\n        'send-messages-to-messages-system',\n        data => this.bp.apps.systems.messages.send({\n            name: 'buddylist-processes-messages',\n            data: data\n    }));\n   // example of another app which filters messages\n\n    bp.apps.system.registerSystem('messages', {\n        registrant: 'shorten-text',\n        send: {\n            // since send is missing name and handler, it will be ignored\n        },\n        receive: {\n            name: 'shorten-text',\n            order: 1, // we can stack multiple systems in order\n            handler: (message) => {\n                console.log('shorten text', message);\n                return message.text.substr(0, 1);\n            }\n        }\n    });\n    */\n    this.bp.on('buddylist-websocket::reward', 'update-local-coin-balance', data => {\n        // TODO: move this into rewards app\n        //$('#menu-bar-coin-balance').text(data.message.newBalance);\n        if (!data.success) {\n            console.log(data.message);\n            return;\n        }\n        rollToNumber($('#menu-bar-coin-balance'), data.message.newBalance)\n\n        // TODO: better condition to check if portfolio app is loaded and ready\n        if (this.bp.apps.portfolio && this.bp.apps.portfolio.portfolioWindow && this.bp.apps.portfolio.portfolioWindow.content && this.bp.apps.portfolio.portfolioData) {\n\n            this.bp.apps.portfolio.updateCoinRow(data.message.symbol, {\n                symbol: data.message.symbol,\n                amount: data.message.newBalance,\n                available: data.message.newBalance,\n                price: 0.001,\n                cost: 0.001 * data.message.newBalance\n            });\n\n            let coinSendSelector = $('#coin-send-name');\n            let coinSendBalance = $('#current-balance');\n\n            // if coinSendSelector value is \"GBP\"\n            if (coinSendSelector.val() === 'GBP') {\n                // set the coin balance to the new balance\n                // window.rollToNumber(coinSendBalance, data.message.newBalance)\n                const formattedValue = data.message.newBalance.toLocaleString('en-US');\n\n                coinSendBalance.text(formattedValue);\n            }\n        }\n    });\n\n    this.bp.on('buddylist-websocket::coinBalance', 'update-local-coin-balance', async (data) => {\n        console.log('buddylist-websocket::coinBalance', data);\n        if (typeof data.message.balance === 'number') {\n            rollToNumber($('#menu-bar-coin-balance'), data.message.balance)\n        } else {\n            this.faucetAttempts++;\n            // should work on 1, adds safe guard in case service is down\n            // we don't want to spam the faucet service or getCoinBalance\n            if (this.faucetAttempts < 3) {\n                // request initial coin balance, null indicates no portfolio entry for GBP\n                // if no portfolio entry, request the default coin allocations\n                await this.requestDefaultCoinAllocations();\n                // make another request to get the coin balance\n                this.bp.apps.buddylist.client.wsClient.send(JSON.stringify({\n                    action: 'getCoinBalance',\n                    buddyname: this.bp.me,\n                    qtokenid: this.bp.qtokenid,\n                }));\n            } else {\n                console.warn('BuddyList: Too many faucet attempts, not requesting balance again this session');\n            }\n\n        }\n\n    })\n}\n\nfunction rollToNumber($el, value) {\n    // Format number with commas\n    const formattedValue = value.toLocaleString('en-US');\n    const digits = formattedValue.split('');\n\n    if (bp.isMobile()) {\n        $el.text(formattedValue);\n        return;\n    }\n\n    const existingDigits = $el.find('.odometer-digit');\n\n    // If digit count changed (new commas or digit length), rebuild fully\n    if (existingDigits.length !== digits.filter(d => d !== ',').length) {\n        $el.empty();\n        digits.forEach(d => {\n            if (d === ',') {\n                $el.append('<span class=\"odometer-comma\">,</span>');\n            } else {\n                const digitContainer = $('<div class=\"odometer-digit\"></div>');\n                const inner = $('<div class=\"odometer-digit-inner\"></div>');\n\n                for (let i = 0; i <= 9; i++) {\n                    inner.append(`<span>${i}</span>`);\n                }\n\n                digitContainer.append(inner);\n                $el.append(digitContainer);\n            }\n        });\n    }\n\n    // Animate each digit to its new position\n    let digitIndex = 0;\n    digits.forEach((d, index) => {\n        if (d === ',') return;\n\n        const digitContainer = $el.find('.odometer-digit').eq(digitIndex);\n        const inner = digitContainer.find('.odometer-digit-inner');\n\n        // Apply transition\n        inner.css({\n            'transition': 'transform 0.5s ease-in-out',\n            'transform': `translateY(-${d * 1}em)`\n        });\n\n        digitIndex++;\n    });\n}\n","import createWebSocketClient from './createWebSocketClient.js';\n\nexport default class Client {\n  constructor(bp, options = {}) {\n    this.bp = bp;\n    this.config = {\n      host: \"\",\n      api: \"\",\n    };\n\n    this.api = buddypond;\n\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 999999; // Set to a high number for unlimited attempts\n    this.maxBackoffDelay = 10000; // 10 seconds\n    this.isIntentionallyClosed = false; // Flag to track intentional closure\n\n    return this;\n  }\n}\n\nClient.prototype.connect = async function connectBuddyListWs() {\n  console.log(\"Connecting to BuddyList WebSocket...\");\n  this.wsClient = await this.createWebSocketClient();\n  console.log(\"Connected to BuddyList WebSocket!\");\n  // TODO: needs to return / await the connection event\n  // TODO: should emit buddylist::connected event ( not auth::qtokenid event )\n  this.bp.emit('buddylist::connected', this.wsClient);\n}\n\nClient.prototype.disconnect = async function disconnectBuddyListWs() {\n  console.log(\"Attempting disconnecting from BuddyList WebSocket...\");\n  if (this.wsClient) {\n    this.wsClient.closeConnection();\n    this.wsClient = null;\n    console.log(\"Disconnected from BuddyList WebSocket\");\n  } else {\n    console.log(\"No active WebSocket connection to disconnect\");\n  }\n}\n\nClient.prototype.addBuddy = async function addBuddy(buddyname, cb) {\n  console.log(\"NEW Calling addBuddy\", this, buddyname);\n\n  apiRequest('/buddylist/' + this.bp.me + '/add-buddy', 'POST', {\n    buddyname: buddyname\n  }, function (err, data) {\n    cb(err, data);\n  })\n}\n\nClient.prototype.receivedInstantMessage = async function receivedInstantMessage(buddyName, cb) {\n  this.wsClient.send(JSON.stringify({\n    action: \"receivedInstantMessage\",\n    buddyname: buddyName,\n  }));\n  cb(null);\n}\n\nClient.prototype.setStatus = async function setStatus(buddyName, update, cb = function noop () {}) {\n  alert('deprecated: Client.setStatus');\n  // use wsClient to send the status update\n  // console.log('calling setStatus', buddyName, update);\n  this.wsClient.send(JSON.stringify({\n    action: \"setStatus\",\n    buddyname: buddyName,\n    status: update.status,\n    profilePicture: update.profilePicture\n  }));\n  cb(null);\n};\n\nClient.prototype.createWebSocketClient = createWebSocketClient;\n\nfunction apiRequest(uri, method, data, cb) {\n  let url;\n\n  url = buddypond.endpoint + uri;\n\n  // console.log(\"making apiRequest\", url, method, data);\n\n  let headers = {\n    \"Accept\": \"application/json\",\n    \"Content-Type\": \"application/json; charset=utf-8\",\n    \"X-Me\": buddypond.me, // âœ… Include X-Me header for user identification\n  };\n\n  if (buddypond.qtokenid) {\n    headers[\"Authorization\"] = `Bearer ${buddypond.qtokenid}`; // âœ… Use Authorization header\n  }\n\n  let body = method === \"POST\" ? JSON.stringify(data) : undefined;\n\n  // Prepare fetch options\n  const options = {\n    method: method,\n    headers: headers,\n    body: body,\n    // credentials: \"include\",  // âœ… Allow CORS with cookies/auth headers\n  };\n\n  // Handling fetch timeout manually\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 sec timeout\n\n  buddypond.incrementPackets(\"packetsSent\");\n  let perf = { start: new Date() };\n  // console.log(\"apiRequest\", url, options);\n  fetch(url, { ...options, signal: controller.signal })\n    .then(response => {\n      clearTimeout(timeoutId);\n      if (!response.ok) {\n        // Parse JSON for non-2xx responses\n        return response.json().then(errorData => {\n          // Create a custom error with status and JSON data\n          const error = new Error(`HTTP ${response.status}: ${response.statusText}`);\n          error.status = response.status;\n          error.data = errorData; // Attach JSON payload\n          throw error;\n        });\n      }\n      return response.json();\n    })\n    .then(data => {\n      buddypond.incrementPackets(\"packetsReceived\");\n      perf.end = new Date();\n      buddypond.addPerfTime(perf);\n      cb(null, data);\n    })\n    .catch(error => {\n      let msg = \"Fetch connection error. Retrying shortly.\";\n      if (error.name === \"AbortError\") {\n        msg = \"Fetch request timeout\";\n      } else if (error.message.includes(\"Payload Too Large\")) {\n        msg = \"File upload was too large. Try a smaller file.\";\n      } else if (error.status === 400 && error.data) {\n        // Use the JSON payload from the 400 error\n        msg = error.data.error || error.data.message || \"Invalid input. Please try again.\";\n      } else {\n        msg = error.message;\n      }\n      console.error(\"âŒ API Request Failed:\", error);\n      cb(new Error(msg), error.data || null);\n    });\n}","// Remark: createWebSocketClient is a prototype method of Client, as Client.createWebSocketClient()\nexport default function createWebSocketClient(reconnect = false) {\n  // Track reconnect state\n  console.log('createWebSocketClient called, reconnect:', reconnect);\n   // If a socket already exists and is open/connecting, reuse it\n  if (this.wsClient && \n      (this.wsClient.readyState === WebSocket.OPEN || \n       this.wsClient.readyState === WebSocket.CONNECTING)) {\n    console.log(\"Reusing existing WebSocket client\");\n    return Promise.resolve(this.wsClient);\n  }\n\n  console.log(`Creating WebSocket client for buddylist`);\n  return new Promise((resolve, reject) => {\n    const wsClient = new WebSocket(\n      `${buddypond.buddyServerWsEndpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`\n    );\n\n    // Handle open event\n    const handleOpen = () => {\n      console.log('WebSocket connection opened to buddylist');\n      this.reconnectAttempts = 0; // Reset reconnect attempts\n\n      this.wsClient = wsClient; // Store the WebSocket instance\n\n      wsClient.send(\n        JSON.stringify({\n          action: 'getBuddyList',\n          buddyname: buddypond.me,\n          qtokenid: buddypond.qtokenid,\n        })\n      );\n\n      /* Remark: Removed as online status per connection should be set on the server side\n      // if (reconnect) {\n        wsClient.send(JSON.stringify({\n          action: \"setStatus\",\n          buddyname: buddypond.me,\n          status: 'online',\n        }));\n\n      // }\n      */\n\n      // alert('set initial status to offline');\n      // Emit connected event\n      bp.emit('buddylist-websocket::connected');\n\n      this.pingInterval = setInterval(() => {\n        if (wsClient.readyState === WebSocket.OPEN) {\n          // console.log('Sending ping to buddylist WebSocket');\n          // wsClient.send('ping'); // Matches server's setWebSocketAutoResponse(\"ping\", \"pong\")\n          // application level ping\n          wsClient.send(JSON.stringify({ action: 'ping' }) );\n\n        }\n      }, 25000);\n\n      resolve(wsClient); // Resolve with the WebSocket instance\n    };\n\n    // Handle message event\n    // TODO: move to a separate function\n    const handleMessage = (event) => {\n      if (event.data === 'pong') {\n        // console.log('Received pong from server');\n        return; // Ignore pong messages\n      }\n      try {\n        const parseData = JSON.parse(event.data);\n        // console.log('Got back from server:', parseData);\n        switch (parseData.action) {\n          case 'buddy_added':\n            console.log('buddy_added WebSocket message received:', parseData);\n            bp.emit('profile::buddy::in', {\n              name: parseData.buddyname,\n              profile: parseData.profile || { ctime: new Date().getTime(), dtime: 0 },\n            });\n            break;\n\n          case 'getRemoteProfiles':\n            // console.log('getRemoteProfiles message received:', parseData);\n            if (parseData.profile && parseData.profile.buddylist) {\n              bp.emit('profile::fullBuddyList', parseData.profile);\n            } else {\n              console.error('getProfile message received but no buddylist:', parseData);\n            }\n            break;\n\n          case 'getBuddyList':\n            // console.log('getBuddyList message received:', parseData.buddies);\n            if (parseData && parseData.buddies) {\n              bp.emit('profile::fullBuddyList', { buddylist: parseData.buddies });\n            } else {\n              console.error('getProfile message received but no buddylist:', parseData);\n            }\n            break\n\n          case 'getProfile':\n            // console.log('getProfile message received:', parseData);\n\n            if (parseData.profile && parseData.profile.buddylist) {\n              bp.emit('profile::fullBuddyList', parseData.profile);\n            } else {\n              console.error('getProfile message received but no buddylist:', parseData);\n            }\n            // TODO: after getting profile, create a new call that wil fetch all buddies DO's to get\n            // most updated state ( a reverse of setStatus() call )\n            // this will ensure we always get the most recent updates for all buddies in case our DO\n            // wasn't updated or missed an update or setStatus() truncation limit for users not recently active\n            // send a message now to getRemoteProfiles\n            console.log('Requesting remote profile backfill for all buddies');\n            // After getting the initial profile ( single DO state, quick load ),\n            // we can request remote profiles for all buddies\n            // This will fetch all buddies DO's and get their most recent state\n            // This is useful for getting the most recent updates for all buddies in case our DO\n            // wasn't updated or missed an update or setStatus() truncation limit for users not recently active\n            wsClient.send(\n              JSON.stringify({\n                action: 'getRemoteProfiles',\n                buddyname: buddypond.me,\n                qtokenid: buddypond.qtokenid,\n              })\n            );\n            break;\n          case 'pong':\n            // console.log('buddylist pong message received:', parseData);\n            break;\n          case 'buddy_removed':\n            // alert('buddy_removed WebSocket message received:', parseData);\n            console.log('buddy_removed WebSocket message received:', parseData);\n            this.bp.emit('profile::buddy::out', { name: parseData.buddyname });\n            break;\n          case 'rewards:response':\n            // console.log('rewards:response message received:', parseData);\n            if (parseData.success) {\n              bp.emit('buddylist-websocket::reward', {\n                success: true,\n                message: parseData.message,\n                reward: parseData.reward,\n              });\n\n            } else {\n              bp.emit('buddylist-websocket::reward', {\n                success: false,\n                message: parseData.message,\n              });\n            }\n            break;\n          default:\n            console.log('Last message:', event.data);\n            console.warn('Unknown action received:', parseData);\n            break;\n        }\n      } catch (error) {\n        console.log('Last message:', event.data);\n        console.error('Error parsing WebSocket message:', error);\n        bp.emit('buddylist-websocket::error', { error: 'Message parsing failed' });\n      }\n    };\n\n    // Handle close event\n    const handleClose = (event) => {\n      console.log('WebSocket connection closed to', 'buddylist', 'Code:', event.code, 'Reason:', event.reason);\n\n      clearInterval(this.pingInterval);\n\n      bp.emit('buddylist-websocket::disconnected', { code: event.code, reason: event.reason });\n\n      // Reconnect only if not intentionally closed\n      if (!this.isIntentionallyClosed && this.reconnectAttempts < this.maxReconnectAttempts) {\n        const delay = Math.min(\n          200 * Math.pow(2, this.reconnectAttempts) * (1 + 0.1 * Math.random()), // Exponential backoff with jitter\n          this.maxBackoffDelay\n        );\n        console.log(`Scheduling reconnect attempt ${this.reconnectAttempts + 1} for buddylist in ${delay}ms`);\n        setTimeout(async () => {\n          this.reconnectAttempts++;\n          bp.emit('buddylist-websocket::reconnecting', { attempt: this.reconnectAttempts });\n          try {\n            this.wsClient = await this.createWebSocketServerClient(true); // Attempt to reconnect\n            // Update event listeners to the new WebSocket instance\n          } catch (error) {\n            console.error('Reconnect failed:', error);\n          }\n        }, delay);\n      } else if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n        console.error(`Max reconnect attempts (${this.maxReconnectAttempts}) reached for buddylist. Giving up.`);\n        bp.emit('buddylist-websocket::reconnect_failed');\n      }\n    };\n\n    // Handle error event\n    const handleError = (event) => {\n      console.error('WebSocket error buddylist', event);\n      bp.emit('buddylist-websocket::error', { error: 'WebSocket error' });\n      // Reject the promise if connection hasn't opened yet\n      if (wsClient.readyState !== WebSocket.OPEN) {\n        reject(new Error('WebSocket connection failed'));\n      }\n      // Close to trigger reconnect logic in handleClose\n      wsClient.close(1000, 'Error occurred');\n    };\n\n    // Add event listeners\n    wsClient.addEventListener('open', handleOpen.bind(this));\n    wsClient.addEventListener('message', handleMessage.bind(this));\n    wsClient.addEventListener('close', handleClose.bind(this));\n    wsClient.addEventListener('error', handleError.bind(this));\n\n    // Method to intentionally close the WebSocket\n    wsClient.closeConnection = () => {\n      this.isIntentionallyClosed = true;\n      console.log(`Intentionally closing WebSocket for buddylist`);\n      wsClient.close(1000, 'Normal closure');\n      // Remove event listeners to prevent memory leaks\n      wsClient.removeEventListener('open', handleOpen);\n      wsClient.removeEventListener('message', handleMessage);\n      wsClient.removeEventListener('close', handleClose);\n      wsClient.removeEventListener('error', handleError);\n      bp.emit('buddylist-websocket::closed');\n    };\n  });\n}","// Remark: createWebSocketClient is a prototype method of Client, as Client.createWebSocketClient()\nexport default function createWebSocketClient(reconnect = false) {\n  // Track reconnect state\n  console.log('createWebSocketClient called, reconnect:', reconnect);\n   // If a socket already exists and is open/connecting, reuse it\n  if (this.wsClient && \n      (this.wsClient.readyState === WebSocket.OPEN || \n       this.wsClient.readyState === WebSocket.CONNECTING)) {\n    console.log(\"Reusing existing WebSocket client\");\n    return Promise.resolve(this.wsClient);\n  }\n\n  console.log(`Creating WebSocket client for buddylist`);\n  return new Promise((resolve, reject) => {\n    const wsClient = new WebSocket(\n      `${buddypond.buddylistWsEndpoint}?me=${buddypond.me}&qtokenid=${buddypond.qtokenid}`\n    );\n\n    // Handle open event\n    const handleOpen = () => {\n      console.log('WebSocket connection opened to buddylist');\n      this.reconnectAttempts = 0; // Reset reconnect attempts\n\n      this.wsClient = wsClient; // Store the WebSocket instance\n\n      wsClient.send(\n        JSON.stringify({\n          action: 'getProfile',\n          buddyname: buddypond.me,\n          qtokenid: buddypond.qtokenid,\n        })\n      );\n\n\n      // Removed 9/17/2025, no longer needed with use of ServerDO\n      /*\n      // getProfile is now serverClient.getBuddyList()\n      // Remark: We may add this back for use in getting user profile settings, not buddylist\n\n      // setStatus is now serverClient.setStatus()\n      if (reconnect) {\n        wsClient.send(JSON.stringify({\n          action: \"setStatus\",\n          buddyname: buddypond.me,\n          status: 'online',\n        }));\n\n      }\n      */\n\n      // Emit connected event\n      bp.emit('buddylist-websocket::connected');\n\n      this.pingInterval = setInterval(() => {\n        if (wsClient.readyState === WebSocket.OPEN) {\n          // console.log('Sending ping to buddylist WebSocket');\n          // wsClient.send('ping'); // Matches server's setWebSocketAutoResponse(\"ping\", \"pong\")\n          // application level ping\n          wsClient.send(JSON.stringify({ action: 'ping' }) );\n\n        }\n      }, 25000);\n\n      resolve(wsClient); // Resolve with the WebSocket instance\n    };\n\n    // Handle message event\n    // TODO: move to a separate function\n    const handleMessage = (event) => {\n      if (event.data === 'pong') {\n        // console.log('Received pong from server');\n        return; // Ignore pong messages\n      }\n      try {\n        const parseData = JSON.parse(event.data);\n        // console.log('Got back from server:', parseData);\n        switch (parseData.action) {\n          case 'buddy_added':\n            // console.log('buddy_added WebSocket message received:', parseData);\n            bp.emit('profile::buddy::in', {\n              name: parseData.buddyname,\n              profile: parseData.profile || { ctime: new Date().getTime(), dtime: 0 },\n            });\n            break;\n\n          case 'getRemoteProfiles':\n            // console.log('getRemoteProfiles message received:', parseData);\n            if (parseData.profile && parseData.profile.buddylist) {\n              bp.emit('profile::fullBuddyList', parseData.profile);\n            } else {\n              console.error('getProfile message received but no buddylist:', parseData);\n            }\n\n            break;\n          case 'getProfile':\n            // console.log('getProfile message received:', parseData);\n\n            if (parseData.profile && parseData.profile.buddylist) {\n              bp.emit('profile::fullBuddyList', parseData.profile);\n            } else {\n              console.error('getProfile message received but no buddylist:', parseData);\n            }\n            console.log('Requesting remote profile backfill for all buddies');\n            // Removed 9/17/2025, no longer needed with use of ServerDO\n            /*\n            wsClient.send(\n              JSON.stringify({\n                action: 'getRemoteProfiles',\n                buddyname: buddypond.me,\n                qtokenid: buddypond.qtokenid,\n              })\n            );\n            */\n            break;\n          case 'pong':\n            // console.log('buddylist pong message received:', parseData);\n            break;\n          case 'buddy_removed':\n            // alert('buddy_removed WebSocket message received:', parseData);\n            console.log('buddy_removed WebSocket message received:', parseData);\n            this.bp.emit('profile::buddy::out', { name: parseData.buddyname });\n            break;\n          case 'rewards:response':\n            // console.log('rewards:response message received:', parseData);\n            if (parseData.success) {\n              bp.emit('buddylist-websocket::reward', {\n                success: true,\n                message: parseData.message,\n                reward: parseData.reward,\n              });\n\n            } else {\n              bp.emit('buddylist-websocket::reward', {\n                success: false,\n                message: parseData.message,\n              });\n            }\n            break;\n          case 'getCoinBalance':\n            // console.log('getCoinBalance message received:', parseData);\n            if (parseData.success) {\n              bp.emit('buddylist-websocket::coinBalance', parseData);\n            } else {\n              bp.emit('buddylist-websocket::coinBalance', parseData);\n            }\n            break;\n          default:\n            console.log('Last message:', event.data);\n            console.warn('Unknown action received:', parseData);\n            break;\n        }\n      } catch (error) {\n        console.log('Last message:', event.data);\n        console.error('Error parsing WebSocket message:', error);\n        bp.emit('buddylist-websocket::error', { error: 'Message parsing failed' });\n      }\n    };\n\n    // Handle close event\n    const handleClose = (event) => {\n      console.log('WebSocket connection closed to', 'buddylist', 'Code:', event.code, 'Reason:', event.reason);\n\n      clearInterval(this.pingInterval);\n\n      bp.emit('buddylist-websocket::disconnected', { code: event.code, reason: event.reason });\n\n      // Reconnect only if not intentionally closed\n      if (!this.isIntentionallyClosed && this.reconnectAttempts < this.maxReconnectAttempts) {\n        const delay = Math.min(\n          200 * Math.pow(2, this.reconnectAttempts) * (1 + 0.1 * Math.random()), // Exponential backoff with jitter\n          this.maxBackoffDelay\n        );\n        console.log(`Scheduling reconnect attempt ${this.reconnectAttempts + 1} for buddylist in ${delay}ms`);\n        setTimeout(async () => {\n          this.reconnectAttempts++;\n          bp.emit('buddylist-websocket::reconnecting', { attempt: this.reconnectAttempts });\n          try {\n            this.wsClient = await this.createWebSocketClient(true); // Attempt to reconnect\n            // Update event listeners to the new WebSocket instance\n          } catch (error) {\n            console.error('Reconnect failed:', error);\n          }\n        }, delay);\n      } else if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n        console.error(`Max reconnect attempts (${this.maxReconnectAttempts}) reached for buddylist. Giving up.`);\n        bp.emit('buddylist-websocket::reconnect_failed');\n      }\n    };\n\n    // Handle error event\n    const handleError = (event) => {\n      console.error('WebSocket error buddylist', event);\n      bp.emit('buddylist-websocket::error', { error: 'WebSocket error' });\n      // Reject the promise if connection hasn't opened yet\n      if (wsClient.readyState !== WebSocket.OPEN) {\n        reject(new Error('WebSocket connection failed'));\n      }\n      // Close to trigger reconnect logic in handleClose\n      wsClient.close(1000, 'Error occurred');\n    };\n\n    // Add event listeners\n    wsClient.addEventListener('open', handleOpen.bind(this));\n    wsClient.addEventListener('message', handleMessage.bind(this));\n    wsClient.addEventListener('close', handleClose.bind(this));\n    wsClient.addEventListener('error', handleError.bind(this));\n\n    // Method to intentionally close the WebSocket\n    wsClient.closeConnection = () => {\n      this.isIntentionallyClosed = true;\n      console.log(`Intentionally closing WebSocket for buddylist`);\n      wsClient.close(1000, 'Normal closure');\n      // Remove event listeners to prevent memory leaks\n      wsClient.removeEventListener('open', handleOpen);\n      wsClient.removeEventListener('message', handleMessage);\n      wsClient.removeEventListener('close', handleClose);\n      wsClient.removeEventListener('error', handleError);\n      bp.emit('buddylist-websocket::closed');\n    };\n  });\n}","import createWebSocketServerClient from './createWebSocketServerClient.js';\n\nexport default class ServerClient {\n  constructor(bp, options = {}) {\n    this.bp = bp;\n    this.config = {\n      host: \"\",\n      api: \"\",\n    };\n\n    this.api = buddypond;\n\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 999999; // Set to a high number for unlimited attempts\n    this.maxBackoffDelay = 10000; // 10 seconds\n    this.isIntentionallyClosed = false; // Flag to track intentional closure\n\n    return this;\n  }\n}\n\nServerClient.prototype.connect = async function connectBuddyServerWs() {\n  console.log(\"Connecting to BuddyServer WebSocket...\");\n  this.wsServerClient = await this.createWebSocketServerClient();\n  console.log(\"Connected to BuddyServer WebSocket!\");\n  // TODO: needs to return / await the connection event\n  // TODO: should emit buddylist::connected event ( not auth::qtokenid event )\n  this.bp.emit('buddylist::connected', this.wsServerClient);\n}\n\nServerClient.prototype.disconnect = async function disconnectBuddyServerWs() {\n  console.log(\"Attempting disconnecting from BuddyServer WebSocket...\");\n  if (this.wsServerClient) {\n    this.wsServerClient.closeConnection();\n    this.wsServerClient = null;\n    console.log(\"Disconnected from BuddyServer WebSocket\");\n  } else {\n    console.log(\"No active WebSocket connection to disconnect\");\n  }\n}\n\nServerClient.prototype.addBuddy = async function addBuddy(buddyname, cb) {\n  console.log(\"NEW Calling addBuddy\", this, buddyname);\n\n  apiRequest('/buddylist/' + this.bp.me + '/add-buddy', 'POST', {\n    buddyname: buddyname\n  }, function (err, data) {\n    cb(err, data);\n  })\n}\n\nServerClient.prototype.receivedInstantMessage = async function receivedInstantMessage(buddyName, cb) {\n  console.log('ServerClient receivedInstantMessage', buddyName);\n  this.wsServerClient.send(JSON.stringify({\n    action: \"receivedInstantMessage\",\n    buddyname: buddyName,\n  }));\n  cb(null);\n}\n\nServerClient.prototype.setStatus = async function setStatus(buddyName, update, cb = function noop () {}) {\n  // use wsServerClient to send the status update\n  // console.log('calling setStatus', buddyName, update);\n  if (!this.wsServerClient) {\n    console.log('No WebSocket connection available for setStatus');\n    return cb(new Error('No WebSocket connection available'));\n  }\n  this.wsServerClient.send(JSON.stringify({\n    action: \"setStatus\",\n    buddyname: buddyName,\n    status: update.status,\n    profilePicture: update.profilePicture\n  }));\n  cb(null);\n};\n\nServerClient.prototype.createWebSocketServerClient = createWebSocketServerClient;\n\nfunction apiRequest(uri, method, data, cb) {\n  let url;\n\n  url = buddypond.buddyServerApiEndpoint + uri;\n\n  console.log(\"making apiRequest\", url, method, data);\n\n  let headers = {\n    \"Accept\": \"application/json\",\n    \"Content-Type\": \"application/json; charset=utf-8\",\n    \"X-Me\": buddypond.me, // âœ… Include X-Me header for user identification\n  };\n\n  if (buddypond.qtokenid) {\n    headers[\"Authorization\"] = `Bearer ${buddypond.qtokenid}`; // âœ… Use Authorization header\n  }\n\n  let body = method === \"POST\" ? JSON.stringify(data) : undefined;\n\n  // Prepare fetch options\n  const options = {\n    method: method,\n    headers: headers,\n    body: body,\n    // credentials: \"include\",  // âœ… Allow CORS with cookies/auth headers\n  };\n\n  // Handling fetch timeout manually\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 sec timeout\n\n  buddypond.incrementPackets(\"packetsSent\");\n  let perf = { start: new Date() };\n  // console.log(\"apiRequest\", url, options);\n  fetch(url, { ...options, signal: controller.signal })\n    .then(response => {\n      clearTimeout(timeoutId);\n      if (!response.ok) {\n        // Parse JSON for non-2xx responses\n        return response.json().then(errorData => {\n          // Create a custom error with status and JSON data\n          const error = new Error(`HTTP ${response.status}: ${response.statusText}`);\n          error.status = response.status;\n          error.data = errorData; // Attach JSON payload\n          throw error;\n        });\n      }\n      return response.json();\n    })\n    .then(data => {\n      buddypond.incrementPackets(\"packetsReceived\");\n      perf.end = new Date();\n      buddypond.addPerfTime(perf);\n      cb(null, data);\n    })\n    .catch(error => {\n      let msg = \"Fetch connection error. Retrying shortly.\";\n      if (error.name === \"AbortError\") {\n        msg = \"Fetch request timeout\";\n      } else if (error.message.includes(\"Payload Too Large\")) {\n        msg = \"File upload was too large. Try a smaller file.\";\n      } else if (error.status === 400 && error.data) {\n        // Use the JSON payload from the 400 error\n        msg = error.data.error || error.data.message || \"Invalid input. Please try again.\";\n      } else {\n        msg = error.message;\n      }\n      console.error(\"âŒ API Request Failed:\", error);\n      cb(new Error(msg), error.data || null);\n    });\n}\n\nServerClient.prototype.createWebSocketServerClient = createWebSocketServerClient;","// TODO: decouple Buddylist class from Message Class\n// TODO: formalize Message class\n// Removed: 9/17/2025, this appears to be legacy for V3 API ( before CF edge workers )\n// import processBuddylist from \"./lib/processProfile.js\";\nimport renderOrUpdateBuddyInBuddyList from \"./lib/renderOrUpdateBuddyInBuddyList.js\";\nimport createChatMessageElement from \"./lib/message/createChatMessageElement.js\";\nimport renderChatMessage from \"./lib/message/renderChatMessage.js\";\nimport renderBuddyRequests from \"./lib/renderBuddyRequests.js\";\nimport buddylistUIEvents from \"./lib/buddylistUIEvents.js\";\nimport openChatWindow from \"./lib/openChatWindow.js\";\nimport generateDefaultProfile from \"./lib/generateDefaultProfile.js\";\nimport requestDefaultCoinAllocations from \"./lib/requestDefaultCoinAllocations.js\";\nimport defaultChatWindowButtons from \"./lib/defaultChatWindowButtons.js\";\nimport sortBuddyList from \"./lib/sortBuddyList.js\";\n// buddylist context menu\nimport showContextMenu from \"./lib/showContextMenu.js\";\n// chat message context menu\nimport bindMessageContextMenu from \"./lib/message/bindMessageContextMenu.js\";\nimport createMessageContextMenu from \"./lib/message/createMessageContextMenu.js\";\nimport loadUserApps from \"./lib/loadUserApps.js\";\n\nimport sendMessageHandler from \"./lib/message/sendMessageHandler.js\";\nimport showCard from \"./lib/message/showCard.js\";\nimport scrollToBottom from \"./lib/message/scrollToBottom.js\";\nimport forbiddenNotes from \"./lib/forbiddenNotes.js\";\n\nimport registerEventHandlers from \"./lib/registerEventHandlers.js\";\nimport createBuddyListWindow from \"./lib/createBuddyListWindow.js\";\nimport logout from \"./lib/logout.js\";\n\nimport defaultAvatarSvg from \"./lib/buddy/defaultAvatarSvg.js\";\n\n// new ws api\nimport Client from './lib/ws/Client.js';\nimport BuddyServerClient from './lib/ws/server/ServerClient.js';\n\n// TODO: why does client care about making UUID at all?\n// this is the responsibility of the server\n// TODO: remove uuid(), is most likely used for local render of message before server confirms ( which is removed atm )\nfunction uuid() {\n    return new Date().getTime();\n}\n\nexport default class BuddyList {\n    constructor(bp, options = {}) {\n        this.bp = bp;\n        this.data = {\n            processedMessages: {},\n            profileState: {\n                me: null,\n                status: null, // are these used?\n                profilePicture: null, // are these used?\n                updates: {}\n            },\n            avatarCache: new Map()\n        };\n\n        this.defaultPond = 'Buddy';\n        this.subscribedBuddies = [];\n        this.subscribedPonds = [];\n        this.options = options;\n\n        // ensures autocomplete options are always used regardless of entry\n        if (bp.apps.buddyscript && bp.apps.buddyscript.commands) {\n            this.options.autocomplete = bp.apps.buddyscript.commands;\n        }\n\n        this.showedHelp = false;\n\n        // alias global logout to the buddylist logout\n        // buddylist logout will handle both buddylist and message logout\n        this.bp.logout = this.logout.bind(this);\n\n        // pull in the default button\n        this.options.chatWindowButtons = this.options.chatWindowButtons || defaultChatWindowButtons(this.bp);\n\n        // add any active buttons that have been added in this session\n        // add the this.bp.apps.desktop.enabledChatWindowButtons array to this.options.chatWindowButtons\n\n        let enabledChatWindowButtons = true;\n        if (this.bp.apps.desktop && typeof this.bp.apps.desktop.enabledChatWindowButtons === 'boolean') {\n            enabledChatWindowButtons = this.bp.apps.desktop.enabledChatWindowButtons;\n        }\n        // iterate through each button and fetch the appList data.chatButton data ( hydrate the button )\n        if (enabledChatWindowButtons && Array.isArray(enabledChatWindowButtons)) {\n            enabledChatWindowButtons.forEach(buttonMeta => {\n                let app = this.bp.apps.list[buttonMeta.name];\n                if (app && app.chatButton) {\n                    this.options.chatWindowButtons.push(app.chatButton);\n                }\n            });\n        }\n\n        this.opened = false;\n        this.showingIsTyping = this.showingIsTyping || {};\n        this.activeMessageContextMenu = null;\n        this.faucetAttempts = 0;\n\n    }\n\n    async init() {\n        // Add event when user closes browser window or navigates away\n        window.addEventListener('beforeunload', (event) => {\n            if (this.buddyServerClient) {\n                this.buddyServerClient.setStatus(this.bp.me, {\n                    status: 'offline'\n                }, function (err, re) {\n                    console.log('buddypond.setStatus', err, re);\n                });\n\n            }\n        });\n\n        await Promise.all([\n            this.bp.vendor.dicebear = await this.bp.importModule('/v5/apps/based/buddylist/vendor/dicebear.core.js', {}, false),\n            this.bp.vendor.dicebearAvatars = await this.bp.importModule('/v5/apps/based/buddylist/vendor/dicebear.identicon.js', {}, false),\n            await this.bp.appendScript('/v5/apps/based/buddylist/vendor/marked.min.js'),\n            await this.bp.appendScript('/v5/apps/based/buddylist/vendor/purify.min.js'),\n            await bp.load('emoji-picker'),\n            await bp.load('buddyscript'),\n            await bp.load('card'),\n            await bp.load('pond')\n        ]);\n\n        this.bindMessageContextMenu();\n        this.forbiddenNotes = forbiddenNotes;\n\n    }\n\n    async open(config = { type: 'buddylist-profile' }) {\n        // buddylist supports (2) window types for bp.open('buddylist, { type: 'buddylist-profile' })\n        // 'buddylist-profile' - the default buddylist window\n        // 'buddylist-chat' - a chat window\n        // console.log('BuddyList open config', config)\n\n        if (typeof config.type !== 'string') {\n            config.type = 'buddylist-profile';\n        }\n\n        if (config.openDefaultPond === true) {\n            this.openDefaultPond = true;\n        }\n\n        // check localStorage for buddylist.openDefaultPond\n        let localValue = bp.get('openPondChatRooms');\n\n        if (localValue === true || typeof localValue === 'undefined') {\n            this.openDefaultPond = true;\n        }\n\n        if (config.showPond === false) {\n            this.showPond = false;\n        }\n\n        if (config.type === 'buddylist-profile') {\n\n            // TODO: have the ability to close and re-open the buddylist gracefully\n            const htmlStr = await this.bp.fetchHTMLFragment('/v5/apps/based/buddylist/buddylist.html');\n            this.messageTemplateString = await this.bp.fetchHTMLFragment('/v5/apps/based/buddylist/message.html');\n            this.bp.appendCSS('/v5/apps/based/buddylist/buddylist.css');\n            this.bp.appendCSS('/v5/apps/based/buddylist/messages.css');\n\n            if (this.opened) {\n                // console.log('BuddyList already opened, focusing existing window');\n                if (!this.buddyListWindow) {\n                    const buddyListWindow = this.createBuddyListWindow();\n                    buddyListWindow.content.appendChild(this.createHTMLContent(htmlStr));\n                    this.buddyListWindow = buddyListWindow;\n                }\n                this.buddyListWindow.open();\n                this.bp.apps.ui.windowManager.focusWindow(this.buddyListWindow);\n                this.buddyListWindow.restore();\n                $('.loginForm input[name=\"username\"]').focus();\n                return 'buddylist already open';\n            }\n\n            this.opened = true;\n\n            // loads affirmations messages via the affirmations app\n            let affirmations = await this.bp.importModule('affirmations');\n\n            if (config.showBuddyList !== false) {\n                const buddyListWindow = this.createBuddyListWindow();\n                buddyListWindow.content.appendChild(this.createHTMLContent(htmlStr));\n                this.buddyListWindow = buddyListWindow;\n            }\n\n            if (this.eventsBound !== true) {\n                // TODO: it would be better if we unregister events on close\n                // and left this close to re-bind on open\n                this.registerEventHandlers();\n            }\n\n            this.buddylistUIEvents();\n\n            this.handleAuthentication();\n\n            this.eventsBound = true;\n\n\n            return 'hello buddyList';\n        }\n\n        // Remark: is this code still used? can we remove? handled by openChatWindow\n        // called from elsewhere?\n        if (config.type === 'pond') {\n            console.log('BuddyList open config.type is pond', config);\n            // the type of window is a chat window\n            // we *don't* need to re-render the buddylist-profile \n            this.openChatWindow(config);\n        }\n\n        if (config.type === 'chat' || config.type === 'buddy') {\n            // the type of window is a chat window\n            // we *don't* need to re-render the buddylist-profile \n            this.openChatWindow(config);\n        }\n\n    }\n\n    createHTMLContent(htmlStr) {\n        const html = document.createElement('div');\n        html.innerHTML = htmlStr;\n        $('.loginForm input[name=\"username\"]').focus();\n        return html;\n    }\n\n    getLatestMessages() {\n        // This can also be called when closing a chat window to let the server\n        // know we are no longer interested in messages from that buddy or pond\n        const data = {\n            buddyname: this.subscribedBuddies.join(','),\n            pondname: this.subscribedPonds.join(','),\n            me: this.bp.me\n        };\n        this.bp.apps.client.sendMessage({ id: uuid(), method: 'getMessages', data: data });\n    }\n\n    // Not used?\n    buddyReadNewMessages(data) {\n        this.bp.log(\"BuddyReadNewMessages\", data);\n        const buddyName = data.name;\n    }\n\n    async handleChatMessages(data) {\n        // console.log('handleChatMessages', data);\n        let windowsToUpdate = new Set();\n        for (const message of data.result.messages) {\n            try {\n                // check to see if we have newMessages in local profile for message.from\n                // if so, send buddypond.receiveInstantMessage(message.from)\n                // console.log('handleChatMessages message', message);\n                // console.log('this.data.profileState', this.data.profileState);\n                if (message.from && this.data.profileState && this.data.profileState.buddylist && this.data.profileState.buddylist[message.from] && this.data.profileState.buddylist[message.from].newMessages) {\n                    console.log(\"receivedInstantMessage receivedInstantMessage receivedInstantMessage\");\n                    // is this now replaced by clearBuddyNewMessages()?\n                    // may be redundant if clearBuddyNewMessages() is called on openChatWindow\n                    // although we may need to also acknowledge here in case message is received in existing window\n                    this.data.profileState.buddylist[message.from].newMessages = false;\n                    this.buddyServerClient.receivedInstantMessage(message.from, function (err, re) {\n                        console.log('receivedInstantMessage', err, re);\n                    });\n                }\n                // console.log('handleChatMessages message', message);\n                // return the chatWindow which the message was rendered in\n                let chatWindow = await this.renderChatMessage(message);\n                windowsToUpdate.add(chatWindow);\n\n            } catch (err) {\n                console.log('error rendering chat message', message, err)\n            }\n        }\n        for (const chatWindow of windowsToUpdate) {\n            if (chatWindow && chatWindow.content) {\n                this.scrollToBottom(chatWindow.content);\n            }\n        }\n        // show help card if local storage does not have the card shown\n        if (!this.showedHelp && this.bp.settings['viewed-help-card'] !== true && !this.bp.isMobile()) {\n            let chatWindow = windowsToUpdate.values().next().value;\n            if (chatWindow && chatWindow.type === 'pond') {\n                this.showCard({\n                    chatWindow,\n                    cardName: 'help'\n                });\n                // console.log('showing help card', chatWindow);\n                this.showedHelp = true;\n            }\n        }\n\n    }\n\n    sendMessageToServer(data, emitLocal = false) {\n        this.bp.log('buddy::sendMessage', data);\n        data.uuid = uuid();\n\n        if (data.text === '') {\n            console.log('will not sendMessageToServer: no text');\n            return;\n        }\n\n        // so confusing client.sendMessage....maybe should be sendWorkerMessage...dunno\n        if (data.type === 'pond') {\n            console.log('sendMessageToServer', data);\n            buddypond.pondSendMessage(data.to, data.text, data, function (err, result) {\n                console.log('pondSendMessage', err, result)\n                console.log(err, result)\n            })\n\n        }\n        if (data.type === 'buddy') {\n            console.log('sendMessageToServer', data);\n            buddypond.sendMessage(data.to, data.text, data, function (err, result) {\n                console.log('pondSendMessage', err, result)\n                console.log(err, result)\n            });\n        }\n\n    }\n\n    // called on open to verify token ( if exists )\n    // signup / login logic is in buddylistUIEvents.js\n    handleAuthentication() {\n\n        if (this.bp.connected) {\n          // if we are already connected, do nothing\n          return; \n        }\n\n        const api = this.bp.apps.client.api;\n        const localToken = localStorage.getItem('qtokenid');\n        const me = localStorage.getItem('me');\n        if (!localToken) return;\n        // console.log('localToken', localToken, me);\n        api.verifyToken(me, localToken, (err, data) => {\n            if (err) {\n                console.error('Failed to verify token:', err);\n                $('.password').show();\n                $('.loginForm .error').text('Failed to authenticate buddy');\n                return;\n            }\n            console.log('verified token', data);\n            if (data.success) {\n                // A pre-existing token was found and verified, emit the auth event\n                this.bp.emit('auth::qtoken', { qtokenid: localToken, me: me, hasPassword: data.user.hasPassword });\n                $('.loggedIn').flexShow();\n                $('.loggedOut').flexHide();\n                if (window.discordView) {\n                    // minimize window\n                    this.buddyListWindow.minimize();\n                } else {\n                    if (!data.user.hasPassword) {\n                        this.bp.open('pincode');\n                    }\n                }\n            } else {\n                $('.loginForm .error').text('Failed to authenticate buddy');\n                $('.password').show();\n                console.error('Failed to authenticate buddy:');\n            }\n        });\n    }\n\n    // TODO: this event should only set the qtokenid and local settings?\n    // it could open the chat window?\n    // maybe also could connect to the websocket server for buddylist?\n    // opening the default window initializes the messages client\n    async handleAuthSuccess(qtoken) {\n        console.log('buddylist.handleAuthSuccess', qtoken);\n        this.bp.connected = true;\n        this.bp.me = qtoken.me;\n        this.bp.qtokenid = qtoken.qtokenid;\n        this.data.profileState = this.data.profileState || {};\n        this.data.profileState.me = this.bp.me;\n\n        $('#me_title').html('Welcome ' + this.bp.me);\n\n        // TODO: connect-to-websocket-server should happen here\n        // plays welcome message\n\n        if (!this.client) {\n            // this will eventually trigger the buddylist::connected event\n            try {\n                this.client = new this.Client(bp);\n                let connected = await this.client.connect();\n            } catch (err) {\n                console.error('Error connecting to BuddyList client:', err);\n            }\n        }\n\n        if (!this.buddyServerClient) {\n            this.bp.play('desktop/assets/audio/WELCOME.mp3', { tryHard: Infinity });\n            console.log('connecting to buddyserver client');\n            try {\n                this.buddyServerClient = new BuddyServerClient(bp);\n                let connected = await this.buddyServerClient.connect();\n                console.log('connected to buddyserver client', connected);\n            }\n            catch (err) {\n                console.error('Error connecting to BuddyServer client:', err);\n            }\n        }\n\n        if (!window.discordView) {\n            if (!qtoken.hasPassword) {\n                // if the user does not have a password, open the pincode window\n                this.bp.open('pincode');\n            }\n        }\n\n        // check if window.tempDiscordId has been set\n        // if so, this indicates user is attempting to link their Discord account\n        // and we first not logged in when clicking the link\n        // if this is the case, re-run window.linkDiscordAccount(window.tempDiscordId);\n        if (window.tempDiscordId) {\n            console.log('linking Discord account', window.tempDiscordId);\n            // link the Discord account\n            window.linkDiscordAccount(window.tempDiscordId);\n            // clear the tempDiscordId\n            window.tempDiscordId = null;\n        }\n\n        // wait until buddylist is connected and then opens default chat window if defined\n        if (this.defaultPond && this.openDefaultPond === true) {\n            setTimeout(() => {\n                // console.log('Opening default pond chat window', this.defaultPond);\n                let chatWindow = this.openChatWindow({ pondname: this.defaultPond });\n                if (window.discordView) {\n                    chatWindow.minimize();\n                }\n                // loads the hotpond client that populates room lists\n                bp.load('pond');\n            }, 100);\n        }\n\n    }\n}\n\nBuddyList.prototype.renderOrUpdateBuddyInBuddyList = renderOrUpdateBuddyInBuddyList;\nBuddyList.prototype.createChatMessageElement = createChatMessageElement;\nBuddyList.prototype.renderChatMessage = renderChatMessage;\nBuddyList.prototype.renderBuddyRequests = renderBuddyRequests;\n// BuddyList.prototype.processBuddylist = processBuddylist;\nBuddyList.prototype.buddylistUIEvents = buddylistUIEvents;\nBuddyList.prototype.openChatWindow = openChatWindow;\nBuddyList.prototype.generateDefaultProfile = generateDefaultProfile;\nBuddyList.prototype.requestDefaultCoinAllocations = requestDefaultCoinAllocations;\nBuddyList.prototype.sortBuddyList = sortBuddyList;\nBuddyList.prototype.showContextMenu = showContextMenu;\n\nBuddyList.prototype.createMessageContextMenu = createMessageContextMenu;\nBuddyList.prototype.bindMessageContextMenu = bindMessageContextMenu;\nBuddyList.prototype.loadUserApps = loadUserApps;\nBuddyList.prototype.sendMessageHandler = sendMessageHandler;\nBuddyList.prototype.showCard = showCard;\nBuddyList.prototype.scrollToBottom = scrollToBottom;\n\nBuddyList.prototype.defaultAvatarSvg = defaultAvatarSvg;\nBuddyList.prototype.registerEventHandlers = registerEventHandlers;\nBuddyList.prototype.createBuddyListWindow = createBuddyListWindow;\nBuddyList.prototype.logout = logout;\n\n// new API\nBuddyList.prototype.Client = Client;","export default function defaultChatWindowButtons(bp) {\n\n    return [\n        {\n            text: 'Upload File',\n            image: 'desktop/assets/images/icons/icon_upload_64.webp',\n            //icon: '<i title=\"Upload File\" class=\"button-bar-button-icon button-bar-button fa-duotone fa-regular fa-upload\"></i>',\n            onclick: async (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n\n                // Create a hidden file input dynamically\n                const fileInput = document.createElement('input');\n                fileInput.type = 'file';\n                fileInput.accept = '*/*'; // customize this if needed (e.g., 'image/*' or '.txt,.pdf')\n                fileInput.style.display = 'none';\n\n                // Append to DOM to make it usable\n                document.body.appendChild(fileInput);\n\n                // Listen for file selection\n                fileInput.addEventListener('change', async () => {\n                    const file = fileInput.files[0];\n                    console.log('Selected file:', file);\n                    if (file) {\n                        file.filePath = 'uploads/' + file.name; // Add filePath if needed\n                        try {\n                            // Optionally show a progress UI\n                            const onProgress = (percent) => {\n                                console.log(`Upload progress: ${percent}%`);\n                            };\n\n                            // Call your API method\n                            let result = await bp.apps.client.api.uploadFile(file, onProgress);\n                            // console.log('Upload successful', result);\n\n                            // send the message with the uploaded file\n                            let message = {\n                                from: bp.me,\n                                to: context,\n                                text: result,\n                                type: type || 'buddy'\n                            }\n                            // console.log('Sending message with uploaded file', message);\n                            bp.apps.client.api.sendCardMessage(message, function (err, response) {\n                                if (err) {\n                                    console.error('Error sending message', err);\n                                } else {\n                                    console.log('Message sent', response);\n                                }\n                            });\n                        } catch (err) {\n                            console.error('Upload failed:', err);\n                        }\n                    }\n\n                    // Clean up\n                    fileInput.remove();\n                });\n\n                // Trigger the file picker\n                fileInput.click();\n\n                return false;\n            }\n        },\n        {\n            text: 'Image Search',\n            image: 'desktop/assets/images/icons/icon_image-search_64.webp',\n            onclick: async (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                // Open the image search window\n                bp.open('image-search', {\n                    output: type || 'buddy',\n                    context: context,\n                    provider: 'giphy-stickers'\n                });\n                return false;\n            }\n        },\n\n        {\n            text: 'BuddySound',\n            image: 'desktop/assets/images/icons/icon_soundrecorder_64.webp',\n            onclick: (ev) => {\n                console.log('BuddySound button clicked', ev);\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                bp.open('soundrecorder', { type: type || 'buddy', output: type || 'buddy', context: context });\n\n            }\n        },\n        /* TOOD: add gifstudio back ( with better UX and features )\n        {\n            text: 'BuddyGif',\n            image: 'desktop/assets/images/icons/icon_gifstudio_64.webp',\n            onclick: (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                JQDX.openWindow('gifstudio', { type: type || 'buddy', context: context, output: type || 'buddy' });\n            }\n        },\n        */\n        {\n            text: 'BuddyPaint',\n            image: 'desktop/assets/images/icons/icon_drawing_64.webp',\n            children: [\n               {\n                  text: 'Chalkboard',\n                  image: 'desktop/assets/images/icons/icon_chalkboard_64.webp',\n                  onclick: (ev) => {\n                      let context = ev.target.dataset.context;\n                      let type = ev.target.dataset.type;\n                      bp.open('chalkboard', { type: type || 'buddy', output: type || 'buddy', context: context });\n                  }\n              },\n               {\n                  text: 'miniPaint',\n                  image: 'desktop/assets/images/icons/icon_minipaint_64.webp',\n                  onclick: (ev) => {\n                      let context = ev.target.dataset.context;\n                      let type = ev.target.dataset.type;\n                      bp.open('minipaint', { type: type || 'buddy', output: type || 'buddy', context: context });\n                  }\n              },\n              {\n                  text: 'Paint',\n                  image: 'desktop/assets/images/icons/icon_paint_64.webp',\n                  onclick: (ev) => {\n                      let context = ev.target.dataset.context;\n                      let type = ev.target.dataset.type;\n                      bp.open('paint', { type: type || 'buddy', output: type || 'buddy', context: context });\n                  }\n              },\n              {\n                  text: 'Painterro',\n                  image: 'desktop/assets/images/icons/icon_painterro_64.webp',\n                  onclick: (ev) => {\n                      let context = ev.target.dataset.context;\n                      let type = ev.target.dataset.type;\n                      bp.open('painterro', { type: type || 'buddy', output: type || 'buddy', context: context });\n                  }\n              }\n            ],\n        \n        },\n        {\n            text: 'BuddySnap',\n            env: 'desktop-only', // for now, use default mobile camera\n            image: 'desktop/assets/images/icons/svg/1f4f7.svg',\n            onclick: (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                // desktop.ui.openWindow('mirror', { type: type || 'buddy', context: context, output: type || 'buddy' });\n                bp.open('camera', { type: type || 'buddy', output: type || 'buddy', context: context });\n            }\n        },\n        {\n            text: 'BuddyEmoji',\n            image: 'desktop/assets/images/icons/svg/1f600.svg',\n            className: 'emojiPicker',\n            onclick: async (ev) => {\n\n                let $target = $(ev.target);\n                console.log('emoji button clicked');\n                $target.emojiPicker({\n                    onSelect: (emoji) => {\n                        console.log(\"Selected:\", emoji);\n                        let messageControls = $target.closest('.aim-message-controls');\n                        $('.aim-input', messageControls).val((i, val) => val + emoji).trigger('input').focus();\n                    }\n                });\n\n                // Immediately show the picker (bypasses internal click)\n                //$target.data('emojiPicker_show')?.();\n\n                // focus on .emoji-search input\n                if ($('.emoji-picker-popup').length > 0) {\n                    //$('.emoji-search').focus();\n                }\n                return;\n\n                // Replaced: Jun 17, 2025\n                // Legacy EmojiPicker code below, can be removed once we confirm new code above works well\n                // EmojiPicker lazy load is a special case\n                // All other BuddyPond deps / lazy imports with await bp.load() are fine to work as expected\n                // We usually don't need to check existence of the app before loading it\n                // For EmojiPicker we need to recall the original click event with same parameters\n                // This could be resolved by using a new EmojiPicker library or patching the current one\n                if (!bp.apps['emoji-picker']) { // this is not a normal practice for user in await bp.load()\n                    await bp.load('emoji-picker');\n                    // Create a new MouseEvent with the original event's coordinates\n                    const newEvent = new MouseEvent('click', {\n                        bubbles: true,\n                        cancelable: true,\n                        clientX: ev.clientX, // Preserve original x coordinate\n                        clientY: ev.clientY, // Preserve original y coordinate\n                        // Include other relevant properties if needed\n                        button: ev.button,\n                        target: ev.target\n                    });\n                    // Dispatch the new event on the original target\n                    ev.target.dispatchEvent(newEvent);\n                    return;\n                }\n                // now that the emoji-picker is loaded, we can open it as normal\n\n                // focus on the .emojiPicker input\n                $('.emojiPicker').focus();\n\n                // we need to add class activeTextArea to the active textarea\n                // so we can append the emoji to the correct textarea\n                // remove the activeTextArea from all other textareas\n                $('.activeTextArea').removeClass('activeTextArea');\n\n                let messageControls = $(ev.target).closest('.aim-message-controls');\n                // find the closest textarea to the ev.target\n                $('.aim-input', messageControls).addClass('activeTextArea');\n\n            }\n        },\n        {\n            text: 'BuddyCall',\n            type: 'buddy-only',\n            image: 'desktop/assets/images/icons/icon_phone_64.webp',\n            onclick: (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                // desktop.ui.openWindow('mirror', { type: type || 'buddy', context: context, output: type || 'buddy' });\n                bp.open('videochat', { type: type || 'buddy', output: type || 'buddy', context: context, isHost: true });\n\n                // should send message to buddy that will open the videocall window on receiving end\n                let message = {\n                    from: bp.me,\n                    to: context,\n                    text: 'Let\\'s have a video call',\n                    type: 'buddy',\n                    card: {\n                        type: 'videochat'\n                    }\n                }\n\n\n                console.log('BuddyCall message', message);\n                // send message to buddy\n                buddypond.sendCardMessage(message, function (err, response) {\n                    if (err) {\n                        console.error('Error sending message', err);\n                    } else {\n                        console.log('Message sent', response);\n                    }\n                });\n\n\n            }\n        },\n        // spellbook\n        {\n            text: 'Spellbook',\n            image: 'desktop/assets/images/icons/icon_spellbook_64.webp',\n            onclick: (ev) => {\n                ev.preventDefault();\n                ev.stopPropagation();\n\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                // desktop.ui.openWindow('spellbook', { type: type || 'buddy', context: context, output: type || 'buddy' });\n                bp.open('spellbook', { type: type || 'buddy', output: type || 'buddy', context: context });\n            }\n        },\n        // buddycoins\n        {\n            text: 'BuddyCoins',\n            image: 'desktop/assets/images/icons/icon_coin_64.webp',\n            onclick: (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                // desktop.ui.openWindow('coin', { type: type || 'buddy', context: context, output: type || 'buddy' });\n                bp.open('portfolio', { type: type || 'buddy', output: context, context: '#portfolio-transfer' });\n            }\n        },\n        /* // TODO: add Dictate with improved UX */\n        {\n            text: 'Dictate',\n            env: 'desktop-only',\n            image: 'desktop/assets/images/icons/icon_dictate_64.webp',\n            onclick: async (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                let targetEl = $('.aim-input', $(ev.target).parent().parent());\n                await bp.open('dictate', { type: type || 'buddy', output: type || 'buddy', context: context, targetEl: targetEl });\n            }\n        },\n        {\n            text: 'BuddyHelp',\n            image: 'desktop/assets/images/icons/icon_help_64.webp',\n            align: 'right',\n            onclick: (ev) => {\n                let context = ev.target.dataset.context;\n                let type = ev.target.dataset.type;\n                // TODO: better way to get the windowId\n                // TODO: instead just use context on the button, like how all the other buttons work\n                let windowIdPrefix = type === 'pond' ? 'pond_message_-' : 'messages/';\n                let windowId = windowIdPrefix + context;\n                if (type === 'pond') {\n                    windowId = 'pond-chat';\n                }\n                // console.log('opening chat window ', windowId)\n                let chatWindow = bp.apps.ui.windowManager.getWindow(windowId);\n                console.log('chatWindow', chatWindow);\n                // bp.apps.buddylist.showCard({ chatWindow, cardName: 'help' });\n\n                let aimInput = chatWindow.content.querySelector('.aim-input');\n                let sendButton = chatWindow.content.querySelector('.aim-send-btn');\n                if (aimInput) {\n                    aimInput.value = '/help';\n                    aimInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger input event\n                }\n                if (sendButton) {\n                    sendButton.click(); // Simulate button click\n                }\n\n\n\n\n            }\n        }\n    ]\n}","import forbiddenNotes from '../forbiddenNotes.js';\nimport checkForLinksInMessage from './checkForLinksInMessage.js';\n\nexport default async function renderChatMessage(message, _chatWindow) {\n    // console.log('renderChatMessage', message, _chatWindow);\n    // console.log('renderChatMessage', message, _chatWindow);\n    let context = 'default';\n\n    // profanity filter, now performed on the backend\n    /*\n    if (message.text && message.text.length > 0) {\n      message.text = forbiddenNotes.filter(message.text);\n    }\n    */\n\n    // TODO: needs to check for links inside the message, not just entire links\n    checkForLinksInMessage(message);\n\n    // if there is a #pondname in the message, add a pond card type\n    if (message.text && message.text.length > 0) {\n        let pondNames = findAllHashPondNames(message.text);\n        if (pondNames.length > 0) {\n            message.card = {\n                type: 'pond',\n                pondNames: pondNames\n            }\n        }\n    }\n\n    // Determine the window ID based on the message context\n    let windowId = `messages/${message.to}`;\n\n    // dynamically create the windowId based on the message details\n    if (message.type === 'buddy') {\n        if (message.to === this.bp.me) {\n            /*\n            // we need to check if message.from is not part of the buddy type chatId, could be a bot talking in the buddy chat\n            // this differs from pond chats, as its a third party in a two person chat\n            // the whole approach here is a bit awkward, but is required if we wish for bots to join buddy chat conversations\n            // check if message.from is not part of the chatId\n            let participants = message.chatId.split('/');\n            // remove the first item from the array\n            participants.shift();\n            // check if message.from is not inside the participants array\n            if (!participants.includes(message.from)) {\n              // this means a third party is sending a message in a buddy chat ( a bot most likely )\n              // we need to set the windowId to be the non-me participant\n              let notMe = participants.find(participant => participant !== this.bp.me);\n              // console.log('Setting windowId for non-me participant', notMe);\n              windowId = `messages/${notMe}`;\n              context = notMe;\n            } else {\n              // regular buddy conversation with (2) participants\n              windowId = `messages/${message.from}`;\n              context = message.from;\n            }\n            */\n            windowId = `messages/${message.from}`;\n            context = message.from;\n\n\n        } else {\n            windowId = `messages/${message.to}`;\n            context = message.to;\n        }\n    }\n\n    if (message.type === 'pond' || (message.chatId && message.chatId.startsWith('pond/'))) {\n        context = message.to;\n        // windowId = `pond_message_-${message.to}`;\n        windowId = 'pond-chat';\n    }\n\n    if (message.chatId.startsWith('buddy')) {\n        let parts = message.chatId.split('/');\n        let buddyname = parts[1];\n        if (buddyname === this.bp.me) {\n            buddyname = parts[2];\n        }\n        context = buddyname;\n        windowId = `messages/${buddyname}`;\n\n    }\n\n    // console.log('windowIdwindowId', windowId)\n    // TODO: scope on processedMessages needs to be keyed by type in addition to context\n    this.data.processedMessages[context] = this.data.processedMessages[context] || [];\n\n    // Stores all active users across all chat windows\n    this.data.activeUsers = this.data.activeUsers || [];\n\n    // Stores all buddies that are currently active in the context of the chat window\n    this.data.activeUsersInContext = this.data.activeUsersInContext || {};\n    this.data.activeUsersInContext[context] = this.data.activeUsersInContext[context] || [];\n\n    this.data.activePonds = this.data.activePonds || [];\n    if (message.type === 'pond') {\n        // If message.to is not in the activePonds, add it\n        if (message.to && !this.data.activePonds.includes(message.to)) {\n            this.data.activePonds.push(message.to);\n            this.bp.emit('pond::activePondAdded', message.to);\n        }\n    }\n\n    if (message.type === 'buddy') {\n        // If message.to is not in the activeUsers, add it\n        if (message.to && !this.data.activeUsers.includes(message.to)) {\n            this.data.activeUsers.push(message.to);\n            this.bp.emit('buddy::activeUserAdded', message.to);\n        }\n        // If message.to is not in the activeUsersInContext, add it\n        if (message.to && !this.data.activeUsersInContext[context].includes(message.to)) {\n            this.data.activeUsersInContext[context].push(message.to);\n        }\n    }\n\n    // If message.from is not in the activeUsers, add it\n    if (message.from && !this.data.activeUsers.includes(message.from)) {\n        this.data.activeUsers.push(message.from);\n        this.bp.emit('buddy::activeUserAdded', message.from);\n    }\n\n\n    // If message.from is not in the activeUsersInContext, add it\n    if (message.from && !this.data.activeUsersInContext[context].includes(message.from)) {\n        this.data.activeUsersInContext[context].push(message.from);\n    }\n\n    // Remark: Removing and editing messages do not currently require a windowId since they currently\n    // do not have a from / to property\n    // We may want to change this in the future to allow for more granular control directly in the chatWindow instance\n    if (message.removed) {\n        console.log(\"ATTEMPTING TO REMOVE MESSAGE\", message);\n        // find the chatMessage by uuid\n        let removedMessageEl = $(`.aim-chat-message[data-uuid=\"${message.removed}\"]`); // could be document as well?\n        if (removedMessageEl.length > 0) {\n            // remove the removed message\n            removedMessageEl.remove();\n        }\n        return chatWindow;\n    }\n\n    if (message.edited) {\n        console.log(\"ATTEMPTING TO EDIT MESSAGE\", message);\n        // find the chatMessage by uuid\n        let editedMessageEl = $(`.aim-chat-message[data-uuid=\"${message.edited}\"]`); // could be document as well?\n\n        if (!editedMessageEl.length > 0) {\n            console.error('No original message found');\n            return;\n        }\n\n        // get the aim-message-content and set the text to the new message\n        let editedMessageContent = editedMessageEl.find('.aim-message-content');\n        if (editedMessageContent.length > 0) {\n            // remove the edited message\n            editedMessageContent.html(message.text);\n        }\n        return chatWindow;\n    }\n\n    let scrollToBottom = false;\n    if (message.reacted) {\n        console.log(\"ATTEMPTING TO REACT TO MESSAGE\", message);\n        let reactedMessageEl = $(`.aim-chat-message[data-uuid=\"${message.reacted}\"]`); // could be document as well?\n        if (!reactedMessageEl.length > 0) {\n            console.error('No original message found for reaction', message);\n            // return chatWindow;\n        }\n\n\n        /*\n         // Message reactions\n    if (message.reactions) {\n      const reactionsContainer = document.createElement('div');\n      reactionsContainer.className = 'aim-message-reactions';\n      console.log('message.reactions', message.reactions);\n      message.reactions = JSON.parse(message.reactions);\n      for (let reaction in message.reactions) {\n        console.log('reaction', reaction, 'count', message.reactions[reaction]);\n        const count = message.reactions[reaction].count;\n        console.log('Rendering reaction:', reaction, count);\n        const reactionElement = document.createElement('span');\n        reactionElement.className = 'aim-message-reaction';\n        reactionElement.setAttribute('data-emoji', reaction);\n        reactionElement.innerHTML = `\n          <span class=\"aim-reaction-emoji\">${reaction}</span>\n          <span class=\"aim-reaction-count\">${count}</span>\n        `;\n        reactionsContainer.appendChild(reactionElement);\n      }\n    \n      messageContent.appendChild(reactionsContainer);\n      }*/\n        // find the .aim-message-reactions container inside the reactedMessageEl\n        let reactionsContainer = reactedMessageEl.find('.aim-message-reactions');\n        if (reactionsContainer.length === 0) {\n            // create the reactions container\n            reactionsContainer = $('<div class=\"aim-message-reactions\"></div>');\n            // append it to the .aim-message-content\n            reactedMessageEl.find('.aim-message-content').append(reactionsContainer);\n        }\n        // clear the reactions container\n        reactionsContainer.html('');\n        // add each reaction to the reactions container\n        for (let reaction in message.reactions) {\n            // console.log('reaction', reaction, 'count', message.reactions[reaction]);\n            const count = message.reactions[reaction].count;\n            // console.log('Rendering reaction:', reaction, count);\n            const reactionElement = $(`\n        <span class=\"aim-message-reaction\" data-emoji=\"${reaction}\">\n          <span class=\"aim-reaction-emoji\">${reaction}</span>\n          <span class=\"aim-reaction-count\">${count}</span>\n        </span>\n      `);\n\n            // add title property to reactionElement with .buddies who reacted\n            const buddies = message.reactions[reaction].buddies || [];\n            if (buddies.length > 0) {\n                $(reactionsContainer).attr('title', `Reacted by: ${buddies.join(', ')}`);\n            }\n\n            reactionsContainer.append(reactionElement);\n\n            // check if this is the last message in the chat window, if so scroll to bottom\n            if (reactedMessageEl.is(':last-child')) {\n                // scroll to bottom of chat window\n                console.log('last message reaction, scrolling to bottom');\n                scrollToBottom = true;\n                //let messagesContainer = $('.aim-messages-container', chatWindow.content);\n                //messagesContainer.scrollTop(messagesContainer[0].scrollHeight);\n            }\n\n        }\n        // return chatWindow;\n    }\n\n    // console.log('current windows', this.bp.windows);\n    // console.log('renderChatMessage windowId', windowId, message);\n    let chatWindow = this.bp.apps.ui.windowManager.getWindow(windowId);\n    //console.log('attemping to fetch chatWindow', windowId, chatWindow);\n    if (_chatWindow) {\n        chatWindow = _chatWindow;\n    }\n\n    if (!chatWindow || !chatWindow.content) {\n        console.log('chat window not ready, trying again soon', windowId, message);\n        console.log(message);\n        return;\n    }\n\n    if (scrollToBottom) {\n        // scroll to bottom of chat window\n        this.scrollToBottom(chatWindow.content);\n    }\n\n\n    // Check if message already exists in the DOM\n    if (document.querySelector(`.chatMessage[data-uuid=\"${message.uuid}\"]`)) {\n        return chatWindow; // Message is already rendered\n    }\n\n    // check to see if this command is less than 10 seconds old\n    // TODO: split local and remote commands\n    // TODO: should probably go through card codepath\n    // this means we create the bs-card on the client\n    // we should only run local commands on the client\n    let now = new Date().getTime();\n    let messageTime = new Date(message.ctime).getTime();\n    // needs to determine if this command should be run locally or remotely\n    // for now, only run locally\n    // check to see  if message.from is bp.me\n\n    // remove .aim-no-messages el from chat window if it exists\n    $('.aim-no-messages', chatWindow.content).remove();\n    // console.log('checking this.data.processedMessages[context]', this.data.processedMessages[context]);\n    // Check if message has been processed to avoid duplication\n    for (let i = 0; i < this.data.processedMessages[context].length; i++) {\n        if (this.data.processedMessages[context][i].uuid === message.uuid) {\n            // console.log('Message already processed, skipping rendering', message);\n            // if the message has already been processed by UUID, then it's a duplicate and we should not render it\n            return chatWindow;\n            // we have a special case here we wish to re-render the client message\n            // this indicates the server filtered parts of the message and it should be removed and re-rendered\n            if (this.data.processedMessages[context][i].from === this.bp.me && this.data.processedMessages[context][i].text !== message.text) {\n                // find the chatMessage by uuid\n                let filteredMessageEl = $(`.chatMessage[data-uuid=\"${message.uuid}\"]`, chatWindow.content);\n                if (filteredMessageEl.length > 0) {\n                    // remove the filtered message\n                    filteredMessageEl.remove();\n                    //this.bp.emit('buddy::message::gotfiltered', message);\n                }\n            } else {\n                // else there is no special filtering case from server\n                // and the messaged is a duplicate, return and do not render\n                return;\n            }\n        }\n    }\n\n    // Manage size of processedMessages to prevent memory leaks\n    if (this.data.processedMessages[context].length > 5000) {\n        this.data.processedMessages[context].shift();\n    }\n\n    // Add the processed message UUID to prevent reprocessing\n    this.data.processedMessages[context].push(message);\n\n    // check if this is an Agent message which gets processed first\n    if (message.type === 'agent') {\n\n        // Legacy BP API\n        if (desktop && desktop.app && desktop.app.spellbook && desktop.app.spellbook[message.text]) {\n            desktop.app.spellbook[message.text]();\n            return;\n        } else {\n            console.log('unknown agent message', message);\n        }\n    }\n\n    // TODO: allow buddylist to register message processors\n    // Is most likely best handled using SystemsManager from ECS code\n    // this way all app can register an update method\n    // we can give each app an onMessage method and have the ECS S delegate the message to the app\n    // bp.apps.buddylist.addMessageProcessor('buddyscript', function (message) {});\n    // bp.apps.buddylist.addMessageProcessor('card', function (message) {});\n    // etc\n    // this way we don't have to pollute the buddylist with all the message processing logic\n    // TODO: Migrate TTS app to v5 API\n\n    if (this.bp.apps.say && message.text && message.text.startsWith('/say')) {\n        // this is a /say message\n        this.bp.apps.say.processMessages(message);\n    }\n\n    // check if mobile, is so shorten the time\n    // legacy API\n    if (this.bp.isMobile()) {\n        messageTime = DateFormat.format.date(messageTime, 'hh:mm:ss a');\n    } else {\n        messageTime = DateFormat.format.date(messageTime, 'E MMMM dd, hh:mm:ss a');\n    }\n\n    // Format message time\n    messageTime = messageTime.toString();\n\n    // Check to see if message is type card\n\n    let container;\n    if (message.card && this.bp && this.bp.apps && this.bp.apps.card) {\n        //console.log('message is', message);\n        //console.log('message is card', message.card);\n\n        let cardData = message.card;\n        // console.log(\"USING CARD\", cardData, message);\n        // make sure card has props\n        if (Object.keys(cardData).length > 0) {\n            cardData.message = message; // TODO probably should clone for CardManager, etc\n            // default JSON rendering will now fail by default due to nested messages cards with arbitrary props ( no .data scope either ), .context might be good...\n            let cardManager = this.bp.apps.card.cardManager;\n            // console.log('cardManager.loadCard', cardData);\n            const _card = await cardManager.loadCard(cardData.type, cardData, chatWindow);\n            container = document.createElement('div');\n            container.classList.add('cardContainer');\n            let d = await _card.render(container);\n        }\n\n    }\n\n    let bp = this.bp;\n\n    this.createChatMessageElement(message, messageTime, chatWindow, container);\n\n    // emit the freshly processed message for any post processing events ( such as playing a sound )\n    if (message.type === 'pond') {\n        this.bp.emit('pond::message::processed', message);\n    } else {\n        this.bp.emit('buddy::message::processed', message);\n    }\n\n    return chatWindow;\n\n}\n\n// TODO: add via addMessageProcessor() on `marked` and `pond` apps\n\nfunction findAllHashPondNames(text) {\n    // Decode HTML entities more comprehensively\n    const decodedText = decodeEntities(text);\n    // Regex: # followed by at least one letter/digit, then optional letters/digits/underscores/hyphens\n    // Requires space or start of string before #, supports Unicode\n    const hashPondNameRegex = /(^|\\s)#([a-zA-Z0-9\\p{L}][a-zA-Z0-9\\p{L}_-]*)/gu;\n    return Array.from(decodedText.matchAll(hashPondNameRegex), m => m[2]);\n}\n\nfunction decodeEntities(text) {\n    const entities = {\n        '&amp;': '&',\n        '&quot;': '\"',\n        '&lt;': '<',\n        '&gt;': '>',\n        '&apos;': \"'\",\n        '&nbsp;': ' ',\n        // Add more as needed\n    };\n    return text.replace(/&[a-zA-Z0-9#]+;/g, match => entities[match] || match);\n}","export default function renderBuddyRequests (buddyrequests) {\n    //console.log(\"renderBuddyRequests\", buddyrequests);\n\n    $('.you_have_no_buddies').hide();\n    let api = this.bp.apps.client.api;\n\n    if (buddyrequests) {\n  \n      $('.pendingIncomingBuddyRequests').html('');\n      $('.pendingOutgoingBuddyRequests').html('');\n      $('.loading').remove();\n  \n      for (let buddy in buddyrequests) {\n        let buddyrequest = buddyrequests[buddy];\n        buddyrequest = JSON.parse(buddyrequest);\n        if (buddyrequest.to === this.bp.me) {\n          $('.pendingIncomingBuddyRequests').append('<li>' + buddyrequest.from + ' - <a href=\"#\" class=\"approveBuddyRequest pointer\" data-buddyname=\"' + buddyrequest.from +'\">Approve</a> / <a href=\"#\" class=\"denyBuddyRequest pointer\" data-buddyname=\"' + buddyrequest.from +'\">Remove</a> </li>');\n        } else {\n          $('.pendingOutgoingBuddyRequests').append('<li>' + buddyrequest.to + ' - <a href=\"#\" class=\"denyBuddyRequest pointer\" data-buddyname=\"' + buddyrequest.to +'\">Remove</a></li>');\n        }\n      }\n  \n      $('.apiResult').val(JSON.stringify(buddyrequests, true, 2));\n  \n      // desktop.app.buddylist.pendingIncomingBuddyRequests = desktop.app.buddylist.pendingIncomingBuddyRequests || 0;\n      this.data.pendingIncomingBuddyRequests = this.data.pendingIncomingBuddyRequests || 0;\n\n      let totalIncomingBuddyRequests = $('.pendingIncomingBuddyRequests li').length;\n  \n      if (totalIncomingBuddyRequests > this.data.pendingIncomingBuddyRequests) {\n        this.data.pendingIncomingBuddyRequests = totalIncomingBuddyRequests;\n  \n        // Remark: short delay is used here to provide nice login experience if Buddy has requests\n        //         allows WELCOME sound to play\n        //         A better solution here is to here priority option for playing sound with queue\n        setTimeout(function () {\n          // this.bp.apps.play('YOUVEGOTMAIL.wav'); // TODO add 'play' app\n        }, 2222);\n      }\n  \n      if (totalIncomingBuddyRequests === 0) {\n        $('.pendingIncomingBuddyRequestsHolder').hide();\n      } else {\n        $('.pendingIncomingBuddyRequestsHolder').show();\n      }\n  \n      if ($('.pendingOutgoingBuddyRequests li').length == 0) {\n        $('.pendingOutgoingBuddyRequestsHolder').hide();\n      } else {\n        $('.pendingOutgoingBuddyRequestsHolder').show();\n      }\n  \n      // TODO: remove links in real-time from client for approve / deny ( no lags or double clicks )\n      //  '.pendingIncomingBuddyRequests'\n      $('.denyBuddyRequest').on('click', function () {\n        $(this).parent().hide();\n        api.denyBuddy($(this).attr('data-buddyname'), function (err, data) {\n          $('.apiResult').val(JSON.stringify(data, true, 2));\n        });\n        return false;\n      });\n  \n      $('.approveBuddyRequest', '.pendingIncomingBuddyRequests').on('click', function () {\n        $(this).parent().hide();\n        let buddyName = $(this).attr('data-buddyname');\n        api.approveBuddy(buddyName, function (err, data) {\n          $('.apiResult').val(JSON.stringify(data, true, 2));\n        });\n        return false;\n      });\n    }\n  \n  }","export default function buddylistUIEvents() {\n  let api = this.bp.apps.client.api;\n  let affirmations = this.bp.apps.affirmations.affirmations;\n\n  // bind events\n  $('.loginForm').submit((e) => {\n    e.preventDefault();\n\n    // disable the login button\n    $('.loginButton').prop('disabled', true);\n    $('.loginButton').addClass('disabled');\n\n    let username = $('.loginForm input[name=\"username\"]').val();\n    let password = $('.loginForm input[name=\"password\"]').val();\n    if (!password) {\n      password = username;\n    }\n\n    api.authBuddy(username, password, function (err, result) {\n      console.log('authBuddy', err, result);\n      if (err) {\n        if (result && result.error) {\n          $('.loginStatus').html(result.error);\n          if (result.error === 'Incorrect password.') {\n            $('.resetPasswordLink').show();\n          }\n        } else {\n          if (err.message === 'Failed to fetch') {\n            $('.loginStatus').text('Failed to connect to Buddy Pond');\n          } else {\n            $('.loginStatus').html(err.message || 'Failed to authenticate buddy');\n          }\n        }\n        $('.loginButton').prop('disabled', false);\n        $('.loginButton').removeClass('disabled');\n\n        $('.password').show();\n        console.error('Failed to authenticate buddy:', err);\n\n        return;\n      }\n      if (result.success) {\n        // attempt to connect for events after getting auth token\n        //console.log('connecting with valid qtokenid', api.qtokenid);\n        result.me = username;\n        // The user has logged in password or signed up successfully, emit the auth event\n        bp.emit('auth::qtoken', result);\n        // $('.loggedIn').flexShow();\n        $('.loginForm .error').text('');\n\n      } else {\n        // re-enable the login button\n        $('.loginButton').prop('disabled', false);\n        $('.loginButton').removeClass('disabled');\n        if (username === password) {\n          $('.password').show();\n          $('.password').focus();\n          return;\n        }\n        $('.loginForm .error').text('Failed to authenticate buddy');\n        $('.password').show();\n        console.error('Failed to authenticate buddy:');\n      }\n    });\n    return false;\n  });\n\n  $('.onlineStatusSelect').change((e) => {\n    let status = $(e.target).val();\n    // console.log('status', status);\n    bp.emit('profile::status', status);\n  });\n\n  $('.openPondChatRooms').change((e) => {\n    let isChecked = $(e.target).is(':checked');\n    if (isChecked) {\n      let chatWindow = this.openChatWindow({ pondname: this.defaultPond });\n      bp.load('pond');\n    }\n    bp.set('openPondChatRooms', isChecked);\n  });\n\n  if (this.openDefaultPond) {\n    $('.openPondChatRooms').prop('checked', true);\n  }\n\n  $('.forgot-password').on('click', (ev) => {\n    $('.loginForm').flexHide();\n    $('.forgot-password-modal').flexShow();\n    $('.tos-checkbox').flexHide();\n    $('.loginStatus').html('');\n    $('.resetPasswordLink').flexHide();\n  });\n\n  $('.closeForgotPassword').on('click', (ev) => {\n    $('.forgot-password-modal').flexHide();\n    $('.loginForm').flexShow();\n    $('.tos-checkbox').flexShow();\n    $('.resetPasswordLink').flexShow();\n  });\n\n  $('.resetPasswordButton').on('click', (ev) => {\n    ev.preventDefault();\n    let email = $('.resetPasswordEmail').val();\n    if (!email) {\n      $('.resetPasswordEmail').addClass('error');\n      return;\n    }\n    $('.resetPasswordEmail').removeClass('error');\n    $('.loginStatus').html('Sending password reset email...');\n    $('.resetPasswordForm').flexHide();\n    $('.resetPasswordMessage').flexHide();\n    api.sendPasswordResetEmail(email, (err, data) => {\n      // console.log('sendPasswordResetEmail', err, data);\n      if (err || !data.success) {\n        $('.loginStatus').html('Failed to send password reset email.');\n        console.error(err || data);\n        return;\n      }\n      $('.loginStatus').removeClass('error').addClass('success').html(data.message);\n    });\n  });\n\n  $('.buddylist').click((e) => {\n    // check if element has a data-buddy attribute\n    if (!$(e.target).closest('.buddy-message-sender').data('buddy')) {\n      return\n    }\n    let buddyname = $(e.target).closest('.buddy-message-sender').data('buddy');\n    // console.log('message-buddy', buddyname);\n    this.openChatWindow({ name: buddyname });\n  });\n\n  // Send a buddy request form\n  $('.sendBuddyRequest').on('click', (ev) => {\n    ev.preventDefault();\n    let buddyName = $('.buddy_request_name').val();\n    if (!buddyName) {\n      $('.buddy_request_name').addClass('error');\n      return;\n    }\n\n    $('.you_have_no_buddies').html('Buddy Request Sent!');\n    $('.buddy_request_name').removeClass('error');\n    $('.buddy_request_name').val('');\n    // $('.pendingOutgoingBuddyRequests').append('<li>' + buddyName + '</li>');\n    this.bp.log('buddypond.addBuddy ->', buddyName);\n\n    this.buddyServerClient.addBuddy(buddyName, (err, data) => {\n      console.log('buddypond.addBuddy <-', err, data);\n      if (data.error) {\n        $('.you_have_no_buddies').html(data.error);\n        console.error(data);\n        return;\n      }\n      if (!data.success) {\n        $('.you_have_no_buddies').html(data.message)\n        console.error(data);\n        return;\n      }\n      this.bp.log('buddypond.addBuddy <-', data);\n    });\n\n  });\n\n  // Initially disable the login button\n  $('.loginButton').prop('disabled', true);\n  $('.loginButton').addClass('disabled');\n\n  // Toggle the login button based on the checkbox status\n  $('#tosAgree').change(function () {\n    if ($(this).is(':checked')) {\n      $('.loginButton').prop('disabled', false);\n      $('.loginButton').removeClass('disabled');\n    } else {\n      $('.loginButton').prop('disabled', true);\n      $('.loginButton').addClass('disabled');\n    }\n  });\n\n  /*\n  // TODO: create context meny for buddy-message-sender\n  $(document).on('click', (e) => {\n    // delegate based on if e.target is a .buddy-message-sender\n    // if so, open profile for that buddy\n    //alert(e.target.classList)\n    if ($(e.target).hasClass('buddy-message-sender')) {\n      alert('buddy-message-sender');\n      let buddyName = $(e.target).text();\n      if (this.bp.admin) {\n        // roles are handled server-side, this is a simple UI route for the implied role access\n        // loading admin-profile from another user won't return admin data\n        this.bp.open('admin-profile', { context: buddyName });\n      } else {\n        // this.bp.open('user-profile', { context: buddyName });\n      }\n    }\n  });\n  */\n\n  // Append a custom context menu to the body (hidden initially)\n  // $('body').append('<div id=\"customContextMenu\" class=\"removeMessage\" style=\"display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; padding: 10px;\">Remove Message</div>');\n\n  // Right-click event on elements with class .buddy-message-sender\n  /*\n  $(document).on('contextmenu', function (e) {\n \n    if (!$(e.target).hasClass('buddy-message-sender')) {\n      return true;\n    }\n \n    e.preventDefault(); // Prevent default context menu\n    let chatMessage = $(e.target).closest('.chatMessage'); // Get the chat message element\n    console.log('using chatMessage', chatMessage.html());\n    if (api.me !== 'Marak') { // could also allow users to remove their own messages\n       // set the removeMessage to disabled class\n      $('#customContextMenu').addClass('disabled');\n    }\n \n    let from = chatMessage.attr('data-from');\n    let to = chatMessage.attr('data-to');\n    let uuid = chatMessage.attr('data-uuid');\n    let type = chatMessage.attr('data-type');\n \n    console.log('type', type, 'from', from, 'uuid', uuid);\n \n    // Position the custom context menu at the mouse coordinates\n    $('#customContextMenu').css({\n      top: e.pageY + 'px',\n      left: e.pageX + 'px',\n      display: 'block'\n    });\n \n    $('#customContextMenu').off('click').on('click', async () => {\n      // Replace 'openProfile' with your actual function to open the profile\n      //openProfile(buddyName);\n \n      let context = to;\n \n      await api.removeMessage({type, from, to, uuid});\n      // $(this).hide(); // Hide the context menu after click\n    });\n  });\n  */\n\n  // Hide context menu when clicking anywhere else on the document\n  /*\n  $(document).on('click', function (e) {\n    if (!$(e.target).hasClass('buddy-message-sender')) {\n      $('#customContextMenu').hide();\n    }\n  });\n  */\n\n  let d = $(document);\n\n\n  /*\n  d.on('mousedown', 'img.remixPaint, img.remixMeme', function () {\n \n    let form = $(this).parent();\n    let url = $('.image', form).attr('src');\n    let output = $(this).data('output');\n    let context = $(this).data('context');\n \n    let cardContainer = $(this).parent().parent();\n    console.log('cardContainer', cardContainer);\n    url = $('.bp-image', cardContainer).attr('src');\n    // url = buddypond.host + url;\n    console.log('remixPaint', url, output, context);\n \n    bp.open('paint', {\n      src: url,\n      output: output,\n      context: context,\n    });\n \n  });\n  */\n\n  // TODO: move these events to chatWindowUIEvents.js\n  // editor configuration: update icon paths if you prefer different icons\n  const _remixEditors = [\n    { key: 'paint', title: 'Paint', icon: 'desktop/assets/images/icons/icon_paint_64.webp' },\n    { key: 'minipaint', title: 'miniPaint', icon: 'desktop/assets/images/icons/icon_minipaint_64.webp' },\n    { key: 'painterro', title: 'Painterro', icon: 'desktop/assets/images/icons/icon_painterro_64.webp' },\n    { key: 'chalkboard', title: 'Chalkboard', icon: 'desktop/assets/images/icons/icon_chalkboard_64.webp' }\n  ];\n\n  // Open / toggle the leftâ†’right menu when clicking the paint icon\n  d.on('click', 'img.remixPaint', function (ev) {\n    ev.stopPropagation();\n\n    const $img = $(this);\n    const $card = $img.closest('.image-card');\n    const $controls = $img.closest('.image-controls');\n\n    // If we don't already have a wrapper, wrap the button and create the menu\n    let $wrapper = $img.parent('.remix-wrapper');\n    if ($wrapper.length === 0) {\n      // wrap the img element in a remix-wrapper\n      $img.wrap('<div class=\"remix-wrapper\"></div>');\n      $wrapper = $img.parent();\n\n      // ensure the wrapper has correct absolute placement (fallback)\n      $wrapper.css({ position: 'absolute', left: '0px', top: '6px' });\n\n      // build the menu DOM\n      const $menu = $('<div class=\"remix-menu\" aria-hidden=\"true\"></div>');\n      _remixEditors.forEach(ed => {\n        const $opt = $(`\n        <button class=\"remix-option\" type=\"button\" title=\"${ed.title}\" data-editor=\"${ed.key}\">\n          <img src=\"${ed.icon}\" alt=\"${ed.title}\" />\n        </button>\n      `);\n        $menu.append($opt);\n      });\n\n      // append menu to wrapper after the image\n      $img.after($menu);\n    }\n\n    // toggle menu open/closed\n    const $menu = $wrapper.find('.remix-menu').first();\n    $menu.toggleClass('open');\n  });\n\n  // Option click handler: launches the selected editor with the same payload\n  d.on('click', '.remix-wrapper .remix-option', function (ev) {\n    ev.stopPropagation();\n\n    const $opt = $(this);\n    const editor = $opt.data('editor');\n\n    const $card = $opt.closest('.image-card');\n    const url = $card.find('.bp-image').attr('src') || $card.find('img.image').attr('src');\n    const output = $card.find('.remixPaint').data('output');\n    const context = $card.find('.remixPaint').data('context');\n\n    // open the chosen editor (assumes bp.open supports these editor keys)\n    bp.open(editor, {\n      src: url,\n      output: output,\n      context: context\n    });\n\n    // close menu\n    $card.find('.remix-menu.open').removeClass('open');\n  });\n\n  // Close any open menus when clicking elsewhere\n  $(document).on('click', function () {\n    $('.remix-menu.open').removeClass('open');\n  });\n\n  // Invite a buddy link ( opens twitter with a random message )\n  $('.inviteBuddy').on('click', () => {\n    let randomInviteMessages = [\n      `Find me as \"${this.bp.me}\" on https://buddypond.com and let's start a conversation that could last a lifetime.`,\n      `I've taken my conversations to the cloud! Reach me at \"${this.bp.me}\" on https://buddypond.com where the future of messaging unfolds.`,\n      `Wave goodbye to the old and hello to the old! I'm waiting at \"${this.bp.me}\" on https://buddypond.com. Let's catch up!`,\n      `Missing chat sessions? They're back and better than ever at \"${this.bp.me}\" on https://buddypond.com. Join me and let's reconnect!`,\n      `Taking conversations to the next level. Find me at \"${this.bp.me}\" on https://buddypond.com and let's dive into new topics together!`,\n      `Remember the ease of old-school messaging? Experience it again with a twist! I'm \"${this.bp.me}\" at https://buddypond.com. Chat soon?`,\n      `I'm charting new territories in the world of digital communication. Join me as \"${this.bp.me}\" on https://buddypond.com and let's explore together!`,\n      `Just like the good old days but better! Find me on \"${this.bp.me}\" at https://buddypond.com and let's keep the conversations flowing.`,\n    ];\n    let inviteMessage = randomInviteMessages[Math.floor(Math.random() * randomInviteMessages.length)];\n    window.open(`https://twitter.com/intent/tweet?url=${inviteMessage}`);\n    return false;\n  });\n\n  function updatePositiveAffirmation() {\n    let key = affirmations[Math.floor(Math.random() * affirmations.length)];\n    $('.positiveAffirmation').html(key);\n  }\n\n  // update the positive affirmation on an interval\n  if (this.positiveAffirmationInterval) {\n    clearInterval(this.positiveAffirmationInterval);\n  }\n\n  this.positiveAffirmationInterval = setInterval(function () {\n    $('.positiveAffirmation').fadeOut({\n      duration: 4444,\n      complete: function () {\n        updatePositiveAffirmation();\n        $('.positiveAffirmation').fadeIn({\n          duration: 4444,\n          complete: function () { }\n        });\n      }\n    });\n  }, 199800); // 3 minutes, 33 seconds\n\n  updatePositiveAffirmation();\n\n  $('.positiveAffirmation').on('click', function () {\n    updatePositiveAffirmation();\n  });\n\n\n}","\n// Remark: Server will only allocate if there is no pre-existing portion of coins\n// Remark: Server maintains a mutex lock to ensure only one request per user at a time ( spamming prevention )\nexport default async function requestDefaultCoinAllocations() {\n\n  let qtokenid = buddypond.qtokenid;\n  let me = this.bp.me;\n\n  // TODO: set a five second alarm here so messages aren't immediately sent on login\n  console.log(`requestDefaultCoinAllocations ${me} ${qtokenid}`);\n\n  let res;\n  try {\n    let faucetUrl = `${buddypond.randolphEndpoint}/faucet`;\n    console.log('faucetUrl', faucetUrl);\n    res = await fetch(faucetUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${qtokenid}`,\n        'x-me': me\n      }\n    });\n    console.log('requestDefaultCoinAllocations', res.status, res.statusText);\n    let json = await res.json();\n    console.log('requestDefaultCoinAllocations', json);\n  } catch (err) {\n    throw err;\n  }\n\n}","export default function sortBuddyList() {\n\n  let buddyList = document.querySelector('.buddylist');\n  if (!buddyList) {\n    console.log('Buddy list not found, unable to sort');\n    return;\n  }\n\n  let buddyItems = Array.from(document.querySelectorAll('.buddylist li')); // TODO: more specific selector?\n\n  buddyItems.sort((a, b) => {\n    // Sort by status (online ðŸŸ¢ first)\n    let aStatus = a.querySelector('.buddy-status').textContent.includes('ðŸŸ¢') ? 0 : 1;\n    let bStatus = b.querySelector('.buddy-status').textContent.includes('ðŸŸ¢') ? 0 : 1;\n\n    if (aStatus !== bStatus) {\n      return aStatus - bStatus; // Online first\n    }\n\n    // If both are online, sort alphabetically by name\n    if (aStatus === 0 && bStatus === 0) {\n      return a.dataset.buddy.localeCompare(b.dataset.buddy);\n    }\n\n    // If both are offline, sort by utime (most recent first), then by name\n    let aUtime = parseInt(a.dataset.utime || 0);\n    let bUtime = parseInt(b.dataset.utime || 0);\n    if (aUtime !== bUtime) {\n      return bUtime - aUtime; // Higher utime (more recent) first\n    }\n\n    return a.dataset.buddy.localeCompare(b.dataset.buddy);\n  });\n\n\n  buddyList.innerHTML = '';\n  buddyItems.forEach(item => buddyList.appendChild(item));\n}","\nexport default function showContextMenu(x, y, buddyName) {\n    const $menu = $('<div>', {\n      id: 'customContextMenu',\n      css: {\n        position: 'absolute',\n        top: y,\n        left: x,\n        zIndex: 99999,\n        display: 'block',\n        background: 'var(--desktop_element-background)',\n        border: '1px solid #ccc',\n        padding: '10px',\n        cursor: 'pointer'\n      }\n    }).append($('<ul>').append(\n      $('<li>').text('View Profile').on('click', () => openProfile(buddyName))\n    ));\n  \n    function openProfile(buddyName) {\n      console.log('Opening profile for ' + buddyName);\n      if (bp.admin) {\n        bp.open('admin-profile', { context: buddyName });\n      } else {\n        bp.open('user-profile', { context: buddyName });\n      }\n    }\n  \n    $('#customContextMenu').remove();\n    $('body').append($menu);\n  \n    $(document).one('click', function () {\n      $('#customContextMenu').remove();\n    });\n  }\n  ","// Context menu creation\nexport default function createMessageContextMenu(target, closestMessage) {\n\n  // Remove existing context menu if any\n  if (this.activeMessageContextMenu) {\n    this.activeMessageContextMenu.remove();\n    this.activeMessageContextMenu = null;\n  }\n\n  if (this.activeMessageHoverMenu) {\n    // set display: none on the hover menu\n    // TODO: needs to swap classes instead of setting styles\n    // this.activeMessageHoverMenu.style.display = 'none';\n    this.activeMessageHoverMenu = null;\n  }\n\n  // TODO: the closest .aim-hover-menu to target should have it's hover CSS logic removed\n  // aim-hover-menu:hover sets display: flex, without its display: none\n  // we need this bypassed while the context menu is open\n  const hoverMenu = target.closest('.aim-hover-menu');\n  /*\n  console.log('hoverMenu', hoverMenu);\n  if (hoverMenu) {\n    // hoverMenu.style.display = 'flex';\n  }\n  */\n\n  const contextMenu = document.createElement('div');\n  contextMenu.className = 'aim-context-menu';\n\n  const messageFrom = closestMessage.getAttribute('data-from');\n\n\n  const menuItems = [\n    { text: 'Reply', action: 'reply-message' },\n    // { text: 'Quote', action: 'quote-message' },\n    { text: 'Say Message', action: 'say-message' },\n    // { text: 'Report Message', action: 'report-message' },\n    // { text: 'Copy Message', action: 'copy-message' },\n  ];\n\n  if (messageFrom === this.bp.me || this.bp.me === 'Marak') { // TODO: admin rbac\n    menuItems.push(\n      { text: 'Edit Message', action: 'edit-message' },\n      { text: 'Delete Message', action: 'delete-message' }\n    );\n  }\n\n  menuItems.push({\n    text: 'Cast Spell',\n    action: 'cast-spell',\n  });\n\n  menuItems.forEach(item => {\n    const menuItem = document.createElement('div');\n    menuItem.className = 'aim-context-menu-item';\n    menuItem.textContent = item.text;\n    menuItem.setAttribute('data-action', item.action);\n    contextMenu.appendChild(menuItem);\n  });\n\n  // Position the context menu\n  document.body.appendChild(contextMenu);\n  const rect = target.getBoundingClientRect();\n  contextMenu.style.left = `${rect.left - 150}px`;\n  contextMenu.style.top = `${rect.bottom + window.scrollY - 20}px`;\n\n  // set data-attr to the closest message data-chat-id and data-uuid\n  const chatId = closestMessage.getAttribute('data-chat-id');\n  const uuid = closestMessage.getAttribute('data-uuid');\n  contextMenu.setAttribute('data-chat-id', chatId);\n  contextMenu.setAttribute('data-uuid', uuid);\n  contextMenu.setAttribute('data-from', messageFrom);\n\n  this.activeMessageContextMenu = contextMenu;\n  this.activeMessageHoverMenu = hoverMenu;\n  return contextMenu;\n}\n","export default function loadUserApps() {\n    console.log('Loading user apps...');\n    // defer loading of default chat window bar apps\n    setTimeout(async () => {\n      /* Instead of parrallel request, we load them sequentially to reduce load client\n      await Promise.all([\n      ]);\n      */\n      await this.bp.load('spellbook');\n      await this.bp.load('coin');\n      await this.bp.load('soundrecorder');\n      await this.bp.load('camera');\n      await this.bp.load('dictate');\n      await this.bp.load('chalkboard');\n      await this.bp.load('paint');\n      await this.bp.load('painterro');\n      await this.bp.load('minipaint');\n      await this.bp.load('say');\n    }, 3000);\n\n\n    // TODO: load from saved profile\n    if (this.bp.me === 'Marak') { // TODO: admin rbac checks\n        // install Admin if not already installed\n        let installedApps = this.bp.settings.apps_installed || {};\n        console.log('installedApps', installedApps);\n        if (!installedApps['admin']) {\n            this.bp.apps.desktop.addApp('admin');\n        }\n        if (typeof window.arrangeDesktop === 'function') {\n          window.arrangeDesktop();\n        }\n    }\n}","export default async function sendMessageHandler(e, chatWindow, windowType, contextName) {\n  // console.log('sendMessageHandler called', e, chatWindow, windowType, contextName);\n  const message = $('.aim-input', chatWindow.content).val();\n\n  const _data = {\n    to: $('.aim-to', chatWindow.content).val(),\n    replyto: $('.aim-replyto', chatWindow.content).val(),\n    type: windowType,\n    from: this.bp.me,\n    message,\n    ctime: Date.now(),\n    text: message,\n    files: [],\n  };\n\n  console.log('sendMessageHandler _data', _data);\n\n  // TODO: move file upload code to separate function\n  // Get file previews\n  const filePreviews = $('.file-preview', chatWindow.content);\n  const files = [];\n\n  if ((!message || message.length === 0) && filePreviews.length === 0) {\n    console.log('No message to send');\n    return;\n  }\n\n  // Collect all files first\n  filePreviews.each((_, filePreview) => {\n    $('.file-content', filePreview).each((_, fileContent) => {\n      const file = this.bp.apps['file-viewer'].getFile(fileContent);\n      if (file) {\n        files.push({\n          file,\n          element: fileContent\n        });\n      }\n    });\n  });\n\n  // Create status indicators for each file\n  files.forEach(({ file, element }) => {\n    const statusDiv = $('<div>', {\n      class: 'upload-status',\n      css: {\n        position: 'absolute',\n        top: 0,\n        left: 0,\n        right: 0,\n        bottom: 0,\n        background: 'rgba(0, 0, 0, 0.7)',\n        color: 'white',\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n        zIndex: 1000\n      }\n    }).text('Waiting...');\n\n    $(element).css('position', 'relative').append(statusDiv);\n  });\n\n  // Process files sequentially\n  try {\n    for (const { file, element } of files) {\n      const statusDiv = $(element).find('.upload-status');\n      statusDiv.text('Uploading...');\n\n      try {\n        console.log('is there a filepath?', file.filePath);\n        console.log('this is the file', file);\n        file.filePath = file.filePath || file.name;\n\n        // we are going to perform some basic file organization and routing here\n        // when the user uploads files via the chat window, we are going to store them\n        // in the user's directory on the CDN\n        // to help out the user, will perform mime type / file ext detection here in order to upload\n        // the file to the appropriate directory such as images, audio, videos, etc\n        let supportedImageTypesExt = ['jpeg', 'png', 'gif', 'webp', 'svg']; // same as server ( for now )\n        let supportedAudioTypesExt = ['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a'];\n        let supportedVideoTypesExt = ['mp4', 'webm', 'ogg', 'avi', 'mov', 'mkv'];\n\n        // check to see if the file.name has an extension included in the supportedImageTypesExt array\n        let fileExt = file.name.split('.').pop().toLowerCase();\n        if (supportedImageTypesExt.includes(fileExt)) {\n          file.filePath = 'images/' + file.filePath;\n        }\n        if (supportedAudioTypesExt.includes(fileExt)) {\n          file.filePath = 'audio/' + file.filePath;\n        }\n        if (supportedVideoTypesExt.includes(fileExt)) {\n          file.filePath = 'videos/' + file.filePath;\n        }\n\n        // make file.filePath url encoded\n        file.filePath = encodeURIComponent(file.filePath);\n\n        console.log('assigning file path', file.filePath);\n        let fileUrl = await this.bp.apps.client.api.uploadFile(file, (progress) => {\n          statusDiv.text('Uploading: ' + progress + '%');\n        });\n\n        // now that we have the url, just send a regular message with the url\n        // the card type should automatically be detected by the server\n        // the the body of the message will be the url with extension of image, video, etc\n        let message = {\n          to: _data.to,\n          from: _data.from,\n          type: _data.type,\n          replyto: _data.replyto,\n          text: fileUrl\n        };\n        // TODO: replyto\n        console.log(\"sending multimedia message\", message);\n        this.bp.emit('buddy::sendMessage', message);\n\n        // Fade out and remove the uploaded file preview\n        await $(element).fadeOut(300);\n        $(element).remove();\n\n      } catch (error) {\n        console.error('Error uploading file:', error);\n        statusDiv.text('Failed: ' + error.message)\n          .css('background', 'rgba(255, 0, 0, 0.7)');\n\n        // Keep failed uploads visible for 2 seconds then fade out\n        await new Promise(resolve => setTimeout(resolve, 8000));\n        await $(element).fadeOut(300);\n        $(element).remove();\n      }\n    }\n  } catch (error) {\n    console.error('Error in file upload process:', error);\n  }\n\n  // Remove empty file preview containers\n  filePreviews.each((_, container) => {\n    if ($(container).children().length === 0) {\n      $(container).remove();\n    }\n  });\n\n  $('.file-preview', chatWindow.content).remove();\n\n  // Send the regular message\n  if (windowType === 'pond') {\n    _data.type = 'pond';\n  } else {\n    _data.type = 'buddy';\n  }\n\n  // TODO: move these commands to defaultCommands in buddyscript\n  if (_data.text.startsWith('/gif')) {\n    // split text to parts on space\n    let params = _data.text.split(' ').slice(1);\n    await bp.load('image-search');\n\n    if (params.length === 0) {\n      await bp.open('image-search', {\n        query: params[0],\n        provider: 'giphy-stickers',\n        context: _data.to,\n        output: windowType\n      });\n      // clear the input\n      $('.aim-input', chatWindow.content).val('');\n      return;\n    }\n\n    let result = await bp.apps['image-search'].fetchImages(params[0], 6, 'giphy-stickers');\n    // pick a random image from the result\n    if (result.error) {\n      console.error('Image search error:', result.error);\n      // show an error message in the chat window\n      await this.showCard({ chatWindow, cardName: 'error', context: { message: result.error } });\n\n      // $('.aim-input', chatWindow.content).val('Error fetching images: ' + result.error);\n      console.error('Error fetching images:', result.error);\n      return;\n    }\n    if (result.length === 0) {\n      console.error('No images found for query:', params[0]);\n      return;\n    }\n    let randomImage = result[Math.floor(Math.random() * result.length)];\n    console.log('Random image selected:', randomImage);\n    // _data.text = randomImage; // set the text to the image URL\n    _data.card = {\n      type: 'image',\n      url: randomImage\n    };\n  }\n\n  // TODO: merge back params to query string, just pop the first one off\n  if (_data.text.startsWith('/image')) {\n    // split text to parts on space\n    let params = _data.text.split(' ').slice(1);\n    console.log('/image params', params);\n    if (params.length === 0) {\n      // if only one parameter is provided, open the image search app\n      await bp.open('image-search', { query: params[0], provider: 'pexels' });\n      // clear the input\n      $('.aim-input', chatWindow.content).val('');\n      return;\n    }\n\n    await bp.load('image-search');\n    console.log('pppp', params)\n    let result = await bp.apps['image-search'].fetchImages(params[0], 6, 'pexels');\n    // pick a random image from the result\n    if (result.error) {\n      console.error('Image search error:', result.error);\n      // show an error message in the chat window\n      await this.showCard({ chatWindow, cardName: 'error', context: { message: result.error } });\n\n      // $('.aim-input', chatWindow.content).val('Error fetching images: ' + result.error);\n      console.error('Error fetching images:', result.error);\n      return;\n    }\n    if (result.length === 0) {\n      console.error('No images found for query:', params[0]);\n      return;\n    }\n    let randomImage = result[Math.floor(Math.random() * result.length)];\n    console.log('Random image selected:', randomImage);\n    // _data.text = randomImage; // set the text to the image URL\n    _data.card = {\n      type: 'image',\n      url: randomImage\n    };\n  }\n\n  // if this is a buddyscript command, but not a /say command\n  // say has a special meaning in the context of the chat window\n  // as it should be sent as regular text message ( should be a card later, click to repeat )\n  // TODO: needs to rebuild bs system to support local transform commands\n  if (_data.text.startsWith('/')\n    && !_data.text.startsWith('/say')\n    && !_data.text.startsWith('/roll')\n    && !_data.text.startsWith('/gif')\n    && !_data.text.startsWith('/image')\n    && !_data.text.startsWith('/deepseek')\n  ) {\n    // TODO: process the card locall here\n    /*\n    _data.card = {\n     type: 'bs'\n   };\n   */\n    // runs local BS script command\n    // alert('bs card')\n\n    let bs = this.bp.apps.buddyscript.parseCommand(_data.text);\n    console.log('got back buddyscript command', bs);\n    if (bs.pipe) {\n      //if (now - messageTime < 10000) {\n      // pipeable / immediate run commands should only persist for 10 seconds\n      bs.pipe({\n      chatWindow,\n      contextName: _data.to,\n      windowType\n    });\n      // clear the input\n      $('.aim-input', chatWindow.content).val('');\n      return false;\n\n      // }\n    }\n\n    console.log(' ', bs);\n    if (bs.type === 'show-card') {\n      // show the bs card\n      // console.log('showing bs card', message, bs);\n      let cardData = bs.data;\n      this.showCard({\n        chatWindow,\n        cardName: 'bs',\n        context: {\n          ...bs,\n          context: message.to,\n          type: windowType\n        }\n      });\n    }\n    $('.aim-input', chatWindow.content).val('');\n\n    return false;\n  }\n\n  console.log(`Sending message to ${_data.to} from ${_data.from} of type ${_data.type}:`, _data.text);\n  console.log(_data.text.startsWith('\\\\'));\n  if (_data.text.startsWith('\\\\')) {\n   \n    // let bs = this.bp.apps.buddyscript.parseCommand(_data.text);\n    // console.log('backwards command', bs);\n    _data.card = {\n      type: 'bs',\n      command: _data.text.replace('\\\\', '/').trim(),\n      //commandData: bs\n    };\n\n  }\n\n\n  // TODO: check if this is a valid BS command\n  // if so, we need to construct a card to show the command\n\n  // TODO: add support for sending /bs commands with \\ instead of /\n  /*\n  if (_data.text.startsWith('\\\\')) {\n    // the command is a /foo style command\n    // extract the command from the text\n    let command = _data.text.split(' ')[0].replace('\\\\', '');\n    alert(command)\n    _data.text = 'Sent app using `\\\\' + command + '` command'; // TODO: better UX message\n    _data.card = {\n      type: 'app', // coould also be a \"bs\" card, might need distinction between app and bs commands\n      context: command\n    };\n  }\n  */\n\n  // console.log('emitting message', _data);\n  this.bp.emit('buddy::sendMessage', _data);\n\n  // Clear input\n  $('.aim-input', chatWindow.content).val('');\n\n  // Hide the aim-reply-box\n  $('.aim-reply-box', chatWindow.content).remove();\n\n  // clear the replyTo input value\n  $('.aim-replyto', chatWindow.content).val('');\n  /*\n  const replyBox = target.closest('.aim-reply-box');\n  if (replyBox) {\n    replyBox.remove();\n    this.activeReplyBox = null;\n    this.bp.replyMode = false;\n    this.bp.replyData = null;\n  }\n  */\n\n  let $sendButton = $('.aim-send-btn', chatWindow.content);\n  $sendButton.css('opacity', 0.5);\n\n\n}","export default async function showCard({chatWindow, cardName, context = {}}) {\n\n  // render the help card and do not send the message\n    let cardManager = this.bp.apps.card.cardManager;\n    // console.log('cardManager.loadCard', cardData);\n    const _card = await cardManager.loadCard(cardName, context, chatWindow);\n    let container = document.createElement('div');\n    container.classList.add('cardContainer');\n    let d = await _card.render(container, chatWindow);\n    if (!chatWindow || !chatWindow.content) {\n      console.error('chatWindow not found. user most likely not in the chat window');\n      throw new Error('chatWindow.content not found. user most likely not in the chat window');\n      return;\n    }\n\n    let aimMessagesContainer = chatWindow.content.querySelector(`.aim-messages-container`);\n\n    // find the correct aim-messages-container ( if pond / or buddy i guess )\n    // find the .aim-messages-container inside the chatWindow.content with data-context attribute\n    if (context.type === 'pond') {\n      // console.log('Inserting message into pond chat window', message);\n      aimMessagesContainer = chatWindow.content.querySelector(`.aim-messages-container[data-context=\"${context.context}\"]`);\n    }\n\n    const aimMessages = aimMessagesContainer.querySelector('.aim-messages');\n    if (!aimMessages) {\n      console.error('aim-messages not found. user most likely not in the chat window');\n      return;\n    }\n\n    // append container to the aim-messages at the end\n    aimMessages.appendChild(container);\n\n    // empty the aim-input\n    $('.aim-input', chatWindow.content).val('');\n\n    // scroll to the bottom of the chat window\n    // aimMessages.scrollTop = aimMessages.scrollHeight;\n    /* No longer needed, as scrollIntoView should be handled by messages\n    if (!this.bp.isMobile()) {\n      container.scrollIntoView({\n        behavior: 'instant',\n        container: 'nearest'\n      });\n    }\n    */\n\n    return d;\n  }\n","export default function scrollToBottom(parent, retryDelay = 0, retryCount = 0) {\n  if (!parent) return;\n  if (retryCount > 5) return;\n\n  const chatArea = $('.aim-chat-area', parent)[0];\n  if (!chatArea) return;\n\n  if (retryCount === 0 && chatArea._scrollRetryTimer) {\n    clearTimeout(chatArea._scrollRetryTimer);\n    chatArea._scrollRetryTimer = null;\n  }\n\n  $(chatArea).scrollTop(chatArea.scrollHeight);\n  \n\n  requestAnimationFrame(() => {\n    const buffer = 10; // tolerate small gap\n    const isAtBottom = (chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight) < buffer;\n\n    if (!isAtBottom) {\n      retryDelay += 200;\n      retryCount++;\n\n      chatArea._scrollRetryTimer = setTimeout(() => {\n        scrollToBottom(parent, retryDelay, retryCount);\n      }, retryDelay);\n    } else {\n      chatArea._scrollRetryTimer = null;\n    }\n\n    // Final fallback if Safari still misbehaves\n    if (retryCount >= 5 && !isAtBottom) {\n      chatArea.lastElementChild?.scrollIntoView({ block: 'end' });\n    }\n  });\n}\n","export default function defaultAvatarSvg(username) {\n  // Check if avatar is already cached\n  if (this.data.avatarCache.has(username)) {\n    return this.data.avatarCache.get(username);\n  }\n\n  // Create an identicon avatar using DiceBear\n  const avatar = this.bp.vendor.dicebear.createAvatar(this.bp.vendor.dicebearAvatars, {\n    seed: username, // Username as seed for consistent avatar\n    size: 40, // Avatar size in pixels\n    backgroundColor: [\"#f0f0f0\"], // Optional: Customize background\n  });\n\n  // Convert avatar to SVG string\n  const svg = avatar.toString();\n\n  // Store in cache\n  this.data.avatarCache.set(username, svg);\n\n  return svg;\n}","export default function createBuddyListWindow() {\n\n    // calculate right side of screen\n    let x = window.innerWidth - 250;\n\n    let buddyListWindow = this.bp.apps.ui.windowManager.createWindow({\n        app: 'buddylist',\n        type: 'buddylist-profile',\n        title: 'Buddy List',\n        icon: '/desktop/assets/images/icons/icon_profile_64.webp',\n        id: 'buddylist',\n        parent: this.bp.apps.ui.parent,\n        width: 250,\n        height: 500,\n        x: x,\n        y: 50,\n        onOpen: () => {\n\n            // Remark: We seeing a race condition where the input field is not focusable\n            // Most likely due to element being hidden / shown\n            // We hooked into window focus events and everything appeared OK in regards to conflicting focus() calls\n            // The issue is most likely due to the element being hidden\n            // This still doesn't work as intended since the element might actually be hidden\n            // TODO: find a better way to handle this\n            function focusOnInput() {\n                const $loginInput = $('.loginForm input[name=\"username\"]');\n                console.log('focusOnInput: Found elements:', $loginInput.length, $loginInput);\n\n                // If the element doesnâ€™t exist, retry after a delay\n                if ($loginInput.length === 0) {\n                    console.log('Input not found, retrying in 100ms');\n                    setTimeout(focusOnInput, 100);\n                    return;\n                }\n\n                // Check if the element is focusable\n                const input = $loginInput[0]; // Get the raw DOM element\n                const isFocusable = input.offsetParent !== null && // Visible in the DOM\n                    !input.disabled && // Not disabled\n                    input.tabIndex !== -1 && // Focusable via tab\n                    getComputedStyle(input).visibility !== 'hidden' && // Not hidden\n                    getComputedStyle(input).display !== 'none'; // Not display: none\n\n                if (!isFocusable) {\n                    console.log('Input is not focusable yet, retrying in 100ms', {\n                        isVisible: input.offsetParent !== null,\n                        isEnabled: !input.disabled,\n                        tabIndex: input.tabIndex,\n                        visibility: getComputedStyle(input).visibility,\n                        display: getComputedStyle(input).display\n                    });\n                    setTimeout(focusOnInput, 100);\n                    return;\n                }\n\n                // Attempt to focus and verify\n                $loginInput.focus();\n                setTimeout(() => {\n                    if (document.activeElement === input) {\n                        console.log('Focus successful on:', input);\n                    } else {\n                        console.warn('Focus failed, active element is:', document.activeElement);\n                        // Optionally retry\n                        setTimeout(focusOnInput, 100);\n                    }\n                }, 0); // Check focus in the next tick\n            }\n            // focusOnInput();\n            // if we call this in console after load, it works\n            $('.loginForm input[name=\"username\"]').focus();\n\n        },\n        onClose: () => {\n            this.opened = false;\n            // disconnect from websocket server\n            if (this.client) {\n                this.client.disconnect();\n                this.client = null;\n            }\n            this.bp.connected = false;\n        }\n    });\n\n    return buddyListWindow;\n\n}\n","export default function logout() {\n    // set status to online\n    $('.loginButton').prop('disabled', false);\n    $('.loginButton').removeClass('disabled');\n    $('#menu-bar-coin-balance').text('0');\n    this.buddyServerClient.setStatus(this.bp.me, {\n        status: 'offline'\n    }, (err, re) => {\n        console.log('buddypond.setStatus', err, re);\n        // close any open chat windows\n        // $('.chatWindow').remove(); // maybe, they could stay open as well\n        this.bp.apps.ui.windowManager.windows.forEach(window => {\n            console.log('closing window', window);\n            if (window.type === 'buddy' || window.type === 'pond') {\n                // console.log('closing chat window', window.id);\n                window.close();\n            }\n        });\n        // iterate through all windows and close any that are chat windows\n        // disconnect the client\n        // this.bp.apps.client.logout();\n        $('.password').val('');\n        $('.loggedIn').flexHide();\n        $('.loggedOut').flexShow();\n\n        this.data.profileState = null;\n        this.bp.play('desktop/assets/audio/GOODBYE.wav');\n        // TODO can we now remove bp.apps.client.logout()?\n        this.bp.apps.client.logout();\n        this.client.disconnect();\n        this.buddyServerClient.disconnect();\n        this.bp.connected = false;\n        this.client = null;\n        this.buddyServerClient = null;\n        // clear out the local .data scope\n        // TODO: only declare this once ( code is repeated in constructor )\n        this.data = {\n            processedMessages: {},\n            profileState: {\n            },\n            activeUsersInContext: {},\n            activeUsers: [],\n            activePonds: [],\n            avatarCache: new Map()\n        };\n        // empty the buddylist\n        $('.buddylist').empty();\n\n        // hide any .dialog\n        $('.dialog').remove();\n\n    });\n}"],"names":["attachContextMenu","buddyElement","$","on","e","preventDefault","buddyName","target","closest","dataset","buddy","this","showContextMenu","pageX","pageY","regionNames","Intl","DisplayNames","type","parseMarkdownWithoutPTags","markdown","text","length","graphemes","splitEmojiGraphemes","emojiList","Set","Object","keys","EMOJIS","emojis","filter","g","has","replace","join","trim","isEmojiOnly","map","supportedColors","supportedStyles","linkExtension","name","level","renderer","token","href","parser","parseInline","tokens","styleExtension","tokenizer","src","match","exec","raw","modifiers","split","every","mod","includes","lexer","inlineTokens","content","reverse","forEach","walkTokens","console","log","html","marked","use","extensions","parse","error","DOMPurify","__added_anchor_hook","addHook","node","tagName","toLowerCase","getAttribute","url","URL","test","protocol","removeAttribute","setAttribute","existing","Boolean","push","sanitize","ALLOWED_TAGS","ALLOWED_ATTR","FORCE_BODY","KEEP_CONTENT","SANITIZE_DOM","ALLOWED_URI_REGEXP","GraphemeSplitter","splitGraphemes","createHoverMenu","message","hoverMenu","document","createElement","className","menuItems","action","svg","from","bp","me","icon","item","button","appendChild","createTextNode","alt","forbiddenNotes","base64","checkForLinksInMessage","messageText","isValidUrl","contentUrl","card","urlObj","ext","pathname","pop","buddypond","supportedImageTypesExt","supportedAudioTypesExt","window","location","hostname","supportedVideoTypesExt","err","warn","isValidYoutubeLink","videoId","searchParams","get","thumbnail","context","slice","isValidGithubLink","githubRegex","owner","repo","filename","setupInputEvents","windowType","contextName","chatWindow","$input","$form","$sendButton","that","event","handleEmojiInput","cursorPos","selectionStart","inputValue","val","getInputContext","autocomplete","which","shiftKey","cursorPosition","newValue","setSelectionRange","css","is","startsWith","submit","replaceShortcodes","activeContext","currentActiveContext","emit","to","isTyping","ctime","Date","now","setupAutocomplete","options","bind","emojiMap","usedShortcodes","reduce","emoji","isValidShortcode","alias","shortcode","add","textBeforeCursor","lastColonIndex","lastIndexOf","endIndex","nextColonIndex","indexOf","potentialShortcode","startIndex","firstChar","charAt","emojiSuggestions","suggestions","label","value","commands","command","focus","ui","source","request","response","query","suggestion","sort","a","b","localeCompare","select","textarea","before","after","newCursorPos","trigger","minLength","position","my","at","collision","open","$textarea","originalText","newText","call","randowFunWord","words","Math","floor","random","containsBadWord","str","lowerStr","decoded","some","fnote","RegExp","JSON","atob","ChatWindowButtonBar","constructor","inputButtons","buttons","storedOrder","settings","Array","isArray","sortButtonsByOrder","container","render","enableDragAndDrop","buttonBar","classList","element","createButtonElement","isRoot","wrapper","image","title","draggable","innerHTML","innerText","baseDataset","entries","k","v","children","dropdown","style","display","child","childWrapper","childBaseEl","remove","addEventListener","ev","stopPropagation","onclick","addButton","newButtonElement","refreshSortable","removeButton","buttonText","index","findIndex","splice","roots","el","contains","removeChild","saveButtonOrder","sortable","items","tolerance","stop","syncButtonOrder","orderedTexts","find","set","apps","windowManager","findWindows","app","reRenderButtons","order","buttonMap","fromEntries","setupChatWindowButtons","chatWindowButtons","isMobile","navigator","userAgent","env","prepend","populateRoomList","hotPonds","roomList","sortedPonds","connection_count","userOpenedPonds","data","activePonds","existingItems","Map","existingPondIds","each","_","pondId","pond","pond_id","pondName","isUserOpened","isActive","existingItem","$scoreElement","String","$closeButton","append","shouldBeActive","hasClass","toggleClass","delete","closeButton","$newItem","previousItem","$item","$nextSibling","next","insertAfter","$firstItem","first","prependTo","not","removeClass","addClass","updatePondConnectedUsers","chatId","userList","existingUserIds","userId","toString","users","user","profilePicture","userItem","$textElement","$profileContainer","$newProfileElement","createProfilePictureElement","empty","$userItem","class","$profilePicture","$userText","$existingContainer","discordMode","config","cdn","$img","attr","$currentImg","defaultAvatarSvg","isValidContextName","alert","handleExistingWindow","client","ensureMessagesContainer","toggleMessagesContainer","createNewChatWindow","windowTitle","windowId","windowConfig","buildWindowConfig","createWindow","onOpen","async","_window","initializeChatWindow","onClose","removeSubscription","id","key","messagesWsClients","wsClient","closeConnection","setupCloseButtonHandler","hide","flexShow","loggedIn","isBuddy","iconImagePath","buddylist","profileState","profile_picture","height","innerHeight","width","innerWidth","parent","x","y","setupChatWindow","addSubscription","clearBuddyNewMessages","renderMessages","attemptFocus","aimInput","setTimeout","focusInputField","newMessages","buddyServerClient","receivedInstantMessage","re","processedMessages","messagesToRender","renderChatMessage","chatArea","userListArea","userListContext","newContainer","newUserList","targetContainer","targetUserList","show","availableContainers","firstContext","firstUserListContext","scrollToBottom","chatWindowTemplate","messageTemplateString","cloned","aimMessagesContainer","aimUserListContainer","joinPond","aimWindow","touchStartX","touchEndX","handleSwipe","deltaX","changedTouches","screenX","toggleRoomListBtn","textContent","toggleUserListBtn","closePondChatBtn","toggle","setupMessageForm","username","openChatWindow","setupRoomListClickHandler","sendMessageHandler","selectedContext","remainingContainers","nextContext","roomItem","getWindow","defaultProfileFiles","getFileType","fileName","endsWith","handleContextMenuItemClick","performAction","closeMenus","handleEditHintAction","messageContent","querySelector","messageUUID","originalMessage","messageData","uuid","cancelEdit","saveEdit","activeMessageContextMenu","activeMessageHoverMenu","activeReplyBox","closestTarget","$target","emojiPicker","onSelect","reactInstantMessage","reaction","editMessage","replyMessage","closestMessage","createMessageContextMenu","deleteMessage","output","removeInstantMessage","ignoreUIControlKeys","editableContainer","parentNode","insertBefore","editHint","handleKeydown","cleanupListeners","handleBlur","relatedTarget","removeEventListener","restoreText","blur","messageElement","newMessageText","editInstantMessage","replyData","replyBox","messageSender","replyInput","messageTextInput","cancelReply","bindProfilePictureClick","parents","chatMessageElement","buddyname","rollToNumber","$el","formattedValue","toLocaleString","digits","d","digitContainer","inner","i","digitIndex","eq","transition","transform","Client","host","api","reconnectAttempts","maxReconnectAttempts","maxBackoffDelay","isIntentionallyClosed","createWebSocketClient","reconnect","readyState","WebSocket","OPEN","CONNECTING","Promise","resolve","reject","buddyServerWsEndpoint","qtokenid","handleOpen","send","stringify","pingInterval","setInterval","handleMessage","parseData","profile","getTime","dtime","buddies","success","reward","handleClose","code","reason","clearInterval","delay","min","pow","attempt","createWebSocketServerClient","handleError","Error","close","prototype","connect","disconnect","addBuddy","cb","uri","method","endpoint","headers","Accept","body","controller","AbortController","timeoutId","abort","incrementPackets","perf","start","fetch","signal","then","clearTimeout","ok","json","errorData","status","statusText","end","addPerfTime","catch","msg","apiRequest","setStatus","update","buddylistWsEndpoint","ServerClient","wsServerClient","buddyServerApiEndpoint","BuddyList","updates","avatarCache","defaultPond","subscribedBuddies","subscribedPonds","buddyscript","showedHelp","logout","fileInput","accept","file","files","filePath","onProgress","percent","result","uploadFile","sendCardMessage","click","provider","messageControls","isHost","targetEl","align","sendButton","dispatchEvent","Event","bubbles","defaultChatWindowButtons","enabledChatWindowButtons","desktop","buttonMeta","list","chatButton","opened","showingIsTyping","faucetAttempts","init","all","vendor","dicebear","importModule","dicebearAvatars","appendScript","load","bindMessageContextMenu","openDefaultPond","localValue","showPond","htmlStr","fetchHTMLFragment","appendCSS","buddyListWindow","createBuddyListWindow","createHTMLContent","focusWindow","restore","showBuddyList","eventsBound","registerEventHandlers","buddylistUIEvents","handleAuthentication","getLatestMessages","pondname","sendMessage","buddyReadNewMessages","handleChatMessages","windowsToUpdate","messages","values","showCard","cardName","sendMessageToServer","emitLocal","pondSendMessage","connected","localToken","localStorage","getItem","verifyToken","hasPassword","flexHide","discordView","minimize","handleAuthSuccess","qtoken","play","tryHard","Infinity","BuddyServerClient","tempDiscordId","linkDiscordAccount","renderOrUpdateBuddyInBuddyList","buddydata","buddyTimeouts","buddyListItems","querySelectorAll","existingBuddy","wasConnected","hasOwnProperty","isConnected","diff","utime","buddyListItemEl","connectedStatusIcon","isCalling","lastSeen","lastSeenDate","lastSeenString","year","month","day","hour","minute","second","hour12","buddyListItem","firstChild","formattedDate","DateFormat","format","date","sortBuddyList","createChatMessageElement","messageTime","cardContainer","chatMessage","img","defaultAvatar","contentWrapper","messageHeader","sender","tripcode","timestamp","messageMeta","geoFlag","of","renderGeoFlag","badgesContainer","replyIndicator","replyto","repliedMessage","repliedSender","repliedText","scrollIntoView","behavior","block","processedText","reactionsContainer","reactions","count","reactionElement","aimMessages","parseInt","low","high","insertBeforeNode","mid","midId","isNaN","insertChatMessage","_chatWindow","pondNames","decodedText","entities","decodeEntities","hashPondNameRegex","matchAll","m","findAllHashPondNames","parts","activeUsers","activeUsersInContext","removed","removedMessageEl","edited","editedMessageEl","editedMessageContent","reacted","reactedMessageEl","shift","spellbook","say","processMessages","cardData","cardManager","_card","loadCard","renderBuddyRequests","buddyrequests","buddyrequest","pendingIncomingBuddyRequests","totalIncomingBuddyRequests","denyBuddy","approveBuddy","affirmations","prop","password","authBuddy","change","isChecked","email","sendPasswordResetEmail","_remixEditors","updatePositiveAffirmation","$wrapper","wrap","left","top","$menu","ed","$opt","editor","$card","randomInviteMessages","inviteMessage","positiveAffirmationInterval","fadeOut","duration","complete","fadeIn","determineWindowParameters","generateWindowId","existingWindow","generateDefaultProfile","basePath","fileContent","blob","Blob","File","lastModified","uploadError","requestDefaultCoinAllocations","res","faucetUrl","randolphEndpoint","Authorization","buddyList","buddyItems","aStatus","bStatus","aUtime","bUtime","zIndex","background","border","padding","cursor","admin","openProfile","one","contextMenu","messageFrom","menuItem","rect","getBoundingClientRect","bottom","scrollY","isHoverMenuAction","loadUserApps","installedApps","apps_installed","addApp","arrangeDesktop","_data","filePreviews","filePreview","getFile","statusDiv","right","color","alignItems","justifyContent","fileExt","encodeURIComponent","fileUrl","progress","params","fetchImages","randomImage","bs","parseCommand","pipe","retryDelay","retryCount","_scrollRetryTimer","scrollTop","scrollHeight","requestAnimationFrame","isAtBottom","clientHeight","lastElementChild","createAvatar","seed","size","backgroundColor","ws","acc","buddy_id","emailVerified","noAlert","videochat","startCall","typingIndicatorId","typingMessage","typingIndicator","appendTo","typingDuration","lastTypingMessage","sendWsMessage","newBalance","portfolio","portfolioWindow","portfolioData","updateCoinRow","symbol","amount","available","price","cost","coinSendSelector","coinSendBalance","balance","windows"],"mappings":"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"}