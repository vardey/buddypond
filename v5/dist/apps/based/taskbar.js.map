{"version":3,"file":"taskbar.js","sources":["../../../apps/based/ui/Window/StartPanel.js","../../../apps/based/ui/Window/TaskBar.js","../../../apps/based/taskbar/taskbar.js"],"sourcesContent":["/* StartPanel.js - Marak Squires 2025 - BuddyPond */\nexport default class StartPanel {\n    constructor({ onAppLaunch, bp } = {}) {\n        this.onAppLaunch = onAppLaunch || function () { };\n        this.bp = bp;\n        this.panelElement = null;\n    }\n\n    open() {\n        if (this.panelElement) {\n            this.close();\n            return;\n        }\n\n        const panel = document.createElement('div');\n        panel.className = 'start-panel';\n        panel.style.display = 'none'; // hide initially for animation\n\n        const searchInput = document.createElement('input');\n        searchInput.id = 'start-panel-search';\n        searchInput.className = 'start-panel-search';\n        searchInput.type = 'text';\n        searchInput.placeholder = 'Search apps...';\n        searchInput.autocomplete = 'off';\n\n        const recentSection = document.createElement('div');\n        recentSection.className = 'start-panel-section';\n        recentSection.innerHTML = `<h3>Recent Apps</h3>`;\n        const recentGrid = document.createElement('div');\n        recentGrid.className = 'start-panel-grid';\n        recentSection.appendChild(recentGrid);\n\n        const allSection = document.createElement('div');\n        allSection.className = 'start-panel-section';\n        allSection.innerHTML = `<h3>All Apps</h3>`;\n        const allGrid = document.createElement('div');\n        allGrid.className = 'start-panel-grid';\n        allSection.appendChild(allGrid);\n\n        panel.appendChild(searchInput);\n        panel.appendChild(recentSection);\n        panel.appendChild(allSection);\n\n        document.body.appendChild(panel);\n        this.panelElement = panel;\n        // Animate it in\n        $(panel).css({\n            display: 'block',\n            opacity: 1,\n            transform: 'translateY(100%)',\n            transition: 'all 300ms ease-out'\n        });\n\n        requestAnimationFrame(() => {\n            $(panel).css({\n                opacity: 1,\n                transform: 'translateY(0)'\n            });\n        });\n\n        const recentApps = (window.bp?.apps?.ui?.recentApps || []).slice(0, 10);\n        recentApps.forEach(appData => {\n            // replace legacy app icons with webp\n            appData.icon = appData.icon ? appData.icon.replace('.png', '.webp') : '';\n            const app = this.createAppTile(appData);\n            recentGrid.appendChild(app);\n        });\n\n        const appList = window.bp?.apps?.list || {};\n        const allAppEntries = Object.entries(appList);\n        allAppEntries.forEach(([appName, appData]) => {\n            if (appData.adminOnly && this.bp.me !== 'Marak') return;\n            if (appData.enumerable === false) return;\n            appData.app = appData.app || appName;\n            appData.id = appData.id || appName;\n            const app = this.createAppTile(appData, appData.icon);\n            allGrid.appendChild(app);\n        });\n\n        searchInput.addEventListener('input', () => {\n            const query = searchInput.value.toLowerCase();\n            recentSection.style.display = query.length > 0 ? 'none' : '';\n            allGrid.querySelectorAll('.start-panel-app').forEach(el => {\n                const label = el.dataset.name.toLowerCase();\n                const _app = this.bp.apps.list[el.dataset.id];\n                let showResult = label.includes(query);\n                if (!showResult && _app?.alias) {\n                    showResult = _app.alias.some(alias => alias.toLowerCase().includes(query));\n                }\n                if (!showResult && _app?.categories) {\n                    showResult = _app.categories.some(cat => cat.toLowerCase().includes(query));\n                }\n                el.style.display = showResult ? 'flex' : 'none';\n            });\n        });\n\n        this.closeEventHandler = (event) => {\n            if ($(event.target).hasClass('taskbar-item')) return;\n            if (this.panelElement && !this.panelElement.contains(event.target) && event.target !== searchInput) {\n                this.close();\n            }\n        };\n\n        document.addEventListener('click', this.closeEventHandler);\n        if (!this.bp.isMobile()) {\n            // Remark: We don't want to focus the search input on mobile devices, since this brings up the keyboard\n            searchInput.focus();\n        }\n    }\n\n\n    close() {\n        if (this.panelElement) {\n            const $panel = $(this.panelElement);\n\n            $panel.css({\n                transform: 'translateY(0)',\n                opacity: 1,\n                transition: 'all 300ms ease-in'\n            });\n\n            requestAnimationFrame(() => {\n                $panel.css({\n                    transform: 'translateY(100%)',\n                    opacity: 1\n                });\n\n                setTimeout(() => {\n                    $panel.remove();\n                    this.panelElement = null;\n                }, 300); // match transition duration\n            });\n        }\n\n        if (this.closeEventHandler) {\n            document.removeEventListener('click', this.closeEventHandler);\n            this.closeEventHandler = null;\n        }\n    }\n\n    createAppTile(appData, icon) {\n        // console.log('Creating app tile for:', appData);\n        let name = appData.id || appData.appName || appData.name || appData.label || 'Unknown App';\n        icon = appData.icon || icon || '';\n        const tile = document.createElement('div');\n        tile.className = 'start-panel-app';\n        tile.dataset.name = name;\n        tile.dataset.id = appData.id || appData.app || name;\n        tile.dataset.app = appData.app || appData.id || name;\n        if (!icon && appData.type === 'buddy' && this.bp.apps.buddylist) {\n            // Remark: special case for default dicebar avatars for buddies\n            let defautSvgAvatar = this.bp.apps.buddylist.defaultAvatarSvg(appData.id.replace('messages/', ''));\n            const svgContainer = document.createElement('div');\n            svgContainer.className = 'start-panel-app-icon';\n            svgContainer.innerHTML = defautSvgAvatar;\n            tile.appendChild(svgContainer);\n        } else {\n            const img = document.createElement('img');\n            // check if icon already starts with http \n            if (!icon.startsWith('http')) {\n              img.src = this.bp.config.host + '/' + icon;\n            } else {\n              img.src = icon;\n            }\n            img.alt = name;\n            tile.appendChild(img);\n        }\n\n        const label = document.createElement('div');\n        label.textContent = appData.label || name;\n\n        tile.appendChild(label);\n\n        tile.onclick = async () => {\n            // TODO: this should be handled when adding the item to the recent apps list\n            if (appData.type === 'buddy' && appData.app === 'buddylist') {\n                appData.context = appData.id.replace('messages/', '');\n            }\n            let win = await this.bp.open(appData.app || appData.id, { context: appData.context, type: appData.type });\n            this.onAppLaunch(name);\n            this.close();\n        };\n\n        return tile;\n    }\n}\n\n// Enable keyboard navigation for the start panel\nStartPanel.prototype.enableKeyboardNavigation = function (panel, searchInput) {\n    // Add keyboard navigation\n    let currentIndex = -1;\n    let appTiles = [];\n\n    function updateTilesList() {\n        appTiles = Array.from(panel.querySelectorAll('.start-panel-app'))\n            .filter(el => el.style.display !== 'none');\n    }\n    updateTilesList();\n\n    // Add highlight class\n    function focusTile(index) {\n        console.log('Focusing tile at index:', index);\n        appTiles.forEach((el, i) => {\n            el.classList.toggle('focused', i === index);\n            if (i === index) el.scrollIntoView({ block: 'nearest' });\n        });\n        currentIndex = index;\n    }\n\n    // Clear highlight\n    function clearFocus() {\n        appTiles.forEach(el => el.classList.remove('focused'));\n        currentIndex = -1;\n    }\n\n    searchInput.addEventListener('keydown', (e) => {\n        if (e.key === 'ArrowDown') {\n            updateTilesList();\n            if (appTiles.length > 0) {\n                focusTile(0);\n                e.preventDefault();\n            }\n        }\n    });\n\n    let ROW_LENGTH = 5;\n\n    panel.addEventListener('keydown', (e) => {\n        console.log('Key pressed:', e.key);\n        if (appTiles.length === 0) return;\n\n\n        // tab key should select the first tile\n        if (e.key === 'Tab') {\n            // TODO: shift tab should select the last tile\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                // Move to next tile\n                let nextIndex = currentIndex + 1;\n                if (nextIndex < appTiles.length) {\n                    focusTile(nextIndex);\n                } else {\n                    // Stay on last tile if next tile is out of bounds\n                    focusTile(appTiles.length - 1);\n                }\n            }\n            e.preventDefault();\n            return;\n        }\n\n        if (e.key === 'ArrowDown') {\n            // ✅ If nothing is focused, focus first tile\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                // ✅ Move down one row\n                let nextIndex = currentIndex + ROW_LENGTH;\n                if (nextIndex < appTiles.length) {\n                    focusTile(nextIndex);\n                } else {\n                    // Stay on last tile if next row is out of bounds\n                    focusTile(appTiles.length - 1);\n                }\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'ArrowUp') {\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                // ✅ Move up one row\n                let prevIndex = currentIndex - ROW_LENGTH;\n                if (prevIndex >= 0) {\n                    focusTile(prevIndex);\n                } else {\n                    // Stay on first tile if already in top row\n                    focusTile(0);\n                }\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'ArrowRight') {\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                focusTile(Math.min(currentIndex + 1, appTiles.length - 1));\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'ArrowLeft') {\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                focusTile(Math.max(currentIndex - 1, 0));\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'Enter' && currentIndex >= 0) {\n            appTiles[currentIndex].click();\n            e.preventDefault();\n        }\n\n        if (e.key === 'Escape') {\n            clearFocus();\n            searchInput.focus();\n        }\n    });\n}","import StartPanel from \"./StartPanel.js\";\n\nexport default class TaskBar {\n    constructor({ homeCallback, bp } = {}) {\n        this.taskBarElement = document.createElement(\"div\");\n        this.taskBarElement.className = \"taskbar-container\";\n        document.body.appendChild(this.taskBarElement);\n\n        // Create containers for anchored and scrollable items\n        this.taskbarLeft = document.createElement(\"div\");\n        this.taskbarLeft.className = \"taskbar-left\";\n        this.taskBarElement.appendChild(this.taskbarLeft);\n\n        this.taskbarItems = document.createElement(\"div\");\n        this.taskbarItems.className = \"taskbar-items\";\n        this.taskBarElement.appendChild(this.taskbarItems);\n\n        this.taskbarRight = document.createElement(\"div\");\n        this.taskbarRight.className = \"taskbar-right\";\n        this.taskBarElement.appendChild(this.taskbarRight);\n\n        this.bp = bp; // Reference to the base platform instance\n        this.items = new Map(); // id -> config\n        this.shortcuts = new Set(); // id\n\n        // Add scroll listener for indicator visibility\n        this.taskbarItems.addEventListener('scroll', () => {\n            const isAtEnd = this.taskbarItems.scrollLeft + this.taskbarItems.clientWidth >= this.taskbarItems.scrollWidth - 1;\n            console.log(\"Scroll end reached:\", isAtEnd);\n            this.taskbarItems.setAttribute('data-scroll-end', isAtEnd);\n        });\n\n        function openStartPanel() {\n            if (!this.startPanel) {\n                this.startPanel = new StartPanel({ bp: this.bp });\n            }\n            this.startPanel.open();\n        }\n\n        // Add \"home\" button (anchored right)\n        if (homeCallback) {\n            this.addItem({\n                id: \"home\",\n                label: \"Home\",\n                onClick: openStartPanel,\n                icon: \"desktop/assets/images/icons/icon_mantra_64.webp\",\n                isShortcut: true,\n                anchor: \"right\"\n            });\n        }\n\n        // Add \"settings\" button (anchored left on mobile)\n        if (this.bp.isMobile()) {\n            this.addItem({\n                id: \"settings\",\n                label: \"Settings\",\n                onClick: (e) => {\n                    e.stopPropagation();\n                    const $menu = $('.menu-bar'); // TODO: Reference class property, not DOM\n                    if ($menu.hasClass(\"mobile-active\")) {\n                        $menu.animate({ left: \"-100%\" }, 300, () => {\n                            $menu.removeClass(\"mobile-active\");\n                        });\n                    } else {\n                        $menu\n                            .css({ left: \"-100%\", display: \"flex\" })\n                            .addClass(\"mobile-active\")\n                            .animate({ left: \"0%\" }, 300);\n                    }\n                },\n                icon: \"desktop/assets/images/icons/icon_settings_64.webp\",\n                isShortcut: true,\n                anchor: \"left\"\n            });\n        }\n        // Handle context menu (desktop)\n        this.taskBarElement.addEventListener('contextmenu', (e) => {\n            e.preventDefault();\n            const target = e.target.closest('.taskbar-item');\n            if (!target) return;\n            const id = target.dataset.id;\n            if (!id || id === 'home' || id === 'settings') return; // Exclude anchored items\n            this.showContextMenu(id, e.clientX, e.clientY);\n        });\n\n        // Handle long-press context menu (mobile)\n        if (this.bp.isMobile()) {\n            let pressTimer = null;\n            let startX = 0, startY = 0;\n\n            this.taskBarElement.addEventListener('touchstart', (e) => {\n\n                // e.preventDefault();\n                const touch = e.touches[0];\n                const target = e.target.closest('.taskbar-item');\n                if (!target) return;\n                const id = target.dataset.id;\n                if (!id || id === 'home' || id === 'settings') return;\n\n                startX = touch.clientX;\n                startY = touch.clientY;\n\n                pressTimer = setTimeout(() => {\n                    // Haptic feedback\n                    if (navigator.vibrate) {\n                        navigator.vibrate(10); // 10ms pulse\n                    }\n                    this.showContextMenu(id, startX, startY);\n                }, 600); // Long press threshold\n            });\n\n            this.taskBarElement.addEventListener('touchend', () => {\n                clearTimeout(pressTimer);\n            });\n\n            this.taskBarElement.addEventListener('touchmove', () => {\n                clearTimeout(pressTimer); // Cancel if finger moves\n            });\n        }\n\n        this.enableDragAndDrop();\n    }\n\n    showContextMenu(id, x, y) {\n        const existing = document.querySelector('.taskbar-context-menu');\n        if (existing) existing.remove();\n\n        const item = this.items.get(id);\n        if (!item) return;\n\n        const menu = document.createElement('div');\n        menu.className = 'taskbar-context-menu';\n        menu.style.position = 'fixed';\n        menu.style.left = `${x}px`;\n        menu.style.visibility = 'hidden';\n        document.body.appendChild(menu);\n\n        const makeOption = (label, handler) => {\n            const option = document.createElement('div');\n            option.className = 'taskbar-context-menu-item';\n            option.textContent = label;\n            option.onclick = () => {\n                handler();\n                this.startPanel.close();\n                menu.remove();\n            };\n            menu.appendChild(option);\n        };\n\n        if (item.isOpen) {\n            makeOption('Close', () => this.closeItem(id));\n        } else {\n            makeOption('Open', () => this.openItem(item));\n        }\n\n        if (this.shortcuts.has(id)) {\n            makeOption('Unpin from Taskbar', () => {\n                this.shortcuts.delete(id);\n                if (!item.isOpen) {\n                    this.removeItem(id);\n                }\n            });\n        } else {\n            if (item.app !== 'buddylist' && id !== 'buddylist' && item.app !== 'emulator') {\n                makeOption('Keep in Taskbar', () => {\n                    this.shortcuts.add(item.app || id);\n                    let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n                    installedTaskBarApps[item.app || id] = {\n                        app: item.app || id,\n                        context: item.context || 'default',\n                        label: item.label || id,\n                        icon: item.icon || ''\n                    };\n                    this.bp.set('taskbar_apps', installedTaskBarApps);\n                });\n            }\n        }\n\n        requestAnimationFrame(() => {\n            const menuHeight = menu.offsetHeight;\n            const viewportHeight = window.innerHeight;\n            let top = y - menuHeight - 4;\n            if (top < 0) {\n                top = y + 4;\n            }\n            menu.style.top = `${top}px`;\n            menu.style.visibility = 'visible';\n        });\n\n        const removeMenu = () => menu.remove();\n        setTimeout(() => {\n            window.addEventListener('click', removeMenu, { once: true });\n            window.addEventListener('contextmenu', removeMenu, { once: true });\n        }, 0);\n    }\n\n    // same as addItem ( calls into addItem )\n    // except it also saves the item to localStorage\n    // this is used when the user explicitly pins an app to the taskbar from outside API\n    saveItem(config) {\n        // first add the item to the taskbar\n        config.isShortcut = true; // Ensure it's treated as a shortcut\n        const itemElement = this.addItem(config);\n        if (!itemElement) return;\n\n        let { app, id, context, label = \"\", onClick, icon, isShortcut = true, anchor } = config;\n\n        let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n        if (id !== 'home' && id !== 'settings') {\n            installedTaskBarApps[app || id] = {\n                id: id,\n                app: app || id,\n                context: context || 'default',\n                label: label || id,\n                icon: icon || ''\n            };\n            this.bp.set('taskbar_apps', installedTaskBarApps);\n        }\n\n    }\n\n    addItem(config) {\n        let { app, id, context, label = \"\", onClick, icon, isShortcut = true, anchor } = config;\n        if (typeof onClick !== 'function') {\n            onClick = async (ev, itemElement) => {\n                let existingWindow = this.bp.apps.ui.windowManager.getWindow(id);\n                if (!existingWindow) {\n                    let win = await this.bp.open(app || id, { context });\n                } else {\n                    if (existingWindow.isMinimized) {\n                        existingWindow.restore();\n                        existingWindow.focus();\n                    } else {\n                        existingWindow.minimize();\n                    }\n                }\n                if (this.startPanel) {\n                    this.startPanel.close();\n                }\n                ev.stopPropagation();\n            };\n        }\n\n        let existing = this.taskBarElement.querySelector(`[data-id=\"${id}\"]`);\n        if (existing) return existing;\n\n        const itemElement = document.createElement(\"div\");\n        itemElement.className = \"taskbar-item\";\n        itemElement.dataset.id = id;\n        itemElement.draggable = id !== 'home' && id !== 'settings'; // Disable drag for anchored items\n\n        if (!this.bp.isMobile()) {\n            const itemText = document.createElement(\"div\");\n            itemText.className = \"taskbar-item-text\";\n            itemText.textContent = label;\n            itemElement.appendChild(itemText);\n        }\n\n        if (!icon && app === 'buddylist' && this.bp.apps.buddylist) {\n            // Remark: special case for default dicebar avatars for buddies\n            let defautSvgAvatar = this.bp.apps.buddylist.defaultAvatarSvg(context.replace('messages/', ''));\n            const svgContainer = document.createElement('div');\n            svgContainer.className = 'start-panel-app-icon';\n            svgContainer.innerHTML = defautSvgAvatar;\n            svgContainer.title = context;\n            label = label || context.replace('messages/', '');\n            // itemText.textContent = label; // Update text content with context\n            itemElement.appendChild(svgContainer);\n        } else if (icon) {\n            const itemIcon = document.createElement(\"img\");\n            // check if icon already starts with http\n            if (!icon.startsWith('http')) {\n              itemIcon.src = this.bp.config.host + '/' + icon;\n            } else {\n              itemIcon.src = icon;\n            }\n            itemIcon.height = 32;\n            itemIcon.width = 32;\n            itemIcon.alt = label;\n            itemElement.appendChild(itemIcon);\n        } else {\n            itemElement.textContent = label;\n        }\n\n        itemElement.onclick = (ev) => {\n            if (onClick) onClick.call(this, ev, itemElement);\n            this.alertItem(id);\n        };\n\n        if (isShortcut) {\n            this.shortcuts.add(id);\n        }\n\n        // Append to appropriate container\n        if (id === 'home' && anchor === 'right') {\n            this.taskbarRight.appendChild(itemElement);\n        } else if (id === 'settings' && anchor === 'left') {\n            this.taskbarLeft.appendChild(itemElement);\n        } else {\n            this.taskbarItems.appendChild(itemElement);\n            // Scroll to the newly added item\n            if (this.bp.isMobile()) {\n                requestAnimationFrame(() => {\n                    itemElement.scrollIntoView({ behavior: 'smooth', inline: 'start' });\n                });\n            }\n        }\n\n        this.items.set(id, {\n            ...config,\n            element: itemElement,\n            isOpen: false,\n            isShortcut: isShortcut\n        });\n\n        return itemElement;\n    }\n\n    openItem(config) {\n        let item = this.items.get(config.id);\n        if (item) {\n            item.isOpen = true;\n            item.element.classList.add(\"taskbar-item-open\");\n            // Scroll to the opened item\n            if (this.bp.isMobile()) {\n                requestAnimationFrame(() => {\n                    item.element.scrollIntoView({ behavior: 'smooth', inline: 'start' });\n                });\n            }\n        } else {\n            this.addItem({ ...config, isShortcut: false });\n            this.openItem(config); // Scroll happens in addItem\n        }\n    }\n\n    closeItem(id) {\n        const item = this.items.get(id);\n        if (!item) return;\n\n        item.isOpen = false;\n        item.element.classList.remove(\"taskbar-item-open\");\n\n        if (!this.shortcuts.has(id)) {\n            this.removeItem(id);\n        }\n\n        const win = this.bp.apps.ui.windowManager.getWindow(id);\n        if (win) {\n            win.close();\n        } else {\n            console.warn(`No window found with ID: ${id}`);\n        }\n    }\n\n    removeItem(id) {\n        const item = this.items.get(id);\n        if (!item) return;\n\n        item.element.parentNode.removeChild(item.element);\n        this.items.delete(id);\n        this.shortcuts.delete(id);\n\n        let taskBarApps = this.bp.settings.taskbar_apps || {};\n        if (taskBarApps[id]) {\n            delete taskBarApps[id];\n            this.bp.set('taskbar_apps', taskBarApps);\n        }\n    }\n\n    getItem(id) {\n        return this.items.get(id);\n    }\n\n    alertItem(id) {\n        const item = this.items.get(id);\n        if (item) {\n            item.element.classList.add(\"taskbar-item-alert\");\n            setTimeout(() => item.element.classList.remove(\"taskbar-item-alert\"), 1000);\n        }\n    }\n\n    enableDragAndDrop() {\n\n        let dragged = null;\n\n        this.taskbarItems.addEventListener(\"dragstart\", (e) => {\n            dragged = e.target.closest(\".taskbar-item\");\n            if (dragged && (dragged.dataset.id === 'home' || dragged.dataset.id === 'settings')) {\n                e.preventDefault(); // Prevent dragging anchored items\n                dragged = null;\n            }\n        });\n\n        this.taskbarItems.addEventListener(\"dragover\", (e) => {\n            e.preventDefault();\n            const over = e.target.closest(\".taskbar-item\");\n            if (dragged && over && dragged !== over && over.dataset.id !== 'home' && over.dataset.id !== 'settings') {\n                const draggedIndex = [...this.taskbarItems.children].indexOf(dragged);\n                const overIndex = [...this.taskbarItems.children].indexOf(over);\n                if (draggedIndex < overIndex) {\n                    this.taskbarItems.insertBefore(over, dragged);\n                } else {\n                    this.taskbarItems.insertBefore(dragged, over);\n                }\n            }\n        });\n\n        this.taskbarItems.addEventListener(\"dragend\", () => {\n            if (dragged) {\n                const newOrder = Array.from(this.taskbarItems.children).map(item => item.dataset.id);\n                // references the saved / pinned taskbar apps\n                let taskBarApps = this.bp.settings.taskbar_apps || {};\n                const newTaskBarApps = {};\n                newOrder.forEach(id => {\n                    // only save the order of taskbar apps that are currently pinned\n                    if (taskBarApps[id]) {\n                        let _app = taskBarApps[id];\n                        newTaskBarApps[id] = _app;\n                    }\n                });\n                this.bp.set('taskbar_apps', newTaskBarApps);\n            }\n            dragged = null;\n        });\n    }\n}","import TaskBar from '../ui/Window/TaskBar.js';\n\nexport default class TaskBarApp {\n  constructor(bp, options = {}) {\n    this.bp = bp;\n    return this;\n  }\n\n  async init() {\n    return 'loaded TaskBarApp';\n  }\n\n  async open(options = {}) {\n\n    if (this.taskBar) {\n      console.log('TaskBar already open');\n      //$('.taskbar-container').css('display', 'flex').hide().fadeIn({ easing: 'linear', duration: 555 });\n      return;\n    }\n    // Remark: Why is TaskBar in the WindowManager?\n    // shouldn't this be in the UI class?\n    this.taskBar = new TaskBar({\n      bp: this.bp,\n      homeCallback: () => {\n\n        if (!this.state) {\n          // save current window positions\n          this.lastPositionsBeforeArranged = this.windows.map(w => {\n            return {\n              x: w.x,\n              y: w.y,\n              height: w.height,\n              width: w.width\n            }\n          });\n          // console.log('lastPositionsBeforeArranged', this.lastPositionsBeforeArranged);\n          this.state = 'maximized';\n        }\n\n        if (this.state === 'minimized') {\n          this.minimizeAllWindows();\n          // this.arrangeHorizontalStacked();\n          this.state = 'maximized';\n\n        } else if (this.state === 'stacked-vertical') {\n          // stack-vertical has been removed ( for now )\n          // it wasn't looking good as a default and was rarely used\n          /*\n          // restore all windows to their previous positions\n          this.windows.forEach((w, i) => {\n              w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n              w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n          });\n          this.state = 'maximized';\n          */\n\n        } else if (this.state === 'stacked-horizontal') {\n          // this.arrangeVerticalStacked();\n          // this.state = 'stacked-vertical';\n          // restore all windows to their previous positions\n          this.windows.forEach((w, i) => {\n            w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n            w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n          });\n          this.state = 'maximized';\n\n        } else {\n          this.minimizeAllWindows(true);\n          this.windows.forEach((w, i) => {\n            w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n            w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n          });\n\n          this.state = 'minimized';\n\n        }\n\n        // close all windows\n        // this.minimizeAllWindows();\n        // this.windowsClosed = true;\n\n        // hide all legacy BP windows\n        $('.window').hide();\n        $('.window').removeClass('window_stack');\n\n      }\n    });\n\n    let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n\n    if (Object.keys(installedTaskBarApps).length === 0) {\n\n        let defaultTaskBarApps = [\n            'file-explorer',\n            'pad',\n            'buddylist',\n            // 'pond',\n            'portfolio',\n        ];\n\n        if (this.bp.isMobile()) {\n            defaultTaskBarApps = [\n                'buddylist',\n                // 'pond',\n                'portfolio',\n                'coin',\n                //'youtube',\n                'fluid-simulation',\n            ]\n        }\n\n        defaultTaskBarApps.forEach(appName => {\n            let app = this.bp.apps.list[appName];\n            if (app) {\n                // console.log(`Adding default taskbar app: ${appName}`);\n                installedTaskBarApps[appName] = {\n                    app: app.app || appName,\n                    context: app.context || 'default',\n                    label: app.label || appName,\n                    icon: app.icon || ''\n                };\n            } else {\n                console.warn(`App ${appName} not found in desktop app list.`);\n            }\n        });\n    }\n\n    Object.keys(installedTaskBarApps).forEach(appName => {\n        let savedApp = installedTaskBarApps[appName];\n        //console.log('Adding taskbar app', appName);\n        //console.log(this.bp.apps.list)\n        // console.log('savedApp', appName, savedApp);\n        let app = this.bp.apps.list[savedApp.id || appName];\n        if (!app) {\n            console.warn(`App ${appName} not found in desktop app list.`);\n            return;\n        }\n\n        app.id = appName; // ensure the app has an id for taskbar\n        app.app = app.app || appName; // ensure the app has an app property\n        // create new app object with necessary properties\n        let _app = {\n            ...app\n        }\n        if (_app) {\n            // console.log(`Adding default taskbar app: ${appName}`, _app);\n            this.taskBar.saveItem(_app);\n        } else {\n            console.warn(`App ${appName} not found in desktop app list.`);\n        }\n    });\n\n     $('.taskbar-container').css('display', 'flex').hide().fadeIn({ easing: 'linear', duration: 555 });\n  }\n}"],"names":["StartPanel","constructor","onAppLaunch","bp","this","panelElement","open","close","panel","document","createElement","className","style","display","searchInput","id","type","placeholder","autocomplete","recentSection","innerHTML","recentGrid","appendChild","allSection","allGrid","body","$","css","opacity","transform","transition","requestAnimationFrame","window","apps","ui","recentApps","slice","forEach","appData","icon","replace","app","createAppTile","appList","list","Object","entries","appName","adminOnly","me","enumerable","addEventListener","query","value","toLowerCase","length","querySelectorAll","el","label","dataset","name","_app","showResult","includes","alias","some","categories","cat","closeEventHandler","event","target","hasClass","contains","isMobile","focus","$panel","setTimeout","remove","removeEventListener","tile","buddylist","defautSvgAvatar","defaultAvatarSvg","svgContainer","img","startsWith","src","config","host","alt","textContent","onclick","async","context","prototype","enableKeyboardNavigation","currentIndex","appTiles","updateTilesList","Array","from","filter","focusTile","index","console","log","i","classList","toggle","scrollIntoView","block","e","key","preventDefault","nextIndex","prevIndex","Math","min","max","click","TaskBar","homeCallback","taskBarElement","taskbarLeft","taskbarItems","taskbarRight","items","Map","shortcuts","Set","isAtEnd","scrollLeft","clientWidth","scrollWidth","setAttribute","addItem","onClick","startPanel","isShortcut","anchor","stopPropagation","$menu","animate","left","removeClass","addClass","closest","showContextMenu","clientX","clientY","pressTimer","startX","startY","touch","touches","navigator","vibrate","clearTimeout","enableDragAndDrop","x","y","existing","querySelector","item","get","menu","position","visibility","makeOption","handler","option","isOpen","closeItem","openItem","has","delete","removeItem","add","installedTaskBarApps","settings","taskbar_apps","set","menuHeight","offsetHeight","top","removeMenu","once","saveItem","ev","itemElement","existingWindow","windowManager","getWindow","isMinimized","restore","minimize","draggable","itemText","title","itemIcon","height","width","call","alertItem","behavior","inline","element","win","warn","parentNode","removeChild","taskBarApps","getItem","dragged","over","children","indexOf","insertBefore","newOrder","map","newTaskBarApps","TaskBarApp","options","init","taskBar","state","lastPositionsBeforeArranged","windows","w","minimizeAllWindows","move","setSize","hide","keys","defaultTaskBarApps","savedApp","fadeIn","easing","duration"],"mappings":"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"}