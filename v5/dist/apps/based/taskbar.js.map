{"version":3,"file":"taskbar.js","sources":["../../../apps/based/ui/Window/StartPanel.js","../../../apps/based/ui/Window/TaskBar.js","../../../apps/based/taskbar/taskbar.js"],"sourcesContent":["/* StartPanel.js - Marak Squires 2025 - BuddyPond */\nexport default class StartPanel {\n    constructor({ onAppLaunch, bp } = {}) {\n        this.onAppLaunch = onAppLaunch || function () { };\n        this.bp = bp;\n        this.panelElement = null;\n    }\n\n    open() {\n        if (this.panelElement) {\n            this.close();\n            return;\n        }\n\n        const panel = document.createElement('div');\n        panel.className = 'start-panel';\n        panel.style.display = 'none'; // hide initially for animation\n\n        const searchInput = document.createElement('input');\n        searchInput.id = 'start-panel-search';\n        searchInput.className = 'start-panel-search';\n        searchInput.type = 'text';\n        searchInput.placeholder = 'Search apps...';\n        searchInput.autocomplete = 'off';\n\n        const recentSection = document.createElement('div');\n        recentSection.className = 'start-panel-section';\n        recentSection.innerHTML = `<h3>Recent Apps</h3>`;\n        const recentGrid = document.createElement('div');\n        recentGrid.className = 'start-panel-grid';\n        recentSection.appendChild(recentGrid);\n\n        const allSection = document.createElement('div');\n        allSection.className = 'start-panel-section';\n        allSection.innerHTML = `<h3>All Apps</h3>`;\n        const allGrid = document.createElement('div');\n        allGrid.className = 'start-panel-grid';\n        allSection.appendChild(allGrid);\n\n        panel.appendChild(searchInput);\n        panel.appendChild(recentSection);\n        panel.appendChild(allSection);\n\n        document.body.appendChild(panel);\n        this.panelElement = panel;\n        // Animate it in\n        $(panel).css({\n            display: 'block',\n            opacity: 1,\n            transform: 'translateY(100%)',\n            transition: 'all 300ms ease-out'\n        });\n\n        requestAnimationFrame(() => {\n            $(panel).css({\n                opacity: 1,\n                transform: 'translateY(0)'\n            });\n        });\n\n        const recentApps = (window.bp?.apps?.ui?.recentApps || []).slice(0, 10);\n        recentApps.forEach(appData => {\n            const app = this.createAppTile(appData);\n            recentGrid.appendChild(app);\n        });\n\n        const appList = window.bp?.apps?.list || {};\n        const allAppEntries = Object.entries(appList);\n        allAppEntries.forEach(([appName, appData]) => {\n            if (appData.adminOnly && this.bp.me !== 'Marak') return;\n            appData.app = appData.app || appName;\n            appData.id = appData.id || appName;\n            const app = this.createAppTile(appData, appData.icon);\n            allGrid.appendChild(app);\n        });\n\n        searchInput.addEventListener('input', () => {\n            const query = searchInput.value.toLowerCase();\n            recentSection.style.display = query.length > 0 ? 'none' : '';\n            allGrid.querySelectorAll('.start-panel-app').forEach(el => {\n                const label = el.dataset.name.toLowerCase();\n                const _app = this.bp.apps.list[el.dataset.id];\n                let showResult = label.includes(query);\n                if (!showResult && _app?.alias) {\n                    showResult = _app.alias.some(alias => alias.toLowerCase().includes(query));\n                }\n                if (!showResult && _app?.categories) {\n                    showResult = _app.categories.some(cat => cat.toLowerCase().includes(query));\n                }\n                el.style.display = showResult ? 'flex' : 'none';\n            });\n        });\n\n        this.closeEventHandler = (event) => {\n            if ($(event.target).hasClass('taskbar-item')) return;\n            if (this.panelElement && !this.panelElement.contains(event.target) && event.target !== searchInput) {\n                this.close();\n            }\n        };\n\n        document.addEventListener('click', this.closeEventHandler);\n        if (!this.bp.isMobile()) {\n            // Remark: We don't want to focus the search input on mobile devices, since this brings up the keyboard\n            searchInput.focus();\n        }\n    }\n\n\n    close() {\n        if (this.panelElement) {\n            const $panel = $(this.panelElement);\n\n            $panel.css({\n                transform: 'translateY(0)',\n                opacity: 1,\n                transition: 'all 300ms ease-in'\n            });\n\n            requestAnimationFrame(() => {\n                $panel.css({\n                    transform: 'translateY(100%)',\n                    opacity: 1\n                });\n\n                setTimeout(() => {\n                    $panel.remove();\n                    this.panelElement = null;\n                }, 300); // match transition duration\n            });\n        }\n\n        if (this.closeEventHandler) {\n            document.removeEventListener('click', this.closeEventHandler);\n            this.closeEventHandler = null;\n        }\n    }\n\n    createAppTile(appData, icon) {\n        // console.log('Creating app tile for:', appData);\n        let name = appData.id || appData.appName || appData.name || appData.label || 'Unknown App';\n        icon = appData.icon || icon;\n        const tile = document.createElement('div');\n        tile.className = 'start-panel-app';\n        tile.dataset.name = name;\n        tile.dataset.id = appData.id || appData.app || name;\n        tile.dataset.app = appData.app || appData.id || name;\n        if (!icon && appData.type === 'buddy' && this.bp.apps.buddylist) {\n            // Remark: special case for default dicebar avatars for buddies\n            let defautSvgAvatar = this.bp.apps.buddylist.defaultAvatarSvg(appData.id.replace('messages/', ''));\n            const svgContainer = document.createElement('div');\n            svgContainer.className = 'start-panel-app-icon';\n            svgContainer.innerHTML = defautSvgAvatar;\n            tile.appendChild(svgContainer);\n        } else {\n            const img = document.createElement('img');\n            // check if icon already starts with http \n            if (!icon.startsWith('http')) {\n              img.src = this.bp.config.host + '/' + icon;\n            } else {\n              img.src = icon;\n            }\n            img.alt = name;\n            tile.appendChild(img);\n        }\n\n        const label = document.createElement('div');\n        label.textContent = appData.label || name;\n\n        tile.appendChild(label);\n\n        tile.onclick = async () => {\n            // TODO: this should be handled when adding the item to the recent apps list\n            if (appData.type === 'buddy' && appData.app === 'buddylist') {\n                appData.context = appData.id.replace('messages/', '');\n            }\n            let win = await this.bp.open(appData.app || appData.id, { context: appData.context, type: appData.type });\n            this.onAppLaunch(name);\n            this.close();\n        };\n\n        return tile;\n    }\n}\n\n// Enable keyboard navigation for the start panel\nStartPanel.prototype.enableKeyboardNavigation = function (panel, searchInput) {\n    // Add keyboard navigation\n    let currentIndex = -1;\n    let appTiles = [];\n\n    function updateTilesList() {\n        appTiles = Array.from(panel.querySelectorAll('.start-panel-app'))\n            .filter(el => el.style.display !== 'none');\n    }\n    updateTilesList();\n\n    // Add highlight class\n    function focusTile(index) {\n        console.log('Focusing tile at index:', index);\n        appTiles.forEach((el, i) => {\n            el.classList.toggle('focused', i === index);\n            if (i === index) el.scrollIntoView({ block: 'nearest' });\n        });\n        currentIndex = index;\n    }\n\n    // Clear highlight\n    function clearFocus() {\n        appTiles.forEach(el => el.classList.remove('focused'));\n        currentIndex = -1;\n    }\n\n    searchInput.addEventListener('keydown', (e) => {\n        if (e.key === 'ArrowDown') {\n            updateTilesList();\n            if (appTiles.length > 0) {\n                focusTile(0);\n                e.preventDefault();\n            }\n        }\n    });\n\n    let ROW_LENGTH = 5;\n\n    panel.addEventListener('keydown', (e) => {\n        console.log('Key pressed:', e.key);\n        if (appTiles.length === 0) return;\n\n\n        // tab key should select the first tile\n        if (e.key === 'Tab') {\n            // TODO: shift tab should select the last tile\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                // Move to next tile\n                let nextIndex = currentIndex + 1;\n                if (nextIndex < appTiles.length) {\n                    focusTile(nextIndex);\n                } else {\n                    // Stay on last tile if next tile is out of bounds\n                    focusTile(appTiles.length - 1);\n                }\n            }\n            e.preventDefault();\n            return;\n        }\n\n        if (e.key === 'ArrowDown') {\n            // ✅ If nothing is focused, focus first tile\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                // ✅ Move down one row\n                let nextIndex = currentIndex + ROW_LENGTH;\n                if (nextIndex < appTiles.length) {\n                    focusTile(nextIndex);\n                } else {\n                    // Stay on last tile if next row is out of bounds\n                    focusTile(appTiles.length - 1);\n                }\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'ArrowUp') {\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                // ✅ Move up one row\n                let prevIndex = currentIndex - ROW_LENGTH;\n                if (prevIndex >= 0) {\n                    focusTile(prevIndex);\n                } else {\n                    // Stay on first tile if already in top row\n                    focusTile(0);\n                }\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'ArrowRight') {\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                focusTile(Math.min(currentIndex + 1, appTiles.length - 1));\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'ArrowLeft') {\n            if (currentIndex === -1) {\n                focusTile(0);\n            } else {\n                focusTile(Math.max(currentIndex - 1, 0));\n            }\n            e.preventDefault();\n        }\n\n        if (e.key === 'Enter' && currentIndex >= 0) {\n            appTiles[currentIndex].click();\n            e.preventDefault();\n        }\n\n        if (e.key === 'Escape') {\n            clearFocus();\n            searchInput.focus();\n        }\n    });\n}","import StartPanel from \"./StartPanel.js\";\n\nexport default class TaskBar {\n    constructor({ homeCallback, bp } = {}) {\n        this.taskBarElement = document.createElement(\"div\");\n        this.taskBarElement.className = \"taskbar-container\";\n        document.body.appendChild(this.taskBarElement);\n\n        // Create containers for anchored and scrollable items\n        this.taskbarLeft = document.createElement(\"div\");\n        this.taskbarLeft.className = \"taskbar-left\";\n        this.taskBarElement.appendChild(this.taskbarLeft);\n\n        this.taskbarItems = document.createElement(\"div\");\n        this.taskbarItems.className = \"taskbar-items\";\n        this.taskBarElement.appendChild(this.taskbarItems);\n\n        this.taskbarRight = document.createElement(\"div\");\n        this.taskbarRight.className = \"taskbar-right\";\n        this.taskBarElement.appendChild(this.taskbarRight);\n\n        this.bp = bp; // Reference to the base platform instance\n        this.items = new Map(); // id -> config\n        this.shortcuts = new Set(); // id\n\n        // Add scroll listener for indicator visibility\n        this.taskbarItems.addEventListener('scroll', () => {\n            const isAtEnd = this.taskbarItems.scrollLeft + this.taskbarItems.clientWidth >= this.taskbarItems.scrollWidth - 1;\n            console.log(\"Scroll end reached:\", isAtEnd);\n            this.taskbarItems.setAttribute('data-scroll-end', isAtEnd);\n        });\n\n        function openStartPanel() {\n            if (!this.startPanel) {\n                this.startPanel = new StartPanel({ bp: this.bp });\n            }\n            this.startPanel.open();\n        }\n\n        // Add \"home\" button (anchored right)\n        if (homeCallback) {\n            this.addItem({\n                id: \"home\",\n                label: \"Home\",\n                onClick: openStartPanel,\n                icon: \"desktop/assets/images/icons/icon_mantra_64.png\",\n                isShortcut: true,\n                anchor: \"right\"\n            });\n        }\n\n        // Add \"settings\" button (anchored left on mobile)\n        if (this.bp.isMobile()) {\n            this.addItem({\n                id: \"settings\",\n                label: \"Settings\",\n                onClick: (e) => {\n                    e.stopPropagation();\n                    const $menu = $('.menu-bar'); // TODO: Reference class property, not DOM\n                    if ($menu.hasClass(\"mobile-active\")) {\n                        $menu.animate({ left: \"-100%\" }, 300, () => {\n                            $menu.removeClass(\"mobile-active\");\n                        });\n                    } else {\n                        $menu\n                            .css({ left: \"-100%\", display: \"flex\" })\n                            .addClass(\"mobile-active\")\n                            .animate({ left: \"0%\" }, 300);\n                    }\n                },\n                icon: \"desktop/assets/images/icons/icon_settings_64.png\",\n                isShortcut: true,\n                anchor: \"left\"\n            });\n        }\n        // Handle context menu (desktop)\n        this.taskBarElement.addEventListener('contextmenu', (e) => {\n            e.preventDefault();\n            const target = e.target.closest('.taskbar-item');\n            if (!target) return;\n            const id = target.dataset.id;\n            if (!id || id === 'home' || id === 'settings') return; // Exclude anchored items\n            this.showContextMenu(id, e.clientX, e.clientY);\n        });\n\n        // Handle long-press context menu (mobile)\n        if (this.bp.isMobile()) {\n            let pressTimer = null;\n            let startX = 0, startY = 0;\n\n            this.taskBarElement.addEventListener('touchstart', (e) => {\n\n                // e.preventDefault();\n                const touch = e.touches[0];\n                const target = e.target.closest('.taskbar-item');\n                if (!target) return;\n                const id = target.dataset.id;\n                if (!id || id === 'home' || id === 'settings') return;\n\n                startX = touch.clientX;\n                startY = touch.clientY;\n\n                pressTimer = setTimeout(() => {\n                    // Haptic feedback\n                    if (navigator.vibrate) {\n                        navigator.vibrate(10); // 10ms pulse\n                    }\n                    this.showContextMenu(id, startX, startY);\n                }, 600); // Long press threshold\n            });\n\n            this.taskBarElement.addEventListener('touchend', () => {\n                clearTimeout(pressTimer);\n            });\n\n            this.taskBarElement.addEventListener('touchmove', () => {\n                clearTimeout(pressTimer); // Cancel if finger moves\n            });\n        }\n\n        this.enableDragAndDrop();\n    }\n\n    showContextMenu(id, x, y) {\n        const existing = document.querySelector('.taskbar-context-menu');\n        if (existing) existing.remove();\n\n        const item = this.items.get(id);\n        if (!item) return;\n\n        const menu = document.createElement('div');\n        menu.className = 'taskbar-context-menu';\n        menu.style.position = 'fixed';\n        menu.style.left = `${x}px`;\n        menu.style.visibility = 'hidden';\n        document.body.appendChild(menu);\n\n        const makeOption = (label, handler) => {\n            const option = document.createElement('div');\n            option.className = 'taskbar-context-menu-item';\n            option.textContent = label;\n            option.onclick = () => {\n                handler();\n                this.startPanel.close();\n                menu.remove();\n            };\n            menu.appendChild(option);\n        };\n\n        if (item.isOpen) {\n            makeOption('Close', () => this.closeItem(id));\n        } else {\n            makeOption('Open', () => this.openItem(item));\n        }\n\n        if (this.shortcuts.has(id)) {\n            makeOption('Unpin from Taskbar', () => {\n                this.shortcuts.delete(id);\n                if (!item.isOpen) {\n                    this.removeItem(id);\n                }\n            });\n        } else {\n            if (item.app !== 'buddylist' && id !== 'buddylist' && item.app !== 'emulator') {\n                makeOption('Keep in Taskbar', () => {\n                    this.shortcuts.add(item.app || id);\n                    let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n                    installedTaskBarApps[item.app || id] = {\n                        app: item.app || id,\n                        context: item.context || 'default',\n                        label: item.label || id,\n                        icon: item.icon || ''\n                    };\n                    this.bp.set('taskbar_apps', installedTaskBarApps);\n                });\n            }\n        }\n\n        requestAnimationFrame(() => {\n            const menuHeight = menu.offsetHeight;\n            const viewportHeight = window.innerHeight;\n            let top = y - menuHeight - 4;\n            if (top < 0) {\n                top = y + 4;\n            }\n            menu.style.top = `${top}px`;\n            menu.style.visibility = 'visible';\n        });\n\n        const removeMenu = () => menu.remove();\n        setTimeout(() => {\n            window.addEventListener('click', removeMenu, { once: true });\n            window.addEventListener('contextmenu', removeMenu, { once: true });\n        }, 0);\n    }\n\n    // same as addItem ( calls into addItem )\n    // except it also saves the item to localStorage\n    // this is used when the user explicitly pins an app to the taskbar from outside API\n    saveItem(config) {\n        // first add the item to the taskbar\n        config.isShortcut = true; // Ensure it's treated as a shortcut\n        const itemElement = this.addItem(config);\n        if (!itemElement) return;\n\n        let { app, id, context, label = \"\", onClick, icon, isShortcut = true, anchor } = config;\n\n        let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n        if (id !== 'home' && id !== 'settings') {\n            installedTaskBarApps[app || id] = {\n                id: id,\n                app: app || id,\n                context: context || 'default',\n                label: label || id,\n                icon: icon || ''\n            };\n            this.bp.set('taskbar_apps', installedTaskBarApps);\n        }\n\n    }\n\n    addItem(config) {\n        let { app, id, context, label = \"\", onClick, icon, isShortcut = true, anchor } = config;\n        if (typeof onClick !== 'function') {\n            onClick = async (ev, itemElement) => {\n                let existingWindow = this.bp.apps.ui.windowManager.getWindow(id);\n                if (!existingWindow) {\n                    let win = await this.bp.open(app || id, { context });\n                } else {\n                    if (existingWindow.isMinimized) {\n                        existingWindow.restore();\n                        existingWindow.focus();\n                    } else {\n                        existingWindow.minimize();\n                    }\n                }\n                if (this.startPanel) {\n                    this.startPanel.close();\n                }\n                ev.stopPropagation();\n            };\n        }\n\n        let existing = this.taskBarElement.querySelector(`[data-id=\"${id}\"]`);\n        if (existing) return existing;\n\n        const itemElement = document.createElement(\"div\");\n        itemElement.className = \"taskbar-item\";\n        itemElement.dataset.id = id;\n        itemElement.draggable = id !== 'home' && id !== 'settings'; // Disable drag for anchored items\n\n        if (!this.bp.isMobile()) {\n            const itemText = document.createElement(\"div\");\n            itemText.className = \"taskbar-item-text\";\n            itemText.textContent = label;\n            itemElement.appendChild(itemText);\n        }\n\n        if (!icon && app === 'buddylist' && this.bp.apps.buddylist) {\n            // Remark: special case for default dicebar avatars for buddies\n            let defautSvgAvatar = this.bp.apps.buddylist.defaultAvatarSvg(context.replace('messages/', ''));\n            const svgContainer = document.createElement('div');\n            svgContainer.className = 'start-panel-app-icon';\n            svgContainer.innerHTML = defautSvgAvatar;\n            svgContainer.title = context;\n            label = label || context.replace('messages/', '');\n            // itemText.textContent = label; // Update text content with context\n            itemElement.appendChild(svgContainer);\n        } else if (icon) {\n            const itemIcon = document.createElement(\"img\");\n            // check if icon already starts with http\n            if (!icon.startsWith('http')) {\n              itemIcon.src = this.bp.config.host + '/' + icon;\n            } else {\n              itemIcon.src = icon;\n            }\n            itemIcon.height = 32;\n            itemIcon.width = 32;\n            itemIcon.alt = label;\n            itemElement.appendChild(itemIcon);\n        } else {\n            itemElement.textContent = label;\n        }\n\n        itemElement.onclick = (ev) => {\n            if (onClick) onClick.call(this, ev, itemElement);\n            this.alertItem(id);\n        };\n\n        if (isShortcut) {\n            this.shortcuts.add(id);\n        }\n\n        // Append to appropriate container\n        if (id === 'home' && anchor === 'right') {\n            this.taskbarRight.appendChild(itemElement);\n        } else if (id === 'settings' && anchor === 'left') {\n            this.taskbarLeft.appendChild(itemElement);\n        } else {\n            this.taskbarItems.appendChild(itemElement);\n            // Scroll to the newly added item\n            if (this.bp.isMobile()) {\n                requestAnimationFrame(() => {\n                    itemElement.scrollIntoView({ behavior: 'smooth', inline: 'start' });\n                });\n            }\n        }\n\n        this.items.set(id, {\n            ...config,\n            element: itemElement,\n            isOpen: false,\n            isShortcut: isShortcut\n        });\n\n        return itemElement;\n    }\n\n    openItem(config) {\n        let item = this.items.get(config.id);\n        if (item) {\n            item.isOpen = true;\n            item.element.classList.add(\"taskbar-item-open\");\n            // Scroll to the opened item\n            if (this.bp.isMobile()) {\n                requestAnimationFrame(() => {\n                    item.element.scrollIntoView({ behavior: 'smooth', inline: 'start' });\n                });\n            }\n        } else {\n            this.addItem({ ...config, isShortcut: false });\n            this.openItem(config); // Scroll happens in addItem\n        }\n    }\n\n    closeItem(id) {\n        const item = this.items.get(id);\n        if (!item) return;\n\n        item.isOpen = false;\n        item.element.classList.remove(\"taskbar-item-open\");\n\n        if (!this.shortcuts.has(id)) {\n            this.removeItem(id);\n        }\n\n        const win = this.bp.apps.ui.windowManager.getWindow(id);\n        if (win) {\n            win.close();\n        } else {\n            console.warn(`No window found with ID: ${id}`);\n        }\n    }\n\n    removeItem(id) {\n        const item = this.items.get(id);\n        if (!item) return;\n\n        item.element.parentNode.removeChild(item.element);\n        this.items.delete(id);\n        this.shortcuts.delete(id);\n\n        let taskBarApps = this.bp.settings.taskbar_apps || {};\n        if (taskBarApps[id]) {\n            delete taskBarApps[id];\n            this.bp.set('taskbar_apps', taskBarApps);\n        }\n    }\n\n    getItem(id) {\n        return this.items.get(id);\n    }\n\n    alertItem(id) {\n        const item = this.items.get(id);\n        if (item) {\n            item.element.classList.add(\"taskbar-item-alert\");\n            setTimeout(() => item.element.classList.remove(\"taskbar-item-alert\"), 1000);\n        }\n    }\n\n    enableDragAndDrop() {\n\n        let dragged = null;\n\n        this.taskbarItems.addEventListener(\"dragstart\", (e) => {\n            dragged = e.target.closest(\".taskbar-item\");\n            if (dragged && (dragged.dataset.id === 'home' || dragged.dataset.id === 'settings')) {\n                e.preventDefault(); // Prevent dragging anchored items\n                dragged = null;\n            }\n        });\n\n        this.taskbarItems.addEventListener(\"dragover\", (e) => {\n            e.preventDefault();\n            const over = e.target.closest(\".taskbar-item\");\n            if (dragged && over && dragged !== over && over.dataset.id !== 'home' && over.dataset.id !== 'settings') {\n                const draggedIndex = [...this.taskbarItems.children].indexOf(dragged);\n                const overIndex = [...this.taskbarItems.children].indexOf(over);\n                if (draggedIndex < overIndex) {\n                    this.taskbarItems.insertBefore(over, dragged);\n                } else {\n                    this.taskbarItems.insertBefore(dragged, over);\n                }\n            }\n        });\n\n        this.taskbarItems.addEventListener(\"dragend\", () => {\n            if (dragged) {\n                const newOrder = Array.from(this.taskbarItems.children).map(item => item.dataset.id);\n                // references the saved / pinned taskbar apps\n                let taskBarApps = this.bp.settings.taskbar_apps || {};\n                const newTaskBarApps = {};\n                newOrder.forEach(id => {\n                    // only save the order of taskbar apps that are currently pinned\n                    if (taskBarApps[id]) {\n                        let _app = taskBarApps[id];\n                        newTaskBarApps[id] = _app;\n                    }\n                });\n                this.bp.set('taskbar_apps', newTaskBarApps);\n            }\n            dragged = null;\n        });\n    }\n}","import TaskBar from '../ui/Window/TaskBar.js';\n\nexport default class TaskBarApp {\n  constructor(bp, options = {}) {\n    this.bp = bp;\n    return this;\n  }\n\n  async init() {\n    return 'loaded TaskBarApp';\n  }\n\n  async open(options = {}) {\n\n    if (this.taskBar) {\n      console.log('TaskBar already open');\n      //$('.taskbar-container').css('display', 'flex').hide().fadeIn({ easing: 'linear', duration: 555 });\n      return;\n    }\n    // Remark: Why is TaskBar in the WindowManager?\n    // shouldn't this be in the UI class?\n    this.taskBar = new TaskBar({\n      bp: this.bp,\n      homeCallback: () => {\n\n        if (!this.state) {\n          // save current window positions\n          this.lastPositionsBeforeArranged = this.windows.map(w => {\n            return {\n              x: w.x,\n              y: w.y,\n              height: w.height,\n              width: w.width\n            }\n          });\n          // console.log('lastPositionsBeforeArranged', this.lastPositionsBeforeArranged);\n          this.state = 'maximized';\n        }\n\n        if (this.state === 'minimized') {\n          this.minimizeAllWindows();\n          // this.arrangeHorizontalStacked();\n          this.state = 'maximized';\n\n        } else if (this.state === 'stacked-vertical') {\n          // stack-vertical has been removed ( for now )\n          // it wasn't looking good as a default and was rarely used\n          /*\n          // restore all windows to their previous positions\n          this.windows.forEach((w, i) => {\n              w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n              w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n          });\n          this.state = 'maximized';\n          */\n\n        } else if (this.state === 'stacked-horizontal') {\n          // this.arrangeVerticalStacked();\n          // this.state = 'stacked-vertical';\n          // restore all windows to their previous positions\n          this.windows.forEach((w, i) => {\n            w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n            w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n          });\n          this.state = 'maximized';\n\n        } else {\n          this.minimizeAllWindows(true);\n          this.windows.forEach((w, i) => {\n            w.move(this.lastPositionsBeforeArranged[i].x, this.lastPositionsBeforeArranged[i].y);\n            w.setSize(this.lastPositionsBeforeArranged[i].width + 'px', this.lastPositionsBeforeArranged[i].height + 'px');\n          });\n\n          this.state = 'minimized';\n\n        }\n\n        // close all windows\n        // this.minimizeAllWindows();\n        // this.windowsClosed = true;\n\n        // hide all legacy BP windows\n        $('.window').hide();\n        $('.window').removeClass('window_stack');\n\n      }\n    });\n\n    let installedTaskBarApps = this.bp.settings.taskbar_apps || {};\n\n    if (Object.keys(installedTaskBarApps).length === 0) {\n\n        let defaultTaskBarApps = [\n            'file-explorer',\n            'pad',\n            'buddylist',\n            // 'pond',\n            'portfolio',\n        ];\n\n        if (this.bp.isMobile()) {\n            defaultTaskBarApps = [\n                'buddylist',\n                // 'pond',\n                'portfolio',\n                'coin',\n                //'youtube',\n                'fluid-simulation',\n            ]\n        }\n\n        defaultTaskBarApps.forEach(appName => {\n            let app = this.bp.apps.list[appName];\n            if (app) {\n                // console.log(`Adding default taskbar app: ${appName}`);\n                installedTaskBarApps[appName] = {\n                    app: app.app || appName,\n                    context: app.context || 'default',\n                    label: app.label || appName,\n                    icon: app.icon || ''\n                };\n            } else {\n                console.warn(`App ${appName} not found in desktop app list.`);\n            }\n        });\n    }\n\n    Object.keys(installedTaskBarApps).forEach(appName => {\n        let savedApp = installedTaskBarApps[appName];\n        //console.log('Adding taskbar app', appName);\n        //console.log(this.bp.apps.list)\n        // console.log('savedApp', appName, savedApp);\n        let app = this.bp.apps.list[savedApp.id || appName];\n        if (!app) {\n            console.warn(`App ${appName} not found in desktop app list.`);\n            return;\n        }\n\n        app.id = appName; // ensure the app has an id for taskbar\n        app.app = app.app || appName; // ensure the app has an app property\n        // create new app object with necessary properties\n        let _app = {\n            ...app\n        }\n        if (_app) {\n            // console.log(`Adding default taskbar app: ${appName}`, _app);\n            this.taskBar.saveItem(_app);\n        } else {\n            console.warn(`App ${appName} not found in desktop app list.`);\n        }\n    });\n\n     $('.taskbar-container').css('display', 'flex').hide().fadeIn({ easing: 'linear', duration: 555 });\n  }\n}"],"names":["StartPanel","constructor","onAppLaunch","bp","this","panelElement","open","close","panel","document","createElement","className","style","display","searchInput","id","type","placeholder","autocomplete","recentSection","innerHTML","recentGrid","appendChild","allSection","allGrid","body","$","css","opacity","transform","transition","requestAnimationFrame","window","apps","ui","recentApps","slice","forEach","appData","app","createAppTile","appList","list","Object","entries","appName","adminOnly","me","icon","addEventListener","query","value","toLowerCase","length","querySelectorAll","el","label","dataset","name","_app","showResult","includes","alias","some","categories","cat","closeEventHandler","event","target","hasClass","contains","isMobile","focus","$panel","setTimeout","remove","removeEventListener","tile","buddylist","defautSvgAvatar","defaultAvatarSvg","replace","svgContainer","img","startsWith","src","config","host","alt","textContent","onclick","async","context","prototype","enableKeyboardNavigation","currentIndex","appTiles","updateTilesList","Array","from","filter","focusTile","index","console","log","i","classList","toggle","scrollIntoView","block","e","key","preventDefault","nextIndex","prevIndex","Math","min","max","click","TaskBar","homeCallback","taskBarElement","taskbarLeft","taskbarItems","taskbarRight","items","Map","shortcuts","Set","isAtEnd","scrollLeft","clientWidth","scrollWidth","setAttribute","addItem","onClick","startPanel","isShortcut","anchor","stopPropagation","$menu","animate","left","removeClass","addClass","closest","showContextMenu","clientX","clientY","pressTimer","startX","startY","touch","touches","navigator","vibrate","clearTimeout","enableDragAndDrop","x","y","existing","querySelector","item","get","menu","position","visibility","makeOption","handler","option","isOpen","closeItem","openItem","has","delete","removeItem","add","installedTaskBarApps","settings","taskbar_apps","set","menuHeight","offsetHeight","top","removeMenu","once","saveItem","ev","itemElement","existingWindow","windowManager","getWindow","isMinimized","restore","minimize","draggable","itemText","title","itemIcon","height","width","call","alertItem","behavior","inline","element","win","warn","parentNode","removeChild","taskBarApps","getItem","dragged","over","children","indexOf","insertBefore","newOrder","map","newTaskBarApps","TaskBarApp","options","init","taskBar","state","lastPositionsBeforeArranged","windows","w","minimizeAllWindows","move","setSize","hide","keys","defaultTaskBarApps","savedApp","fadeIn","easing","duration"],"mappings":"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"}