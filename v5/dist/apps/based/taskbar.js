class t{constructor({onAppLaunch:t,bp:e}={}){this.onAppLaunch=t||function(){},this.bp=e,this.panelElement=null}open(){if(this.panelElement)return void this.close();const t=document.createElement("div");t.className="start-panel",t.style.display="none";const e=document.createElement("input");e.id="start-panel-search",e.className="start-panel-search",e.type="text",e.placeholder="Search apps...",e.autocomplete="off";const s=document.createElement("div");s.className="start-panel-section",s.innerHTML="<h3>Recent Apps</h3>";const a=document.createElement("div");a.className="start-panel-grid",s.appendChild(a);const i=document.createElement("div");i.className="start-panel-section",i.innerHTML="<h3>All Apps</h3>";const n=document.createElement("div");n.className="start-panel-grid",i.appendChild(n),t.appendChild(e),t.appendChild(s),t.appendChild(i),document.body.appendChild(t),this.panelElement=t,$(t).css({display:"block",opacity:1,transform:"translateY(100%)",transition:"all 300ms ease-out"}),requestAnimationFrame((()=>{$(t).css({opacity:1,transform:"translateY(0)"})}));(window.bp?.apps?.ui?.recentApps||[]).slice(0,10).forEach((t=>{const e=this.createAppTile(t);a.appendChild(e)}));const o=window.bp?.apps?.list||{};Object.entries(o).forEach((([t,e])=>{if(e.adminOnly&&"Marak"!==this.bp.me)return;if(!1===e.enumerable)return;e.app=e.app||t,e.id=e.id||t;const s=this.createAppTile(e,e.icon);n.appendChild(s)})),e.addEventListener("input",(()=>{const t=e.value.toLowerCase();s.style.display=t.length>0?"none":"",n.querySelectorAll(".start-panel-app").forEach((e=>{const s=e.dataset.name.toLowerCase(),a=this.bp.apps.list[e.dataset.id];let i=s.includes(t);!i&&a?.alias&&(i=a.alias.some((e=>e.toLowerCase().includes(t)))),!i&&a?.categories&&(i=a.categories.some((e=>e.toLowerCase().includes(t)))),e.style.display=i?"flex":"none"}))})),this.closeEventHandler=t=>{$(t.target).hasClass("taskbar-item")||this.panelElement&&!this.panelElement.contains(t.target)&&t.target!==e&&this.close()},document.addEventListener("click",this.closeEventHandler),this.bp.isMobile()||e.focus()}close(){if(this.panelElement){const t=$(this.panelElement);t.css({transform:"translateY(0)",opacity:1,transition:"all 300ms ease-in"}),requestAnimationFrame((()=>{t.css({transform:"translateY(100%)",opacity:1}),setTimeout((()=>{t.remove(),this.panelElement=null}),300)}))}this.closeEventHandler&&(document.removeEventListener("click",this.closeEventHandler),this.closeEventHandler=null)}createAppTile(t,e){let s=t.id||t.appName||t.name||t.label||"Unknown App";e=t.icon||e;const a=document.createElement("div");if(a.className="start-panel-app",a.dataset.name=s,a.dataset.id=t.id||t.app||s,a.dataset.app=t.app||t.id||s,!e&&"buddy"===t.type&&this.bp.apps.buddylist){let e=this.bp.apps.buddylist.defaultAvatarSvg(t.id.replace("messages/",""));const s=document.createElement("div");s.className="start-panel-app-icon",s.innerHTML=e,a.appendChild(s)}else{const t=document.createElement("img");e.startsWith("http")?t.src=e:t.src=this.bp.config.host+"/"+e,t.alt=s,a.appendChild(t)}const i=document.createElement("div");return i.textContent=t.label||s,a.appendChild(i),a.onclick=async()=>{"buddy"===t.type&&"buddylist"===t.app&&(t.context=t.id.replace("messages/","")),await this.bp.open(t.app||t.id,{context:t.context,type:t.type}),this.onAppLaunch(s),this.close()},a}}t.prototype.enableKeyboardNavigation=function(t,e){let s=-1,a=[];function i(){a=Array.from(t.querySelectorAll(".start-panel-app")).filter((t=>"none"!==t.style.display))}function n(t){console.log("Focusing tile at index:",t),a.forEach(((e,s)=>{e.classList.toggle("focused",s===t),s===t&&e.scrollIntoView({block:"nearest"})})),s=t}i(),e.addEventListener("keydown",(t=>{"ArrowDown"===t.key&&(i(),a.length>0&&(n(0),t.preventDefault()))}));t.addEventListener("keydown",(t=>{if(console.log("Key pressed:",t.key),0!==a.length)if("Tab"!==t.key){if("ArrowDown"===t.key){if(-1===s)n(0);else{let t=s+5;t<a.length?n(t):n(a.length-1)}t.preventDefault()}if("ArrowUp"===t.key){if(-1===s)n(0);else{let t=s-5;n(t>=0?t:0)}t.preventDefault()}"ArrowRight"===t.key&&(n(-1===s?0:Math.min(s+1,a.length-1)),t.preventDefault()),"ArrowLeft"===t.key&&(n(-1===s?0:Math.max(s-1,0)),t.preventDefault()),"Enter"===t.key&&s>=0&&(a[s].click(),t.preventDefault()),"Escape"===t.key&&(a.forEach((t=>t.classList.remove("focused"))),s=-1,e.focus())}else{if(-1===s)n(0);else{let t=s+1;t<a.length?n(t):n(a.length-1)}t.preventDefault()}}))};class e{constructor({homeCallback:e,bp:s}={}){if(this.taskBarElement=document.createElement("div"),this.taskBarElement.className="taskbar-container",document.body.appendChild(this.taskBarElement),this.taskbarLeft=document.createElement("div"),this.taskbarLeft.className="taskbar-left",this.taskBarElement.appendChild(this.taskbarLeft),this.taskbarItems=document.createElement("div"),this.taskbarItems.className="taskbar-items",this.taskBarElement.appendChild(this.taskbarItems),this.taskbarRight=document.createElement("div"),this.taskbarRight.className="taskbar-right",this.taskBarElement.appendChild(this.taskbarRight),this.bp=s,this.items=new Map,this.shortcuts=new Set,this.taskbarItems.addEventListener("scroll",(()=>{const t=this.taskbarItems.scrollLeft+this.taskbarItems.clientWidth>=this.taskbarItems.scrollWidth-1;console.log("Scroll end reached:",t),this.taskbarItems.setAttribute("data-scroll-end",t)})),e&&this.addItem({id:"home",label:"Home",onClick:function(){this.startPanel||(this.startPanel=new t({bp:this.bp})),this.startPanel.open()},icon:"desktop/assets/images/icons/icon_mantra_64.png",isShortcut:!0,anchor:"right"}),this.bp.isMobile()&&this.addItem({id:"settings",label:"Settings",onClick:t=>{t.stopPropagation();const e=$(".menu-bar");e.hasClass("mobile-active")?e.animate({left:"-100%"},300,(()=>{e.removeClass("mobile-active")})):e.css({left:"-100%",display:"flex"}).addClass("mobile-active").animate({left:"0%"},300)},icon:"desktop/assets/images/icons/icon_settings_64.png",isShortcut:!0,anchor:"left"}),this.taskBarElement.addEventListener("contextmenu",(t=>{t.preventDefault();const e=t.target.closest(".taskbar-item");if(!e)return;const s=e.dataset.id;s&&"home"!==s&&"settings"!==s&&this.showContextMenu(s,t.clientX,t.clientY)})),this.bp.isMobile()){let t=null,e=0,s=0;this.taskBarElement.addEventListener("touchstart",(a=>{const i=a.touches[0],n=a.target.closest(".taskbar-item");if(!n)return;const o=n.dataset.id;o&&"home"!==o&&"settings"!==o&&(e=i.clientX,s=i.clientY,t=setTimeout((()=>{navigator.vibrate&&navigator.vibrate(10),this.showContextMenu(o,e,s)}),600))})),this.taskBarElement.addEventListener("touchend",(()=>{clearTimeout(t)})),this.taskBarElement.addEventListener("touchmove",(()=>{clearTimeout(t)}))}this.enableDragAndDrop()}showContextMenu(t,e,s){const a=document.querySelector(".taskbar-context-menu");a&&a.remove();const i=this.items.get(t);if(!i)return;const n=document.createElement("div");n.className="taskbar-context-menu",n.style.position="fixed",n.style.left=`${e}px`,n.style.visibility="hidden",document.body.appendChild(n);const o=(t,e)=>{const s=document.createElement("div");s.className="taskbar-context-menu-item",s.textContent=t,s.onclick=()=>{e(),this.startPanel.close(),n.remove()},n.appendChild(s)};i.isOpen?o("Close",(()=>this.closeItem(t))):o("Open",(()=>this.openItem(i))),this.shortcuts.has(t)?o("Unpin from Taskbar",(()=>{this.shortcuts.delete(t),i.isOpen||this.removeItem(t)})):"buddylist"!==i.app&&"buddylist"!==t&&"emulator"!==i.app&&o("Keep in Taskbar",(()=>{this.shortcuts.add(i.app||t);let e=this.bp.settings.taskbar_apps||{};e[i.app||t]={app:i.app||t,context:i.context||"default",label:i.label||t,icon:i.icon||""},this.bp.set("taskbar_apps",e)})),requestAnimationFrame((()=>{const t=n.offsetHeight;let e=s-t-4;e<0&&(e=s+4),n.style.top=`${e}px`,n.style.visibility="visible"}));const l=()=>n.remove();setTimeout((()=>{window.addEventListener("click",l,{once:!0}),window.addEventListener("contextmenu",l,{once:!0})}),0)}saveItem(t){t.isShortcut=!0;if(!this.addItem(t))return;let{app:e,id:s,context:a,label:i="",onClick:n,icon:o,isShortcut:l=!0,anchor:r}=t,c=this.bp.settings.taskbar_apps||{};"home"!==s&&"settings"!==s&&(c[e||s]={id:s,app:e||s,context:a||"default",label:i||s,icon:o||""},this.bp.set("taskbar_apps",c))}addItem(t){let{app:e,id:s,context:a,label:i="",onClick:n,icon:o,isShortcut:l=!0,anchor:r}=t;"function"!=typeof n&&(n=async(t,i)=>{let n=this.bp.apps.ui.windowManager.getWindow(s);n?n.isMinimized?(n.restore(),n.focus()):n.minimize():await this.bp.open(e||s,{context:a}),this.startPanel&&this.startPanel.close(),t.stopPropagation()});let c=this.taskBarElement.querySelector(`[data-id="${s}"]`);if(c)return c;const d=document.createElement("div");if(d.className="taskbar-item",d.dataset.id=s,d.draggable="home"!==s&&"settings"!==s,!this.bp.isMobile()){const t=document.createElement("div");t.className="taskbar-item-text",t.textContent=i,d.appendChild(t)}if(!o&&"buddylist"===e&&this.bp.apps.buddylist){let t=this.bp.apps.buddylist.defaultAvatarSvg(a.replace("messages/",""));const e=document.createElement("div");e.className="start-panel-app-icon",e.innerHTML=t,e.title=a,i=i||a.replace("messages/",""),d.appendChild(e)}else if(o){const t=document.createElement("img");o.startsWith("http")?t.src=o:t.src=this.bp.config.host+"/"+o,t.height=32,t.width=32,t.alt=i,d.appendChild(t)}else d.textContent=i;return d.onclick=t=>{n&&n.call(this,t,d),this.alertItem(s)},l&&this.shortcuts.add(s),"home"===s&&"right"===r?this.taskbarRight.appendChild(d):"settings"===s&&"left"===r?this.taskbarLeft.appendChild(d):(this.taskbarItems.appendChild(d),this.bp.isMobile()&&requestAnimationFrame((()=>{d.scrollIntoView({behavior:"smooth",inline:"start"})}))),this.items.set(s,{...t,element:d,isOpen:!1,isShortcut:l}),d}openItem(t){let e=this.items.get(t.id);e?(e.isOpen=!0,e.element.classList.add("taskbar-item-open"),this.bp.isMobile()&&requestAnimationFrame((()=>{e.element.scrollIntoView({behavior:"smooth",inline:"start"})}))):(this.addItem({...t,isShortcut:!1}),this.openItem(t))}closeItem(t){const e=this.items.get(t);if(!e)return;e.isOpen=!1,e.element.classList.remove("taskbar-item-open"),this.shortcuts.has(t)||this.removeItem(t);const s=this.bp.apps.ui.windowManager.getWindow(t);s?s.close():console.warn(`No window found with ID: ${t}`)}removeItem(t){const e=this.items.get(t);if(!e)return;e.element.parentNode.removeChild(e.element),this.items.delete(t),this.shortcuts.delete(t);let s=this.bp.settings.taskbar_apps||{};s[t]&&(delete s[t],this.bp.set("taskbar_apps",s))}getItem(t){return this.items.get(t)}alertItem(t){const e=this.items.get(t);e&&(e.element.classList.add("taskbar-item-alert"),setTimeout((()=>e.element.classList.remove("taskbar-item-alert")),1e3))}enableDragAndDrop(){let t=null;this.taskbarItems.addEventListener("dragstart",(e=>{t=e.target.closest(".taskbar-item"),!t||"home"!==t.dataset.id&&"settings"!==t.dataset.id||(e.preventDefault(),t=null)})),this.taskbarItems.addEventListener("dragover",(e=>{e.preventDefault();const s=e.target.closest(".taskbar-item");if(t&&s&&t!==s&&"home"!==s.dataset.id&&"settings"!==s.dataset.id){[...this.taskbarItems.children].indexOf(t)<[...this.taskbarItems.children].indexOf(s)?this.taskbarItems.insertBefore(s,t):this.taskbarItems.insertBefore(t,s)}})),this.taskbarItems.addEventListener("dragend",(()=>{if(t){const t=Array.from(this.taskbarItems.children).map((t=>t.dataset.id));let e=this.bp.settings.taskbar_apps||{};const s={};t.forEach((t=>{if(e[t]){let a=e[t];s[t]=a}})),this.bp.set("taskbar_apps",s)}t=null}))}}class s{constructor(t,e={}){return this.bp=t,this}async init(){return"loaded TaskBarApp"}async open(t={}){if(this.taskBar)return void console.log("TaskBar already open");this.taskBar=new e({bp:this.bp,homeCallback:()=>{this.state||(this.lastPositionsBeforeArranged=this.windows.map((t=>({x:t.x,y:t.y,height:t.height,width:t.width}))),this.state="maximized"),"minimized"===this.state?(this.minimizeAllWindows(),this.state="maximized"):"stacked-vertical"===this.state||("stacked-horizontal"===this.state?(this.windows.forEach(((t,e)=>{t.move(this.lastPositionsBeforeArranged[e].x,this.lastPositionsBeforeArranged[e].y),t.setSize(this.lastPositionsBeforeArranged[e].width+"px",this.lastPositionsBeforeArranged[e].height+"px")})),this.state="maximized"):(this.minimizeAllWindows(!0),this.windows.forEach(((t,e)=>{t.move(this.lastPositionsBeforeArranged[e].x,this.lastPositionsBeforeArranged[e].y),t.setSize(this.lastPositionsBeforeArranged[e].width+"px",this.lastPositionsBeforeArranged[e].height+"px")})),this.state="minimized")),$(".window").hide(),$(".window").removeClass("window_stack")}});let s=this.bp.settings.taskbar_apps||{};if(0===Object.keys(s).length){let t=["file-explorer","pad","buddylist","portfolio"];this.bp.isMobile()&&(t=["buddylist","portfolio","coin","fluid-simulation"]),t.forEach((t=>{let e=this.bp.apps.list[t];e?s[t]={app:e.app||t,context:e.context||"default",label:e.label||t,icon:e.icon||""}:console.warn(`App ${t} not found in desktop app list.`)}))}Object.keys(s).forEach((t=>{let e=s[t],a=this.bp.apps.list[e.id||t];if(!a)return void console.warn(`App ${t} not found in desktop app list.`);a.id=t,a.app=a.app||t;let i={...a};i?this.taskBar.saveItem(i):console.warn(`App ${t} not found in desktop app list.`)})),$(".taskbar-container").css("display","flex").hide().fadeIn({easing:"linear",duration:555})}}export{s as default};
//# sourceMappingURL=taskbar.js.map
