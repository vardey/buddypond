<!DOCTYPE html>
<html dir="ltr" lang="en-US">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <title>miniPaint - image editor</title>
  <meta name="description"
    content="miniPaint is free online image editor using HTML5. Edit, adjust your images, add effects online in your browser, without installing anything..." />
  <meta name="keywords"
    content="photo, image, picture, transparent, layers, free, edit, html5, canvas, javascript, online, photoshop, gimp, effects, sharpen, blur, magic eraser tool, clone tool, rotate, resize, photoshop online, online tools, tilt shift, sprites, keypoints" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0" />
  <link rel="icon" sizes="192x192" href="images/favicon.png">
  <!-- <link rel="manifest" href="dist/manifest.json"> -->
  <!-- Google -->
  <meta itemprop="name" content="miniPaint" />
  <meta itemprop="description"
    content="miniPaint is free online image editor using HTML5. Edit, adjust your images, add effects online in your browser, without installing anything..." />
  <meta itemprop="image" content="https://viliusle.github.io/miniPaint/images/preview.jpg" />
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="miniPaint" />
  <meta name="twitter:description"
    content="miniPaint is free online image editor using HTML5. Edit, adjust your images, add effects online in your browser, without installing anything..." />
  <meta name="twitter:image" content="https://viliusle.github.io/miniPaint/images/preview.jpg" />
  <meta name="twitter:image:alt"
    content="miniPaint is free online image editor using HTML5. Edit, adjust your images, add effects online in your browser, without installing anything..." />
  <!-- Facebook, Pinterest -->
  <meta property="og:title" content="miniPaint" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://viliusle.github.io/miniPaint/" />
  <meta property="og:image" content="https://viliusle.github.io/miniPaint/images/preview.jpg" />
  <meta property="og:description"
    content="miniPaint is free online image editor using HTML5. Edit, adjust your images, add effects online in your browser, without installing anything..." />
  <meta property="og:site_name" content="miniPaint" />

  <script src="dist/bundle.js"></script>
  <script>
    // TODO: add a custom save button that would trigger this event
    document.addEventListener('DOMContentLoaded', function () {

      // parse query string for context and output
      const urlParams = new URLSearchParams(window.location.search);
      const context = urlParams.get('context');
      const output = urlParams.get('output');

      const channel = new BroadcastChannel("buddypond-desktop");
      channel.postMessage({ type: "app", app: "minipaint", action: "open" });
      channel.onmessage = (event) => console.log("minipaint received:", event.data);

      // add listener to the save button
      const saveButton = document.querySelector('.save-button');
      if (saveButton) {

        if (context === 'default' || context === 'file-system') {
          // remove the button if we are using default or file-system context
          saveButton.remove();
        }
        saveButton.addEventListener('click', function () {
          // disable button to prevent multiple clicks
          this.disabled = true;
          this.innerText = 'SENDING...';
          save_image();
        });
      } else {
        console.error('Save button not found');
      }

        const reciever = new BroadcastChannel("buddypond-minipaint");
        reciever.onmessage = (event) => {
          alert('minipaint reciever got message');
          if (event.data.action = 'load') {
            console.log('minipaint received load command', event.data);
            // open image in minipaint
            if (event.data.src) {
              // load the image as url in minipaint
              if (window.minipaint && typeof window.minipaint.loadImageFromUrl === 'function') {
                window.minipaint.loadImageFromUrl(event.data.src).then(() => {
                  console.log('minipaint image loaded from url:', event.data.src);
                }).catch((error) => {
                  console.error('Error loading minipaint image from url:', error);
                });
              } else {
                console.error('minipaint instance or loadImageFromUrl method not found');
              }
            } else {
              console.error('minipaint load command missing src');
            }

          }

        };


      /*
      // Listen for custom save event
      document.addEventListener('minipaint-save', function () {
        if (window.minipaint && typeof window.minipaint.saveImage === 'function') {
          window.minipaint.saveImage().then((dataUrl) => {
            console.log('minipaint image saved, dataUrl length:', dataUrl.length);
            channel.postMessage({
              type: "app",
              app: "minipaint",
              action: "save",
              image: dataUrl,
              timestamp: Date.now()
            });
          }).catch((error) => {
            console.error('Error saving minipaint image:', error);
          });
        } else {
          console.error('minipaint instance or saveImage method not found');
        }
      });
      */
    });


    function save_image() {
      var Layers = window.Layers;
      var tempCanvas = document.createElement("canvas");
      var tempCtx = tempCanvas.getContext("2d");
      var dim = Layers.get_dimensions();
      tempCanvas.width = dim.width;
      tempCanvas.height = dim.height;
      Layers.convert_layers_to_canvas(tempCtx);

      //update image using blob (faster)
      tempCanvas.toBlob(function (blob) {
        // alert('Data length: ' + blob.size);
        console.log(blob);
        // convert blob to dataURL
        var reader = new FileReader();
        reader.onloadend = function () {
          var dataUrl = reader.result;
          console.log('minipaint image saved, dataUrl length:', dataUrl.length);
          const channel = new BroadcastChannel("buddypond-desktop");
          channel.postMessage({
            type: "app",
            app: "minipaint",
            action: "save",
            image: dataUrl,
            timestamp: Date.now()
          });
        };
        reader.readAsDataURL(blob);
      }, 'image/png');

    }

  </script>
  <style>
    .save-button {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10000;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <button class="save-button">SEND TO CHAT</button>
  <div class="wrapper">

    <nav aria-label="Main Menu" class="main_menu" id="main_menu"></nav>

    <div class="submenu">
      <a class="logo" href="#">miniPaint</a>
      <div class="block attributes" id="action_attributes"></div>
      <button class="undo_button" id="undo_button" type="button">
        <span class="sr_only">Undo</span>
      </button>
    </div>

    <div class="sidebar_left" id="tools_container"></div>


    <div class="middle_area" id="middle_area">

      <canvas class="ruler_left" id="ruler_left"></canvas>
      <canvas class="ruler_top" id="ruler_top"></canvas>

      <div class="main_wrapper" id="main_wrapper">
        <div class="canvas_wrapper" id="canvas_wrapper">
          <div id="mouse"></div>
          <div class="transparent-grid" id="canvas_minipaint_background"></div>
          <canvas id="canvas_minipaint">
            <div class="trn error">
              Your browser does not support canvas or JavaScript is not enabled.
            </div>
          </canvas>
        </div>
      </div>
    </div>

    <div class="sidebar_right">
      <div class="preview block">
        <h2 class="trn toggle" data-target="toggle_preview">Preview</h2>
        <div id="toggle_preview"></div>
      </div>

      <div class="colors block">
        <h2 class="trn toggle" data-target="toggle_colors">Colors</h2>
        <div class="content" id="toggle_colors"></div>
      </div>

      <div class="block" id="info_base">
        <h2 class="trn toggle toggle-full" data-target="toggle_info">Information</h2>
        <div class="content" id="toggle_info"></div>
      </div>

      <div class="details block" id="details_base">
        <h2 class="trn toggle toggle-full" data-target="toggle_details">Layer details</h2>
        <div class="content details-content" id="toggle_details"></div>
      </div>

      <div class="layers block">
        <h2 class="trn">Layers</h2>
        <div class="content" id="layers_base"></div>
      </div>
    </div>
  </div>
  <div class="mobile_menu">
    <button class="left_mobile_menu" id="left_mobile_menu_button" type="button">
      <span class="sr_only">Toggle Menu</span>
    </button>
    <button class="right_mobile_menu" id="mobile_menu_button" type="button">
      <span class="sr_only">Toggle Menu</span>
    </button>
  </div>
  <div class="hidden" id="tmp"></div>
  <div id="popups"></div>
</body>

</html>