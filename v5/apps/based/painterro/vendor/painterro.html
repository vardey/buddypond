<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painterro Example</title>
</head>

<body>
  <button class="save-button">SEND TO CHAT</button>

  <script src="./painterro-1.2.87.min.js"></script>
  <script>
    let painterroInstance = null;

    // on domcontent loaded
    document.addEventListener('DOMContentLoaded', (event) => {

      // parse query string for context and output
      const urlParams = new URLSearchParams(window.location.search);
      const context = urlParams.get('context');
      const output = urlParams.get('output');

      const saveButton = document.querySelector('.save-button');
      if (saveButton) {
        if (context === 'default' || context === 'file-system') {
          // remove the button if we are using default or file-system context
          saveButton.remove();
        }
        saveButton.addEventListener('click', function () {
          // disable button to prevent multiple clicks
          this.disabled = true;
          this.innerText = 'SENDING...';
          // trigger save
          painterroInstance.save();
        });
      } else {
        console.error('Save button not found');
      }

      let config = {
        defaultTool: 'brush', // Select brush tool by default
        saveHandler: function (image, doneCallback) {
          console.log('Image saved!'); // Notify user that the image is saved
          // Create a download link for the image
              let dataUrl = image.asDataURL('image/png');

          if (context === 'default' || context === 'file-system') {
            // create a link and click it to download the image
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = 'edited-image.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            /*
            const link = dataUrl;
            link.href = image.asDataURL('image/png');
            link.download = image.suggestedFileName('image/png') || 'edited-image.png';
            link.click();
            */


          } else {
          console.log('dataUrl:', dataUrl);

          channel.postMessage({
            type: "app",
            app: "painterro",
            action: "save",
            image: dataUrl,
            timestamp: Date.now()
          });
          }



          // Signal that saving is complete
          doneCallback(false); // false means do not hide the editor
        }
      }

      const channel = new BroadcastChannel("buddypond-desktop");
      channel.postMessage({ type: "app", app: "painterro", action: "open" });
      channel.onmessage = (event) => console.log("painterro received:", event.data);

      const reciever = new BroadcastChannel("buddypond-painterro");
      reciever.onmessage = (event) => {
        if (event.data.action === 'load') {
          console.log('painterro received load command', event.data);
          if (event.data.src) {
            painterroInstance = Painterro(config).show(event.data.src);
          } else {
            console.error('painterro load command missing src');
          }
        }
      };

      painterroInstance = Painterro(config).show();
    });


  </script>
  <style>
    .save-button {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10000;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</body>

</html>