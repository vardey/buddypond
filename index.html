<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description"
    content="Buddy Pond - Cloud OS and Instant Messenger all wrapped up in one delightfully fun to use App. We are making the Internet Fun Again." />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://buddypond.com">
  <meta name="twitter:site" content="@marak">
  <meta name="twitter:creator" content="@marak">
  <meta name="twitter:title" content="Buddy Pond Cloud OS and Instant Messenger">
  <meta name="twitter:description"
    content="Buddy Pond is a Cloud OS and Instant Messenger all wrapped up in one delightfully fun to use App. We are making the Internet Fun Again.">
  <meta name="twitter:image"
    content="https://github.com/Marak/buddypond-assets/raw/master/promo/buddypond-demo-april-2022.gif">
  <title>Buddy Pond</title>
  <base href="/">
  <!--[if lt IE 7]>
<script>
window.top.location = 'ie.html';
</script>
<![endif]-->

  <!-- <script type="text/javascript" src="/v4-to-v5-bridge.js"></script> -->
  <script type="text/javascript" src="/v5.js"></script>

  <script type="text/javascript">

    // certain websites are currently not supported as referrer
    let notCurrentlySupportedSites = [/*'example.com', 'website.com'*/];
    notCurrentlySupportedSites.forEach(function (site) {
      if (document.referrer.search(site) !== -1) {
        alert(site + ' is currently not supported by Buddy Pond. \n\n Please check out our Github or try again later.')
        document.location = 'https://duckduckgo.com/?q=happy+puppies&t=opera&iax=images&ia=images'
      }
    });

  </script>

  <link rel="stylesheet" href="desktop/assets/css/reset.css">
  <link rel="stylesheet" href="desktop/assets/css/loader.css">


  <!--[if lt IE 9]>
<link rel="stylesheet" href="desktop/assets/css/ie.css" />
<![endif]-->

</head>

<body>
  <img id="wallpaper" class="abs wallpaper" />
  <div id="wallpaper-html" style="position: absolute; pointer-events: none; left: 0; width: 100%; height: 100%; z-index: -1;"></div>
  <div id="loaderHolder">
    <div id="loader"></div>
    <p class="loaderText">Loading Buddy Pond...</p>
  </div>

  <!--
  <div class="importantConfirmationsScreen">
    <div class="confirmationForm">
      CONFIRM
      <form>
        <button>Purchase GBP</button>
      </form>
    </div>
  </div>
-->
  <!-- src="desktop/assets/images/gui/rainbow-hexagon-lattice.gif" -->
  <!-- TODO: remove? -->
  <div id="mainOverlay" class="has-droparea">
    <img class="mobileLoadingOverlay" />
    <div class="abs" id="wrapper">
      <div class="abs" id="desktop">
        <!-- default desktop icons are currently rendered in `app.settings.load()` -->
        <canvas class="canvasBackground" id="c"></canvas>
      </div>
    </div>

    <link rel="stylesheet" href="desktop/assets/css/desktop.css" />
    <!-- <link rel="stylesheet" href="desktop/assets/css/mobile.css" /> -->

    <!-- <script src="/desktop/assets/js/jquery.js"></script> -->
    <script src="/desktop/assets/js/jquery.min.js"></script>
    <!-- <script src="desktop/assets/js/jquery.ripples.js"></script> -->

    <!-- <script src="/v5/router.js"></script> -->

    <script src="/v5/vendor/flexHide.js"></script>

    <!-- jQuery UI can be replaced when legacy autocomplete and Windows are fully replaced -->
    <!-- <link rel="stylesheet" href="/desktop/assets/css/jquery.ui.css"> -->
    <link rel="stylesheet" href="/desktop/assets/css/jquery-ui.min.css">
    <!-- <script src="/desktop/assets/js/jquery.ui.js"></script> -->
    <script src="/desktop/assets/js/jquery-ui.min.js"></script>
    <script src="/desktop/assets/js/jquery.dateformat.js"></script>


    <!-- TODO: remove all the below files with replaced v5 code-->
    <script src="/desktop/assets/js/forbidden.notes.js"></script>
    <!-- SDK should be able to be removed -->
    <script src="/v5/apps/based/client/lib/api.js"></script>

    <script>

      let _host = 'https://buddypond.com';
      let _api = 'https://a.buddypond.com';
      _api = 'https://buddypond.com/api/buddylist';
      let _cdn = 'https://files.buddypond.com';

      let _admin = 'https://buddypond.com/api/admin';
      let _apiKeysEndpoint = 'https://buddypond.com/api/api-keys';
      let _appsEndpoint = 'https://buddypond.com/api/apps';
      let _coinEndpoint = 'https://buddypond.com/api/coin';
      let _gamblorEndpoint = 'https://gamblor.buddypond.com/api/v6';

      let _imageSearchEndpoint = 'https://buddypond.com/api/image-search';
      let _portfolioEndpoint = 'https://buddypond.com/api/portfolio';
      let _orderbookEndpoint = 'https://buddypond.com/api/orderbook';
      let _messagesApiEndpoint = 'https://buddypond.com/api/messages';

      let _uploadsEndpoint = 'https://buddypond.com/api/uploads';
      let _errorsEndpoint = 'https://buddypond.com/api/errors';
      let _randolphEndpoint = 'https://buddypond.com/api/randolph';
      let _buddyProxy = 'https://buddypond.com/api/proxy';


      let _buddylistWsEndpoint = 'wss://buddypond.com/api/buddylist/ws/buddylist';
      let _chessWsEndpoint = 'wss://buddypond.com/api/chess/ws/chess';
      let _messagesWsEndpoint = 'wss://buddypond.com/api/ws/messages';
      let _pondsWsEndpoint = 'wss://buddypond.com/api/ponds/ws/ponds';
      let _videoChatEndpoint = 'wss://buddypond.com/api/videochat';

      let devmode = false;

      // TODO: checks if current host is buddypond.com
      // buddypond.com force devmode to false
      if (window.location.hostname === 'buddypond.com') {
        devmode = false;
      }

      let localIp = '192.168.200.59';
      // localIp = '0.0.0.0';

      localIp = window.location.origin;

      let localProtocol = window.location.protocol;


      if (devmode) {
        // localIp = '192.168.64.1';

        _host = `${localIp}`;
        _admin = `${localIp}:8789/api/admin`;
        _api = `${localIp}:8787/api/buddylist`;
        _appsEndpoint = `${localIp}:9008/api/apps`;
        _apiKeysEndpoint = `${localIp}:9009/api/api-keys`;
        _buddyProxy = `${localIp}:9007/api/proxy`;
        _coinEndpoint = `${localIp}:9001/api/coin`;
        _errorsEndpoint = `${localIp}:9010/api/errors`;
        _gamblorEndpoint = `${localIp}:9012/api/gamblor`;
        _imageSearchEndpoint = `${localIp}:9005/api/image-search`;
        _messagesApiEndpoint = `${localIp}:8788/api/messages`;
        _portfolioEndpoint = `${localIp}:9002/api/portfolio`;
        _randolphEndpoint = `${localIp}:8889/api/randolph`;
        _uploadsEndpoint = `${localIp}:9004/api/uploads`;
        _videoChatEndpoint = 'wss://192.168.200.59:8001/videochat/ws';

        _buddylistWsEndpoint = `${localIp.replace('http://', 'ws://')}:8787/api/buddylist/ws/buddylist`;
        _chessWsEndpoint = `${localIp.replace('http://', 'ws://')}:5556/api/chess/ws/chess`;
        _messagesWsEndpoint = `${localIp.replace('http://', 'ws://')}:8788/api/messages/ws/messages`;
        _pondsWsEndpoint = `${localIp.replace('http://', 'ws://')}:8788/api/messages/ws/ponds`;

        console.log('Running in development mode. All services are pointing to local sources.');
      }

      let discordMode = false;

      // check if the current host is a Discord proxy
      if (window.location.hostname.includes('discord')) {
        discordMode = true;
        // console.log('Running in Discord mode. All services are pointing to Discord proxy.');
        console.log('Running in Discord mode. All services are pointing to Discord proxy.');
      }
      // _api = `${localIp}:8787/api/buddylist`;
      window.discordMode = discordMode;

      // _host = 'http://' + localIp;
      //_host = 'https://prime-sections-rescue-name.trycloudflare.com';
      // set _host to current document location

      if (discordMode) {
        _api = `${_host}/.proxy/api/buddylist`;
        _appsEndpoint = `${_host}/.proxy/api/apps`;
        _uploadsEndpoint = `${_host}/.proxy/api/uploads`;
        _coinEndpoint = `${_host}/.proxy/api/coin`;
        _portfolioEndpoint = `${_host}/.proxy/api/portfolio`;

        // TODO: map all endpoints

        // ws endpoints
        _messagesWsEndpoint = `${_host.replace('https://', 'wss://')}/.proxy/api/messages/ws/messages`;
        _buddylistWsEndpoint = `${_host.replace('https://', 'wss://')}/.proxy/api/buddylist/ws/buddylist`;

        console.log(`_messagesWsEndpoint`, _messagesWsEndpoint);
        console.log(`_buddylistWsEndpoint`, _buddylistWsEndpoint);
      }

      // _errorsEndpoint = `http://${localIp}:9010`;

      buddypond.host = _host;
      buddypond.endpoint = _api;
      buddypond.messagesWsEndpoint = _messagesWsEndpoint;
      buddypond.pondsWsEndpoint = _pondsWsEndpoint;
      buddypond.messagesApiEndpoint = _messagesApiEndpoint;
      buddypond.buddylistWsEndpoint = _buddylistWsEndpoint;
      buddypond.adminEndpoint = _admin;
      buddypond.errorsEndpoint = _errorsEndpoint;
      buddypond.uploadsEndpoint = _uploadsEndpoint;
      buddypond.portfolioEndpoint = _portfolioEndpoint;
      buddypond.coinEndpoint = _coinEndpoint;
      buddypond.randolphEndpoint = _randolphEndpoint;
      buddypond.imageSearchEndpoint = _imageSearchEndpoint;
      buddypond.buddyProxy = _buddyProxy;
      buddypond.appsEndpoint = _appsEndpoint;
      buddypond.apiKeysEndpoint = _apiKeysEndpoint;
      buddypond.chessWsEndpoint = _chessWsEndpoint;
      buddypond.gamblorEndpoint = _gamblorEndpoint;
      buddypond.videoChatEndpoint = _videoChatEndpoint;

      let renderBpApp = true;
      let loadedFromApp = false;

      // route the SPA based on the current path
      // any routes that land here outside of root will be proxied to files.buddypond.com ( user pads )
      let currentPath = window.location.pathname;

      // get the current subdomain
      // if not empty or www, assume its the currentPath
      let subdomain = window.location.hostname.split('.')[0];

      if (subdomain !== '' && subdomain !== 'www') {
        // TODO: will need better check for _host.startsWith('https://subdomain')
        // currentPath = '/' + subdomain; // TODO: all buddynames will need to be lowercased for subdomains to work for everyone
      }
      // alert(`currentPath: ${currentPath}`);
      // document.write currentPath

      if (currentPath !== '/') {
        // check if route is /app/app-name, if so we still wil render the app
        // but we will not render the BuddyPad iframe
        if (!currentPath.startsWith('/app/')) {
          renderBpApp = false;
          console.log('currentPath', currentPath);
        } else {
          // indicates that loaded from an app
          // currently used to prevent default behaviors like opening the motd app
          loadedFromApp = true;
        }
      }

      bindJqueryReady();
      function bindJqueryReady() {
        // see: ReadMe.md for documentation on `desktop.use`
        $(document).ready(async function () {
          bp.loadedFromApp = loadedFromApp;
          bp.on('bp::loading', 'update-loading-text', function (resource) {
            // desktop.log('Buddy Pond Cloud OS Loading');
            if (typeof resource === 'object') {
              // if resource is an object, stringify it
              console.log('Loading ' + resource.name + '...');
              $('.loaderText').text('Loading ' + resource.name + '...');
            } else {
              console.log('Loading ' + resource + '...');
              $('.loaderText').text('Loading ' + resource + '...');
            }
          });

          if (!renderBpApp) {
            // render the app
            // renderApp();
            // empty the body
            // now we need to fetch the pad and render it
            $('body').empty();
            // write the buddypad iframe
            let buddypadIframe = document.createElement('iframe');
            // set height and width
            //buddypadIframe.style.width =  document.documentElement.clientWidth + 'px';
            //buddypadIframe.style.height = document.documentElement.clientHeight + 'px';

            buddypadIframe.style.width = '100%';
            buddypadIframe.style.height = '800px';
            // set the id
            buddypadIframe.id = 'buddypad';
            $('body').append(buddypadIframe);

            // remove padding and margin from body
            $('body').css('padding', '0');
            $('body').css('margin', '0');
            // remove border from iframe and body
            $('#buddypad').css('border', 'none');
            $('body').css('border', 'none');

            // set the src of the buddypad to the current path
            let filesSrc = 'https://files.buddypond.com' + currentPath;
            console.log('Setting BuddyPad src to', filesSrc);
            console.log(`You may visit ${filesSrc} directly in your browser.`);
            $('#buddypad').attr('src', filesSrc);
            return;

          }

          let urlParams = new URLSearchParams(window.location.search);

          window.linkDiscordAccount = function linkDiscordAccount(discordId) {
            // if we have a discord_id, apply discord login logic
            console.log(`You have a discord_id: ${discordId}. \n\n This will link your Discord account to your Buddy Pond account.`);

            buddypond.apiRequest(`/auth/link-discord`, 'POST', {
              discord_id: discordId
            }, (err, data) => {
              console.log('Link Discord response:', err, data);
              if (err || !data.success) {
                if (err.message === 'HTTP 401: Unauthorized') {
                  alert('You must be logged in to link your Discord account.');
                  console.log('You must be logged in to link your Discord account.');
                  // set temporary window variable for discord_id, such that on next login we can link the account
                  window.tempDiscordId = discordId;
                } else if (data.message) {
                  console.error(data.message);
                } else {
                  alert('An unknown error occurred while linking your Discord account.');
                  console.error('Unknown error linking Discord account:', err, data);
                }
                console.error('Error linking Discord account:', err, data);
                return;
              }

              alert('Successfully linked Discord account!');
              console.log('Linked Discord account:', data);
            });
          }

          // check if we have a query param named discord_id
          let discordId = urlParams.get('discord_id');
          if (discordId) {
            linkDiscordAccount(discordId);
          }

          // check if we have a query param named rtoken
          // must be done before bp_v_5() is called since loading logic may update pushstate
          let rtoken = urlParams.get('rtoken');
          let buddyname = urlParams.get('buddyname');

          await bp_v_5();

          let documentReadyTime = new Date();
          // desktop.log('Buddy Pond Cloud OS Initialized');
          // desktop.log('Now loading apps');

          let now = new Date();

          // For Buddy Experience we'll add some fades and delays
          let fadeInDelay = 555;

          // If the page has taken over 3.333 seconds to load...
          // ...reduce the fade in delay ( since the Buddy has waited long enough )
          if (now.getTime() - documentReadyTime.getTime() > 3333) {
            fadeInDelay = 111;
          }
          $('#loaderHolder').fadeOut({
            easing: 'linear',
            duration: fadeInDelay,
            complete: async function () {
              $('#mainOverlay').fadeIn({
                easing: 'linear',
                duration: 333
              });

              // show the .taskbar-container
              $('.taskbar-container')
                .css('display', 'flex')
                .hide()
                .fadeIn({
                  easing: 'linear',
                  duration: 555
                });

              // check if currentPath starts with /app/app-name
              // if so, then extra app-name and call bp.open('app-name');
              if (currentPath.startsWith('/app/')) {
                // get the app name from the currentPath
                let appName = currentPath.split('/')[2];
                console.log('Opening app:', appName);
                // open the app

                // check if there is a url param named context
                // if so, use it as the context for the app
                let appContext = 'default';
                if (urlParams.has('context')) {
                  appContext = urlParams.get('context');
                }

                let win = await bp.open(appName, {
                  context: appContext,
                  output: 'window',
                  urlParams: urlParams
                });
                console.log('Opened app:', win);
                if (win) {
                  if (!win.isMaximized) {
                    // if the window is not maximized, maximize it
                    if (win.maximize) {
                      win.maximize();
                    } else {
                      // should not happen
                      throw new Error('Window maximize function not found for ' + appName);
                    }
                  }
                } else {
                  bp.loadedFromApp = false;
                  // TODO: better control of default loading apps / failover if missing /app/app-name
                  // there was an error loading the /app/app-name
                  // we need to re-run the default logic
                  let allCommands = bp.apps.buddyscript.commands;
                  await bp.open({
                    name: 'welcome',
                    autocomplete: allCommands
                  });
                }
              }


              if (rtoken && buddyname) {
                // if we have a rtoken, apply password reset logic
                // alert('You have a rtoken: ' + rtoken);
                console.log('You have a rtoken: ' + rtoken);
                buddypond.apiRequest(`/auth/reset-password?rtoken=${rtoken}&buddyname=${buddyname}`, 'GET', {
                }, (err, data) => {
                  // TODO: consolidate login logic to new API client
                  if (err || !data.success) {
                    if (data.message) {
                      alert(data.message);
                    } else {
                      alert(err.message);
                    }
                  }

                  console.log('Password reset response:', err, data);
                  if (data.success) {
                    let qtoken = data;
                    data.me = buddyname;
                    buddypond.me = buddyname;
                    buddypond.qtokenid = data.qtokenid;
                    localStorage.setItem('qtokenid', data.qtokenid);
                    localStorage.setItem('me', buddypond.me);
                    bp.emit('auth::qtoken', data);
                    bp.open('pincode');
                    // remove all query params from the URL
                    let newUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
                    window.history.pushState({ path: newUrl }, '', newUrl);
                    // loads non-critical apps after main apps are loaded
                    // this is used for chatbar buttons, etc, makes UI more responsive
                    // window.deferLoad();
                  }
                });
              } else {
                // window.deferLoad();
              }



            }
          });
        });
      }

    </script>
    <div id="shadowRender">
    </div>
    <iframe id="buddypad"></iframe>
    <script type="module" src="/v5/public/buddypond.umd.js"></script>

    <!-- <bp-minesweeper open></bp-minesweeper> -->
    <!-- <bp-youtube open context="G50eivcSvuQ"></bp-youtube> -->

</body>

</html>